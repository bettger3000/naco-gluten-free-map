<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>グルテンフリーマップ | ビヨフリ倶楽部</title>
    
    <!-- アイコン設定 -->
    <link rel="icon" type="image/png" href="nacoキャラクター.png">
    
    <!-- フォント -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary: #ff6b9d;
            --primary-dark: #e55a8a;
            --secondary: #40e0d0;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-glass: rgba(255, 255, 255, 0.9);
            
            --text-primary: #1a1a1a;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
            
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            
            --gradient-primary: linear-gradient(135deg, #ff6b9d 0%, #40e0d0 100%);
            --gradient-bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            --font-display: 'Inter', 'Noto Sans JP', sans-serif;
            --font-body: 'Noto Sans JP', 'Inter', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--gradient-bg);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* メインアプリ */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-light);
            padding: var(--space-md) var(--space-lg);
            position: sticky;
            top: 0;
            z-index: 1100; /* ヘッダー全体を少し上げる */
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* PC版のヘッダーレイアウト：中央にnaco+タイトル */
        @media (min-width: 769px) {
            .header-content {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                align-items: center;
                gap: var(--space-lg);
            }
            
            .app-title {
                grid-column: 2;
                justify-self: center;
                display: flex;
                align-items: center;
                gap: var(--space-sm);
                font-family: var(--font-display);
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--primary);
                white-space: nowrap;
            }
            
            .app-title .title-icon {
                width: 50px;
                height: 50px;
                flex-shrink: 0;
            }
            
            .app-title span {
                font-family: inherit;
                font-size: inherit;
                font-weight: inherit;
                color: inherit;
            }
            
            .header-actions {
                grid-column: 3;
                justify-self: end;
            }
        }

        /* スマホ版ヘッダー3分割レイアウト */
        @media (max-width: 768px) {
            .header-content {
                display: grid;
                grid-template-columns: 50px 1fr 50px;
                align-items: center;
                padding: var(--space-md);
                gap: var(--space-sm);
                max-width: 100%;
            }
            
            .app-title {
                display: contents !important; /* PC版のflexを無効化してgridの子要素として扱う */
                font-family: var(--font-display) !important;
                font-weight: 700 !important;
                color: var(--primary) !important;
            }
            
            .title-icon {
                grid-column: 1;
                justify-self: center;
                width: 45px !important;
                height: 45px !important;
            }
            
            .title-icon img {
                width: 45px !important;
                height: 45px !important;
            }
            
            .app-title span {
                grid-column: 2;
                justify-self: center;
                text-align: center;
                font-size: 1.0rem !important;
                line-height: 1.2;
                white-space: nowrap;
                overflow: visible !important;
                text-overflow: ellipsis;
                max-width: 100%;
                display: block !important;
                visibility: visible !important;
                color: var(--primary) !important;
            }
            
            .header-actions {
                grid-column: 3;
                justify-self: center;
            }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            position: relative; /* ドロップダウン用 */
        }

        /* ユーザーメニュードロップダウン */
        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: #ffffff;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25), 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1200; /* 最前面に表示 */
            min-width: 220px;
            overflow: hidden;
            margin-top: 8px;
            backdrop-filter: blur(20px);
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            font-weight: 500;
            color: #1a1a1a;
            background: #ffffff;
        }

        .menu-item:hover {
            background: #f8f9fa;
            color: #333333;
        }

        .menu-item.danger {
            color: #dc3545;
        }

        .menu-item.danger:hover {
            background: #fff5f5;
            color: #c82333;
        }

        .menu-divider {
            height: 1px;
            background: #e9ecef;
            margin: 6px 0;
        }

        .menu-item i {
            width: 18px;
            height: 18px;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
            color: inherit;
        }

        .menu-item.danger i {
            opacity: 1;
        }

        .menu-item span {
            color: inherit;
            font-weight: inherit;
        }

        /* 店舗詳細モーダル */
        .store-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        .store-detail-container {
            background: white;
            max-width: 600px;
            width: 90%;
            margin: 20px auto;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease;
            position: relative;
        }

        .store-detail-header {
            position: sticky;
            top: 0;
            background: white;
            border-radius: 12px 12px 0 0;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            z-index: 10;
            display: flex;
            justify-content: flex-end;
        }

        .store-detail-close {
            width: 32px;
            height: 32px;
            border: none;
            background: #f5f5f5;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 18px;
            color: #666;
        }

        .store-detail-close:hover {
            background: #e0e0e0;
            transform: scale(1.1);
        }

        .store-detail-body {
            padding: 20px;
        }

        .store-detail-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .store-detail-category {
            display: inline-block;
            padding: 4px 12px;
            background: var(--gradient-primary);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 20px;
        }
        .store-detail-category-container {
            margin-bottom: 20px;
        }

        .store-detail-section {
            margin-bottom: 25px;
        }
        
        /* 店舗画像ギャラリー */
        .store-images-container {
            min-height: 150px;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-sm);
        }
        .store-images-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 120px;
            color: var(--text-secondary);
        }
        .store-images-placeholder i {
            font-size: 2rem;
            margin-bottom: var(--space-sm);
            opacity: 0.5;
        }
        .store-images-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: var(--space-sm);
        }
        .store-image-item {
            position: relative;
            border-radius: var(--radius-sm);
            overflow: hidden;
            aspect-ratio: 1;
            cursor: pointer;
        }
        .store-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s ease;
        }
        .store-image-item:hover img {
            transform: scale(1.05);
        }
        .store-image-admin {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }
        .image-limit-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .delete-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
            transition: background-color 0.2s ease;
        }
        .delete-image-btn:hover {
            background: rgba(255, 0, 0, 1);
        }
        
        /* 画像拡大モーダル */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            cursor: pointer;
        }
        .image-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }
        .image-modal-content img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: var(--radius-md);
        }
        .image-modal-close {
            position: absolute;
            top: -40px;
            right: -40px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .store-detail-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .store-detail-info {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            color: #666;
            font-size: 14px;
        }

        .store-detail-info i {
            width: 20px;
            text-align: center;
            color: var(--primary-green);
            flex-shrink: 0;
        }

        .store-detail-description {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
            color: #555;
            font-size: 14px;
        }

        .store-detail-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .store-detail-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .store-detail-btn.primary {
            background: var(--gradient-primary);
            color: white;
        }

        .store-detail-btn.secondary {
            background: #f5f5f5;
            color: #666;
        }
        .store-detail-btn.want-to-go {
            background: #fff;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        .store-detail-btn.want-to-go.active {
            background: var(--primary);
            color: white;
        }
        .store-detail-btn.visited {
            background: #fff;
            color: var(--success);
            border: 2px solid var(--success);
        }
        .store-detail-btn.visited.active {
            background: var(--success);
            color: white;
        }

        .store-detail-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .store-detail-container {
                width: 100%;
                height: 100%;
                margin: 0;
                border-radius: 0;
                max-width: none;
            }

            .store-detail-header {
                border-radius: 0;
            }

            .store-detail-body {
                padding: 15px;
            }

            .store-detail-title {
                font-size: 20px;
            }
        }

        /* アニメーション */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* プロフィールモーダル */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1300;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg);
        }

        .modal-container {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-lg);
            border-bottom: 1px solid #f1f3f4;
            background: #fafbfc;
        }

        .modal-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .modal-close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-body {
            padding: var(--space-lg);
            overflow-y: auto;
            max-height: calc(90vh - 100px);
        }

        /* プロフィール表示 */
        .profile-view {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }

        .profile-avatar {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-sm);
            position: relative;
        }

        .avatar-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            box-shadow: 0 4px 12px rgba(152, 216, 200, 0.3);
            overflow: hidden;
            position: relative;
        }

        .avatar-circle.image-avatar {
            background: none;
            padding: 0;
        }

        .avatar-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-edit-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .avatar-edit-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .profile-field {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .profile-field label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-field span {
            font-size: 1rem;
            color: var(--text-primary);
            padding: var(--space-sm) 0;
            border-bottom: 1px solid #f3f4f6;
        }

        /* プロフィール編集 */
        .profile-edit {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }

        /* アバタータブ */
        .avatar-tabs {
            display: flex;
            gap: var(--space-xs);
            margin: var(--space-md) 0;
            justify-content: center;
        }

        .avatar-tab {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm);
            border: 2px solid #e5e7eb;
            background: #ffffff;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .avatar-tab.active {
            border-color: var(--primary);
            background: var(--bg-light);
            color: var(--primary);
        }

        .avatar-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .avatar-options {
            display: flex;
            gap: var(--space-sm);
            justify-content: center;
            flex-wrap: wrap;
            margin-top: var(--space-sm);
        }

        /* 画像アップロード */
        .image-upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }

        .upload-btn {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(152, 216, 200, 0.4);
        }

        .upload-info {
            text-align: center;
            color: #6b7280;
        }

        .image-preview {
            position: relative;
            margin-top: var(--space-sm);
        }

        .image-preview img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            box-shadow: 0 4px 12px rgba(152, 216, 200, 0.3);
        }

        .remove-image-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 24px;
            height: 24px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }

        .remove-image-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .avatar-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #e5e7eb;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .avatar-option:hover {
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: var(--primary);
            background: var(--bg-light);
        }

        .profile-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .form-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea {
            padding: var(--space-sm);
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .char-count {
            text-align: right;
            font-size: 0.8rem;
            color: #6b7280;
        }

        .form-actions {
            display: flex;
            gap: var(--space-sm);
            justify-content: flex-end;
            margin-top: var(--space-md);
        }

        .btn {
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(152, 216, 200, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #6b7280;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
            color: #374151;
        }

        /* モバイル対応 */
        @media (max-width: 768px) {
            .modal-overlay {
                padding: var(--space-md);
            }
            
            .modal-container {
                max-height: 95vh;
            }
            
            .modal-header,
            .modal-body {
                padding: var(--space-md);
            }
            
            .form-actions {
                flex-direction: column;
            }
        }

        .auth-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-lg);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .auth-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .hamburger-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: var(--space-sm);
            border-radius: var(--radius-lg);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 42px;
            height: 42px;
            transition: all 0.2s ease;
        }

        .hamburger-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            background: var(--primary-dark);
        }

        /* PC版ユーザープロフィールボタン */
        .user-profile-btn {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            background: var(--bg-glass);
            border: 1px solid var(--border);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-xl);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .user-profile-btn:hover {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .user-profile-btn .user-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
        }

        /* スマホ版アバターボタン */
        .mobile-user-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: white;
            border: 2px solid var(--bg-primary);
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .mobile-user-btn:hover {
            transform: translateY(-1px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        /* スマホ版アバターボタン内の画像 */
        .mobile-user-btn img {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
            border-radius: 50%;
        }


        .title-icon {
            width: 50px;
            height: 50px;
            background: transparent;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: float 3s ease-in-out infinite;
        }
        
        .title-icon img {
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.1));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        /* 現在地マーカー用アニメーション */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.6; }
            100% { transform: scale(1); opacity: 1; }
        }

        .current-location-marker {
            animation: pulse 2s ease-in-out infinite;
        }

        /* 現在地マーカー二重円デザイン */
        .location-marker-container {
            position: relative;
            width: 44px;
            height: 44px;
            display: block !important;
        }

        .location-outer-circle {
            position: absolute;
            top: 0;
            left: 0;
            width: 44px;
            height: 44px;
            background: rgba(0, 122, 255, 0.2);
            border: 2px solid rgba(0, 122, 255, 0.4);
            border-radius: 50%;
            display: block;
        }

        .location-inner-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            background: #007AFF;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.5);
            z-index: 10;
            display: block;
        }



        .search-input {
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }

        .filter-chips {
            display: flex;
            gap: var(--space-sm);
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-bottom: var(--space-xs);
        }
        
        .filter-chips::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: var(--space-sm) var(--space-md);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .filter-chip:hover,
        .filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* メインコンテンツ */
        .main-content {
            flex: 1;
            display: flex;
            width: 100%;
            height: calc(100vh - 120px); /* ヘッダーと検索エリアを引く */
            position: relative;
        }


        .map-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            /* スマホでの長押しメニューを無効化 */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* 地図エリア内のすべての要素で長押し選択を無効化 */
        #map {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: pan-x pan-y;
        }

        #map {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }

        .map-controls {
            position: absolute;
            top: calc(var(--space-lg) * 2.5);
            right: var(--space-md);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        /* モバイル版では左上配置を維持 */
        @media (max-width: 1024px) {
            .map-controls {
                top: var(--space-lg);
                left: var(--space-lg);
                right: auto;
            }
        }

        .map-control-btn {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: var(--radius-md);
            padding: var(--space-md);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
        }

        .map-control-btn:hover {
            background: var(--bg-primary);
            transform: translateY(-1px);
        }
        
        /* ズームコントロール */
        .zoom-controls {
            display: flex;
            flex-direction: column;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-sm);
        }
        
        .zoom-btn {
            background: transparent;
            border-radius: 0;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-primary);
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            box-shadow: none;
        }
        
        .zoom-btn:first-child {
            border-bottom: 1px solid var(--border-light);
        }
        
        .zoom-btn:hover {
            background: var(--bg-primary);
        }
        
        /* モバイル専用現在地ボタン */
        .mobile-location-control {
            position: absolute;
            bottom: 100px; /* オーバーレイパネルの上に配置 */
            right: var(--space-lg);
            z-index: 1000;
            display: flex;
            gap: 8px;
            flex-direction: column;
        }
        
        @media (max-width: 1024px) {
            /* モバイル版ではズームコントロールを非表示（デフォルトのLeafletズームを使用） */
            .zoom-controls {
                display: none;
            }
            
            /* PC版では現在地ボタンを非表示 */
            #locateBtn {
                display: none;
            }
        }
        
        @media (min-width: 1025px) {
            /* PC版ではモバイル現在地ボタンを非表示 */
            .mobile-location-control {
                display: none;
            }
            
        }

        /* 店舗リスト */
        .store-sidebar {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-secondary);
        }


        .sidebar-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .store-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-sm);
        }

        .store-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .store-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .store-card:hover,
        .store-card.selected {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        /* 店舗カード内のアクションボタン */
        .store-card-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-light);
        }
        
        .action-btn {
            flex: 1;
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: white;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
        }
        
        .action-btn:hover {
            background: var(--bg-secondary);
        }
        
        .action-btn.want-to-go {
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .action-btn.want-to-go.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .action-btn.visited {
            color: var(--success);
            border-color: var(--success);
        }
        
        .action-btn.visited.active {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        /* ポップアップ内のアクションボタン */
        .popup-action-btn {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: white;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 40px;
            white-space: nowrap;
        }

        .popup-action-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary);
        }

        .popup-action-btn:active {
            transform: scale(0.95);
            background: var(--primary);
            color: white;
        }

        .popup-action-btn.want-to-go:active {
            background: #ec4899;
            border-color: #ec4899;
        }

        .popup-action-btn.visited:active {
            background: #4ade80;
            border-color: #4ade80;
        }

        .popup-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
            flex-wrap: wrap;
        }
        
        /* スマホ版でのボタンレイアウト調整 */
        @media (max-width: 768px) {
            .popup-actions {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
                gap: 6px;
            }
            
            .popup-action-btn {
                min-width: 0;
                padding: 8px 6px;
                font-size: 0.85rem;
            }
            
            /* 詳細ボタン（3番目）を1行目全体に配置 */
            .popup-action-btn:nth-child(3) {
                grid-column: 1 / 3;
                grid-row: 1;
                background: var(--gradient-primary);
                color: white;
                font-weight: 600;
                border: none;
            }
            
            /* 行きたいボタンを2行目左側に配置 */
            .popup-action-btn:nth-child(1) {
                grid-column: 1;
                grid-row: 2;
            }
            
            /* 行ったボタンを2行目右側に配置 */
            .popup-action-btn:nth-child(2) {
                grid-column: 2;
                grid-row: 2;
            }
            
            .popup-action-btn:nth-child(3):hover {
                opacity: 0.9;
                transform: translateY(-1px);
            }
        }

        /* ポップアップボタンのアクティブ状態 */
        .popup-action-btn.want-to-go.active {
            background: #ec4899;
            border-color: #ec4899;
            color: white;
            font-weight: 600;
        }

        .popup-action-btn.visited.active {
            background: #22c55e;
            border-color: #22c55e;
            color: white;
            font-weight: 600;
        }

        /* ボタン押下時のアニメーション */
        @keyframes buttonPress {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.95);
            }
            100% {
                transform: scale(1);
            }
        }

        /* ボタン押下時の一時的な視覚効果 */
        .action-btn.pressing,
        .popup-action-btn.pressing {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }

        /* PC版店舗カードスタイル */
        .pc-store-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-light);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .pc-store-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .pc-store-card.selected {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(152, 216, 200, 0.2);
        }

        .pc-store-card .store-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .pc-store-card .store-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.3;
        }

        .pc-store-card .store-distance {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: var(--bg-light);
            padding: 2px 6px;
            border-radius: 6px;
        }

        .pc-store-card .store-meta {
            margin-bottom: 12px;
        }

        .pc-store-card .store-category {
            font-size: 0.85rem;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            background: var(--primary);
        }

        .pc-store-card .store-info {
            margin-bottom: 12px;
        }

        .pc-store-card .info-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .pc-store-card .info-icon {
            flex-shrink: 0;
            width: 16px;
            text-align: center;
        }

        .pc-store-card .store-card-actions {
            display: flex;
            gap: 6px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
        }

        .pc-store-card .action-btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.85rem;
            min-height: 36px;
        }

        .store-card:hover::before,
        .store-card.selected::before {
            transform: scaleY(1);
        }

        .store-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .store-header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--space-xs);
        }

        .store-distance {
            background: rgba(0, 122, 255, 0.1);
            color: #007AFF;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .store-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.4;
            flex: 1;
        }

        .store-category {
            color: white;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-xl);
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            margin-left: var(--space-sm);
        }

        /* カテゴリ別色設定（マップマーカーと統一） */
        .store-category[data-category="カフェ"] {
            background: #8B4513;
        }
        .store-category[data-category="和食"] {
            background: #E74C3C;
        }
        .store-category[data-category="洋食"] {
            background: #3498DB;
        }
        .store-category[data-category="パン屋"] {
            background: #F39C12;
        }
        .store-category[data-category="スイーツ"] {
            background: #E91E63;
        }
        .store-category[data-category="販売店"] {
            background: #27AE60;
        }
        .store-category[data-category="その他"] {
            background: #7F8C8D;
        }

        .store-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .store-address {
            color: var(--text-secondary);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .store-gf-type {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.875rem;
            color: var(--success);
            font-weight: 500;
        }

        .store-hours {
            color: var(--text-light);
            font-size: 0.8rem;
        }

        /* ポップアップスタイル */
        .popup-content {
            min-width: 250px;
        }

        .popup-header {
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .popup-header-main {
            flex: 1;
        }
        
        .popup-close-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-left: var(--space-sm);
        }
        
        .popup-close-btn:hover {
            background: var(--error);
            border-color: var(--error);
            color: white;
            transform: scale(1.1);
        }
        
        .close-icon {
            font-size: 18px;
            font-weight: bold;
            line-height: 1;
        }

        .popup-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }


        .popup-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .popup-essential-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        .popup-additional-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            padding-top: var(--space-sm);
        }

        .popup-header-fixed {
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .popup-scrollable-content {
            flex: 1;
            overflow-y: auto;
            max-height: calc(100% - 80px);
        }

        .popup-info-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            padding-bottom: var(--space-md);
        }

        .popup-category-row {
            margin-bottom: var(--space-sm);
        }


        .popup-actions {
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: var(--space-sm);
        }

        .visit-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            padding: var(--space-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            background: white;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .visit-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-1px);
        }

        .visit-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .btn-icon {
            font-size: 1rem;
        }

        .popup-row {
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            font-size: 0.875rem;
        }

        .popup-icon {
            color: var(--text-light);
            min-width: 16px;
        }

        .popup-text {
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* カスタムマーカー */
        .custom-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: var(--shadow-md);
            font-size: 14px;
            font-weight: 600;
            color: white;
            transition: all 0.2s ease;
        }

        .custom-marker:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        /* リーフレットポップアップカスタム */
        .leaflet-popup-content-wrapper {
            border-radius: var(--radius-lg) !important;
            box-shadow: var(--shadow-xl) !important;
            max-width: 320px !important;
        }

        .leaflet-popup-content {
            margin: var(--space-lg) !important;
            font-family: var(--font-body) !important;
            line-height: 1.6 !important;
            width: auto !important;
            max-width: none !important;
        }

        /* モバイル用ポップアップ高さ制限 */
        @media (max-width: 1024px) {
            .leaflet-popup-content-wrapper {
                max-height: 35vh !important;
                overflow: hidden !important;
            }
            
            .popup-content {
                max-height: calc(35vh - 32px) !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .popup-header-fixed {
                flex-shrink: 0 !important;
            }
            
            .popup-scrollable-content {
                overflow-y: auto !important;
                flex: 1 !important;
                min-height: 0 !important;
            }
        }
        
        /* Leafletのデフォルト閉じるボタンを非表示 */
        .leaflet-popup-close-button {
            display: none !important;
        }

        /* 地図コントロール（ズームボタン）のカスタマイズ */
        .leaflet-control-zoom {
            border: none !important;
            border-radius: var(--radius-lg) !important;
            box-shadow: var(--shadow-lg) !important;
            background: white !important;
            overflow: hidden !important;
        }

        .leaflet-control-zoom a {
            background: white !important;
            border: none !important;
            color: var(--primary) !important;
            font-weight: 600 !important;
            font-size: 18px !important;
            width: 36px !important;
            height: 36px !important;
            line-height: 32px !important;
            text-align: center !important;
            transition: all 0.2s ease !important;
            border-radius: 0 !important;
        }

        .leaflet-control-zoom a:hover {
            background: var(--primary) !important;
            color: white !important;
            transform: scale(1.05) !important;
        }

        .leaflet-control-zoom a:first-child {
            border-top-left-radius: var(--radius-lg) !important;
            border-top-right-radius: var(--radius-lg) !important;
        }

        .leaflet-control-zoom a:last-child {
            border-bottom-left-radius: var(--radius-lg) !important;
            border-bottom-right-radius: var(--radius-lg) !important;
        }

        /* レスポンシブ */

        /* オーバーレイ式店舗リストパネル */
        .overlay-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top-left-radius: var(--radius-2xl);
            border-top-right-radius: var(--radius-2xl);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1100;
            transform: translateY(calc(100% - 60px));
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .overlay-panel.half-open {
            transform: translateY(50%);
        }
        
        .overlay-panel.full-open {
            transform: translateY(0);
        }
        
        .panel-handle {
            padding: var(--space-md) var(--space-lg);
            cursor: grab;
            touch-action: pan-y;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            border-top-left-radius: var(--radius-2xl);
            border-top-right-radius: var(--radius-2xl);
        }
        
        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .panel-controls {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .state-indicators {
            display: flex;
            gap: 4px;
            margin-right: var(--space-sm);
        }
        
        .state-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.2s ease;
        }
        
        .state-dot.active {
            background: var(--primary);
            transform: scale(1.2);
        }
        
        .panel-control-btn.compact {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            padding: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .panel-control-btn.compact:hover {
            background: var(--bg-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .panel-control-btn.compact:disabled {
            background: var(--bg-secondary);
            color: var(--text-light);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .panel-control-btn.compact .control-icon {
            font-size: 0.9rem;
            line-height: 1;
        }
        
        /* PC用サイドバー */
        .store-sidebar {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            display: none; /* デフォルトは非表示 */
            flex-direction: column;
            overflow: hidden;
            height: 100vh; /* 画面全体の高さに固定 */
            max-height: 100vh;
        }
        
        .sidebar-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-secondary);
            flex-shrink: 0; /* ヘッダーは高さ固定 */
        }
        
        .sidebar-title-row {
            display: flex;
            align-items: center;
            margin-bottom: var(--space-md);
            gap: var(--space-sm);
        }
        
        .sidebar-title {
            flex: 1;
            min-width: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .sidebar-count {
            flex-shrink: 0;
        }
        
        .sidebar-title-row .pin-mode-btn {
            flex-shrink: 0;
        }
        
        /* PC版ピンボタン専用スタイル */
        .pc-pin-btn {
            padding: 8px 16px !important;
            height: auto !important;
            min-width: auto !important;
            font-size: 0.9rem !important;
            border-radius: 12px !important;
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
            white-space: nowrap;
            font-weight: 500;
        }
        
        .pc-pin-btn .pin-icon {
            font-size: 1rem;
        }
        
        .pc-pin-btn .pin-label {
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        /* PC版ピンボタンの状態表示 */
        .pc-pin-btn.active .pin-label::after {
            content: '設置中';
            margin-left: 4px;
            font-size: 0.75rem;
            opacity: 0.9;
        }
        
        
        .sidebar-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* PC用検索ボックス */
        .sidebar-search {
            margin-bottom: var(--space-lg);
        }
        
        .sidebar-search-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }
        
        .sidebar-search-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* PC用タブ */
        .sidebar-tabs {
            display: flex;
            gap: var(--space-xs);
            margin: var(--space-md) 0;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: var(--space-xs);
        }
        
        .sidebar-tab {
            flex: 1;
            background: transparent;
            border: none;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sidebar-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }
        
        .sidebar-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5);
        }

        /* PC用フィルターチップ */
        .sidebar-filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
            margin-bottom: var(--space-md);
        }
        
        .sidebar-chip {
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            white-space: nowrap;
            font-weight: 500;
        }
        
        .sidebar-chip:hover {
            background: var(--bg-primary);
            border-color: var(--primary);
            color: var(--text-primary);
            transform: translateY(-1px);
        }
        
        .sidebar-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .store-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-sm);
            min-height: 0; /* flex子要素のスクロール有効化 */
            scrollbar-width: thin; /* Firefox用スクロールバー */
            scrollbar-color: var(--primary) var(--bg-secondary); /* Firefox用カラー */
        }
        
        /* Webkit系ブラウザ用スクロールバー */
        .store-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .store-list::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }
        
        .store-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }
        
        .store-list::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* サイドバー用店舗カード */
        .store-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .store-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .store-card:hover,
        .store-card.selected {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .store-card:hover::before,
        .store-card.selected::before {
            transform: scaleY(1);
        }
        
        /* レスポンシブ表示制御 */
        .pc-only {
            display: none;
        }
        
        .mobile-only {
            display: block;
        }
        
        @media (min-width: 1025px) {
            .pc-only {
                display: flex;
            }
            
            .mobile-only {
                display: none;
            }
            
            
            .main-content {
                display: grid !important;
                grid-template-columns: 400px 1fr !important;
                gap: var(--space-xl) !important;
                height: 100vh !important;
                padding: var(--space-xl) !important;
                box-sizing: border-box;
                align-items: stretch;
            }
            
            .map-container {
                border-radius: var(--radius-xl);
                overflow: hidden;
                box-shadow: var(--shadow-lg);
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            
            #map {
                height: 100% !important;
                border-radius: var(--radius-xl);
                flex: 1;
            }
        }
        
        .panel-handle:active {
            cursor: grabbing;
        }
        
        
        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-sm);
        }
        
        .panel-title-left {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .search-toggle-btn {
            background: transparent;
            border: none;
            padding: var(--space-xs);
            cursor: pointer;
            display: flex;
            align-items: center;
            position: relative;
            font-size: 1.2rem;
            transition: transform 0.2s ease;
        }
        
        .search-toggle-btn:hover {
            transform: scale(1.1);
        }
        
        .search-toggle-btn.active {
            transform: rotate(90deg);
        }
        
        .filter-indicator {
            position: absolute;
            top: 0;
            right: 0;
            color: var(--error);
            font-size: 0.6rem;
        }
        
        /* モバイル版検索・フィルター - 完全に独立したレイアウト */
        .mobile-search-filter {
            position: fixed;
            top: 140px; /* 固定値に変更してテスト */
            left: 0;
            right: 0;
            z-index: 1000;
            background: var(--bg-secondary);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-bottom: 0;
        }
        
        .panel-tabs {
            display: flex;
            gap: 0;
            padding: 0 var(--space-lg) 0;
            border-bottom: 1px solid var(--border-light);
            background: white;
            flex-shrink: 0;
            margin-top: 0;
        }
        
        .panel-tab {
            flex: 1;
            padding: var(--space-sm) var(--space-md);
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
            text-align: center;
        }
        
        .panel-tab.active {
            color: var(--primary);
        }
        
        .panel-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }
        
        .panel-content {
            flex: 1 1 0;
            overflow-y: auto !important;
            padding: var(--space-sm);
            padding-top: var(--space-xs);
            min-height: 0;
            max-height: 100%;
            -webkit-overflow-scrolling: touch;
            /* デバッグ用: スクロール確認 */
            position: relative;
        }
        
        .mobile-search-filter.show {
            max-height: 200px;
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-light);
        }
        
        .mobile-search-box {
            margin-bottom: var(--space-md);
        }
        
        .mobile-search-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }
        
        .mobile-search-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .mobile-filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
        }
        
        .mobile-chip {
            padding: var(--space-xs) var(--space-sm);
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .mobile-chip:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
            color: var(--text-primary);
        }
        
        .mobile-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* 訪問履歴ビュー */
        .visit-history-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1100;
            overflow-y: auto;
            padding-bottom: 80px; /* 底部導航の高さ分 */
        }

        .visit-history-view.hidden {
            display: none;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            background: var(--gradient-primary);
            color: white;
        }

        .history-count {
            background: rgba(255, 255, 255, 0.2);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
        }

        .history-list {
            padding: var(--space-md);
        }

        .history-item {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .history-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-sm);
        }

        .history-store-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .history-category {
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
        }

        .history-address {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: var(--space-xs);
        }

        .history-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }

        .history-action-btn {
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            background: white;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-action-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: var(--space-md);
        }

        .empty-message {
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .header-content {
                padding: 0 var(--space-lg);
            }

            .main-content {
                height: calc(100vh - 100px); /* モバイルではヘッダーの高さ調整 */
            }
            
            .search-filter-content {
                flex-direction: column;
                align-items: stretch;
                padding: 0 var(--space-lg);
            }
            
            .main-content {
                padding: var(--space-lg);
                gap: var(--space-lg);
            }
            
            .filter-chips {
                justify-content: center;
            }
        }

        .loading-indicator {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin: var(--space-md);
            text-align: center;
        }

        /* エレガントなマーカースタイル */
        .elegant-marker .marker-icon:hover {
            transform: scale(1.1) !important;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25) !important;
        }

        .elegant-marker .marker-container {
            cursor: pointer;
        }

        /* マーカーアニメーション */
        @keyframes markerPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .elegant-marker:hover .marker-icon {
            animation: markerPulse 0.6s ease-in-out;
        }

        /* モバイル対応のマーカーサイズ調整 */
        @media (max-width: 768px) {
            .elegant-marker .marker-icon {
                width: 36px !important;
                height: 36px !important;
                font-size: 16px !important;
            }
        }

        /* Leafletポップアップのz-index調整 */
        .leaflet-popup {
            z-index: 700 !important;
        }
        
        .leaflet-popup-pane {
            z-index: 700 !important;
        }
        
        
        /* PC版でポップアップ位置調整 */
        @media (min-width: 1025px) {
            .leaflet-popup {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            
            .leaflet-popup-content-wrapper {
                white-space: normal;
                word-wrap: break-word;
                word-break: break-word;
                box-sizing: border-box;
                min-width: 350px;
                max-width: 420px;
            }
            
            .leaflet-popup-content {
                box-sizing: border-box;
                overflow-wrap: break-word;
            }
            
            /* PC版：ポップアップの情報階層を修正 */
            .desktop-popup .popup-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 1px solid var(--border-light);
            }
            
            .desktop-popup .popup-header-main {
                display: flex;
                flex-direction: column;
                gap: 6px;
                align-items: flex-start;
            }
            
            .desktop-popup .popup-title {
                margin: 0 !important;
                font-size: 1.2rem !important;
                font-weight: 600 !important;
                line-height: 1.3 !important;
                color: var(--text-primary);
            }
            
            .desktop-popup .store-category {
                font-size: 0.85rem;
                font-weight: 500;
                padding: 4px 8px;
                border-radius: 12px;
                color: white;
                background: var(--primary);
            }
            
            .desktop-popup .popup-close-btn {
                background: none;
                border: none;
                font-size: 20px;
                cursor: pointer;
                color: var(--text-secondary);
                padding: 4px;
                line-height: 1;
            }
            
            .desktop-popup .popup-body {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            .desktop-popup .popup-info {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .desktop-popup .popup-row {
                display: flex;
                align-items: flex-start;
                gap: 8px;
                font-size: 0.9rem;
            }
            
            .desktop-popup .popup-icon {
                flex-shrink: 0;
                width: 20px;
                text-align: center;
            }
            
            .desktop-popup .popup-text {
                flex: 1;
                word-wrap: break-word;
                word-break: keep-all;
                line-height: 1.4;
            }
            
            .desktop-popup .popup-row {
                margin-bottom: 8px;
                min-height: 24px;
            }
            
            .desktop-popup .popup-actions {
                display: flex;
                gap: 8px;
                margin-top: 8px;
                padding-top: 12px;
                border-top: 1px solid var(--border-light);
            }
            
            .popup-header-main .store-category {
                font-size: 0.85rem !important;
                margin: 0 !important;
            }
        }
        
        /* モバイルでポップアップ位置調整 */
        @media (max-width: 768px) {
            .leaflet-popup {
                margin-left: 0px !important; /* 中央に配置 */
            }
            
            /* カスタムポップアップクラス */
            .custom-popup .leaflet-popup-content-wrapper {
                margin-left: 0px;
            }
            
            .leaflet-popup-content-wrapper {
                min-width: 300px !important;
                max-width: 350px !important;
            }
            
            .popup-action-btn {
                font-size: 13px !important;
                padding: 8px 10px !important;
                min-height: 38px !important;
            }
        }

        /* 底部导航 */
        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border-light);
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            padding: var(--space-xs) 0;
            z-index: 1000;
            height: 70px;
        }

        .nav-btn {
            flex: 1;
            max-width: 120px;
            background: none;
            border: none;
            padding: var(--space-xs);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-xs);
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--radius-sm);
        }

        .nav-btn:hover {
            background: var(--bg-light);
            color: var(--primary);
        }

        .nav-btn.active {
            color: var(--primary);
            background: var(--bg-light);
        }

        .nav-btn i {
            font-size: 1.2rem;
        }

        /* 底部导航のためのコンテンツ下マージン */
        .main-content {
            margin-bottom: 70px;
        }

        .store-overlay-panel {
            bottom: 70px;
        }

        /* デスクトップでは底部导航を非表示 */
        @media (min-width: 1024px) {
            .bottom-navigation {
                display: none;
            }
            
            .main-content {
                margin-bottom: 0;
            }
            
            .store-overlay-panel {
                bottom: 0;
            }
        }

        /* =====================================
           カスタムピン機能のスタイリング
           ===================================== */
        
        /* マップコンテキストメニュー */
        .map-context-menu {
            position: absolute;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: var(--space-xs);
            z-index: 1001;
            min-width: 180px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .context-menu-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            background: none;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .context-menu-item:hover {
            background: var(--bg-light);
            color: var(--primary);
            transform: translateY(-1px);
        }
        
        .context-menu-item i {
            font-size: 1.1rem;
            color: var(--primary);
        }
        
        
        
        
        /* 高品質カスタムピンマーカー - 洗練されたデザイン */
        .custom-pin-marker {
            width: 32px;
            height: 32px;
            background: linear-gradient(145deg, #FF6B9D 0%, #C44569 100%);
            border-radius: 50%;
            position: relative;
            box-shadow: 
                0 4px 12px rgba(196, 69, 105, 0.25),
                0 2px 6px rgba(196, 69, 105, 0.15),
                inset 0 -2px 6px rgba(255, 255, 255, 0.2);
            animation: pinBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
        }
        
        .custom-pin-marker::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.1) 100%);
            border-radius: 50%;
            box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.5);
        }
        
        .custom-pin-marker::after {
            content: '📍';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
        }
        
        
        /* アニメーション */
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(1);
            }
        }
        
        @keyframes pinPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes pinBounce {
            0% { transform: rotate(-45deg) scale(0) translateY(20px); opacity: 0; }
            50% { transform: rotate(-45deg) scale(1.2) translateY(-5px); opacity: 0.8; }
            100% { transform: rotate(-45deg) scale(1) translateY(0); opacity: 1; }
        }
        
        /* ピン設置モードボタン */
        .pin-mode-btn {
            opacity: 0.6;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 249, 250, 0.85) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 107, 157, 0.2);
            border-radius: 8px;
            padding: 4px 6px;
            min-width: 28px;
            height: 28px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .pin-mode-btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
            border-color: rgba(255, 107, 157, 0.4);
        }
        
        .pin-mode-btn.active {
            opacity: 1;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
            animation: pulse 2s infinite;
        }
        
        .pin-mode-btn.active .pin-mode-icon {
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* ピン設置モードのヒント */
        .pin-mode-hint {
            position: absolute;
            top: calc(var(--space-lg) * 3);
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.95) 0%, rgba(196, 69, 105, 0.9) 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
            z-index: 1000;
            animation: slideInFromTop 0.3s ease-out;
            pointer-events: none;
        }
        
        /* PC版でのピンヒント位置調整 */
        @media (min-width: 1024px) {
            .pin-mode-hint {
                top: calc(var(--space-lg) * 2);
                left: calc(320px + 50%);
                transform: translateX(-50%);
            }
            
            .pin-guidance-message {
                top: calc(var(--space-lg) * 2);
                left: calc(320px + 50%);
                transform: translateX(-50%);
            }
        }
        
        /* ピンガイダンスメッセージ（ピンモードOFF時） */
        .pin-guidance-message {
            position: absolute;
            top: calc(var(--space-lg) * 3);
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 140, 0, 0.95) 0%, rgba(255, 165, 0, 0.9) 100%);
            color: white;
            padding: 10px 18px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 140, 0, 0.4);
            z-index: 1000;
            animation: slideInFromTop 0.3s ease-out;
            pointer-events: none;
            text-align: center;
            line-height: 1.4;
        }
        
        /* モバイル用ピン設置ヒント */
        .mobile-pin-hint {
            position: absolute;
            bottom: calc(var(--space-lg) * 6);
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.9) 100%);
            backdrop-filter: blur(10px);
            padding: 10px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            font-size: 0.85rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 500;
            animation: slideInFromBottom 0.5s ease-out;
        }
        
        .mobile-pin-hint i {
            color: var(--primary);
            font-size: 1rem;
        }
        
        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* モバイル対応 */
        @media (max-width: 1024px) {
            .pin-control-panel {
                top: calc(var(--space-lg) * 2);
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                justify-content: space-between;
                animation: slideInFromTop 0.3s ease-out;
            }
            
            .map-context-menu {
                min-width: 160px;
            }
            
            .context-menu-item {
                padding: var(--space-md);
            }
        }
        
        /* ユーティリティクラス */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- メインアプリ -->
    <div class="app-container">
        <!-- ヘッダー -->
        <header class="app-header">
            <div class="header-content">
                <div class="app-title">
                    <div class="title-icon">
                        <img src="nacoキャラクター.png" alt="naco" style="width: 50px; height: 50px; object-fit: contain; background: transparent;">
                    </div>
                    <span>グルテンフリーマップ</span>
                </div>
                <div class="header-actions" id="headerActions">
                    <!-- デバイス判定で動的に生成 -->
                </div>
                
                <!-- ユーザーメニュー（ドロップダウン） -->
                <div class="user-menu-dropdown" id="userMenuDropdown" style="display: none;">
                    <div class="menu-item" onclick="showUserProfile()">
                        <i class="fas fa-user"></i>
                        <span>プロフィール</span>
                    </div>
                    <div class="menu-item" onclick="showUserReviews()">
                        <i class="fas fa-star"></i>
                        <span>マイレビュー</span>
                    </div>
                    <div class="menu-item" onclick="showUserStats()">
                        <i class="fas fa-chart-bar"></i>
                        <span>統計</span>
                    </div>
                    <div class="menu-item" onclick="showAppGuide()">
                        <i class="fas fa-question-circle"></i>
                        <span>使い方ガイド</span>
                    </div>
                    <div class="menu-item" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                        <span>通知</span>
                    </div>
                    <div class="menu-divider"></div>
                    <div class="menu-item danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>ログアウト</span>
                    </div>
                </div>
            </div>
        </header>


        <!-- メインコンテンツ -->
        <div class="main-content">
            <!-- 店舗リスト（PC用サイドバー） -->
            <div class="store-sidebar pc-only">
                <div class="sidebar-header">
                    <div class="sidebar-title-row">
                        <h2 class="sidebar-title">店舗リスト</h2>
                        <span class="sidebar-count"><span id="storeCount">62</span>件</span>
                        <button class="pin-mode-btn pc-pin-btn" id="pcPinModeBtn" title="ピン設置モード">
                            <span class="pin-icon">📍</span>
                            <span class="pin-label">目的地ピン</span>
                        </button>
                    </div>
                    
                    <!-- PC用検索ボックス -->
                    <div class="sidebar-search">
                        <input type="text" id="sidebarSearchInput" class="sidebar-search-input" placeholder="店名・エリアで検索">
                    </div>
                    
                    <!-- PC用タブ -->
                    <div class="sidebar-tabs">
                        <button class="sidebar-tab active" data-tab="all">すべて</button>
                        <button class="sidebar-tab" data-tab="want-to-go">行きたい</button>
                        <button class="sidebar-tab" data-tab="visited">行った</button>
                    </div>
                    
                    <!-- PC用フィルターチップ -->
                    <div class="sidebar-filter-chips">
                        <button class="sidebar-chip active" data-category="">すべて</button>
                        <button class="sidebar-chip" data-category="カフェ">☕ カフェ</button>
                        <button class="sidebar-chip" data-category="和食">🍱 和食</button>
                        <button class="sidebar-chip" data-category="洋食">🍽️ 洋食</button>
                        <button class="sidebar-chip" data-category="パン屋">🥐 パン屋</button>
                        <button class="sidebar-chip" data-category="スイーツ">🧁 スイーツ</button>
                        <button class="sidebar-chip" data-category="販売店">🛒 販売店</button>
                    </div>
                </div>
                <div id="storeList" class="store-list">
                    <!-- 店舗リストがここに表示される -->
                </div>
            </div>
            
            <!-- マップ -->
            <div class="map-container">
                <div class="map-controls">
                    <!-- ズームコントロール -->
                    <div class="zoom-controls">
                        <button class="map-control-btn zoom-btn" id="zoomInBtn" title="拡大">+</button>
                        <button class="map-control-btn zoom-btn" id="zoomOutBtn" title="縮小">−</button>
                    </div>
                    <!-- その他のコントロール -->
                    <button class="map-control-btn" id="locateBtn" title="現在地を表示">📍</button>
                </div>
                
                <!-- モバイル専用現在地ボタン（右下角） -->
                <div class="mobile-location-control mobile-only">
                    <button class="map-control-btn" id="mobileLocateBtn" title="現在地を表示">📍</button>
                </div>
                <div id="map"></div>
                
                <!-- カスタムピン用コンテキストメニュー -->
                <div id="mapContextMenu" class="map-context-menu hidden">
                    <button class="context-menu-item" id="setPinBtn">
                        <i class="fas fa-map-pin"></i>
                        <span>ここにピンを設置</span>
                    </button>
                </div>
                
                
            </div>
        </div>
    </div>

    <!-- オーバーレイ式店舗リストパネル（モバイル用） -->
    <div id="overlayPanel" class="overlay-panel mobile-only">
        <div class="panel-handle" id="panelHandle">
            <div class="panel-title">
                <div class="panel-title-left">
                    <span id="panelStoreCount">店舗リスト 62件</span>
                    <button class="search-toggle-btn" id="searchToggleBtn" title="検索・フィルター">
                        <span class="search-icon">🔍</span>
                        <span class="filter-indicator" id="filterIndicator" style="display: none;">●</span>
                    </button>
                    <button class="pin-mode-btn" id="pinModeBtn" title="ピン設置モード">
                        <span class="pin-icon">📍</span>
                    </button>
                </div>
                <div class="panel-controls">
                    <div class="state-indicators">
                        <span class="state-dot active" id="stateDot1"></span>
                        <span class="state-dot" id="stateDot2"></span>
                        <span class="state-dot" id="stateDot3"></span>
                    </div>
                    <button class="panel-control-btn compact" id="panelDownBtn">
                        <span class="control-icon">🔽</span>
                    </button>
                    <button class="panel-control-btn compact" id="panelUpBtn">
                        <span class="control-icon">🔼</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- モバイル版検索・フィルター -->
        <div class="mobile-search-filter" id="mobileSearchFilter">
            <div class="mobile-search-box">
                <input type="text" id="mobileSearchInput" class="mobile-search-input" placeholder="店名・エリアで検索">
            </div>
            <div class="mobile-filter-chips">
                <button class="mobile-chip active" data-category="">すべて</button>
                <button class="mobile-chip" data-category="カフェ">☕ カフェ</button>
                <button class="mobile-chip" data-category="和食">🍱 和食</button>
                <button class="mobile-chip" data-category="洋食">🍽️ 洋食</button>
                <button class="mobile-chip" data-category="パン屋">🥐 パン屋</button>
                <button class="mobile-chip" data-category="スイーツ">🧁 スイーツ</button>
                <button class="mobile-chip" data-category="販売店">🛒 販売店</button>
            </div>
        </div>
        
        <div class="panel-tabs">
            <button class="panel-tab active" data-tab="all">すべて</button>
            <button class="panel-tab" data-tab="want-to-go">行きたい</button>
            <button class="panel-tab" data-tab="visited">行った</button>
        </div>
        <div class="panel-content" id="panelContent">
            <!-- 店舗リストがここに表示される -->
        </div>
    </div>

    <!-- 訪問履歴ビュー -->
    <div id="visitHistoryView" class="visit-history-view hidden">
        <div class="history-header">
            <h2 id="historyTitle">行きたいお店</h2>
            <div id="historyCount" class="history-count">0件</div>
        </div>
        <div id="historyList" class="history-list">
            <!-- 履歴リストがここに表示される -->
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="bottom-navigation">
        <button class="nav-btn active" data-tab="map">
            <i class="fas fa-map-marked-alt"></i>
            <span>マップ</span>
        </button>
        <button class="nav-btn" data-tab="want-to-go">
            <i class="fas fa-heart"></i>
            <span>行きたい</span>
        </button>
        <button class="nav-btn" data-tab="visited">
            <i class="fas fa-check-circle"></i>
            <span>行った</span>
        </button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // Supabase設定 - 正しいプロジェクト情報
        const SUPABASE_URL = 'https://hxrmsjfvgctoaxpbukvo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4cm1zamZ2Z2N0b2F4cGJ1a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MTI3NTAsImV4cCI6MjA3MDQ4ODc1MH0.tM1vDVVhYhh7OHlA1BTj071BfsIzeBG_HatijjtxwLw';
        
        // Supabaseクライアント初期化
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // カテゴリー色
        const categoryColors = {
            'カフェ': '#8B4513',
            '和食': '#FF6347',
            '洋食': '#FF4500',
            'パン屋': '#DEB887',
            'スイーツ': '#FF69B4',
            '販売店': '#4169E1',
            'その他': '#666666'
        };

        // カテゴリークラス名生成
        function getCategoryClass(category) {
            const classMap = {
                'カフェ': 'cafe',
                '和食': 'japanese',
                '洋食': 'western',
                'パン屋': 'bakery',
                'スイーツ': 'sweets',
                '販売店': 'shop',
                'その他': 'other'
            };
            return classMap[category] || 'other';
        }

        // カテゴリー別デザイン設定（高コントラスト・視認性重視）
        const categoryConfig = {
            'カフェ': { 
                icon: 'fas fa-coffee', 
                color: '#FFFFFF',
                bgColor: '#8B4513',      // 濃いブラウン
                borderColor: '#5D2F0A'   // さらに濃いブラウン
            },
            '和食': { 
                icon: 'fas fa-utensils', 
                color: '#FFFFFF',
                bgColor: '#E74C3C',      // 鮮やかな赤
                borderColor: '#C0392B'   // 濃い赤
            },
            '洋食': { 
                icon: 'fas fa-pizza-slice', 
                color: '#FFFFFF',
                bgColor: '#3498DB',      // 鮮やかなブルー
                borderColor: '#2980B9'   // 濃いブルー
            },
            'パン屋': { 
                icon: 'fas fa-bread-slice', 
                color: '#FFFFFF',
                bgColor: '#F39C12',      // 鮮やかなオレンジ
                borderColor: '#E67E22'   // 濃いオレンジ
            },
            'スイーツ': { 
                icon: 'fas fa-birthday-cake', 
                color: '#FFFFFF',
                bgColor: '#E91E63',      // 鮮やかなピンク
                borderColor: '#C2185B'   // 濃いピンク
            },
            '販売店': { 
                icon: 'fas fa-store', 
                color: '#FFFFFF',
                bgColor: '#27AE60',      // 鮮やかなグリーン
                borderColor: '#229954'   // 濃いグリーン
            },
            'その他': { 
                icon: 'fas fa-store', 
                color: '#FFFFFF',
                bgColor: '#7F8C8D',      // グレー
                borderColor: '#5D6D6E'   // 濃いグレー
            }
        };

        // 後方互換性のため
        const categoryEmojis = Object.fromEntries(
            Object.entries(categoryConfig).map(([key, value]) => [key, value.icon])
        );

        // 🚀 埋め込み店舗データ（即座表示）
        const embeddedStores = [
          {
                    "id": 6,
                    "name": "みちのり弁当（Gluten-Free Michinori Bento）",
                    "category": "和食",
                    "address": "名古屋市西区浄心１丁目４−６",
                    "latitude": 35.1938,
                    "longitude": 136.8901,
                    "phone": "052-5086-615",
                    "website": "https://gf-michinori.jp/",
                    "description": "📍グルテンフリーのお弁当専門店です。\n     テイクアウトのみでご提供しております🍱\n\n     ご注文をいただいてからお作りいたしますので、\n     事前にお電話でご予約いただくと、スムーズにお渡しできます✨",
                    "gluten_free_options": "完全GF",
                    "opening_hours": "11時00分～19時00分"
          },
          {
                    "id": 7,
                    "name": "Biople 名古屋タカシマヤゲートタワーモール店",
                    "category": "販売店",
                    "address": "名古屋市中村区名駅１丁目１−３ JRゲートタワー タカシマヤ モール B1F",
                    "latitude": 35.1722,
                    "longitude": 136.882,
                    "phone": "052-5666-112",
                    "website": "https://store.biople.jp/",
                    "description": "ナチュラル＆オーガニックのセルフケアアイテムを幅広く取り扱うセレクトショップです。\n     グルテンフリーの珍しいお菓子など取り扱っています。\n     ・ZENB BREAD\n     ・グルテンフリーお菓子",
                    "gluten_free_options": "部分GF",
                    "opening_hours": "9時00分～21時00分"
          },
          {
                    "id": 8,
                    "name": "成城石井 名古屋駅広小路口店",
                    "category": "販売店",
                    "address": "名古屋市中村区名駅１丁目１−４ 名古屋うまいもん通り 広小路口",
                    "latitude": 35.1698,
                    "longitude": 136.8835,
                    "phone": "052-5872-345",
                    "website": "https://shop.seijoishii.co.jp/seijoishii/spot/detail?code=0035",
                    "description": "新鮮な野菜・果物、厳選された輸入チーズやワイン、自家製サンドイッチ・お惣\n     菜、パン、スイーツ、オーガニック商品、調味料や冷凍食品も充実しているスーパーマーケットです。",
                    "gluten_free_options": "部分GF",
                    "opening_hours": "7時30分～22時00分"
          },
          {
                    "id": 9,
                    "name": "成城石井 名古屋 近鉄パッセ店",
                    "category": "販売店",
                    "address": "名古屋市中村区名駅１丁目２−２ 近鉄パッセ B1F",
                    "latitude": 35.1695,
                    "longitude": 136.8842,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "部分GF",
                    "opening_hours": ""
          },
          {
                    "id": 10,
                    "name": "ダモンデ ミールシフォン＆スイーツ",
                    "category": "スイーツ",
                    "address": "名古屋市中区錦２丁目１１−２７ ＴＨ錦ビル 1F",
                    "latitude": 35.1711,
                    "longitude": 136.9001,
                    "phone": "052-2119-333",
                    "website": "https://da-monde.co.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-18:00"
          },
          {
                    "id": 11,
                    "name": "ライラック",
                    "category": "スイーツ",
                    "address": "名古屋市千種区東山通１丁目１５−２",
                    "latitude": 35.164,
                    "longitude": 136.9651,
                    "phone": "052-8877-818",
                    "website": "http://lilacs.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-19:00"
          },
          {
                    "id": 12,
                    "name": "エンキッチンカフェ",
                    "category": "洋食",
                    "address": "名古屋市中区大井町３−３１",
                    "latitude": 35.1507,
                    "longitude": 136.9053,
                    "phone": "052-8981-015",
                    "website": "http://en-kitchen.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:30-19:00"
          },
          {
                    "id": 13,
                    "name": "スギヤマ調剤薬局 御器所店",
                    "category": "販売店",
                    "address": "名古屋市昭和区阿由知通４丁目７",
                    "latitude": 35.149,
                    "longitude": 136.934,
                    "phone": "052-8422-112",
                    "website": "https://sugiyama-club.jp/shop/detail.asp?Seq=165",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "9:00-19:00,土曜のみ9:00-16:00"
          },
          {
                    "id": 14,
                    "name": "旬楽膳 名古屋・地アミ店",
                    "category": "販売店",
                    "address": "名古屋市名東区若葉台１４０２",
                    "latitude": 35.1787,
                    "longitude": 136.994,
                    "phone": "052-7603-071",
                    "website": "http://www.shun-rakuzen.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-20:00"
          },
          {
                    "id": 15,
                    "name": "コルポ",
                    "category": "洋食",
                    "address": "名古屋市中川区荒子１丁目１１６",
                    "latitude": 35.1416,
                    "longitude": 136.8603,
                    "phone": "052-3628-686",
                    "website": "https://cafe-corpo.owst.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-18:00"
          },
          {
                    "id": 16,
                    "name": "カルディコーヒーファーム 名古屋ゲートウォーク店",
                    "category": "販売店",
                    "address": "名古屋市中村区名駅１丁目１−２ ゲートウォーク B1F",
                    "latitude": 35.1743,
                    "longitude": 136.8836,
                    "phone": "052-5898-552",
                    "website": "https://www.kaldi.co.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-22:00"
          },
          {
                    "id": 17,
                    "name": "グルテンフリー 菓子屋 藤ノ宮",
                    "category": "販売店",
                    "address": "名古屋市中村区千原町４−５０",
                    "latitude": 35.1812,
                    "longitude": 136.8732,
                    "phone": "052-4517-584",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-19:00"
          },
          {
                    "id": 18,
                    "name": "グルテンフリー＆米粉ベーグル屋 はるのはな",
                    "category": "パン屋",
                    "address": "名古屋市千種区萱場２丁目１３−２２",
                    "latitude": 35.1824,
                    "longitude": 136.9452,
                    "phone": "",
                    "website": "https://haruno-hana.com/shop/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-15:00"
          },
          {
                    "id": 19,
                    "name": "I 'm donut？（アイムドーナツ？）グルテンフリー",
                    "category": "スイーツ",
                    "address": "東京都渋谷区神宮前５丁目５３−４",
                    "latitude": 35.6611,
                    "longitude": 139.7077,
                    "phone": "",
                    "website": "",
                    "description": "本物ドーナツそっくりのふわふわさでとてもよかったです！注文票に使用されてるアレルゲンが記載されてるの素敵だなと思います。",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-19:00"
          },
          {
                    "id": 20,
                    "name": "SO TARTE 代々木上原店",
                    "category": "カフェ",
                    "address": "東京都渋谷区上原１丁目１８−７ 第五大貴ビル",
                    "latitude": 35.6685,
                    "longitude": 139.6801,
                    "phone": "036-4079-260",
                    "website": "https://sotarte.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-18:00"
          },
          {
                    "id": 21,
                    "name": "EWALU -お米農家が営む完全グルテンフリー専門店-",
                    "category": "パン屋",
                    "address": "愛知県弥富市鯏浦町車東23−２",
                    "phone": "056-7973-200",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "8:00-17:00"
          },
          {
                    "id": 22,
                    "name": "pâtisserie Éclat de",
                    "category": "スイーツ",
                    "address": "兵庫県西宮市上甲子園１丁目３−１０",
                    "latitude": 34.7334,
                    "longitude": 135.3701,
                    "phone": "090-4190-1118",
                    "website": "https://eclat-de-sourire.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": ""
          },
          {
                    "id": 23,
                    "name": "グルテンフリーの⽶粉スイーツ専⾨店 HB Style KIYOKEN",
                    "category": "スイーツ",
                    "address": "神奈川県横浜市西区南幸１丁目１−１ CIAL横浜 B1",
                    "latitude": 35.4662,
                    "longitude": 139.6193,
                    "phone": "045-6208-600",
                    "website": "https://hb-style-kiyoken.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-21:00"
          },
          {
                    "id": 24,
                    "name": "米m BEIEMU 米粉スイーツ&おにぎり（グルテンフリー ）",
                    "category": "スイーツ",
                    "address": "沖縄県読谷村喜名２３４６−１１",
                    "latitude": 26.3929,
                    "longitude": 127.7436,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": ""
          },
          {
                    "id": 25,
                    "name": "F&F 自然食品のお店",
                    "category": "販売店",
                    "address": "東京都千代田区麹町４丁目１−３",
                    "latitude": 35.6837,
                    "longitude": 139.735,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": ""
          },
          {
                    "id": 26,
                    "name": "ペドラブランカ 戸越銀座店",
                    "category": "スイーツ",
                    "address": "東京都品川区平塚２丁目１４−８ 1F",
                    "latitude": 35.6213,
                    "longitude": 139.7151,
                    "phone": "",
                    "website": "https://pedrabranca-cafe.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-20:00"
          },
          {
                    "id": 27,
                    "name": "出町ふたば",
                    "category": "スイーツ",
                    "address": "京都府京都市上京区青龍町２３６",
                    "phone": "075-2311-658",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "8:30-17:30"
          },
          {
                    "id": 28,
                    "name": "SOT COFFEE ROASTER Kyoto",
                    "category": "カフェ",
                    "address": "京都府京都市東山区本町新５丁目１４８−２",
                    "latitude": 34.9917,
                    "longitude": 135.7669,
                    "phone": "080-0808-8288",
                    "website": "https://www.sotcoffee.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "8:00-18:00"
          },
          {
                    "id": 29,
                    "name": "NAYAMACHI DONUTS 君に、あげる",
                    "category": "カフェ",
                    "address": "京都府京都市伏見区中油掛町１０６−７",
                    "latitude": 34.9315,
                    "longitude": 135.7575,
                    "phone": "075-6061-134",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-19:00"
          },
          {
                    "id": 30,
                    "name": "宮古冷麺",
                    "category": "和食",
                    "address": "沖縄県宮古島市平良下里３３８−８",
                    "latitude": 24.8031,
                    "longitude": 125.2697,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-15:00"
          },
          {
                    "id": 31,
                    "name": "OLU OLU Crep",
                    "category": "スイーツ",
                    "address": "神奈川県相模原市中央区横山４丁目２３−２０ メゾン村山",
                    "latitude": 35.5662,
                    "longitude": 139.3561,
                    "phone": "042-7070-707",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-18:00"
          },
          {
                    "id": 32,
                    "name": "BEYOND SWEETS （ビヨンドスイーツ）カフェ 表参道店",
                    "category": "スイーツ",
                    "address": "東京都港区南青山３丁目１３−９",
                    "phone": "036-4340-936",
                    "website": "https://beyondsweets-shop-cafe.com/",
                    "description": "",
                    "gluten_free_options": "対応可能",
                    "opening_hours": "10:00-19:00"
          },
          {
                    "id": 33,
                    "name": "Creperiz Stand.Nagoya",
                    "category": "スイーツ",
                    "address": "名古屋市中区大須３丁目３０−２５ 合点承知ビル １階",
                    "latitude": 35.1602,
                    "longitude": 136.9084,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-20:00"
          },
          {
                    "id": 34,
                    "name": "みちのり亭",
                    "category": "和食",
                    "address": "名古屋市中村区椿町８−７−２F",
                    "latitude": 35.1695,
                    "longitude": 136.879,
                    "phone": "",
                    "website": "https://gf-michinori.jp/pages/michinori-tei",
                    "description": "グルテンフリーの定食屋",
                    "gluten_free_options": "完全GF",
                    "opening_hours": "11:00-15:00(LO14:00)  18:00-22:00(LO21::00"
          },
          {
                    "id": 35,
                    "name": "2525sweets",
                    "category": "スイーツ",
                    "address": "愛知県名古屋市中区新栄３丁目３−１ 太陽ビル １F",
                    "latitude": 35.1695,
                    "longitude": 136.9235,
                    "phone": "090-9250-3725",
                    "website": "https://2525sweets.base.shop/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "火水木11:00-17:30,金土11:00-18:00"
          },
          {
                    "id": 36,
                    "name": "甲賀米粉たい焼き 勝川店",
                    "category": "スイーツ",
                    "address": "愛知県春日井市松新町４丁目8−１",
                    "latitude": 35.231,
                    "longitude": 136.9568,
                    "phone": "090-4426-0940",
                    "website": "https://komeko.club/archives/shoplists/970",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-19:00"
          },
          {
                    "id": 37,
                    "name": "定食 笑いーと",
                    "category": "和食",
                    "address": "福島県いわき市好間町北好間南町田５５−１",
                    "latitude": 37.0766,
                    "longitude": 140.8651,
                    "phone": "070-8308-6994",
                    "website": "https://wara-eat.com/business/teishoku-wara-eat/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "6:00-15:00"
          },
          {
                    "id": 38,
                    "name": "titbit!(ティットビット)",
                    "category": "スイーツ",
                    "address": "名古屋市西区那古野１丁目１０−１７",
                    "latitude": 35.1771,
                    "longitude": 136.8887,
                    "phone": "052-5268-133",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-18:00"
          },
          {
                    "id": 39,
                    "name": "米粉の焼菓子 a\" (エーダブルプライム)",
                    "category": "スイーツ",
                    "address": "名古屋市昭和区北山本町２丁目１８",
                    "latitude": 35.1523,
                    "longitude": 136.9246,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-17:00"
          },
          {
                    "id": 40,
                    "name": "グルテンフリー食堂 おみやはん",
                    "category": "和食",
                    "address": "名古屋市守山区小幡太田３−３２",
                    "latitude": 35.1941,
                    "longitude": 136.9758,
                    "phone": "080-3548-5679",
                    "website": "https://www.omiyahan.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": ""
          },
          {
                    "id": 41,
                    "name": "genuine gluten free Where is a dog?",
                    "category": "カフェ",
                    "address": "東京都武蔵野市吉祥寺本町２丁目２４−９ SUNO Ecru 103",
                    "latitude": 35.7039,
                    "longitude": 139.5724,
                    "phone": "042-2272-812",
                    "website": "",
                    "description": "元々パンが大好きだったのでこうしてパンが食べられることができるのがとても幸せでした。",
                    "gluten_free_options": "",
                    "opening_hours": "月〜金　\t 12時00分～15時00分 17時00分～20時00分／土日\t 12時00分～20時00分"
          },
          {
                    "id": 42,
                    "name": "米ぱんの店ぱんて",
                    "category": "パン屋",
                    "address": "福井県福井市文京３丁目９−３４",
                    "latitude": 36.0766846,
                    "longitude": 136.2076805,
                    "phone": "776636781",
                    "website": "http://www.pante.jp/?mode=pc",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-19:00"
          },
          {
                    "id": 43,
                    "name": "グルテンフリーラーメン専門店 RYU-Gu 龍旗信",
                    "category": "和食",
                    "address": "大阪府堺市西区浜寺石津町西２丁７−６ ａｕ石津川",
                    "latitude": 34.562,
                    "longitude": 135.4503,
                    "phone": "",
                    "website": "http://www.ryukishin.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-14:30,17:30-20:45"
          },
          {
                    "id": 44,
                    "name": "月夜野こまもの店",
                    "category": "カフェ",
                    "address": "長野県上伊那郡辰野町辰野１６１５−３",
                    "latitude": 35.9826,
                    "longitude": 137.9938,
                    "phone": "070-7564-0768",
                    "website": "https://tsukikoma-tatsuno.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "日11:00-22:00,金11:00-18:00"
          },
          {
                    "id": 45,
                    "name": "縁-enishi-",
                    "category": "パン屋",
                    "address": "長野県長野市若里２丁目１−２３",
                    "latitude": 36.6342,
                    "longitude": 138.1864,
                    "phone": "026-4666-610",
                    "website": "https://enishi-sorghum.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "9:00-16:00"
          },
          {
                    "id": 46,
                    "name": "Buddha グルテンフリー & ヴィーガン専門店",
                    "category": "カフェ",
                    "address": "大阪府大阪市東成区中道１丁目８−１５ 金井ビル",
                    "latitude": 34.6778,
                    "longitude": 135.5337,
                    "phone": "066-7537-797",
                    "website": "https://buddha-online.site/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:30-15:30"
          },
          {
                    "id": 47,
                    "name": "where is my chou? 田町タワー店",
                    "category": "スイーツ",
                    "address": "東京都港区芝５丁目３３−１１ 田町タワ １－Ｆ",
                    "latitude": 35.6469,
                    "longitude": 139.7464,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "月〜金11:00-19:00/土日11:00-18:00"
          },
          {
                    "id": 48,
                    "name": "米粉ヘルシーカフェ セレンペッシュ 心斎橋店",
                    "category": "カフェ",
                    "address": "大阪府大阪市中央区南船場２丁目４−２０ 大阪福谷ビル 1階",
                    "latitude": 34.6758,
                    "longitude": 135.5031,
                    "phone": "070-2424-3975",
                    "website": "https://seren-peche.owst.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "7:30-21:30"
          },
          {
                    "id": 49,
                    "name": "薬膳スパイスカレー＆グルテンフリーバルSpys Oasis",
                    "category": "洋食",
                    "address": "大阪府大阪市中央区難波１丁目５−８",
                    "latitude": 34.6675,
                    "longitude": 135.4993,
                    "phone": "066-2115-115",
                    "website": "http://spys-oasis.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "日11:30-22:00,月火水金土11:30-15:00,18:00-0:00"
          },
          {
                    "id": 50,
                    "name": "おやつ 創房優",
                    "category": "スイーツ",
                    "address": "岐阜県多治見市本町５丁目9−１ 陶都創造館 １階",
                    "latitude": 35.3347,
                    "longitude": 137.1284,
                    "phone": "",
                    "website": "https://www.soboyu-design.page/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-15:00"
          },
          {
                    "id": 51,
                    "name": "やまの ひつじ",
                    "category": "カフェ",
                    "address": "東京都渋谷区恵比寿西１丁目２６−２",
                    "latitude": 35.6478,
                    "longitude": 139.7032,
                    "phone": "080-4710-8870",
                    "website": "http://hitsuzi.chagasi.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:30-15:00"
          },
          {
                    "id": 52,
                    "name": "もんじゃ宝島",
                    "category": "和食",
                    "address": "東京都中央区月島３丁目５−４",
                    "latitude": 35.6633,
                    "longitude": 139.7784,
                    "phone": "033-5335-700",
                    "website": "https://rakukatsu.jp/tsukishima-monjya-takarajima-20210101/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "水木金17:00-22:30/ 土日12:00-16:00,17:00-22:00"
          },
          {
                    "id": 53,
                    "name": "MOCMO sandwiches (Gluten free sandwiches）",
                    "category": "パン屋",
                    "address": "東京都三鷹市下連雀１丁目１７−４ GRATO井の頭公園 1F",
                    "latitude": 35.7232,
                    "longitude": 139.5873,
                    "phone": "036-8208-795",
                    "website": "https://phoenix-since2018.com/food/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "月〜金11:00-17:00/土日9:00-17:00"
          },
          {
                    "id": 54,
                    "name": "ソラノイロ ARTISAN NOODLES",
                    "category": "和食",
                    "address": "東京都千代田区平河町１丁目３−１０ ブルービル本館 1B",
                    "latitude": 35.6831,
                    "longitude": 139.7369,
                    "phone": "033-2635-460",
                    "website": "http://soranoiro-vege.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-15:00,17:00-21:30"
          },
          {
                    "id": 55,
                    "name": "202カリー堂",
                    "category": "洋食",
                    "address": "東京都世田谷区代田５丁目３４−２１ 202",
                    "latitude": 35.6614,
                    "longitude": 139.6631,
                    "phone": "036-4138-857",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "9:00-20:00"
          },
          {
                    "id": 56,
                    "name": "TORIBA COFFEE TOKYO",
                    "category": "カフェ",
                    "address": "東京都中央区八重洲２丁目１−１ YANMAR TOKYO B1F",
                    "latitude": 35.6798,
                    "longitude": 139.7645,
                    "phone": "080-3715-4434",
                    "website": "http://www.toriba-coffee.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "月〜金10:00-19:00/ 土日10:00-20:00"
          },
          {
                    "id": 57,
                    "name": "premium SOW",
                    "category": "洋食",
                    "address": "東京都渋谷区代官山町１２−１６ シンフォニー代官山 103",
                    "latitude": 35.6507,
                    "longitude": 139.701,
                    "phone": "035-4223-390",
                    "website": "http://premium-sow.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-18:00"
          },
          {
                    "id": 58,
                    "name": "RISO GRAN",
                    "category": "パン屋",
                    "address": "大阪府大阪市此花区春日出中２丁目１４−２３ マンション住田 1F",
                    "latitude": 34.6799,
                    "longitude": 135.4473,
                    "phone": "070-2215-7547",
                    "website": "https://risogran.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-14:00"
          },
          {
                    "id": 59,
                    "name": "田田田堂",
                    "category": "スイーツ",
                    "address": "兵庫県神戸市東灘区御影郡家１丁目２３−１２",
                    "latitude": 34.7215,
                    "longitude": 135.251,
                    "phone": "078-8553-358",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-18:00"
          },
          {
                    "id": 60,
                    "name": "阿闍梨餅本舗満月 本店",
                    "category": "スイーツ",
                    "address": "京都府京都市左京区田中大堰町１３９",
                    "latitude": 35.0301,
                    "longitude": 135.7755,
                    "phone": "075-7914-121",
                    "website": "http://www.ajyarimochi.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "9:00-18:00"
          },
          {
                    "id": 61,
                    "name": "京都炎神",
                    "category": "和食",
                    "address": "京都府京都市中京区中之町５８０−２",
                    "latitude": 35.0045,
                    "longitude": 135.7649,
                    "phone": "075-6064-234",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "12:00-22:30"
          },
          {
                    "id": 62,
                    "name": "和レ和レ和アラシヤマ",
                    "category": "和食",
                    "address": "京都府京都市右京区嵯峨天龍寺芒ノ馬場町３−１４",
                    "latitude": 35.0142,
                    "longitude": 135.6745,
                    "phone": "075-3349-065",
                    "website": "https://www.bread-espresso.jp/shop/warewarewa_arashiyama.html",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "8:00-18:00"
          },
          {
                    "id": 63,
                    "name": "エスパルスドリームプラザ",
                    "category": "販売店",
                    "address": "静岡県静岡市清水区入船町１３−１５",
                    "latitude": 35.0106,
                    "longitude": 138.4902,
                    "phone": "054-3543-360",
                    "website": "https://www.dream-plaza.co.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-20:00"
          },
          {
                    "id": 64,
                    "name": "グルテンフリースイーツ専門店 NachuRa Yoyogi park",
                    "category": "スイーツ",
                    "address": "東京都渋谷区富ケ谷１丁目１７−７ 第二山栄ビル １階",
                    "latitude": 35.6664,
                    "longitude": 139.6893,
                    "phone": "070-4680-4217",
                    "website": "https://nachura.shop/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "8:00-17:00"
          },
          {
                    "id": 65,
                    "name": "Linda Lindo SWEETS",
                    "category": "スイーツ",
                    "address": "岐阜県本巣郡北方町曲路３丁目３９",
                    "latitude": 35.4311,
                    "longitude": 136.6934,
                    "phone": "058-2606-377",
                    "website": "https://lindalindo.shop/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-18:00"
          },
          {
                    "id": 66,
                    "name": "cadeau",
                    "category": "スイーツ",
                    "address": "三重県津市八町２丁目１５−１",
                    "latitude": 34.7204,
                    "longitude": 136.4946,
                    "phone": "059-2021-402",
                    "website": "https://malalatete.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:30-16:30"
          },
          {
                    "id": 67,
                    "name": "お米のいいなり",
                    "category": "和食",
                    "address": "和歌山県和歌山市小松原５丁目６−７",
                    "latitude": 34.2332,
                    "longitude": 135.1892,
                    "phone": "073-4228-228",
                    "website": "https://komeno-e-nari.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:30-15:00,18:00-22:00"
          }
];

        // グローバル変数
        let map;
        let stores = [];
        let markers = [];
        
        // カスタムピン機能用変数
        let customPinMarker = null;
        let customPinLocation = null;
        let mapContextMenu = null;

        // DOM読み込み完了後に即座に初期化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('⚡ 埋め込みデータ版 - 高速起動');
            await initializeApp();
        });

        // アプリ初期化（認証ガード付き）
        async function initializeApp() {
            try {
                console.log('🚀 アプリ初期化開始（認証チェック）');
                
                // 1. 認証状態を確認
                const isAuthenticated = await checkAuthenticationStatus();
                
                if (!isAuthenticated) {
                    console.log('🔒 未認証ユーザー - ログイン画面にリダイレクト');
                    showLoginScreen();
                    return;
                }
                
                console.log('✅ 認証済みユーザー - マップ画面を表示');
                showMapScreen();
                
                // 1.5. プロフィール情報を読み込み（重要: ヘッダー初期化前に実行）
                try {
                    await loadUserProfile();
                    console.log('📱 初期プロフィール情報読み込み完了');
                } catch (profileError) {
                    console.error('⚠️ プロフィール読み込みエラー（続行）:', profileError);
                    // プロフィール読み込み失敗でも処理は続行
                }
                
                // 2. 即座に店舗データを表示
                try {
                    loadEmbeddedStores();
                } catch (storeError) {
                    console.error('⚠️ 店舗データ読み込みエラー:', storeError);
                }
                
                // 3. 地図を初期化
                try {
                    initMap();
                } catch (mapError) {
                    console.error('⚠️ 地図初期化エラー:', mapError);
                }
                
                // 4. イベントリスナー設定
                try {
                    setupEventListeners();
                } catch (eventError) {
                    console.error('⚠️ イベントリスナー設定エラー:', eventError);
                }
                
                // 5. データベース状態確認
                try {
                    checkDatabaseStatus();
                } catch (dbError) {
                    console.error('⚠️ データベース状態確認エラー:', dbError);
                }
                
                // 6. ヘッダーアクションの初期化
                try {
                    initializeHeaderActions();
                } catch (headerError) {
                    console.error('⚠️ ヘッダー初期化エラー:', headerError);
                }
                
                console.log('✅ アプリ初期化完了 - 全機能利用可能');
                
            } catch (error) {
                console.error('❌ アプリ初期化で重大なエラー:', error);
                alert('アプリの初期化に失敗しました。ページを再読み込みしてください。');
            }
        }

        // 認証状態チェック
        async function checkAuthenticationStatus() {
            try {
                console.log('🔍 認証状態をチェック中...');
                
                // Supabaseセッションチェック
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (session && session.user) {
                    currentUser = session.user.email;
                    console.log('✅ 有効なセッション:', currentUser);
                    return true;
                }
                
                // フォールバック: ユーザー情報チェック
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (user && !userError) {
                    currentUser = user.email;
                    console.log('✅ 有効なユーザー:', currentUser);
                    return true;
                }
                
                console.log('❌ 認証セッションなし');
                return false;
                
            } catch (error) {
                console.error('❌ 認証チェックエラー:', error);
                return false;
            }
        }

        // ログイン画面を表示
        function showLoginScreen() {
            document.body.innerHTML = `
                <div class="login-container">
                    <div class="login-card">
                        <div class="login-header">
                            <img src="nacoキャラクター.png" alt="naco" class="login-logo">
                            <h1>グルテンフリーマップ</h1>
                            <p>ビヨフリ倶楽部</p>
                        </div>
                        <div class="login-content">
                            <h2>ログインが必要です</h2>
                            <p>このサイトは会員限定です。<br>Googleアカウントでログインしてください。</p>
                            <button id="loginBtn" class="google-login-btn" onclick="performGoogleLogin()">
                                <i class="fab fa-google"></i>
                                Googleでログイン
                            </button>
                        </div>
                    </div>
                </div>
                <style>
                    .login-container {
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: var(--gradient-bg);
                        padding: var(--space-lg);
                    }
                    .login-card {
                        background: var(--bg-glass);
                        backdrop-filter: blur(20px);
                        border-radius: var(--radius-2xl);
                        padding: var(--space-2xl);
                        box-shadow: var(--shadow-xl);
                        text-align: center;
                        max-width: 400px;
                        width: 100%;
                    }
                    .login-logo {
                        width: 80px;
                        height: 80px;
                        object-fit: contain;
                        margin-bottom: var(--space-md);
                    }
                    .login-header h1 {
                        color: var(--primary);
                        font-size: 1.8rem;
                        margin-bottom: var(--space-xs);
                        white-space: nowrap;
                    }
                    
                    /* スマホでタイトルを1行に表示 */
                    @media (max-width: 480px) {
                        .login-header h1 {
                            font-size: 1.4rem;
                        }
                    }
                    .login-header p {
                        color: var(--text-secondary);
                        font-size: 1rem;
                        margin-bottom: var(--space-xl);
                    }
                    .login-content h2 {
                        color: var(--text-primary);
                        font-size: 1.3rem;
                        margin-bottom: var(--space-md);
                    }
                    .login-content p {
                        color: var(--text-secondary);
                        margin-bottom: var(--space-xl);
                        line-height: 1.6;
                    }
                    .google-login-btn {
                        background: #4285f4;
                        color: white;
                        border: none;
                        padding: var(--space-md) var(--space-xl);
                        border-radius: var(--radius-lg);
                        font-size: 1rem;
                        font-weight: 500;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: var(--space-sm);
                        width: 100%;
                        transition: all 0.2s ease;
                    }
                    .google-login-btn:hover {
                        background: #3367d6;
                        transform: translateY(-1px);
                        box-shadow: var(--shadow-lg);
                    }
                </style>
            `;
        }

        // マップ画面を表示
        function showMapScreen() {
            // 既存のマップ画面は既に表示されているので、何もしない
            console.log('📍 マップ画面を表示');
        }

        // Google認証実行
        async function performGoogleLogin() {
            try {
                console.log('🔐 Google認証を開始...');
                
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://bettger3000.github.io/naco-gluten-free-map/'
                    }
                });
                
                if (error) {
                    console.error('❌ Google認証エラー:', error);
                    alert('認証に失敗しました。しばらく時間をおいて再度お試しください。');
                } else {
                    console.log('✅ Google認証リクエスト送信成功');
                }
            } catch (error) {
                console.error('❌ 認証処理エラー:', error);
                alert('認証に失敗しました。しばらく時間をおいて再度お試しください。');
            }
        }

        // データベース状態確認（簡略版）
        async function checkDatabaseStatus() {
            try {
                // 基本接続確認のみ
                const { data, error } = await supabaseClient
                    .from('visit_history')
                    .select('count', { count: 'exact' })
                    .limit(1);
                
                if (error) {
                    console.warn('⚠️ データベース接続確認エラー:', error);
                } else {
                    console.log('✅ データベース接続正常');
                }
            } catch (error) {
                console.warn('⚠️ データベース確認エラー:', error);
            }
        }

        // 埋め込み店舗データ読み込み（即座）
        function loadEmbeddedStores() {
            console.log('📦 埋め込みデータ読み込み開始');
            
            stores = embeddedStores;
            
            displayStores(stores);
            
            // デバイス別UI更新
            if (isDesktop()) {
                // PC用サイドバーに表示
                displayStoreList(stores);
            } else {
                // モバイル用オーバーレイパネルに初期表示
                updatePanelContent('all');
            }
            
            console.log(`✅ ${stores.length}店舗のデータを即座に表示完了`);
        }

        // マップ初期化
        function initMap() {
            try {
                console.log('🗺️ 地図初期化開始');
                
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    console.error('マップ要素が見つかりません');
                    return;
                }

                // デフォルト位置（日本全体）
                const defaultCenter = [35.6762, 139.6503];
                const defaultZoom = 6;

                map = L.map('map', {
                    center: defaultCenter,
                    zoom: defaultZoom,
                    zoomControl: false, // 一旦無効にして後で追加
                    scrollWheelZoom: true
                });

                // 現在地を取得して地図の中心に設定
                getCurrentLocationAndCenter();
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(map);


                // マップ準備完了時に店舗マーカーを表示
                map.whenReady(() => {
                    console.log('🗺️ 地図準備完了 - マーカー表示');
                    displayStores(stores);
                    
                    // カスタムピン機能を初期化
                    initCustomPinFeature();
                });

                console.log('✅ 地図初期化完了');
            } catch (error) {
                console.error('地図初期化エラー:', error);
            }
        }

        // マップに店舗表示
        function displayStores(storesData) {
            if (!map) {
                console.log('⏳ 地図準備中のため、マーカー表示を待機');
                return;
            }

            // 既存マーカー削除
            markers.forEach(marker => {
                try {
                    map.removeLayer(marker);
                } catch (e) {
                    console.warn('マーカー削除エラー:', e);
                }
            });
            markers = [];

            storesData.forEach(store => {
                if (!store.latitude || !store.longitude) {
                    console.warn(`店舗「${store.name}」の座標が無効です`);
                    return;
                }

                try {
                    const config = categoryConfig[store.category] || categoryConfig['その他'];

                    const marker = L.marker([store.latitude, store.longitude], {
                        icon: L.divIcon({
                            className: 'elegant-marker',
                            html: `
                                <div class="marker-container">
                                    <div class="marker-icon" style="
                                        background: ${config.bgColor};
                                        border: 3px solid ${config.borderColor};
                                        color: ${config.color};
                                        width: 40px;
                                        height: 40px;
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 18px;
                                        font-weight: bold;
                                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                        transition: transform 0.2s ease;
                                    "><i class="${config.icon}"></i></div>
                                    <div class="marker-pin" style="
                                        width: 0;
                                        height: 0;
                                        border-left: 6px solid transparent;
                                        border-right: 6px solid transparent;
                                        border-top: 8px solid ${config.borderColor};
                                        margin-left: 14px;
                                        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
                                    "></div>
                                </div>
                            `,
                            iconSize: [40, 48],
                            iconAnchor: [20, 48],
                            popupAnchor: [0, -48]
                        })
                    }).addTo(map);

                    const popupContent = createPopupContent(store);
                    marker.bindPopup(popupContent, {
                        offset: [0, -10], // ポップアップを中央に配置、上に10pxずらす
                        className: 'custom-popup'
                    });

                    marker.on('click', function() {
                        selectStoreCard(store.id);
                        // ポップアップが開いた後にボタン状態を更新
                        setTimeout(() => {
                            updatePopupButtons(store.id);
                        }, 100); // 少し遅延させてポップアップのDOM生成を待つ
                    });

                    // マーカーにstoreIdを保存
                    marker.storeId = store.id;
                    markers.push(marker);
                } catch (error) {
                    console.error(`店舗「${store.name}」のマーカー作成エラー:`, error);
                }
            });

            console.log(`📍 ${markers.length}個のマーカーを地図に表示`);
        }

        // 現在地を取得して地図の中心に設定
        function getCurrentLocationAndCenter() {
            console.log('📍 現在地取得を試行中...');

            if (!navigator.geolocation) {
                console.log('❌ Geolocation API がサポートされていません');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5分間キャッシュ
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    console.log(`✅ 現在地取得成功: ${lat.toFixed(6)}, ${lng.toFixed(6)} (精度: ${Math.round(accuracy)}m)`);

                    // 現在地情報を保存
                    currentUserLocation = { lat: lat, lng: lng };

                    // 地図の中心を現在地に移動（徒歩圏内の店舗が見えるレベルに拡大）
                    if (map) {
                        map.setView([lat, lng], 14);

                        // 現在地マーカーを追加（位置問題解決版）
                        console.log(`📍 現在地座標: lat=${lat}, lng=${lng}`);
                        
                        // 通常のLeafletマーカーアイコンを使用（確実に正しい位置に表示）
                        const currentLocationIcon = L.icon({
                            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30">
                                    <circle cx="15" cy="15" r="12" fill="#007AFF" stroke="white" stroke-width="3" opacity="0.9"/>
                                    <circle cx="15" cy="15" r="6" fill="#007AFF" stroke="white" stroke-width="2"/>
                                </svg>
                            `),
                            iconSize: [30, 30],
                            iconAnchor: [15, 15],
                            popupAnchor: [0, -15]
                        });

                        const locationMarker = L.marker([lat, lng], { 
                            icon: currentLocationIcon,
                            zIndexOffset: 1000 
                        });
                        
                        locationMarker.addTo(map);
                        // ポップアップなしでアイコンのみ表示（よりスタイリッシュ）
                        
                        console.log('✅ 現在地マーカー追加完了');

                        // 店舗リストを現在地から近い順で再表示
                        if (stores && stores.length > 0) {
                            displayStoreList(stores);
                            console.log('🔄 店舗リストを現在地順で更新完了');
                        }
                    }
                },
                function(error) {
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '位置情報の取得が拒否されました';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '位置情報が取得できませんでした';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '位置情報の取得がタイムアウトしました';
                            break;
                        default:
                            errorMessage = '不明なエラーが発生しました';
                            break;
                    }
                    console.log(`ℹ️ 現在地取得失敗: ${errorMessage}（デフォルト位置で表示）`);
                },
                options
            );
        }

        // 現在地情報を保存する変数
        let currentUserLocation = null;

        // 2点間の距離計算（Haversine公式）
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球の半径（km）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // 距離（km）
        }

        // 店舗リスト表示（現在地から近い順）
        function displayStoreList(storesData) {
            const container = document.getElementById('storeList');
            if (!container) return;
            
            container.innerHTML = '';

            if (storesData.length === 0) {
                container.innerHTML = '<div class="loading-indicator">表示する店舗がありません</div>';
                return;
            }

            // 現在地から近い順にソート
            let sortedStores = [...storesData];
            if (currentUserLocation) {
                sortedStores = sortedStores.sort((a, b) => {
                    if (!a.latitude || !a.longitude || !b.latitude || !b.longitude) return 0;
                    const distanceA = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, a.latitude, a.longitude);
                    const distanceB = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, b.latitude, b.longitude);
                    return distanceA - distanceB;
                });
                console.log('📍 現在地から近い順でソート完了');
            }

            sortedStores.forEach(store => {
                try {
                    const card = createMobileStoreCard(store);
                    container.appendChild(card);
                } catch (error) {
                    console.error(`店舗「${store.name}」のカード作成エラー:`, error);
                }
            });
        }

        // モバイル用店舗カード作成
        function createMobileStoreCard(store) {
            const card = document.createElement('div');
            card.className = 'store-card';
            card.dataset.storeId = store.id;

            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            const storeHours = store.opening_hours ? escapeHtml(store.opening_hours) : '';

            // 現在地からの距離を計算
            let distanceText = '';
            if (currentUserLocation && store.latitude && store.longitude) {
                const distance = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, store.latitude, store.longitude);
                if (distance < 1) {
                    distanceText = `${Math.round(distance * 1000)}m`;
                } else {
                    distanceText = `${distance.toFixed(1)}km`;
                }
            }
            
            // カテゴリ設定を取得
            const config = getCategoryConfig(store.category);

            // 訪問ステータスをチェック
            const visitStatus = userVisitHistory.get(`${store.id}`);
            const isWantToGo = visitStatus === 'want_to_go';
            const isVisited = visitStatus === 'visited';

            card.innerHTML = `
                <div class="store-header">
                    <h3 class="store-name">${storeName}</h3>
                    <div class="store-header-right">
                        <span class="store-category" data-category="${storeCategory}">${config.icon} ${storeCategory}</span>
                        ${distanceText ? `<span class="store-distance">📍 ${distanceText}</span>` : ''}
                    </div>
                </div>
                <div class="store-info">
                    <div class="store-address">
                        <span class="popup-icon">📍</span>
                        <span>${storeAddress}</span>
                    </div>
                    ${storeGfOptions ? `
                        <div class="store-gf-type">
                            <span>✨</span>
                            <span>${storeGfOptions}</span>
                        </div>
                    ` : ''}
                    ${storeHours ? `
                        <div class="store-hours">
                            <span class="popup-icon">🕒</span>
                            <span>${storeHours}</span>
                        </div>
                    ` : ''}
                </div>
                <div class="store-card-actions">
                    <button class="action-btn want-to-go ${isWantToGo ? 'active' : ''}" 
                            onclick="event.stopPropagation(); toggleVisitStatus(${store.id}, 'want_to_go')">
                        🤍 行きたい
                    </button>
                    <button class="action-btn visited ${isVisited ? 'active' : ''}" 
                            onclick="event.stopPropagation(); toggleVisitStatus(${store.id}, 'visited')">
                        ✨ 行った
                    </button>
                    <button class="action-btn detail" onclick="event.stopPropagation(); openStoreDetail(${store.id})">
                        📋 詳細
                    </button>
                </div>
            `;

            card.addEventListener('click', function() {
                if (store.latitude && store.longitude && map) {
                    map.setView([store.latitude, store.longitude], 15);
                    const marker = markers.find(m => 
                        Math.abs(m.getLatLng().lat - store.latitude) < 0.00001 && 
                        Math.abs(m.getLatLng().lng - store.longitude) < 0.00001
                    );
                    if (marker) {
                        marker.openPopup();
                    }
                }
                selectStoreCard(store.id);
            });

            return card;
        }

        // ポップアップコンテンツ作成
        function createPopupContent(store) {
            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            const storeHours = store.opening_hours ? escapeHtml(store.opening_hours) : '';
            const storePhone = store.phone ? escapeHtml(store.phone) : '';
            const storeWebsite = store.website ? escapeHtml(store.website) : '';
            const storeDescription = store.description ? escapeHtml(store.description) : '';
            
            // カテゴリバッジ（店舗一覧と同じスタイル）
            const config = getCategoryConfig(store.category);
            const categoryBadge = `<span class="category-badge" style="background: ${config.color}15; color: ${config.color}; border: 1px solid ${config.color}30; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">${config.icon} ${storeCategory}</span>`;
            
            // 訪問ステータスをチェック
            const visitStatus = userVisitHistory.get(`${store.id}`);
            const isWantToGo = visitStatus === 'want_to_go';
            const isVisited = visitStatus === 'visited';
            
            // PC版とモバイル版で異なる情報階層
            if (isDesktop()) {
                // PC版：店舗名が最上部、その下にカテゴリ
                return `
                    <div class="popup-content desktop-popup">
                        <div class="popup-header">
                            <div class="popup-header-main">
                                <h3 class="popup-title">${storeName}</h3>
                                ${categoryBadge}
                            </div>
                            <button class="popup-close-btn" onclick="closePopup()" title="閉じる">×</button>
                        </div>
                        <div class="popup-body">
                            <div class="popup-info">
                                <div class="popup-row">
                                    <span class="popup-icon">📍</span>
                                    <span class="popup-text">${storeAddress}</span>
                                </div>
                                ${storeGfOptions ? `
                                    <div class="popup-row">
                                        <span class="popup-icon">✨</span>
                                        <span class="popup-text">${storeGfOptions}</span>
                                    </div>
                                ` : ''}
                                ${storeHours ? `
                                    <div class="popup-row">
                                        <span class="popup-icon">🕒</span>
                                        <span class="popup-text">${storeHours}</span>
                                    </div>
                                ` : ''}
                                ${storePhone ? `
                                    <div class="popup-row">
                                        <span class="popup-icon">📞</span>
                                        <span class="popup-text">${storePhone}</span>
                                    </div>
                                ` : ''}
                                ${storeWebsite ? `
                                    <div class="popup-row">
                                        <span class="popup-icon">🌐</span>
                                        <span class="popup-text"><a href="${storeWebsite}" target="_blank" rel="noopener">ウェブサイト</a></span>
                                    </div>
                                ` : ''}
                                ${storeDescription ? `
                                    <div class="popup-row">
                                        <span class="popup-icon">💬</span>
                                        <span class="popup-text">${storeDescription}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="popup-actions">
                                <button class="action-btn want-to-go popup-action-btn ${isWantToGo ? 'active' : ''}" onclick="toggleVisitStatus(${store.id}, 'want_to_go')" data-store-id="${store.id}">
                                    🤍 行きたい
                                </button>
                                <button class="action-btn visited popup-action-btn ${isVisited ? 'active' : ''}" onclick="toggleVisitStatus(${store.id}, 'visited')" data-store-id="${store.id}">
                                    ✨ 行った
                                </button>
                                <button class="action-btn popup-action-btn" onclick="openStoreDetail(${store.id})">
                                    📋 詳細
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // モバイル版：既存のレイアウトを維持
                return `
                    <div class="popup-content mobile-popup">
                        <div class="popup-header-fixed">
                            <div class="popup-header-main">
                                <h3 class="popup-title">${storeName}</h3>
                            </div>
                            <button class="popup-close-btn" onclick="closePopup()" title="閉じる">
                                <span class="close-icon">×</span>
                            </button>
                        </div>
                        <div class="popup-scrollable-content">
                            <div class="popup-info-section">
                                <div class="popup-category-row">
                                    ${categoryBadge}
                                </div>
                                <div class="popup-row">
                                    <span class="popup-icon">📍</span>
                                    <span class="popup-text">${storeAddress}</span>
                                </div>
                                ${storeGfOptions ? `
                                    <div class="popup-row">
                                        <span class="popup-icon">✨</span>
                                        <span class="popup-text">${storeGfOptions}</span>
                                    </div>
                                ` : ''}
                                ${storeHours ? `
                                    <div class="popup-row">
                                        <span class="popup-icon">🕒</span>
                                        <span class="popup-text">${storeHours}</span>
                                    </div>
                                ` : ''}
                                ${storePhone ? `
                                    <div class="popup-row">
                                        <span class="popup-icon">📞</span>
                                        <span class="popup-text">${storePhone}</span>
                                    </div>
                                ` : ''}
                                ${storeWebsite ? `
                                    <div class="popup-row">
                                        <span class="popup-icon">🌐</span>
                                        <span class="popup-text"><a href="${storeWebsite}" target="_blank" rel="noopener">ウェブサイト</a></span>
                                    </div>
                                ` : ''}
                                ${storeDescription ? `
                                    <div class="popup-row">
                                        <span class="popup-icon">💬</span>
                                        <span class="popup-text">${storeDescription}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="popup-actions">
                                <button class="action-btn want-to-go popup-action-btn ${isWantToGo ? 'active' : ''}" onclick="toggleVisitStatus(${store.id}, 'want_to_go')" data-store-id="${store.id}">
                                    🤍 行きたい
                                </button>
                                <button class="action-btn visited popup-action-btn ${isVisited ? 'active' : ''}" onclick="toggleVisitStatus(${store.id}, 'visited')" data-store-id="${store.id}">
                                    ✨ 行った
                                </button>
                                <button class="action-btn popup-action-btn" onclick="openStoreDetail(${store.id})">
                                    📋 詳細
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // 店舗カード選択（PC版専用）
        function selectStoreCard(storeId) {
            if (!isDesktop()) return;
            
            // 既存の選択を解除
            document.querySelectorAll('.store-card').forEach(card => {
                card.classList.remove('selected');
            });

            // 該当する店舗カードを選択
            const selectedCard = document.querySelector(`[data-store-id="${storeId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                // 店舗一覧の一番上にスクロール
                selectedCard.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start',  // 一番上に配置
                    inline: 'nearest' 
                });
            }
        }

        // 店舗数更新
        function updateStoreCount(count) {
            const element = document.getElementById('storeCount');
            if (element) {
                element.textContent = count;
            }
        }

        // フィルタリング
        function filterStores() {
            if (!stores.length) return;

            // 検索テキストを取得（PC用またはモバイル用）
            let searchText = '';
            if (isDesktop()) {
                const sidebarSearchInput = document.getElementById('sidebarSearchInput');
                searchText = sidebarSearchInput ? sidebarSearchInput.value.toLowerCase() : '';
            } else {
                const mobileSearchInput = document.getElementById('mobileSearchInput');
                searchText = mobileSearchInput ? mobileSearchInput.value.toLowerCase() : '';
            }
            
            // カテゴリフィルターを取得（PC用またはモバイル用）
            let selectedCategory = '';
            if (isDesktop()) {
                const activeChip = document.querySelector('.sidebar-chip.active');
                selectedCategory = activeChip ? activeChip.dataset.category : '';
            } else {
                const activeChip = document.querySelector('.mobile-chip.active');
                selectedCategory = activeChip ? activeChip.dataset.category : '';
            }

            // タブフィルターを取得（PC用のみ）
            let selectedTab = 'all';
            if (isDesktop()) {
                const activeTab = document.querySelector('.sidebar-tab.active');
                selectedTab = activeTab ? activeTab.dataset.tab : 'all';
            }

            // 地域検索を先にチェック
            if (searchText && searchLocationAndMove(searchText)) {
                console.log(`🗺️ 地域検索実行: "${searchText}"`);
                // 地域検索が成功した場合でも、店舗フィルタリングは続行
            }

            const filteredStores = stores.filter(store => {
                const matchesCategory = !selectedCategory || store.category === selectedCategory;
                const matchesSearch = !searchText ||
                    (store.name && store.name.toLowerCase().includes(searchText)) ||
                    (store.address && store.address.toLowerCase().includes(searchText)) ||
                    (store.description && store.description.toLowerCase().includes(searchText));
                
                // タブフィルターを適用（PC用）
                let matchesTab = true;
                if (selectedTab === 'want-to-go') {
                    const status = userVisitHistory.get(`${store.id}`);
                    matchesTab = status === 'want_to_go';
                } else if (selectedTab === 'visited') {
                    const status = userVisitHistory.get(`${store.id}`);
                    matchesTab = status === 'visited';
                }

                return matchesCategory && matchesSearch && matchesTab;
            });

            displayStores(filteredStores);
            
            // PC用サイドバーを更新（PC版専用処理）
            if (isDesktop()) {
                displayStoreList(filteredStores);
            }
            
            // モバイル用フィルターインジケーター更新
            if (!isDesktop()) {
                const filterIndicator = document.getElementById('filterIndicator');
                const panelStoreCount = document.getElementById('panelStoreCount');
                
                // フィルターが適用されているかチェック
                const hasFilter = searchText || selectedCategory;
                
                if (filterIndicator) {
                    filterIndicator.style.display = hasFilter ? 'inline' : 'none';
                }
                
                if (panelStoreCount) {
                    if (hasFilter) {
                        panelStoreCount.textContent = `フィルター中 ${filteredStores.length}件`;
                    } else {
                        panelStoreCount.textContent = `店舗リスト ${stores.length}件`;
                    }
                }
            }
            // 注意: モバイル版は直接updatePanelContent()を呼ぶため、ここでは処理しない
        }

        // 全国主要地域データ（150地域）
        const famousLocations = {
            // 北海道・東北
            '札幌': { lat: 43.0642, lng: 141.3469, zoom: 13 },
            '札幌駅': { lat: 43.0683, lng: 141.3506, zoom: 15 },
            '青森': { lat: 40.8244, lng: 140.7400, zoom: 13 },
            '盛岡': { lat: 39.7036, lng: 141.1527, zoom: 13 },
            '仙台': { lat: 38.2682, lng: 140.8694, zoom: 13 },
            '仙台駅': { lat: 38.2601, lng: 140.8820, zoom: 15 },
            '秋田': { lat: 39.7186, lng: 140.1024, zoom: 13 },
            '山形': { lat: 38.2404, lng: 140.3634, zoom: 13 },
            '福島': { lat: 37.7503, lng: 140.4676, zoom: 13 },
            
            // 関東
            '水戸': { lat: 36.3418, lng: 140.4468, zoom: 13 },
            '宇都宮': { lat: 36.5658, lng: 139.8836, zoom: 13 },
            '前橋': { lat: 36.3911, lng: 139.0608, zoom: 13 },
            'さいたま': { lat: 35.8617, lng: 139.6455, zoom: 13 },
            '大宮': { lat: 35.9067, lng: 139.6235, zoom: 14 },
            '千葉': { lat: 35.6074, lng: 140.1065, zoom: 13 },
            '千葉駅': { lat: 35.6135, lng: 140.1133, zoom: 15 },
            '船橋': { lat: 35.6950, lng: 139.9840, zoom: 14 },
            
            // 東京23区・主要エリア
            '東京': { lat: 35.6812, lng: 139.7671, zoom: 12 },
            '東京駅': { lat: 35.6812, lng: 139.7671, zoom: 15 },
            '新宿': { lat: 35.6896, lng: 139.7006, zoom: 14 },
            '渋谷': { lat: 35.6598, lng: 139.7004, zoom: 14 },
            '池袋': { lat: 35.7280, lng: 139.7101, zoom: 14 },
            '上野': { lat: 35.7141, lng: 139.7773, zoom: 14 },
            '浅草': { lat: 35.7148, lng: 139.7967, zoom: 15 },
            '銀座': { lat: 35.6762, lng: 139.7653, zoom: 15 },
            '六本木': { lat: 35.6627, lng: 139.7314, zoom: 15 },
            '表参道': { lat: 35.6652, lng: 139.7126, zoom: 15 },
            '原宿': { lat: 35.6702, lng: 139.7025, zoom: 15 },
            '秋葉原': { lat: 35.6984, lng: 139.7731, zoom: 15 },
            '品川': { lat: 35.6284, lng: 139.7387, zoom: 14 },
            '品川駅': { lat: 35.6284, lng: 139.7387, zoom: 15 },
            '有楽町': { lat: 35.6751, lng: 139.7632, zoom: 15 },
            '丸の内': { lat: 35.6813, lng: 139.7640, zoom: 15 },
            '赤坂': { lat: 35.6740, lng: 139.7377, zoom: 15 },
            '恵比寿': { lat: 35.6466, lng: 139.7100, zoom: 15 },
            '中目黒': { lat: 35.6441, lng: 139.6979, zoom: 15 },
            '自由が丘': { lat: 35.6082, lng: 139.6679, zoom: 15 },
            '二子玉川': { lat: 35.6134, lng: 139.6289, zoom: 15 },
            '吉祥寺': { lat: 35.7022, lng: 139.5803, zoom: 15 },
            '立川': { lat: 35.6986, lng: 139.4141, zoom: 14 },
            '横浜': { lat: 35.4437, lng: 139.6380, zoom: 13 },
            '新横浜': { lat: 35.5064, lng: 139.6177, zoom: 14 },
            '川崎': { lat: 35.5308, lng: 139.7029, zoom: 14 },
            
            // 中部
            '新潟': { lat: 37.9161, lng: 139.0364, zoom: 13 },
            '富山': { lat: 36.6953, lng: 137.2113, zoom: 13 },
            '金沢': { lat: 36.5944, lng: 136.6256, zoom: 13 },
            '福井': { lat: 36.0613, lng: 136.2236, zoom: 13 },
            '甲府': { lat: 35.6638, lng: 138.5681, zoom: 13 },
            '長野': { lat: 36.6513, lng: 138.1810, zoom: 13 },
            '軽井沢': { lat: 36.3420, lng: 138.6332, zoom: 14 },
            '岐阜': { lat: 35.3912, lng: 136.7223, zoom: 13 },
            '高山': { lat: 36.1460, lng: 137.2510, zoom: 14 },
            '下呂': { lat: 35.8044, lng: 137.2489, zoom: 14 },
            '静岡': { lat: 34.9756, lng: 138.3827, zoom: 13 },
            '浜松': { lat: 34.7108, lng: 137.7261, zoom: 13 },
            '熱海': { lat: 35.0951, lng: 139.0779, zoom: 14 },
            '伊豆': { lat: 34.9679, lng: 138.9470, zoom: 13 },
            '三島': { lat: 35.1184, lng: 138.9184, zoom: 14 },
            '小田原': { lat: 35.2562, lng: 139.1563, zoom: 14 },
            '箱根': { lat: 35.2322, lng: 139.1069, zoom: 14 },
            '名古屋': { lat: 35.1815, lng: 136.9066, zoom: 12 },
            '名古屋駅': { lat: 35.1706, lng: 136.8816, zoom: 15 },
            '栄': { lat: 35.1681, lng: 136.9031, zoom: 14 },
            '大須': { lat: 35.1594, lng: 136.9078, zoom: 15 },
            '金山': { lat: 35.1434, lng: 136.9007, zoom: 15 },
            '星ヶ丘': { lat: 35.1847, lng: 136.9710, zoom: 15 },
            '藤が丘': { lat: 35.1904, lng: 137.0507, zoom: 15 },
            '豊橋': { lat: 34.7693, lng: 137.3914, zoom: 14 },
            '岡崎': { lat: 34.9553, lng: 137.1741, zoom: 14 },
            
            // 近畿
            '津': { lat: 34.7309, lng: 136.5086, zoom: 13 },
            '大津': { lat: 35.0045, lng: 135.8686, zoom: 13 },
            '京都': { lat: 35.0116, lng: 135.7681, zoom: 12 },
            '祇園': { lat: 35.0039, lng: 135.7756, zoom: 15 },
            '嵐山': { lat: 35.0096, lng: 135.6761, zoom: 14 },
            '清水寺': { lat: 34.9949, lng: 135.7851, zoom: 15 },
            '金閣寺': { lat: 35.0394, lng: 135.7292, zoom: 15 },
            '伏見': { lat: 34.9389, lng: 135.7606, zoom: 14 },
            '大阪': { lat: 34.6937, lng: 135.5023, zoom: 12 },
            '大阪駅': { lat: 34.7024, lng: 135.4959, zoom: 15 },
            '梅田': { lat: 34.7024, lng: 135.4959, zoom: 14 },
            '難波': { lat: 34.6659, lng: 135.5006, zoom: 14 },
            '心斎橋': { lat: 34.6743, lng: 135.5017, zoom: 15 },
            '天王寺': { lat: 34.6455, lng: 135.5061, zoom: 14 },
            '京橋': { lat: 34.6958, lng: 135.5273, zoom: 15 },
            '新大阪': { lat: 34.7331, lng: 135.5003, zoom: 14 },
            '神戸': { lat: 34.6901, lng: 135.1956, zoom: 13 },
            '三ノ宮': { lat: 34.6937, lng: 135.1955, zoom: 14 },
            '姫路': { lat: 34.8161, lng: 134.6851, zoom: 13 },
            '奈良': { lat: 34.6851, lng: 135.8048, zoom: 13 },
            '和歌山': { lat: 34.2261, lng: 135.1675, zoom: 13 },
            '白浜': { lat: 33.6829, lng: 135.3379, zoom: 14 },
            '有馬温泉': { lat: 34.7973, lng: 135.2486, zoom: 15 },
            '城崎温泉': { lat: 35.6190, lng: 134.8077, zoom: 15 },
            
            // 中国
            '鳥取': { lat: 35.5038, lng: 134.2378, zoom: 13 },
            '松江': { lat: 35.4723, lng: 133.0505, zoom: 13 },
            '岡山': { lat: 34.6617, lng: 133.9341, zoom: 13 },
            '倉敷': { lat: 34.5956, lng: 133.7722, zoom: 14 },
            '広島': { lat: 34.3853, lng: 132.4553, zoom: 13 },
            '宮島': { lat: 34.2954, lng: 132.3190, zoom: 14 },
            '山口': { lat: 34.1861, lng: 131.4704, zoom: 13 },
            
            // 四国
            '徳島': { lat: 34.0658, lng: 134.5594, zoom: 13 },
            '高松': { lat: 34.3401, lng: 134.0434, zoom: 13 },
            '松山': { lat: 33.8416, lng: 132.7658, zoom: 13 },
            '高知': { lat: 33.5597, lng: 133.5311, zoom: 13 },
            
            // 九州・沖縄
            '福岡': { lat: 33.5904, lng: 130.4017, zoom: 12 },
            '博多': { lat: 33.5904, lng: 130.4017, zoom: 14 },
            '博多駅': { lat: 33.5904, lng: 130.4017, zoom: 15 },
            '天神': { lat: 33.5918, lng: 130.3989, zoom: 14 },
            '小倉': { lat: 33.8834, lng: 130.8751, zoom: 14 },
            '久留米': { lat: 33.3197, lng: 130.5089, zoom: 14 },
            '佐賀': { lat: 33.2494, lng: 130.2989, zoom: 13 },
            '長崎': { lat: 32.7503, lng: 129.8779, zoom: 13 },
            '熊本': { lat: 32.7896, lng: 130.7417, zoom: 13 },
            '阿蘇': { lat: 32.9511, lng: 131.1074, zoom: 13 },
            '大分': { lat: 33.2382, lng: 131.6126, zoom: 13 },
            '別府': { lat: 33.2849, lng: 131.4919, zoom: 14 },
            '湯布院': { lat: 33.2662, lng: 131.3664, zoom: 14 },
            '宮崎': { lat: 31.9077, lng: 131.4202, zoom: 13 },
            '鹿児島': { lat: 31.5966, lng: 130.5571, zoom: 13 },
            '鹿児島中央': { lat: 31.5814, lng: 130.5431, zoom: 14 },
            '屋久島': { lat: 30.3318, lng: 130.5021, zoom: 12 },
            '那覇': { lat: 26.2124, lng: 127.6792, zoom: 13 },
            
            // 主要空港
            '羽田空港': { lat: 35.5494, lng: 139.7798, zoom: 14 },
            '成田空港': { lat: 35.7653, lng: 140.3862, zoom: 14 },
            '中部国際空港': { lat: 34.8584, lng: 136.8054, zoom: 14 },
            '関西空港': { lat: 34.4274, lng: 135.2440, zoom: 14 },
            '伊丹空港': { lat: 34.7855, lng: 135.4389, zoom: 14 },
            '福岡空港': { lat: 33.5859, lng: 130.4510, zoom: 14 },
            '新千歳空港': { lat: 42.7747, lng: 141.6920, zoom: 14 },
            '那覇空港': { lat: 26.1958, lng: 127.6460, zoom: 14 },
            
            // その他主要地点
            'ニセコ': { lat: 42.8048, lng: 140.6874, zoom: 13 },
            '小樽': { lat: 43.1907, lng: 140.9947, zoom: 13 },
            '函館': { lat: 41.7687, lng: 140.7290, zoom: 13 },
            '松島': { lat: 38.3736, lng: 141.0647, zoom: 14 },
            '会津若松': { lat: 37.4953, lng: 139.9303, zoom: 13 },
            '日光': { lat: 36.7581, lng: 139.6170, zoom: 13 },
            '鎌倉': { lat: 35.3193, lng: 139.5519, zoom: 14 },
            '江ノ島': { lat: 35.2986, lng: 139.4814, zoom: 15 },
            '河口湖': { lat: 35.5135, lng: 138.7636, zoom: 13 },
            '富士山': { lat: 35.3606, lng: 138.7274, zoom: 12 },
            'つくば': { lat: 36.0837, lng: 140.1133, zoom: 13 },
            '武蔵小杉': { lat: 35.5781, lng: 139.6565, zoom: 15 },
            'みなとみらい': { lat: 35.4563, lng: 139.6380, zoom: 14 },
            '多摩センター': { lat: 35.6246, lng: 139.4461, zoom: 14 },
            '幕張': { lat: 35.6487, lng: 140.0340, zoom: 14 }
        };

        // 地域名の異名・略称対応
        const locationAliases = {
            '名古屋': ['名古屋', 'なごや', 'ナゴヤ'],
            '名古屋駅': ['名古屋駅', '名駅', 'めいえき'],
            '東京': ['東京', 'とうきょう', 'トウキョウ'],
            '東京駅': ['東京駅', '東京ステーション'],
            '大阪': ['大阪', 'おおさか', 'オオサカ'],
            '大阪駅': ['大阪駅', '梅田', 'うめだ'],
            '福岡': ['福岡', 'ふくおか', 'フクオカ'],
            '博多': ['博多', 'はかた', 'ハカタ'],
            '博多駅': ['博多駅', '博多', 'はかた'],
            '京都': ['京都', 'きょうと', 'キョウト'],
            '神戸': ['神戸', 'こうべ', 'コウベ'],
            '横浜': ['横浜', 'よこはま', 'ヨコハマ'],
            '札幌': ['札幌', 'さっぽろ', 'サッポロ'],
            '仙台': ['仙台', 'せんだい', 'センダイ'],
            '広島': ['広島', 'ひろしま', 'ヒロシマ'],
            '渋谷': ['渋谷', 'しぶや', 'シブヤ'],
            '新宿': ['新宿', 'しんじゅく', 'シンジュク'],
            '池袋': ['池袋', 'いけぶくろ', 'イケブクロ'],
            '栄': ['栄', 'さかえ', 'サカエ'],
            '天神': ['天神', 'てんじん', 'テンジン']
        };

        // 地域検索機能
        function searchLocationAndMove(searchText) {
            if (!searchText || searchText.length < 2) return false;
            
            const query = searchText.toLowerCase();
            
            // 直接一致を確認
            if (famousLocations[searchText]) {
                const location = famousLocations[searchText];
                moveMapToLocation(location.lat, location.lng, location.zoom);
                return true;
            }
            
            // 異名・略称での検索
            for (const [mainName, aliases] of Object.entries(locationAliases)) {
                if (aliases.some(alias => alias.toLowerCase().includes(query))) {
                    if (famousLocations[mainName]) {
                        const location = famousLocations[mainName];
                        moveMapToLocation(location.lat, location.lng, location.zoom);
                        return true;
                    }
                }
            }
            
            // 部分一致検索
            for (const [locationName, location] of Object.entries(famousLocations)) {
                if (locationName.toLowerCase().includes(query)) {
                    moveMapToLocation(location.lat, location.lng, location.zoom);
                    return true;
                }
            }
            
            return false;
        }

        // マップ移動実行
        function moveMapToLocation(lat, lng, zoom = 14) {
            if (map) {
                map.setView([lat, lng], zoom);
                console.log(`📍 マップを移動: ${lat}, ${lng} (zoom: ${zoom})`);
            }
        }

        // ユーザーメニュー切り替え
        function toggleUserMenu() {
            console.log('👤 ユーザーメニューボタンがクリックされました');
            
            const dropdown = document.getElementById('userMenuDropdown');
            if (!dropdown) return;
            
            // 現在の表示状態を切り替え
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                console.log('✅ メニューを表示');
            } else {
                dropdown.style.display = 'none';
                console.log('❌ メニューを非表示');
            }
        }

        // メニュー外クリックで閉じる
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('userMenuDropdown');
            const headerActions = document.getElementById('headerActions');
            
            if (dropdown && headerActions) {
                // メニューまたはボタン以外をクリックした場合は閉じる
                if (!headerActions.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.style.display = 'none';
                }
            }
        });

        // プロフィール関連の変数
        let currentUserProfile = {
            avatar: '👤',
            avatarType: 'emoji', // 'emoji' or 'image'
            avatarImage: null, // Base64画像データ
            name: '',
            email: '',
            bio: '',
            joinDate: ''
        };

        // メニューアイテムの機能実装
        async function showUserProfile() {
            try {
                console.log('👤 プロフィール画面を表示');
                // メニューを閉じる
                const dropdown = document.getElementById('userMenuDropdown');
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
                
                // プロフィール保存ボタンのイベントリスナーを設定（一度だけ）
                setupProfileSaveListener();
                
                // プロフィールデータを読み込んで表示
                await loadUserProfile();
                
                const modal = document.getElementById('profileModal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            } catch (error) {
                console.error('❌ プロフィール画面表示エラー:', error);
                alert('プロフィール画面の表示に失敗しました');
            }
        }
        
        // プロフィール保存ボタンのイベントリスナー設定
        function setupProfileSaveListener() {
            const saveBtn = document.getElementById('saveProfileBtn');
            if (saveBtn && !saveBtn.hasAttribute('data-listener-added')) {
                saveBtn.addEventListener('click', async () => {
                    try {
                        await saveProfile();
                    } catch (error) {
                        console.error('❌ プロフィール保存エラー:', error);
                        alert('プロフィールの保存に失敗しました');
                    }
                });
                saveBtn.setAttribute('data-listener-added', 'true');
                console.log('✅ プロフィール保存リスナー設定完了');
            }
        }

        // プロフィールデータ読み込み（Supabaseベース）
        async function loadUserProfile() {
            try {
                // 基本情報
                currentUserProfile.email = currentUser || 'demo@example.com';
                currentUserProfile.joinDate = new Date().toLocaleDateString('ja-JP');
                
                // currentUserが設定されていない場合は処理を停止
                if (!currentUser || currentUser === 'demo@example.com') {
                    console.log('⚠️ ユーザー未ログイン - デフォルトプロフィール使用');
                    setDefaultProfile();
                    return;
                }
                
                // Supabaseからプロフィール情報を読み込み
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('nickname, bio, avatar_type, avatar_emoji, avatar_url')
                    .eq('email', currentUser)
                    .single();
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = レコードが見つからない
                    throw error;
                }
                
                if (data) {
                    currentUserProfile.name = data.nickname || '';
                    currentUserProfile.bio = data.bio || '';
                    currentUserProfile.avatarType = data.avatar_type || 'emoji';
                    currentUserProfile.avatar = data.avatar_emoji || '🍰';
                    currentUserProfile.avatarImage = data.avatar_url || null;
                    console.log('✅ Supabaseからプロフィール読み込み完了:', data);
                } else {
                    // プロフィールが存在しない場合のデフォルト値
                    setDefaultProfile();
                    console.log('📝 新規ユーザー - デフォルトプロフィール設定');
                }
                
            } catch (error) {
                console.error('❌ プロフィール読み込みエラー:', error);
                // エラー時はLocalStorageのフォールバック
                loadProfileFromLocalStorage();
            }
            
            // 画面に表示
            try {
                updateProfileDisplay();
                console.log('📋 プロフィール読み込み完了:', currentUserProfile);
            } catch (displayError) {
                console.error('❌ プロフィール表示エラー:', displayError);
            }
        }
        
        // デフォルトプロフィール設定
        function setDefaultProfile() {
            currentUserProfile.name = getUserDisplayNameFromEmail();
            currentUserProfile.bio = '';
            currentUserProfile.avatarType = 'emoji';
            currentUserProfile.avatar = '🍰';
            currentUserProfile.avatarImage = null;
        }
        
        // LocalStorageからプロフィール読み込み
        function loadProfileFromLocalStorage() {
            try {
                const savedProfile = localStorage.getItem(`profile_${currentUser}`);
                if (savedProfile) {
                    const parsed = JSON.parse(savedProfile);
                    currentUserProfile = { ...currentUserProfile, ...parsed };
                    console.log('🔄 LocalStorageフォールバック使用');
                } else {
                    setDefaultProfile();
                }
            } catch (error) {
                console.error('❌ LocalStorage読み込みエラー:', error);
                setDefaultProfile();
            }
        }
        
        // メールアドレスから表示名を生成
        function getUserDisplayNameFromEmail() {
            if (currentUser && currentUser.includes('@')) {
                return currentUser.split('@')[0];
            }
            return 'ユーザー';
        }

        // プロフィール表示を更新
        function updateProfileDisplay() {
            try {
                const userAvatar = document.getElementById('userAvatar');
                const editAvatar = document.getElementById('editAvatar');
                
                // アバター表示を更新
                if (userAvatar) {
                    if (currentUserProfile.avatarType === 'image' && currentUserProfile.avatarImage) {
                        // 画像アバターの場合
                        userAvatar.innerHTML = `<img src="${currentUserProfile.avatarImage}" alt="プロフィール画像">`;
                        userAvatar.className = 'avatar-circle image-avatar';
                    } else {
                        // 絵文字アバターの場合
                        userAvatar.textContent = currentUserProfile.avatar || '🍰';
                        userAvatar.className = 'avatar-circle';
                    }
                }
                
                if (editAvatar) {
                    if (currentUserProfile.avatarType === 'image' && currentUserProfile.avatarImage) {
                        editAvatar.innerHTML = `<img src="${currentUserProfile.avatarImage}" alt="プロフィール画像">`;
                        editAvatar.className = 'avatar-circle image-avatar';
                    } else {
                        editAvatar.textContent = currentUserProfile.avatar || '🍰';
                        editAvatar.className = 'avatar-circle';
                    }
                }
                
                // テキスト情報を更新
                const displayName = document.getElementById('displayName');
                if (displayName) {
                    displayName.textContent = currentUserProfile.name || '-';
                }
                
                const displayEmail = document.getElementById('displayEmail');
                if (displayEmail) {
                    displayEmail.textContent = currentUserProfile.email || '-';
                }
                
                const displayJoinDate = document.getElementById('displayJoinDate');
                if (displayJoinDate) {
                    displayJoinDate.textContent = currentUserProfile.joinDate || '-';
                }
                
                const displayBio = document.getElementById('displayBio');
                if (displayBio) {
                    displayBio.textContent = currentUserProfile.bio || '自己紹介がまだ設定されていません';
                }
                
            } catch (error) {
                console.error('❌ プロフィール表示更新エラー:', error);
            }
        }

        // プロフィールモーダルを閉じる
        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
            // 編集モードの場合は表示モードに戻す
            showProfileView();
        }

        // プロフィール編集モードに切り替え
        function editProfile() {
            // 編集フォームに現在の値を設定
            document.getElementById('editName').value = currentUserProfile.name || '';
            document.getElementById('editBio').value = currentUserProfile.bio || '';
            
            // アバター表示を更新
            updateProfileDisplay();
            
            // タブ設定
            const avatarType = currentUserProfile.avatarType || 'emoji';
            showAvatarTypeByValue(avatarType);
            
            // 画像プレビューの設定
            if (avatarType === 'image' && currentUserProfile.avatarImage) {
                document.getElementById('previewImg').src = currentUserProfile.avatarImage;
                document.getElementById('imagePreview').style.display = 'block';
            } else {
                document.getElementById('imagePreview').style.display = 'none';
            }
            
            // 文字数カウントを更新
            updateCharCount();
            
            // アバター選択状態を更新
            updateAvatarSelection();
            
            // 編集モードを表示
            document.getElementById('profileView').style.display = 'none';
            document.getElementById('profileEdit').style.display = 'flex';
        }

        // アバタータイプを値で設定
        function showAvatarTypeByValue(type) {
            // タブの表示切り替え
            document.querySelectorAll('.avatar-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            if (type === 'emoji') {
                document.querySelector('.avatar-tab:first-child').classList.add('active');
                document.getElementById('emojiAvatars').style.display = 'flex';
                document.getElementById('imageUpload').style.display = 'none';
            } else {
                document.querySelector('.avatar-tab:last-child').classList.add('active');
                document.getElementById('emojiAvatars').style.display = 'none';
                document.getElementById('imageUpload').style.display = 'flex';
            }
        }

        // プロフィール表示モードに戻す
        function showProfileView() {
            document.getElementById('profileEdit').style.display = 'none';
            document.getElementById('profileView').style.display = 'flex';
        }

        // アバター選択
        function selectAvatar(emoji) {
            currentUserProfile.avatar = emoji;
            currentUserProfile.avatarType = 'emoji';
            currentUserProfile.avatarImage = null;
            
            const editAvatar = document.getElementById('editAvatar');
            editAvatar.textContent = emoji;
            editAvatar.className = 'avatar-circle';
            editAvatar.innerHTML = emoji; // imgタグを削除
            
            updateAvatarSelection();
            
            // 画像プレビューを非表示
            document.getElementById('imagePreview').style.display = 'none';
        }

        // アバタータイプ切り替え
        function showAvatarType(type) {
            // タブの表示切り替え
            document.querySelectorAll('.avatar-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.avatar-tab').classList.add('active');
            
            // コンテンツの表示切り替え
            if (type === 'emoji') {
                document.getElementById('emojiAvatars').style.display = 'flex';
                document.getElementById('imageUpload').style.display = 'none';
            } else {
                document.getElementById('emojiAvatars').style.display = 'none';
                document.getElementById('imageUpload').style.display = 'flex';
            }
        }

        // 画像アップロード処理
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // ファイルサイズチェック (2MB制限)
            if (file.size > 2 * 1024 * 1024) {
                alert('ファイルサイズが2MBを超えています。より小さなファイルを選択してください。');
                return;
            }
            
            // ファイルタイプチェック
            if (!file.type.startsWith('image/')) {
                alert('画像ファイルを選択してください。');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // 画像をリサイズ
                    const resizedImage = resizeImage(img, 200, 200);
                    
                    // プロフィールに設定
                    currentUserProfile.avatarType = 'image';
                    currentUserProfile.avatarImage = resizedImage;
                    
                    // プレビュー表示
                    document.getElementById('previewImg').src = resizedImage;
                    document.getElementById('imagePreview').style.display = 'block';
                    
                    // 編集用アバターも更新
                    const editAvatar = document.getElementById('editAvatar');
                    editAvatar.innerHTML = `<img src="${resizedImage}" alt="プロフィール画像">`;
                    editAvatar.className = 'avatar-circle image-avatar';
                    
                    console.log('✅ 画像アップロード完了');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // 画像リサイズ関数（サイズ最適化版）
        function resizeImage(img, maxWidth, maxHeight) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // アスペクト比を保持してリサイズ
            let { width, height } = img;
            
            if (width > height) {
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
            } else {
                if (height > maxHeight) {
                    width = (width * maxHeight) / height;
                    height = maxHeight;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            
            // 画像を描画
            ctx.drawImage(img, 0, 0, width, height);
            
            // Base64として返す（品質を下げてサイズ削減）
            // 最初は品質0.5で試す
            let dataUrl = canvas.toDataURL('image/jpeg', 0.5);
            
            // データサイズをチェック（約50KB以下を目標）
            console.log('画像データサイズ:', Math.round(dataUrl.length / 1024), 'KB');
            
            if (dataUrl.length > 50000) {
                // さらに圧縮が必要な場合は品質を0.3に下げる
                dataUrl = canvas.toDataURL('image/jpeg', 0.3);
                console.log('再圧縮後のサイズ:', Math.round(dataUrl.length / 1024), 'KB');
            }
            
            return dataUrl;
        }

        // アップロードした画像を削除
        function removeUploadedImage() {
            currentUserProfile.avatarType = 'emoji';
            currentUserProfile.avatarImage = null;
            
            // プレビューを非表示
            document.getElementById('imagePreview').style.display = 'none';
            
            // デフォルトの絵文字に戻す
            const editAvatar = document.getElementById('editAvatar');
            editAvatar.textContent = currentUserProfile.avatar;
            editAvatar.className = 'avatar-circle';
            editAvatar.innerHTML = currentUserProfile.avatar;
            
            // ファイル入力をクリア
            document.getElementById('avatarImageInput').value = '';
            
            console.log('🗑️ アップロード画像を削除');
        }

        // アバター選択状態を更新
        function updateAvatarSelection() {
            const options = document.querySelectorAll('.avatar-option');
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.textContent === currentUserProfile.avatar) {
                    option.classList.add('selected');
                }
            });
        }

        // 文字数カウント更新
        function updateCharCount() {
            const textarea = document.getElementById('editBio');
            const counter = document.getElementById('bioCharCount');
            counter.textContent = textarea.value.length;
            
            // 文字数に応じて色を変更
            if (textarea.value.length > 90) {
                counter.style.color = '#dc3545';
            } else if (textarea.value.length > 70) {
                counter.style.color = '#fd7e14';
            } else {
                counter.style.color = '#6b7280';
            }
        }

        // プロフィール編集をキャンセル
        function cancelEdit() {
            showProfileView();
        }

        // プロフィールを保存（Supabaseベース）
        async function saveProfile() {
            try {
                // ユーザー認証確認
                if (!currentUser || currentUser === 'demo@example.com') {
                    alert('ログインが必要です');
                    return false;
                }
                
                // フォームデータを取得
                const nameElement = document.getElementById('editName');
                const bioElement = document.getElementById('editBio');
                
                if (!nameElement || !bioElement) {
                    console.error('❌ フォーム要素が見つかりません');
                    alert('フォームの読み込みに問題があります');
                    return false;
                }
                
                const name = nameElement.value.trim();
                const bio = bioElement.value.trim();
                
                // バリデーション
                if (!name) {
                    alert('名前を入力してください');
                    nameElement.focus();
                    return false;
                }
                
                if (name.length > 50) {
                    alert('名前は50文字以内で入力してください');
                    nameElement.focus();
                    return false;
                }
                
                if (bio.length > 100) {
                    alert('自己紹介は100文字以内で入力してください');
                    bioElement.focus();
                    return false;
                }
                
                // 保存ボタンを無効化（二重送信防止）
                const saveBtn = document.getElementById('saveProfileBtn');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = '保存中...';
                }
                
                // プロフィールデータを更新
                currentUserProfile.name = name;
                currentUserProfile.bio = bio;
                
                // Supabaseに保存
                // avatar_urlが大きすぎる場合の対策
                let avatarUrl = currentUserProfile.avatarImage || null;
                if (avatarUrl && avatarUrl.length > 65535) {
                    console.warn('⚠️ 画像データが大きすぎます。圧縮または削除が必要です。');
                    // 暫定対応：大きすぎる場合はnullにする
                    avatarUrl = null;
                    currentUserProfile.avatarImage = null;
                    currentUserProfile.avatarType = 'emoji';
                    alert('画像サイズが大きすぎるため、絵文字アバターに変更されました。');
                }
                
                const profileData = {
                    email: currentUser,
                    nickname: currentUserProfile.name,
                    bio: currentUserProfile.bio,
                    avatar_type: currentUserProfile.avatarType || 'emoji',
                    avatar_emoji: currentUserProfile.avatar || '🍰',
                    avatar_url: avatarUrl,
                    updated_at: new Date().toISOString()
                };
                
                // upsertを実行（emailが存在すれば更新、なければ挿入）
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .upsert(profileData);
                    
                if (error) {
                    console.error('Supabase upsertエラーの詳細:', error);
                    throw error;
                }
                
                console.log('✅ Supabaseにプロフィール保存完了');
                
                // LocalStorageにもバックアップ保存
                saveProfileToLocalStorage();
                
                // 表示を更新
                updateProfileDisplay();
                
                // ヘッダーのユーザー表示も更新（PC・スマホ両対応）
                updateAllHeaderDisplays();
                
                // 表示モードに戻す
                showProfileView();
                
                // 成功メッセージ
                showSaveSuccessMessage(saveBtn);
                
                console.log('✅ プロフィールを保存しました（全デバイス対応・Supabase同期済み）');
                return true;
                
            } catch (error) {
                console.error('❌ プロフィール保存エラー:', error);
                
                // エラー時はLocalStorageのみに保存
                saveProfileToLocalStorage();
                console.log('🔄 LocalStorageにフォールバック保存');
                
                // エラーメッセージ表示
                alert('サーバーへの保存に失敗しましたが、ローカルには保存されました');
                return false;
                
            } finally {
                // 保存ボタンを再有効化
                const saveBtn = document.getElementById('saveProfileBtn');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '保存';
                }
            }
        }
        
        // LocalStorageにプロフィール保存
        function saveProfileToLocalStorage() {
            try {
                localStorage.setItem(`profile_${currentUser}`, JSON.stringify({
                    avatar: currentUserProfile.avatar,
                    avatarType: currentUserProfile.avatarType,
                    avatarImage: currentUserProfile.avatarImage,
                    name: currentUserProfile.name,
                    bio: currentUserProfile.bio
                }));
                console.log('💾 LocalStorageに保存完了');
            } catch (error) {
                console.error('❌ LocalStorage保存エラー:', error);
            }
        }
        
        // 保存成功メッセージ表示
        function showSaveSuccessMessage(saveBtn) {
            if (!saveBtn) return;
            
            const originalText = saveBtn.textContent;
            const originalBackground = saveBtn.style.background;
            
            saveBtn.textContent = '保存完了！';
            saveBtn.style.background = '#28a745';
            
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.background = originalBackground;
            }, 2000);
        }

        // 全てのヘッダー表示を更新（PC・スマホ対応）
        function updateAllHeaderDisplays() {
            initializeHeaderActions();
            
            // 追加: スマホ版のアバターボタンが存在する場合は個別更新
            const mobileUserBtn = document.querySelector('.mobile-user-btn');
            if (mobileUserBtn) {
                const userAvatar = getUserAvatar();
                let mobileAvatarContent = userAvatar;
                
                // 画像アバターの場合はインラインスタイルを削除（CSSで制御）
                if (userAvatar.includes('<img')) {
                    mobileAvatarContent = userAvatar.replace(/style="[^"]*"/g, '');
                }
                
                mobileUserBtn.innerHTML = mobileAvatarContent;
            }
            
            console.log('🔄 全デバイスのヘッダー表示を更新しました');
        }

        function showUserReviews() {
            console.log('⭐ マイレビュー画面を表示');
            document.getElementById('userMenuDropdown').style.display = 'none';
            // TODO: レビュー画面の実装
            alert('マイレビュー機能は準備中です');
        }

        function showUserStats() {
            console.log('📊 統計画面を表示');
            document.getElementById('userMenuDropdown').style.display = 'none';
            // TODO: 統計画面の実装
            alert('統計機能は準備中です');
        }

        function showAppGuide() {
            console.log('❓ 使い方ガイドを表示');
            document.getElementById('userMenuDropdown').style.display = 'none';
            // TODO: ガイド画面の実装
            alert('使い方ガイドは準備中です');
        }

        function showNotifications() {
            console.log('🔔 通知画面を表示');
            document.getElementById('userMenuDropdown').style.display = 'none';
            // TODO: 通知画面の実装
            alert('通知機能は準備中です');
        }

        function logout() {
            console.log('🚪 ログアウト処理を開始');
            document.getElementById('userMenuDropdown').style.display = 'none';
            
            if (confirm('ログアウトしますか？')) {
                supabaseClient.auth.signOut();
                console.log('✅ ログアウト完了');
            }
        }

        // ========== 店舗詳細モーダル関連 ==========
        
        // 店舗詳細モーダルを開く
        function openStoreDetail(storeId) {
            try {
                console.log('🏪 店舗詳細を開く:', storeId);
                
                // 店舗データを取得（embeddedStoresを使用）
                const store = embeddedStores.find(s => s.id === storeId);
                if (!store) {
                    console.error('店舗が見つかりません:', storeId);
                    return;
                }
                
                // モーダルコンテンツを生成
                const content = createStoreDetailContent(store);
                document.getElementById('storeDetailContent').innerHTML = content;
                
                // モーダルを表示
                const modal = document.getElementById('storeDetailModal');
                if (modal) {
                    modal.style.display = 'block';
                    modal.dataset.currentStoreId = storeId; // storeIdを保存
                    document.body.style.overflow = 'hidden'; // スクロール防止
                    
                    // 画像を読み込み
                    setTimeout(() => loadStoreImages(storeId), 100);
                    
                    // 画像アップロードイベントリスナーを設定
                    setupImageUploadListener(storeId);
                    
                    // ボタン状態を更新
                    setTimeout(() => {
                        updateDetailButtons(storeId);
                    }, 100); // DOM生成後に実行
                }
                
            } catch (error) {
                console.error('❌ 店舗詳細表示エラー:', error);
                alert('店舗詳細の表示に失敗しました');
            }
        }
        
        // カテゴリ設定取得（マップで実際に使用されている設定と統一）
        function getCategoryConfig(category) {
            const categoryConfig = {
                'カフェ': { icon: '☕', color: '#8B4513' },      // 濃いブラウン
                '和食': { icon: '🍱', color: '#E74C3C' },       // 鮮やかな赤
                '洋食': { icon: '🍽️', color: '#3498DB' },      // 鮮やかなブルー
                'パン屋': { icon: '🥐', color: '#F39C12' },     // 鮮やかなオレンジ
                'スイーツ': { icon: '🧁', color: '#E91E63' },   // 鮮やかなピンク
                '販売店': { icon: '🛒', color: '#27AE60' },     // 鮮やかなグリーン
                'その他': { icon: '🏪', color: '#7F8C8D' }      // グレー
            };
            return categoryConfig[category] || categoryConfig['その他'];
        }
        
        // 管理者モード判定
        function isAdminMode() {
            // 開発用: ログインしているユーザーが管理者の場合
            return currentUser && (
                currentUser.email === 'kanakugimakoto@gmail.com' ||
                localStorage.getItem('adminMode') === 'true'
            );
        }
        
        // 管理者モード切り替え（開発用）
        function toggleAdminMode() {
            const current = localStorage.getItem('adminMode') === 'true';
            localStorage.setItem('adminMode', !current ? 'true' : 'false');
            console.log('🔧 管理者モード:', !current ? 'ON' : 'OFF');
            
            // モーダルが開いている場合は再読み込み
            const modal = document.getElementById('storeDetailModal');
            if (modal && modal.style.display === 'block') {
                const storeId = modal.dataset.currentStoreId;
                if (storeId) {
                    openStoreDetail(parseInt(storeId));
                }
            }
        }
        
        // 画像アップロードイベントリスナー設定
        function setupImageUploadListener(storeId) {
            const fileInput = document.getElementById(`imageUpload-${storeId}`);
            if (!fileInput) return;
            
            fileInput.addEventListener('change', async (event) => {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;
                
                await handleImageUpload(storeId, files);
                
                // ファイル入力をリセット
                event.target.value = '';
            });
        }
        
        // 画像アップロード処理
        async function handleImageUpload(storeId, files) {
            try {
                console.log('📤 画像アップロード開始:', files.length, '枚');
                
                if (files.length > 3) {
                    alert('画像は最大3枚まで選択できます。');
                    return;
                }
                
                // 画像ファイルのみフィルタ
                const imageFiles = files.filter(file => file.type.startsWith('image/'));
                if (imageFiles.length !== files.length) {
                    alert('画像ファイルのみを選択してください。');
                    return;
                }
                
                // 各画像を処理
                const processedImages = [];
                for (const file of imageFiles) {
                    if (file.size > 10 * 1024 * 1024) { // 10MB制限
                        alert(`${file.name} は10MBを超えています。`);
                        continue;
                    }
                    
                    const compressedImage = await compressImage(file);
                    processedImages.push({
                        file: compressedImage,
                        originalName: file.name
                    });
                }
                
                if (processedImages.length === 0) return;
                
                // Supabaseに保存
                await saveImagesToSupabase(storeId, processedImages);
                
                // 表示を更新
                await loadStoreImages(storeId);
                
                console.log('✅ 画像アップロード完了');
                
            } catch (error) {
                console.error('❌ 画像アップロードエラー:', error);
                alert('画像のアップロードに失敗しました。');
            }
        }
        
        // 画像圧縮
        async function compressImage(file, maxWidth = 800, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // アスペクト比を保持してリサイズ
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    
                    // 描画
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Blobに変換
                    canvas.toBlob(resolve, 'image/jpeg', quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        // Supabaseに画像保存
        async function saveImagesToSupabase(storeId, images) {
            try {
                console.log('💾 Supabaseに画像保存開始');
                
                // Supabaseクライアントの確認
                if (!supabaseClient) {
                    throw new Error('Supabaseクライアントが初期化されていません');
                }
                
                for (const imageData of images) {
                    // Base64エンコード
                    const base64 = await fileToBase64(imageData.file);
                    
                    const { data, error } = await supabaseClient
                        .from('store_images')
                        .insert([{
                            store_id: storeId,
                            image_url: base64,
                            caption: imageData.originalName,
                            uploaded_by: currentUser || 'admin',
                            is_primary: false
                        }]);
                        
                    if (error) {
                        console.error('Supabase保存エラー:', error);
                        throw error;
                    }
                }
                
                console.log('✅ 画像Supabase保存完了');
                
            } catch (error) {
                console.error('❌ Supabase画像保存エラー:', error);
                throw error;
            }
        }
        
        // ファイルをBase64に変換
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // 店舗画像を読み込み表示
        async function loadStoreImages(storeId) {
            try {
                console.log('🖼️ 店舗画像読み込み開始:', storeId);
                
                const container = document.getElementById(`storeImagesContainer-${storeId}`);
                if (!container) return;
                
                // Supabaseクライアントの確認
                if (!supabaseClient) {
                    console.warn('⚠️ Supabaseクライアントが未初期化、プレースホルダー表示');
                    container.innerHTML = `
                        <div class="store-images-placeholder">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>データベース接続エラー</p>
                        </div>
                    `;
                    return;
                }
                
                // Supabaseから画像データを取得
                const { data: images, error } = await supabaseClient
                    .from('store_images')
                    .select('*')
                    .eq('store_id', storeId)
                    .order('created_at', { ascending: true });
                
                if (error) {
                    console.error('画像取得エラー:', error);
                    throw error;
                }
                
                if (!images || images.length === 0) {
                    container.innerHTML = `
                        <div class="store-images-placeholder">
                            <i class="fas fa-camera"></i>
                            <p>まだ画像がありません</p>
                        </div>
                    `;
                    return;
                }
                
                // 画像ギャラリーを表示
                const galleryHTML = images.map(img => `
                    <div class="store-image-item" onclick="viewImageLarge('${img.image_url}')">
                        <img src="${img.image_url}" alt="${img.caption || '店舗画像'}" loading="lazy">
                        ${isAdminMode() ? `
                            <button class="delete-image-btn" onclick="event.stopPropagation(); deleteImage(${img.id}, ${storeId})">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                `).join('');
                
                container.innerHTML = `
                    <div class="store-images-gallery">
                        ${galleryHTML}
                    </div>
                `;
                
                console.log('✅ 画像表示完了:', images.length, '枚');
                
            } catch (error) {
                console.error('❌ 店舗画像読み込みエラー:', error);
                
                // エラー時はプレースホルダー表示
                const container = document.getElementById(`storeImagesContainer-${storeId}`);
                if (container) {
                    container.innerHTML = `
                        <div class="store-images-placeholder">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>画像の読み込みに失敗しました</p>
                        </div>
                    `;
                }
            }
        }
        
        // 画像削除
        async function deleteImage(imageId, storeId) {
            try {
                if (!confirm('この画像を削除してもよろしいですか？')) {
                    return;
                }
                
                console.log('🗑️ 画像削除開始:', imageId);
                
                const { error } = await supabaseClient
                    .from('store_images')
                    .delete()
                    .eq('id', imageId);
                
                if (error) {
                    console.error('画像削除エラー:', error);
                    throw error;
                }
                
                console.log('✅ 画像削除完了');
                
                // 表示を更新
                await loadStoreImages(storeId);
                
            } catch (error) {
                console.error('❌ 画像削除エラー:', error);
                alert('画像の削除に失敗しました。');
            }
        }
        
        // 画像拡大表示
        function viewImageLarge(imageUrl) {
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="image-modal-content">
                    <span class="image-modal-close">&times;</span>
                    <img src="${imageUrl}" alt="拡大画像">
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // クリックで閉じる
            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target.className === 'image-modal-close') {
                    document.body.removeChild(modal);
                }
            });
            
            // ESCキーで閉じる
            const handleKeydown = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(modal);
                    document.removeEventListener('keydown', handleKeydown);
                }
            };
            document.addEventListener('keydown', handleKeydown);
        }
        
        // 店舗詳細のコンテンツを生成
        function createStoreDetailContent(store) {
            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storePhone = store.phone ? escapeHtml(store.phone) : '';
            const storeWebsite = store.website ? escapeHtml(store.website) : '';
            const storeHours = store.opening_hours ? escapeHtml(store.opening_hours) : '';
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            const storeDescription = store.description ? escapeHtml(store.description) : '';
            
            // カテゴリスタイル（店舗一覧と完全に同じ）
            const config = getCategoryConfig(store.category);
            const categoryBadge = `
                <span class="category-badge" style="background: ${config.color}15; color: ${config.color}; border: 1px solid ${config.color}30; padding: 4px 12px; border-radius: 15px; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; gap: 4px;">
                    ${config.icon} ${storeCategory}
                </span>
            `;
            
            return `
                <h2 class="store-detail-title">${storeName}</h2>
                <div class="store-detail-category-container">${categoryBadge}</div>
                
                <!-- 店舗画像ギャラリー -->
                <div class="store-detail-section">
                    <h3><i class="fas fa-images"></i> 店舗画像</h3>
                    <div class="store-images-container" id="storeImagesContainer-${store.id}">
                        <div class="store-images-placeholder">
                            <i class="fas fa-camera"></i>
                            <p>画像を読み込み中...</p>
                        </div>
                    </div>
                    ${isAdminMode() ? `
                        <div class="store-image-admin">
                            <input type="file" id="imageUpload-${store.id}" accept="image/*" multiple style="display: none;">
                            <button class="btn btn-secondary" onclick="document.getElementById('imageUpload-${store.id}').click()">
                                <i class="fas fa-plus"></i> 画像を追加
                            </button>
                            <span class="image-limit-text">最大3枚まで</span>
                        </div>
                    ` : ''}
                </div>
                
                <!-- 基本情報 -->
                <div class="store-detail-section">
                    <h3><i class="fas fa-info-circle"></i> 基本情報</h3>
                    
                    <div class="store-detail-info">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${storeAddress}</span>
                    </div>
                    
                    ${storePhone ? `
                        <div class="store-detail-info">
                            <i class="fas fa-phone"></i>
                            <span>${storePhone}</span>
                        </div>
                    ` : ''}
                    
                    ${storeHours ? `
                        <div class="store-detail-info">
                            <i class="fas fa-clock"></i>
                            <span>${storeHours}</span>
                        </div>
                    ` : ''}
                    
                    ${storeWebsite ? `
                        <div class="store-detail-info">
                            <i class="fas fa-globe"></i>
                            <a href="${storeWebsite}" target="_blank" rel="noopener noreferrer">
                                ウェブサイト
                            </a>
                        </div>
                    ` : ''}
                </div>
                
                <!-- グルテンフリー情報 -->
                ${storeGfOptions ? `
                    <div class="store-detail-section">
                        <h3><i class="fas fa-check-circle"></i> グルテンフリー対応</h3>
                        <div class="store-detail-description">
                            ${storeGfOptions}
                        </div>
                    </div>
                ` : ''}
                
                <!-- 店舗説明 -->
                ${storeDescription ? `
                    <div class="store-detail-section">
                        <h3><i class="fas fa-comment-dots"></i> 店舗について</h3>
                        <div class="store-detail-description">
                            ${storeDescription}
                        </div>
                    </div>
                ` : ''}
                
                <!-- アクションボタン -->
                <div class="store-detail-actions">
                    <button class="store-detail-btn want-to-go" id="detailWantToGoBtn-${store.id}" onclick="toggleVisitStatus(${store.id}, 'want_to_go'); updateDetailButtons(${store.id})">
                        🤍 行きたい
                    </button>
                    <button class="store-detail-btn visited" id="detailVisitedBtn-${store.id}" onclick="toggleVisitStatus(${store.id}, 'visited'); updateDetailButtons(${store.id})">
                        ✨ 行った
                    </button>
                    <button class="store-detail-btn secondary" onclick="closeStoreDetail()">
                        閉じる
                    </button>
                </div>
            `;
        }
        
        // 店舗詳細モーダルを閉じる
        function closeStoreDetail() {
            const modal = document.getElementById('storeDetailModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = ''; // スクロール復活
            }
        }

        // ヘッダーアクションを初期化
        function initializeHeaderActions() {
            const headerActions = document.getElementById('headerActions');
            if (!headerActions) return;
            
            // ユーザー名とアバター情報を取得
            const userName = getUserDisplayName();
            const userAvatar = getUserAvatar();
            
            if (isDesktop()) {
                // PC版: ユーザープロフィールボタン
                headerActions.innerHTML = `
                    <button class="user-profile-btn" onclick="toggleUserMenu()">
                        <div class="user-icon">${userAvatar}</div>
                        <span>${userName}</span>
                        <i class="fas fa-chevron-down" style="font-size: 0.7rem; opacity: 0.7;"></i>
                    </button>
                `;
            } else {
                // スマホ版: 丸いアバターボタン（プロフィール画像対応）
                let mobileAvatarContent = userAvatar;
                
                // 画像アバターの場合はスマホ用にサイズを削除（CSSで制御）
                if (userAvatar.includes('<img')) {
                    // インラインスタイルを削除してCSSで制御
                    mobileAvatarContent = userAvatar.replace(/style="[^"]*"/g, '');
                }
                
                headerActions.innerHTML = `
                    <button class="mobile-user-btn" onclick="toggleUserMenu()">
                        ${mobileAvatarContent}
                    </button>
                `;
            }
        }

        // ユーザーアバターを取得
        function getUserAvatar() {
            // まずcurrentUserProfileから取得
            if (currentUserProfile) {
                if (currentUserProfile.avatarType === 'image' && currentUserProfile.avatarImage) {
                    // 画像アバターの場合
                    return `<img src="${currentUserProfile.avatarImage}" alt="プロフィール画像" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">`;
                } else if (currentUserProfile.avatar) {
                    // 絵文字アバターの場合
                    return currentUserProfile.avatar;
                }
            }
            
            if (currentUser) {
                // フォールバック：LocalStorageから取得
                const savedProfile = localStorage.getItem(`profile_${currentUser}`);
                if (savedProfile) {
                    try {
                        const parsed = JSON.parse(savedProfile);
                        if (parsed.avatarType === 'image' && parsed.avatarImage) {
                            // 画像アバターの場合
                            return `<img src="${parsed.avatarImage}" alt="プロフィール画像" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">`;
                        } else if (parsed.avatar) {
                            // 絵文字アバターの場合
                            return parsed.avatar;
                        }
                    } catch (e) {
                        console.error('アバター読み込みエラー:', e);
                    }
                }
            }
            // フォールバック
            return '👤';
        }

        // ユーザー表示名を取得
        function getUserDisplayName() {
            // まずcurrentUserProfileから取得
            if (currentUserProfile && currentUserProfile.name) {
                return currentUserProfile.name.trim();
            }
            
            if (currentUser) {
                // フォールバック：LocalStorageから取得
                const savedProfile = localStorage.getItem(`profile_${currentUser}`);
                if (savedProfile) {
                    try {
                        const parsed = JSON.parse(savedProfile);
                        if (parsed.name && parsed.name.trim()) {
                            return parsed.name.trim();
                        }
                    } catch (e) {
                        console.error('プロフィール読み込みエラー:', e);
                    }
                }
                
                // 最終フォールバック: メールアドレスから名前部分を抽出
                const emailName = currentUser.split('@')[0];
                // 数字や記号を除去して、見やすい名前に
                const cleanName = emailName.replace(/[0-9]/g, '').replace(/[._-]/g, '');
                return cleanName || 'ユーザー';
            }
            return 'ゲスト';
        }

        // 現在地取得
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('このブラウザは位置情報に対応していません');
                return;
            }

            if (!map) {
                alert('マップが初期化されていません');
                return;
            }

            getCurrentLocationAndCenter();
        }

        // マップ表示リセット

        // HTMLエスケープ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // デバイス判定
        function isDesktop() {
            return window.innerWidth >= 1025;
        }
        
        // PC用サイドバー店舗リスト表示
        function displayStoreList(storesData) {
            const container = document.getElementById('storeList');
            if (!container || !isDesktop()) return;
            
            container.innerHTML = '';
            
            // 店舗数更新
            const storeCountElement = document.getElementById('storeCount');
            if (storeCountElement) {
                storeCountElement.textContent = storesData.length;
            }
            
            if (storesData.length === 0) {
                container.innerHTML = '<div class="loading-indicator">表示する店舗がありません</div>';
                return;
            }
            
            // 現在地から近い順にソート
            let sortedStores = [...storesData];
            if (currentUserLocation) {
                sortedStores = sortedStores.sort((a, b) => {
                    if (!a.latitude || !a.longitude || !b.latitude || !b.longitude) return 0;
                    const distanceA = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, a.latitude, a.longitude);
                    const distanceB = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, b.latitude, b.longitude);
                    return distanceA - distanceB;
                });
            }
            
            sortedStores.forEach(store => {
                try {
                    const card = createStoreCard(store);
                    container.appendChild(card);
                } catch (error) {
                    console.error(`店舗「${store.name}」のカード作成エラー:`, error);
                }
            });
        }
        
        // PC用店舗カード作成
        function createStoreCard(store) {
            const card = document.createElement('div');
            card.className = 'store-card pc-store-card';
            card.dataset.storeId = store.id;
            
            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            
            // 現在地からの距離を計算
            let distanceText = '';
            if (currentUserLocation && store.latitude && store.longitude) {
                const distance = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, store.latitude, store.longitude);
                if (distance < 1) {
                    distanceText = `${Math.round(distance * 1000)}m`;
                } else {
                    distanceText = `${distance.toFixed(1)}km`;
                }
            }
            
            // 訪問ステータスをチェック
            const visitStatus = userVisitHistory.get(`${store.id}`);
            const isWantToGo = visitStatus === 'want_to_go';
            const isVisited = visitStatus === 'visited';
            
            card.innerHTML = `
                <div class="store-header">
                    <div class="store-name">${storeName}</div>
                    ${distanceText ? `<div class="store-distance">📍 ${distanceText}</div>` : ''}
                </div>
                <div class="store-meta">
                    <span class="store-category" data-category="${storeCategory}">${config.icon} ${storeCategory}</span>
                </div>
                <div class="store-info">
                    <div class="info-item">
                        <span class="info-icon">📍</span>
                        <span>${storeAddress}</span>
                    </div>
                    ${storeGfOptions ? `
                        <div class="info-item">
                            <span class="info-icon">✨</span>
                            <span>${storeGfOptions}</span>
                        </div>
                    ` : ''}
                </div>
                <div class="store-card-actions">
                    <button class="action-btn want-to-go ${isWantToGo ? 'active' : ''}" 
                            onclick="event.stopPropagation(); toggleVisitStatus(${store.id}, 'want_to_go')">
                        🤍 行きたい
                    </button>
                    <button class="action-btn visited ${isVisited ? 'active' : ''}" 
                            onclick="event.stopPropagation(); toggleVisitStatus(${store.id}, 'visited')">
                        ✨ 行った
                    </button>
                    <button class="action-btn" onclick="event.stopPropagation(); openStoreDetail(${store.id})">
                        📋 詳細
                    </button>
                </div>
            `;
            
            card.addEventListener('click', function() {
                selectStoreCard(store.id);
                focusOnStore(store.id);
            });
            
            return card;
        }
        
        // 店舗カード選択
        
        // ウィンドウリサイズ処理
        function handleResize() {
            // レスポンシブ切り替え時の処理
            if (isDesktop()) {
                // デスクトップに切り替わった場合
                if (stores && stores.length > 0) {
                    displayStoreList(stores);
                }
            } else {
                // モバイルに切り替わった場合
                if (!document.querySelector('.overlay-panel').classList.contains('initialized')) {
                    initOverlayPanel();
                }
            }
        }
        
        // ポップアップを閉じる関数
        function closePopup() {
            if (map) {
                map.closePopup();
            }
        }


        // グローバル関数として公開（onclick用）
        window.toggleVisitStatus = toggleVisitStatus;
        window.focusOnStore = focusOnStore;
        window.closePopup = closePopup;

        // イベントリスナー設定
        function setupEventListeners() {
            console.log('🎛️ イベントリスナー設定開始');

            // PC用検索
            const sidebarSearchInput = document.getElementById('sidebarSearchInput');
            if (sidebarSearchInput) {
                sidebarSearchInput.addEventListener('input', filterStores);
            }
            
            // モバイル用検索
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            if (mobileSearchInput) {
                mobileSearchInput.addEventListener('input', () => {
                    if (!isDesktop()) {
                        // モバイル版では直接パネル更新（重複防止）
                        const activeTab = document.querySelector('.panel-tab.active');
                        if (activeTab) {
                            updatePanelContent(activeTab.dataset.tab);
                        }
                    } else {
                        filterStores();
                    }
                });
            }

            // PC用サイドバータブ
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    filterStores(); // 既存のフィルター関数を再利用
                });
            });

            // PC用フィルターチップ
            document.querySelectorAll('.sidebar-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.sidebar-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    filterStores();
                });
            });
            
            // モバイル用フィルターチップ
            document.querySelectorAll('.mobile-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.mobile-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    
                    if (!isDesktop()) {
                        // モバイル版では直接パネル更新（重複防止）
                        const activeTab = document.querySelector('.panel-tab.active');
                        if (activeTab) {
                            updatePanelContent(activeTab.dataset.tab);
                        }
                    } else {
                        filterStores();
                    }
                });
            });

            // マップ制御
            const locateBtn = document.getElementById('locateBtn');
            if (locateBtn) {
                locateBtn.addEventListener('click', getCurrentLocation);
            }
            
            const mobileLocateBtn = document.getElementById('mobileLocateBtn');
            if (mobileLocateBtn) {
                mobileLocateBtn.addEventListener('click', getCurrentLocation);
            }

            
            // ズームコントロール
            const zoomInBtn = document.getElementById('zoomInBtn');
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', () => {
                    if (map) {
                        map.zoomIn();
                    }
                });
            }
            
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', () => {
                    if (map) {
                        map.zoomOut();
                    }
                });
            }

            // 訪問履歴機能の初期化
            initVisitHistory();
            
            // デバイス別UI初期化
            if (isDesktop()) {
                // PC用サイドバー初期化
                console.log('🖥️ PC環境を検出 - サイドバー初期化');
            } else {
                // モバイル用オーバーレイパネル初期化
                console.log('📱 モバイル環境を検出 - オーバーレイパネル初期化');
                initOverlayPanel();
            }
            
            // ウィンドウリサイズ時のレスポンシブ対応
            window.addEventListener('resize', handleResize);
            
            // 底部导航イベントリスナー
            setupBottomNavigation();
            
            console.log('✅ イベントリスナー設定完了');
        }

        // 底部导航設定
        function setupBottomNavigation() {
            console.log('📱 底部导航初期化開始');
            
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    console.log('📱 ナビゲーションタブ切り替え:', tab);
                    
                    // アクティブ状態更新
                    navButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // タブ切り替え実行
                    switchTab(tab);
                });
            });
            
            console.log('✅ 底部导航初期化完了');
        }

        // 訪問履歴グローバル変数
        let userVisitHistory = new Map();
        let currentUser = null;

        // 訪問履歴機能初期化
        async function initVisitHistory() {
            console.log('📝 訪問履歴機能初期化開始');
            
            // Supabaseクライアントの準備を待つ
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // 認証状態変更の監視を設定
            setupAuthStateListener();
            
            // 認証確認を少し遅らせて実行
            setTimeout(async () => {
                await checkAuthentication();
                console.log('🔄 遅延認証確認完了');
            }, 200);
            
            // 一旦デモモードで続行
            if (!currentUser) {
                currentUser = 'demo_user@example.com';
                console.log('⏳ 認証確認を並行実行中、デモモードで開始');
            }
            
            // Supabaseから訪問履歴を読み込み
            await loadVisitHistoryFromSupabase();
            
            // ローカルストレージからのフォールバック読み込み
            const saved = localStorage.getItem('visit_history');
            if (saved && userVisitHistory.size === 0) {
                try {
                    const parsed = JSON.parse(saved);
                    userVisitHistory = new Map(Object.entries(parsed));
                    console.log('💾 ローカル訪問履歴を復元:', userVisitHistory.size, '件');
                } catch (e) {
                    console.warn('⚠️ 訪問履歴の復元に失敗:', e);
                    userVisitHistory = new Map();
                }
            }
            
            console.log('✅ 訪問履歴機能初期化完了');
        
        // 初期化完了後に店舗カードのボタン状態を更新（遅延実行で他の初期化処理と分離）
        setTimeout(() => {
            updateAllStoreCardButtons();
            // 検索ボタンのイベントリスナーを強制再設定
            reinitializeSearchButton();
        }, 100);
        }
        
        // 全店舗カードのボタン状態を更新
        function updateAllStoreCardButtons() {
            console.log('🔄 全店舗カードのボタン状態を更新中...');
            
            // 店舗一覧のカードを更新
            const storeCards = document.querySelectorAll('.store-card');
            storeCards.forEach(card => {
                const storeId = card.dataset.storeId;
                if (storeId) {
                    updateStoreCardButtons(storeId, card);
                    // ついでにポップアップのボタンも更新（開いている場合）
                    updatePopupButtons(storeId);
                }
            });
            
            console.log('✅ 店舗カードとポップアップのボタン状態更新完了');
        }
        
        // 個別店舗カードのボタン状態を更新
        function updateStoreCardButtons(storeId, cardElement) {
            const status = userVisitHistory.get(`${storeId}`);
            const isWantToGo = status === 'want_to_go';
            const isVisited = status === 'visited';
            
            // 「行きたい」ボタンの更新
            const wantToGoBtn = cardElement.querySelector('.action-btn.want-to-go');
            if (wantToGoBtn) {
                if (isWantToGo) {
                    wantToGoBtn.classList.add('active');
                } else {
                    wantToGoBtn.classList.remove('active');
                }
            }
            
            // 「行った」ボタンの更新
            const visitedBtn = cardElement.querySelector('.action-btn.visited');
            if (visitedBtn) {
                if (isVisited) {
                    visitedBtn.classList.add('active');
                } else {
                    visitedBtn.classList.remove('active');
                }
            }
        }
        
        // マップポップアップ内のボタン状態を更新
        function updatePopupButtons(storeId) {
            const status = userVisitHistory.get(`${storeId}`);
            const isWantToGo = status === 'want_to_go';
            const isVisited = status === 'visited';
            
            // ポップアップ内の「行きたい」ボタンを更新
            const popupWantBtns = document.querySelectorAll(`.popup-action-btn.want-to-go[data-store-id="${storeId}"]`);
            popupWantBtns.forEach(btn => {
                if (isWantToGo) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // ポップアップ内の「行った」ボタンを更新
            const popupVisitedBtns = document.querySelectorAll(`.popup-action-btn.visited[data-store-id="${storeId}"]`);
            popupVisitedBtns.forEach(btn => {
                if (isVisited) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // 詳細モーダル内のボタン状態を更新
        function updateDetailButtons(storeId) {
            const status = userVisitHistory.get(`${storeId}`);
            const isWantToGo = status === 'want_to_go';
            const isVisited = status === 'visited';
            
            // 詳細モーダル内の「行きたい」ボタンを更新
            const detailWantBtn = document.getElementById(`detailWantToGoBtn-${storeId}`);
            if (detailWantBtn) {
                if (isWantToGo) {
                    detailWantBtn.classList.add('active');
                } else {
                    detailWantBtn.classList.remove('active');
                }
            }
            
            // 詳細モーダル内の「行った」ボタンを更新
            const detailVisitedBtn = document.getElementById(`detailVisitedBtn-${storeId}`);
            if (detailVisitedBtn) {
                if (isVisited) {
                    detailVisitedBtn.classList.add('active');
                } else {
                    detailVisitedBtn.classList.remove('active');
                }
            }
        }
        
        // 検索ボタンのイベントリスナーを強制再設定
        function reinitializeSearchButton() {
            console.log('🔄 検索ボタンの強制再設定開始');
            
            const searchToggleBtn = document.getElementById('searchToggleBtn');
            const mobileSearchFilter = document.getElementById('mobileSearchFilter');
            
            if (searchToggleBtn && mobileSearchFilter) {
                // 既存のイベントリスナーをクリア（クローンで置き換え）
                const newSearchBtn = searchToggleBtn.cloneNode(true);
                searchToggleBtn.parentNode.replaceChild(newSearchBtn, searchToggleBtn);
                
                // 新しいイベントリスナーを設定
                newSearchBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('🔍 検索ボタンがクリックされました（強制再設定版）');
                    
                    // 検索エリアの表示/非表示を切り替え
                    if (mobileSearchFilter.classList.contains('show')) {
                        console.log('🔍 検索エリアを非表示にします');
                        mobileSearchFilter.classList.remove('show');
                        newSearchBtn.classList.remove('active');
                        newSearchBtn.querySelector('.search-icon').textContent = '🔍';
                    } else {
                        console.log('🔍 検索エリアを表示します');
                        mobileSearchFilter.classList.add('show');
                        newSearchBtn.classList.add('active');
                        newSearchBtn.querySelector('.search-icon').textContent = '✕';
                    }
                });
                
                console.log('✅ 検索ボタンの強制再設定完了');
                
                // 検索エリアの状態をデバッグ出力
                debugSearchAreaStatus();
            } else {
                console.error('❌ 検索ボタンまたは検索フィルター要素が見つかりません（強制再設定）');
            }
        }
        
        // 検索エリアの状態をデバッグ
        function debugSearchAreaStatus() {
            const searchToggleBtn = document.getElementById('searchToggleBtn');
            const mobileSearchFilter = document.getElementById('mobileSearchFilter');
            
            console.log('🔍 検索エリア状態デバッグ:');
            console.log('- 検索ボタン存在:', !!searchToggleBtn);
            console.log('- 検索フィルター存在:', !!mobileSearchFilter);
            
            if (searchToggleBtn) {
                console.log('- ボタンクラス:', searchToggleBtn.className);
                console.log('- アクティブ状態:', searchToggleBtn.classList.contains('active'));
            }
            
            if (mobileSearchFilter) {
                console.log('- フィルタークラス:', mobileSearchFilter.className);
                console.log('- show状態:', mobileSearchFilter.classList.contains('show'));
                console.log('- 表示スタイル:', window.getComputedStyle(mobileSearchFilter).display);
                console.log('- 最大高さ:', window.getComputedStyle(mobileSearchFilter).maxHeight);
                console.log('- Z-index:', window.getComputedStyle(mobileSearchFilter).zIndex);
                console.log('- 位置:', {
                    top: window.getComputedStyle(mobileSearchFilter).top,
                    left: window.getComputedStyle(mobileSearchFilter).left,
                    right: window.getComputedStyle(mobileSearchFilter).right
                });
            }
        }
        
        // テスト用: 手動で検索エリアを表示/非表示
        window.testSearchToggle = function() {
            console.log('🔧 手動検索テスト実行');
            const mobileSearchFilter = document.getElementById('mobileSearchFilter');
            const searchToggleBtn = document.getElementById('searchToggleBtn');
            
            if (mobileSearchFilter) {
                if (mobileSearchFilter.classList.contains('show')) {
                    mobileSearchFilter.classList.remove('show');
                    console.log('🔧 検索エリアを非表示にしました');
                } else {
                    mobileSearchFilter.classList.add('show');
                    console.log('🔧 検索エリアを表示しました');
                }
                
                if (searchToggleBtn) {
                    searchToggleBtn.classList.toggle('active');
                    const icon = searchToggleBtn.querySelector('.search-icon');
                    if (icon) {
                        icon.textContent = mobileSearchFilter.classList.contains('show') ? '✕' : '🔍';
                    }
                }
                
                debugSearchAreaStatus();
            } else {
                console.error('🔧 検索フィルター要素が見つかりません');
            }
        };

        // Supabaseから訪問履歴を読み込み
        async function loadVisitHistoryFromSupabase() {
            try {
                console.log('🔄 Supabaseから訪問履歴を読み込み中...');
                
                const { data, error } = await supabaseClient
                    .from('visit_history')
                    .select('store_id, status')
                    .eq('user_email', currentUser);

                if (error) {
                    console.error('❌ Supabase読み込みエラー:', error);
                    throw error;
                }

                if (data) {
                    userVisitHistory.clear();
                    data.forEach(item => {
                        userVisitHistory.set(`${item.store_id}`, item.status);
                    });
                    console.log('✅ Supabaseから訪問履歴を読み込み:', data.length, '件');
                    
                    // 読み込み完了後に店舗カードのボタン状態を更新（遅延実行）
                    setTimeout(() => {
                        updateAllStoreCardButtons();
                    }, 150);
                }
            } catch (error) {
                console.error('❌ 訪問履歴読み込み失敗:', error);
                // エラーが発生してもローカルストレージから読み込みを試行
            }
        }

        // 訪問ステータス切り替え
        async function toggleVisitStatus(storeId, status) {
            console.log('📝 訪問ステータス更新:', storeId, status);
            
            // 即座に視覚的フィードバックを提供
            const clickedButton = event.target.closest('.action-btn, .popup-action-btn');
            if (clickedButton) {
                clickedButton.classList.add('pressing');
                setTimeout(() => {
                    clickedButton.classList.remove('pressing');
                }, 100);
            }
            
            if (!currentUser) {
                alert('ユーザー認証が必要です');
                return;
            }
            
            const key = `${storeId}`;
            const currentStatus = userVisitHistory.get(key);
            
            if (currentStatus === status) {
                // 同じステータスの場合は削除
                userVisitHistory.delete(key);
                await deleteVisitHistoryFromSupabase(storeId);
                console.log('🗑️ 訪問ステータス削除:', storeId);
            } else {
                // 新しいステータスを設定
                userVisitHistory.set(key, status);
                await saveVisitHistoryToSupabase(storeId, status);
                console.log('✅ 訪問ステータス設定:', storeId, status);
            }
            
            // ローカルストレージにもバックアップ保存
            const obj = Object.fromEntries(userVisitHistory);
            localStorage.setItem('visit_history', JSON.stringify(obj));
            
            // UIを更新
            updateVisitButtonsForStore(storeId);
            
            // 現在履歴ビューを表示している場合は更新
            const historyView = document.getElementById('visitHistoryView');
            if (historyView && !historyView.classList.contains('hidden')) {
                const activeTab = document.querySelector('.nav-btn.active');
                if (activeTab && activeTab.dataset.tab !== 'map') {
                    updateHistoryView(activeTab.dataset.tab);
                }
            }
            
            console.log('💾 訪問履歴保存完了');
        }

        // Supabaseに訪問履歴を保存
        async function saveVisitHistoryToSupabase(storeId, status) {
            try {
                console.log('💾 Supabaseに保存中...', storeId, status);
                
                // 既存レコードを削除してから挿入（UPSERT的な動作）
                const { error: deleteError } = await supabaseClient
                    .from('visit_history')
                    .delete()
                    .eq('user_email', currentUser)
                    .eq('store_id', storeId);

                if (deleteError) {
                    console.warn('⚠️ 既存レコード削除エラー:', deleteError);
                }

                // 新しいレコードを挿入
                const { data, error } = await supabaseClient
                    .from('visit_history')
                    .insert([
                        {
                            user_email: currentUser,
                            store_id: storeId,
                            status: status,
                            visited_date: status === 'visited' ? new Date().toISOString().split('T')[0] : null,
                            notes: null
                        }
                    ]);

                if (error) {
                    console.error('❌ Supabase保存エラー:', error);
                    throw error;
                } else {
                    console.log('✅ Supabase保存成功');
                }
            } catch (error) {
                console.error('❌ 訪問履歴保存失敗:', error);
                // エラーが発生してもローカルには保存されているので続行
            }
        }

        // Supabaseから訪問履歴を削除
        async function deleteVisitHistoryFromSupabase(storeId) {
            try {
                console.log('🗑️ Supabaseから削除中...', storeId);
                
                const { error } = await supabaseClient
                    .from('visit_history')
                    .delete()
                    .eq('user_email', currentUser)
                    .eq('store_id', storeId);

                if (error) {
                    console.error('❌ Supabase削除エラー:', error);
                    throw error;
                } else {
                    console.log('✅ Supabase削除成功');
                }
            } catch (error) {
                console.error('❌ 訪問履歴削除失敗:', error);
                // エラーが発生してもローカルからは削除されているので続行
            }
        }

        // 特定店舗の訪問ボタンUI更新
        function updateVisitButtonsForStore(storeId) {
            const status = userVisitHistory.get(`${storeId}`);
            
            // ポップアップ内のボタンを更新（新しいクラス名に対応）
            const popupWantBtns = document.querySelectorAll(`.popup-action-btn.want-to-go[data-store-id="${storeId}"]`);
            const popupVisitedBtns = document.querySelectorAll(`.popup-action-btn.visited[data-store-id="${storeId}"]`);
            
            // 店舗カード内のボタンを更新
            const cardWantBtns = document.querySelectorAll(`.action-btn.want-to-go[onclick*="${storeId}"]`);
            const cardVisitedBtns = document.querySelectorAll(`.action-btn.visited[onclick*="${storeId}"]`);
            
            // ポップアップのボタン更新
            popupWantBtns.forEach(btn => {
                btn.classList.toggle('active', status === 'want_to_go');
                if (status === 'want_to_go') {
                    btn.style.animation = 'buttonPress 0.2s ease';
                }
            });
            
            popupVisitedBtns.forEach(btn => {
                btn.classList.toggle('active', status === 'visited');
                if (status === 'visited') {
                    btn.style.animation = 'buttonPress 0.2s ease';
                }
            });
            
            // 店舗カードのボタン更新
            cardWantBtns.forEach(btn => {
                btn.classList.toggle('active', status === 'want_to_go');
                if (status === 'want_to_go') {
                    btn.style.animation = 'buttonPress 0.2s ease';
                }
            });
            
            cardVisitedBtns.forEach(btn => {
                btn.classList.toggle('active', status === 'visited');
                if (status === 'visited') {
                    btn.style.animation = 'buttonPress 0.2s ease';
                }
            });
            
            // アニメーション終了後にリセット
            setTimeout(() => {
                document.querySelectorAll('.action-btn, .popup-action-btn').forEach(btn => {
                    btn.style.animation = '';
                });
            }, 200);
        }

        // 認証状態変更の監視設定
        function setupAuthStateListener() {
            console.log('👁️ 認証状態変更の監視を開始');
            
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log('🔄 認証状態変更:', event, session ? `user: ${session.user.email}` : 'no session');
                
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user.email;
                    console.log('✅ ログイン成功:', currentUser);
                    
                    // ログイン成功時は直接マップ画面を表示（リロードしない）
                    console.log('🔄 認証成功 - マップ画面を表示');
                    showMapScreen();
                    
                    // プロフィール情報を読み込み（重要: ヘッダー初期化前に実行）
                    await loadUserProfile();
                    console.log('📱 プロフィール情報読み込み完了');
                    
                    // 地図の初期化とデータ読み込み（まだ初期化されていない場合のみ）
                    if (!window.mapInitialized) {
                        loadEmbeddedStores();
                        initMap();
                        setupEventListeners();
                        checkDatabaseStatus();
                        initializeHeaderActions();
                        window.mapInitialized = true;
                    } else {
                        // 既に初期化済みの場合はヘッダーのみ更新
                        initializeHeaderActions();
                    }
                    
                } else if (event === 'SIGNED_OUT') {
                    console.log('🚪 ログアウト');
                    currentUser = 'demo_user@example.com';
                    userVisitHistory.clear();
                    initializeHeaderActions();
                    
                } else if (event === 'TOKEN_REFRESHED' && session) {
                    console.log('🔄 トークン更新:', session.user.email);
                    currentUser = session.user.email;
                    initializeHeaderActions();
                }
            });
        }

        // 認証確認
        async function checkAuthentication() {
            try {
                console.log('🔐 認証状態を確認中...');
                
                // まずセッションを確認
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError) {
                    console.warn('⚠️ セッション確認エラー:', sessionError.message);
                } else if (session && session.user) {
                    currentUser = session.user.email;
                    console.log('✅ セッションから認証済みユーザーを確認:', currentUser);
                    return;
                }
                
                // セッションがない場合、ユーザー情報を確認
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (userError) {
                    console.warn('⚠️ ユーザー確認エラー、デモモードで続行:', userError.message);
                } else if (user && user.email) {
                    currentUser = user.email;
                    console.log('✅ 認証済みユーザー:', currentUser);
                    return;
                }
                
                // 両方とも失敗した場合、デモモードに設定
                console.log('⚠️ 未認証状態、デモモードで続行');
                currentUser = 'demo_user@example.com';
                
            } catch (error) {
                console.warn('⚠️ 認証情報エラー、デモモードで実行:', error.message || error);
                currentUser = 'demo_user@example.com'; // フォールバック
            }
        }

        // Google認証（オプション機能）
        async function signInWithGoogle() {
            try {
                console.log('🔐 Google認証を開始...');
                
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://bettger3000.github.io/naco-gluten-free-map/'
                    }
                });
                
                if (error) {
                    console.error('❌ Google認証エラー:', error);
                    alert('認証に失敗しました。デモモードで続行します。');
                } else {
                    console.log('✅ Google認証成功');
                }
            } catch (error) {
                console.error('❌ 認証処理エラー:', error);
                alert('認証に失敗しました。デモモードで続行します。');
            }
        }

        // 認証ボタンハンドラー
        async function handleAuth() {
            console.log('🔘 ログインボタンがクリックされました');
            console.log('現在のユーザー:', currentUser);
            
            if (currentUser && currentUser !== 'demo_user@example.com') {
                console.log('ログアウト処理を開始...');
                await signOut();
            } else {
                console.log('Google認証を開始...');
                await signInWithGoogle();
            }
        }

        // ログアウト
        async function signOut() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) {
                    console.error('❌ ログアウトエラー:', error);
                } else {
                    console.log('✅ ログアウト成功');
                    currentUser = 'demo_user';
                    userVisitHistory.clear();
                    location.reload();
                }
            } catch (error) {
                console.error('❌ ログアウト処理エラー:', error);
            }
        }

        // オーバーレイパネル初期化
        function initOverlayPanel() {
            console.log('📦 オーバーレイパネル初期化開始');
            
            const panel = document.getElementById('overlayPanel');
            const panelContent = document.getElementById('panelContent');
            
            if (!panel) {
                console.error('オーバーレイパネル要素が見つかりません');
                return;
            }
            
            let panelState = 'collapsed'; // collapsed, half, full
            
            // パネル位置設定
            function setPanelPosition(state) {
                panelState = state;
                panel.classList.remove('half-open', 'full-open');
                
                // パネル位置をCSS変数として設定
                let panelTop = window.innerHeight - 120; // collapsed
                if (state === 'half') {
                    panelTop = window.innerHeight * 0.5;
                } else if (state === 'full') {
                    panelTop = 80;
                }
                document.documentElement.style.setProperty('--panel-top', panelTop + 'px');
                
                // 状態インジケーターを更新
                document.querySelectorAll('.state-dot').forEach(dot => {
                    dot.classList.remove('active');
                });
                
                const downBtn = document.getElementById('panelDownBtn');
                const upBtn = document.getElementById('panelUpBtn');
                
                if (state === 'collapsed') {
                    document.getElementById('stateDot1').classList.add('active');
                    downBtn.disabled = true;
                    upBtn.disabled = false;
                } else if (state === 'half') {
                    panel.classList.add('half-open');
                    document.getElementById('stateDot2').classList.add('active');
                    downBtn.disabled = false;
                    upBtn.disabled = false;
                } else if (state === 'full') {
                    panel.classList.add('full-open');
                    document.getElementById('stateDot3').classList.add('active');
                    downBtn.disabled = false;
                    upBtn.disabled = true;
                }
            }
            
            
            // 検索トグルボタン
            const searchToggleBtn = document.getElementById('searchToggleBtn');
            const mobileSearchFilter = document.getElementById('mobileSearchFilter');
            
            if (searchToggleBtn && mobileSearchFilter) {
                console.log('🔍 検索ボタンのイベントリスナー設定開始');
                searchToggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('🔍 検索ボタンがクリックされました');
                    
                    // 検索エリアの表示/非表示を切り替え
                    if (mobileSearchFilter.classList.contains('show')) {
                        console.log('🔍 検索エリアを非表示にします');
                        mobileSearchFilter.classList.remove('show');
                        searchToggleBtn.classList.remove('active');
                        searchToggleBtn.querySelector('.search-icon').textContent = '🔍';
                    } else {
                        console.log('🔍 検索エリアを表示します');
                        mobileSearchFilter.classList.add('show');
                        searchToggleBtn.classList.add('active');
                        searchToggleBtn.querySelector('.search-icon').textContent = '✕';
                    }
                });
                console.log('🔍 検索ボタンのイベントリスナー設定完了');
            } else {
                console.error('❌ 検索ボタンまたは検索フィルター要素が見つかりません', {
                    searchToggleBtn: !!searchToggleBtn,
                    mobileSearchFilter: !!mobileSearchFilter
                });
            }
            
            // 2ボタンコントロール（上下矢印）
            document.getElementById('panelDownBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                
                // 一段階下げる
                if (panelState === 'full') {
                    setPanelPosition('half');
                } else if (panelState === 'half') {
                    setPanelPosition('collapsed');
                }
            });
            
            document.getElementById('panelUpBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                
                // 一段階上げる
                if (panelState === 'collapsed') {
                    setPanelPosition('half');
                } else if (panelState === 'half') {
                    setPanelPosition('full');
                }
            });
            
            // タブ切り替え
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    updatePanelContent(tab.dataset.tab);
                });
            });
            
            // 初期表示
            updatePanelContent('all');
            setPanelPosition('collapsed'); // 初期状態は閉じた状態
            
            // 初期化フラグを設定
            const overlayPanel = document.getElementById('overlayPanel');
            if (overlayPanel) {
                overlayPanel.classList.add('initialized');
            }
            
            console.log('✅ オーバーレイパネル初期化完了');
        }

        // パネルコンテンツ更新
        function updatePanelContent(tab) {
            console.log('📋 パネルコンテンツ更新:', tab);
            
            const panelContent = document.getElementById('panelContent');
            if (!panelContent) return;
            
            // まず検索・カテゴリフィルターを適用
            let filteredStores = [...stores];
            
            // モバイル版の検索・カテゴリフィルターを適用
            if (!isDesktop()) {
                const mobileSearchInput = document.getElementById('mobileSearchInput');
                const searchText = mobileSearchInput ? mobileSearchInput.value.toLowerCase() : '';
                
                const activeChip = document.querySelector('.mobile-chip.active');
                const selectedCategory = activeChip ? activeChip.dataset.category : '';
                
                filteredStores = filteredStores.filter(store => {
                    const matchesCategory = !selectedCategory || store.category === selectedCategory;
                    const matchesSearch = !searchText ||
                        (store.name && store.name.toLowerCase().includes(searchText)) ||
                        (store.address && store.address.toLowerCase().includes(searchText)) ||
                        (store.description && store.description.toLowerCase().includes(searchText));
                    
                    return matchesCategory && matchesSearch;
                });
            }
            
            // 訪問ステータスフィルターを適用
            if (tab === 'want-to-go') {
                filteredStores = filteredStores.filter(store => {
                    const status = userVisitHistory.get(`${store.id}`);
                    return status === 'want_to_go';
                });
            } else if (tab === 'visited') {
                filteredStores = filteredStores.filter(store => {
                    const status = userVisitHistory.get(`${store.id}`);
                    return status === 'visited';
                });
            }
            
            // 店舗数更新
            const countEl = document.getElementById('panelStoreCount');
            if (countEl) {
                if (tab === 'all') {
                    countEl.textContent = `店舗リスト ${filteredStores.length}件`;
                } else if (tab === 'want-to-go') {
                    countEl.textContent = `行きたい ${filteredStores.length}件`;
                } else if (tab === 'visited') {
                    countEl.textContent = `行った ${filteredStores.length}件`;
                }
            }
            
            displayPanelStoreList(filteredStores, panelContent);
        }
        
        // パネル用店舗リスト表示
        function displayPanelStoreList(storesData, container) {
            if (!container) return;
            
            container.innerHTML = '';
            
            if (storesData.length === 0) {
                container.innerHTML = '<div class="loading-indicator">表示する店舗がありません</div>';
                return;
            }
            
            // 現在地から近い順にソート
            let sortedStores = [...storesData];
            if (currentUserLocation) {
                sortedStores = sortedStores.sort((a, b) => {
                    if (!a.latitude || !a.longitude || !b.latitude || !b.longitude) return 0;
                    const distanceA = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, a.latitude, a.longitude);
                    const distanceB = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, b.latitude, b.longitude);
                    return distanceA - distanceB;
                });
            }
            
            sortedStores.forEach(store => {
                try {
                    const card = createPanelStoreCard(store);
                    container.appendChild(card);
                } catch (error) {
                    console.error(`店舗「${store.name}」のカード作成エラー:`, error);
                }
            });
        }
        
        // パネル用店舗カード作成
        function createPanelStoreCard(store) {
            const card = document.createElement('div');
            card.className = 'store-card';
            card.dataset.storeId = store.id;
            
            const status = userVisitHistory.get(`${store.id}`);
            const isWantToGo = status === 'want_to_go';
            const isVisited = status === 'visited';
            
            // 現在地からの距離を計算
            let distanceText = '';
            if (currentUserLocation && store.latitude && store.longitude) {
                const distance = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, store.latitude, store.longitude);
                if (distance < 1) {
                    distanceText = `${Math.round(distance * 1000)}m`;
                } else {
                    distanceText = `${distance.toFixed(1)}km`;
                }
            }
            
            const categoryConfig = {
                'カフェ': { icon: '☕', color: '#8B4513' },
                '和食': { icon: '🍱', color: '#006400' },
                '洋食': { icon: '🍽️', color: '#FF6347' },
                'パン屋': { icon: '🥐', color: '#FFA500' },
                'スイーツ': { icon: '🧁', color: '#FF69B4' },
                '販売店': { icon: '🛒', color: '#4169E1' },
                'その他': { icon: '🏪', color: '#808080' }
            };
            
            const config = categoryConfig[store.category] || categoryConfig['その他'];
            
            card.innerHTML = `
                <div class="store-header">
                    <div class="store-name">${escapeHtml(store.name || '')}</div>
                    ${distanceText ? `<div class="store-distance">${distanceText}</div>` : ''}
                </div>
                <div class="store-meta">
                    <span class="category-badge" style="background: ${config.color}15; color: ${config.color}; border: 1px solid ${config.color}30;">
                        ${config.icon} ${escapeHtml(store.category || '')}
                    </span>
                </div>
                <div class="store-info">
                    <div class="info-item">
                        <span class="info-icon">📍</span>
                        <span class="info-text">${escapeHtml(store.address || '')}</span>
                    </div>
                    ${store.gluten_free_options ? `
                        <div class="info-item">
                            <span class="info-icon">🌾</span>
                            <span class="info-text">${escapeHtml(store.gluten_free_options)}</span>
                        </div>
                    ` : ''}
                </div>
                <div class="store-card-actions">
                    <button class="action-btn want-to-go ${isWantToGo ? 'active' : ''}" 
                            onclick="toggleVisitStatus(${store.id}, 'want_to_go')">
                        🤍 行きたい
                    </button>
                    <button class="action-btn visited ${isVisited ? 'active' : ''}" 
                            onclick="toggleVisitStatus(${store.id}, 'visited')">
                        ✨ 行った
                    </button>
                    <button class="action-btn" onclick="openStoreDetail(${store.id})">
                        📋 詳細
                    </button>
                </div>
            `;
            
            return card;
        }
        
        // 店舗にフォーカス
        function focusOnStore(storeId) {
            const store = stores.find(s => s.id === storeId);
            if (store && map) {
                map.setView([store.latitude, store.longitude], 16);
                
                // パネルを閉じる
                const panel = document.getElementById('overlayPanel');
                if (panel) {
                    panel.classList.remove('half-open', 'full-open');
                }
                
                // マーカーのポップアップを開く
                setTimeout(() => {
                    const marker = markers.find(m => m.storeId === storeId);
                    if (marker) {
                        marker.openPopup();
                    }
                }, 300);
            }
        }
        
        // タブ切り替え（古い関数、互換性のため残す）
        function switchTab(tab) {
            console.log('🔄 タブ切り替え:', tab);
            
            // 導航ボタンのアクティブ状態更新
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            const mainContent = document.querySelector('.main-content');
            const historyView = document.getElementById('visitHistoryView');
            
            // 要素の存在チェック
            if (!mainContent) {
                console.error('❌ .main-content要素が見つかりません');
                return;
            }
            if (!historyView) {
                console.error('❌ visitHistoryView要素が見つかりません');
                return;
            }
            
            if (tab === 'map') {
                // 地図表示
                mainContent.style.display = 'block';
                historyView.classList.add('hidden');
            } else {
                // 履歴表示
                mainContent.style.display = 'none';
                historyView.classList.remove('hidden');
                updateHistoryView(tab);
            }
        }

        // 履歴ビュー更新
        function updateHistoryView(type) {
            console.log('📝 履歴ビュー更新:', type);
            
            const titleEl = document.getElementById('historyTitle');
            const countEl = document.getElementById('historyCount');
            const listEl = document.getElementById('historyList');
            
            // 要素の存在チェック
            if (!titleEl || !countEl || !listEl) {
                console.error('❌ 履歴ビュー要素が見つかりません:', {
                    titleEl: !!titleEl,
                    countEl: !!countEl,
                    listEl: !!listEl
                });
                return;
            }
            
            // タイトル設定
            titleEl.textContent = type === 'want-to-go' ? '行きたいお店' : '行ったお店';
            
            // フィルタリング
            const filteredStores = stores.filter(store => {
                const status = userVisitHistory.get(`${store.id}`);
                return status === (type === 'want-to-go' ? 'want_to_go' : 'visited');
            });
            
            // 件数更新
            countEl.textContent = `${filteredStores.length}件`;
            
            // リスト生成
            if (filteredStores.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">${type === 'want-to-go' ? '🤍' : '✨'}</div>
                        <div class="empty-message">まだ${type === 'want-to-go' ? '行きたいお店' : '行ったお店'}がありません</div>
                    </div>
                `;
            } else {
                listEl.innerHTML = filteredStores.map(store => createHistoryItem(store, type)).join('');
            }
        }

        // 履歴アイテム生成
        function createHistoryItem(store, type) {
            const categoryClass = getCategoryClass(store.category);
            const categoryColor = categoryColors[store.category] || '#666';
            
            return `
                <div class="history-item" data-store-id="${store.id}">
                    <div class="history-item-header">
                        <div class="history-store-name">${escapeHtml(store.name || '')}</div>
                        <div class="history-category" style="background-color: ${categoryColor}">
                            ${escapeHtml(store.category || '')}
                        </div>
                    </div>
                    <div class="history-address">${escapeHtml(store.address || '')}</div>
                    <div class="history-actions">
                        <button class="history-action-btn" onclick="openStoreDetail(${store.id})">
                            詳細を見る
                        </button>
                        <button class="history-action-btn" onclick="toggleVisitStatus(${store.id}, '${type === 'want-to-go' ? 'want_to_go' : 'visited'}')">
                            削除
                        </button>
                    </div>
                </div>
            `;
        }

        // 地図で店舗を表示
        function showStoreOnMap(storeId) {
            console.log('🗺️ 地図で店舗表示:', storeId);
            
            // 地図タブに切り替え
            switchTab('map');
            
            // 店舗を探してフォーカス
            const store = stores.find(s => s.id === storeId);
            if (store && map) {
                map.setView([store.latitude, store.longitude], 16);
                
                // マーカーのポップアップを開く
                setTimeout(() => {
                    const marker = markers.find(m => m.storeId === storeId);
                    if (marker) {
                        marker.openPopup();
                    }
                }, 300);
            }
        }

        // Supabase接続テスト関数
        async function testSupabaseConnection() {
            console.log('🔍 Supabase接続テスト開始...');
            
            try {
                // 1. visit_historyテーブルの存在と構造確認
                console.log('1. visit_historyテーブル確認...');
                const { data: visitHistory, error: visitError } = await supabaseClient
                    .from('visit_history')
                    .select('*')
                    .limit(5);
                    
                if (visitError) {
                    console.error('❌ visit_historyテーブルエラー:', visitError);
                    
                    // テーブルが存在しない場合、作成を試行
                    console.log('🛠️ visit_historyテーブルが存在しない可能性があります');
                } else {
                    console.log('✅ visit_historyテーブル接続成功');
                    console.log('📋 既存の訪問履歴データ:', visitHistory?.length, '件');
                    if (visitHistory && visitHistory.length > 0) {
                        console.log('📊 サンプルデータ:', visitHistory);
                    }
                }
                
                // 2. user_profilesテーブル確認
                console.log('2. user_profilesテーブル確認...');
                const { data: profiles, error: profileError } = await supabaseClient
                    .from('user_profiles')
                    .select('email, nickname')
                    .limit(3);
                    
                if (profileError) {
                    console.error('❌ user_profilesテーブルエラー:', profileError);
                } else {
                    console.log('✅ user_profilesテーブル接続成功:', profiles?.length, '件');
                    console.log('👤 ユーザープロファイル:', profiles);
                }
                
                // 3. storesテーブル確認
                console.log('3. storesテーブル確認...');
                const { data: stores, error: storeError } = await supabaseClient
                    .from('stores')
                    .select('id, name, category_id')
                    .limit(5);
                    
                if (storeError) {
                    console.error('❌ storesテーブルエラー:', storeError);
                } else {
                    console.log('✅ storesテーブル接続成功:', stores?.length, '件');
                    console.log('🏪 店舗データサンプル:', stores);
                }
                
                // 4. テーブルスキーマ情報の取得試行
                console.log('4. データベース情報確認...');
                const { data: schemaInfo, error: schemaError } = await supabaseClient
                    .from('information_schema.tables')
                    .select('table_name')
                    .eq('table_schema', 'public')
                    .in('table_name', ['visit_history', 'user_profiles', 'stores', 'store_categories']);
                
                if (!schemaError && schemaInfo) {
                    console.log('📋 存在するテーブル:', schemaInfo.map(t => t.table_name));
                }
                
                return true;
            } catch (error) {
                console.error('❌ Supabase接続テスト失敗:', error);
                return false;
            }
        }

        // テストデータ挿入機能
        async function insertTestVisitHistory() {
            console.log('🧪 テスト訪問履歴データ挿入開始...');
            
            try {
                const testUser = 'demo_user@example.com';
                const testStoreId = 1; // みちのり亭のID
                
                // 1. user_profilesにテストユーザーを作成
                const { error: userError } = await supabaseClient
                    .from('user_profiles')
                    .upsert({
                        email: testUser,
                        nickname: 'テストユーザー',
                        is_active: true
                    });
                
                if (userError) {
                    console.error('❌ テストユーザー作成エラー:', userError);
                } else {
                    console.log('✅ テストユーザー作成成功');
                }
                
                // 2. visit_historyにテストデータ挿入
                const { data: insertData, error: insertError } = await supabaseClient
                    .from('visit_history')
                    .insert([
                        {
                            user_email: testUser,
                            store_id: testStoreId,
                            status: 'want_to_go',
                            notes: 'テスト用の行きたい店データ'
                        }
                    ])
                    .select();
                
                if (insertError) {
                    console.error('❌ テストデータ挿入エラー:', insertError);
                } else {
                    console.log('✅ テストデータ挿入成功:', insertData);
                }
                
                // 3. データ確認
                const { data: checkData, error: checkError } = await supabaseClient
                    .from('visit_history')
                    .select('*')
                    .eq('user_email', testUser);
                
                if (!checkError && checkData) {
                    console.log('📊 挿入確認結果:', checkData);
                }
                
            } catch (error) {
                console.error('❌ テストデータ挿入失敗:', error);
            }
        }

        // テスト関数をグローバルに公開
        window.insertTestData = insertTestVisitHistory;

        // 認証状態デバッグ機能
        async function debugAuthentication() {
            console.log('🔍=== 認証状態デバッグ開始 ===');
            
            try {
                // 1. Supabaseクライアント確認
                console.log('1. Supabaseクライアント:', supabaseClient ? '✅ 初期化済み' : '❌ 未初期化');
                
                // 2. セッション確認
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                console.log('2. セッション確認:');
                if (sessionError) {
                    console.log('   ❌ セッションエラー:', sessionError);
                } else if (session) {
                    console.log('   ✅ セッション存在:', {
                        user: session.user.email,
                        expires_at: new Date(session.expires_at * 1000),
                        access_token: session.access_token ? '存在' : '不在'
                    });
                } else {
                    console.log('   ⚠️ セッション不在');
                }
                
                // 3. ユーザー確認
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                console.log('3. ユーザー確認:');
                if (userError) {
                    console.log('   ❌ ユーザーエラー:', userError);
                } else if (user) {
                    console.log('   ✅ ユーザー存在:', {
                        email: user.email,
                        id: user.id,
                        created_at: user.created_at
                    });
                } else {
                    console.log('   ⚠️ ユーザー不在');
                }
                
                // 4. 現在の状態
                console.log('4. 現在の認証状態:', {
                    currentUser: currentUser,
                    isDemo: currentUser === 'demo_user@example.com'
                });
                
            } catch (error) {
                console.error('❌ デバッグ中にエラー:', error);
            }
            
            console.log('🔍=== 認証状態デバッグ終了 ===');
        }

        // テスト実行用のグローバル関数として公開
        window.testSupabase = testSupabaseConnection;
        window.debugAuthentication = debugAuthentication;

        // =======================================
        // カスタムピン機能の実装
        // =======================================

        // カスタムピン機能初期化
        function initCustomPinFeature() {
            console.log('📍 カスタムピン機能を初期化中...');
            
            // UI要素を取得
            mapContextMenu = document.getElementById('mapContextMenu');
            
            // マップのイベントリスナーを設定
            setupMapEventListeners();
            
            // UI要素のイベントリスナーを設定
            setupPinUIEventListeners();
            
            // 外部クリックでメニュー閉じる
            document.addEventListener('click', hideContextMenu);
            
            
            console.log('✅ カスタムピン機能初期化完了');
        }

        // ピン設置モード管理
        let pinModeActive = false;
        
        // マップイベントリスナー設定
        function setupMapEventListeners() {
            console.log('🗺️ マップイベントリスナー設定中...');
            
            // PC版: クリックでピン設置
            map.on('click', function(e) {
                if (pinModeActive) {
                    console.log('📍 ピン設置モードでクリック');
                    setCustomPin(e.latlng);
                    togglePinMode(); // 設置後は自動でモードOFF
                } else {
                    hideContextMenu();
                }
            });
            
            console.log('✅ マップイベントリスナー設定完了');
        }

        // ピンモード切り替え
        function togglePinMode() {
            pinModeActive = !pinModeActive;
            
            // ボタンの表示を更新
            updatePinModeButtons();
            
            // ヒント表示
            if (pinModeActive) {
                showPinModeHint();
            } else {
                hidePinModeHint();
            }
            
            console.log('🎯 ピンモード:', pinModeActive ? 'ON' : 'OFF');
        }
        
        // ピンモードボタンの表示更新
        function updatePinModeButtons() {
            const buttons = document.querySelectorAll('.pin-mode-btn');
            buttons.forEach(btn => {
                if (pinModeActive) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // ピンモードヒント表示
        function showPinModeHint() {
            // 既存のヒントを削除
            const existingHint = document.querySelector('.pin-mode-hint');
            if (existingHint) {
                existingHint.remove();
            }
            
            // 新しいヒントを作成
            const hint = document.createElement('div');
            hint.className = 'pin-mode-hint';
            
            // PC版とモバイル版、ピンの有無に応じてメッセージを変更
            if (isDesktop()) {
                // PC版
                if (customPinMarker && customPinLocation) {
                    hint.innerHTML = '📍 新しいピン設置・<br>既存ピンダブルクリックで削除';
                } else {
                    hint.innerHTML = '📍 地図クリックでピン設置・<br>ピンダブルクリックで削除';
                }
            } else {
                // モバイル版
                if (customPinMarker && customPinLocation) {
                    hint.textContent = '📍 新しいピン設置・既存ピンダブルタップで削除';
                } else {
                    hint.textContent = '📍 地図タップでピン設置';
                }
            }
            
            const mapContainer = document.querySelector('.map-container');
            mapContainer.appendChild(hint);
            
            // 3秒後に自動で消す（少し長めに）
            setTimeout(() => {
                if (hint && hint.parentNode) {
                    hint.remove();
                }
            }, 3000);
        }
        
        // ピンモードヒント非表示
        function hidePinModeHint() {
            const hint = document.querySelector('.pin-mode-hint');
            if (hint) {
                hint.remove();
            }
        }
        
        // スマホ用ダブルタップ検出
        function setupMobileDoubleTap(marker) {
            let tapCount = 0;
            let tapTimer = null;
            
            marker.on('click', function(e) {
                tapCount++;
                
                if (tapCount === 1) {
                    // 最初のタップ - 300ms待機
                    tapTimer = setTimeout(() => {
                        tapCount = 0;
                        // 単一タップ時：ピンモードOFF時はガイダンス表示
                        if (!pinModeActive) {
                            showPinGuidanceMessage();
                        }
                    }, 300);
                } else if (tapCount === 2) {
                    // ダブルタップ検出 - ピン削除
                    clearTimeout(tapTimer);
                    tapCount = 0;
                    removeCustomPin();
                    e.originalEvent?.preventDefault();
                    e.originalEvent?.stopPropagation();
                }
            });
        }
        
        // ピンガイダンスメッセージ表示（ピンモードOFF時）
        function showPinGuidanceMessage() {
            // 既存のガイダンスを削除
            const existingGuidance = document.querySelector('.pin-guidance-message');
            if (existingGuidance) {
                existingGuidance.remove();
            }
            
            // 新しいガイダンスを作成
            const guidance = document.createElement('div');
            guidance.className = 'pin-guidance-message';
            
            // PC版とモバイル版で異なるメッセージを表示
            if (isDesktop()) {
                guidance.innerHTML = '📍 ピンモードをオンにして、<br>ダブルクリックで削除できます';
            } else {
                guidance.innerHTML = '📍 ダブルタップで削除できます';
            }
            
            const mapContainer = document.querySelector('.map-container');
            mapContainer.appendChild(guidance);
            
            // 4秒後に自動で消す
            setTimeout(() => {
                if (guidance && guidance.parentNode) {
                    guidance.remove();
                }
            }, 4000);
        }
        
        // ピンUI要素のイベントリスナー設定
        function setupPinUIEventListeners() {
            console.log('🎯 ピンUIイベントリスナー設定中...');
            
            // PC版ピンモードボタン（モバイル版）
            const pinModeBtn = document.getElementById('pinModeBtn');
            if (pinModeBtn) {
                pinModeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    togglePinMode();
                });
            }
            
            // PC版ピンモードボタン（サイドバー）
            const pcPinModeBtn = document.getElementById('pcPinModeBtn');
            if (pcPinModeBtn) {
                pcPinModeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    togglePinMode();
                });
            }
            
            
            
            console.log('✅ ピンUIイベントリスナー設定完了');
        }

        // コンテキストメニュー表示
        function showContextMenu(latlng, event) {
            if (!mapContextMenu) return;
            
            // 既存のピンがある場合は削除確認
            if (customPinMarker) {
                removeCustomPin();
            }
            
            // 座標を保存
            mapContextMenu.dataset.latlng = JSON.stringify(latlng);
            
            // メニューを一度表示してサイズを取得
            mapContextMenu.style.left = '0px';
            mapContextMenu.style.top = '0px';
            mapContextMenu.classList.remove('hidden');
            
            // 実際のメニューサイズを取得
            const rect = mapContextMenu.getBoundingClientRect();
            const menuWidth = rect.width;
            const menuHeight = rect.height;
            
            // map-containerの位置を取得
            const mapContainer = document.querySelector('.map-container');
            const mapRect = mapContainer.getBoundingClientRect();
            
            // マウス/タッチ位置をmap-container基準に変換
            let x = (event.clientX || event.touches?.[0]?.clientX || 0) - mapRect.left;
            let y = (event.clientY || event.touches?.[0]?.clientY || 0) - mapRect.top;
            
            // map-container内でのメニュー位置調整
            const containerWidth = mapRect.width;
            const containerHeight = mapRect.height;
            
            // 水平方向の調整（コンテナ内での左端、右端を考慮）
            if (x + menuWidth > containerWidth) {
                x = Math.max(10, containerWidth - menuWidth - 10);
            }
            if (x < 10) {
                x = 10;
            }
            
            // 垂直方向の調整（コンテナ内での上端、下端を考慮）
            if (y + menuHeight > containerHeight) {
                y = Math.max(10, y - menuHeight - 10);
            }
            if (y < 10) {
                y = 10;
            }
            
            // 最終位置を設定
            mapContextMenu.style.left = x + 'px';
            mapContextMenu.style.top = y + 'px';
            
            console.log('📍 コンテキストメニュー表示:', {
                latlng,
                position: { x, y },
                menuSize: { width: menuWidth, height: menuHeight },
                mapContainer: { width: containerWidth, height: containerHeight },
                mousePosition: { clientX: event.clientX, clientY: event.clientY }
            });
        }

        // コンテキストメニュー非表示
        function hideContextMenu() {
            if (mapContextMenu) {
                mapContextMenu.classList.add('hidden');
            }
        }

        // カスタムピン設置
        function setCustomPin(latlng) {
            console.log('📍 カスタムピン設置:', latlng);
            
            // 既存のピンを削除
            if (customPinMarker) {
                map.removeLayer(customPinMarker);
            }
            
            // カスタムピンアイコンを作成
            const customIcon = L.divIcon({
                className: 'custom-pin-marker',
                html: '',
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, -32]
            });
            
            // ピンマーカーを作成
            customPinMarker = L.marker(latlng, { icon: customIcon }).addTo(map);
            customPinLocation = latlng;
            
            // ピンのクリック・ダブルクリックイベントを設定
            if (isDesktop()) {
                // PC版：ピンモードON時のみ削除可能
                customPinMarker.on('click', function() {
                    if (!pinModeActive) {
                        showPinGuidanceMessage();
                    }
                });
                
                customPinMarker.on('dblclick', function() {
                    if (pinModeActive) {
                        removeCustomPin();
                    }
                });
            } else {
                // スマホ版：ピンモードに関係なくダブルタップで削除可能
                setupMobileDoubleTap(customPinMarker);
            }
            
            // ピンモードを無効にする
            if (pinModeActive) {
                togglePinMode();
            }
            
            // 店舗リストを距離順でソート・更新
            sortStoresByCustomPin();
            
            console.log('✅ カスタムピン設置完了');
        }

        // カスタムピン削除
        function removeCustomPin() {
            console.log('🗑️ カスタムピン削除');
            
            if (customPinMarker) {
                map.removeLayer(customPinMarker);
                customPinMarker = null;
            }
            
            customPinLocation = null;
            
            
            // 店舗リストを現在地基準に戻す
            if (isDesktop()) {
                displayStoreList(stores);
            } else {
                const activeTab = document.querySelector('.panel-tab.active');
                if (activeTab) {
                    updatePanelContent(activeTab.dataset.tab);
                }
            }
            
            console.log('✅ カスタムピン削除完了');
        }

        // カスタムピンから距離順で店舗をソート
        function sortStoresByCustomPin() {
            if (!customPinLocation) return;
            
            console.log('📏 カスタムピンからの距離でソート中...');
            
            // 距離を計算して店舗をソート
            const sortedStores = [...stores].sort((a, b) => {
                if (!a.latitude || !a.longitude || !b.latitude || !b.longitude) return 0;
                
                const distanceA = calculateDistance(
                    customPinLocation.lat, 
                    customPinLocation.lng, 
                    a.latitude, 
                    a.longitude
                );
                const distanceB = calculateDistance(
                    customPinLocation.lat, 
                    customPinLocation.lng, 
                    b.latitude, 
                    b.longitude
                );
                
                return distanceA - distanceB;
            });
            
            // PC版・モバイル版それぞれでリスト更新
            if (isDesktop()) {
                displayStoreListWithCustomDistance(sortedStores);
            } else {
                const activeTab = document.querySelector('.panel-tab.active');
                if (activeTab) {
                    updatePanelContentWithCustomDistance(activeTab.dataset.tab, sortedStores);
                }
            }
            
            console.log('✅ 距離順ソート完了');
        }

        // PC用: カスタムピンからの距離付き店舗リスト表示
        function displayStoreListWithCustomDistance(sortedStores) {
            const container = document.getElementById('storeList');
            if (!container) return;
            
            container.innerHTML = '';
            
            sortedStores.forEach(store => {
                if (!store.latitude || !store.longitude) return;
                
                const distance = calculateDistance(
                    customPinLocation.lat,
                    customPinLocation.lng,
                    store.latitude,
                    store.longitude
                );
                
                const distanceText = distance < 1 ? 
                    `${Math.round(distance * 1000)}m` : 
                    `${distance.toFixed(1)}km`;
                
                const card = document.createElement('div');
                card.className = 'store-card';
                card.innerHTML = createStoreCardHTML(store, `📍 ${distanceText}`);
                
                card.addEventListener('click', () => focusOnStore(store.id));
                container.appendChild(card);
            });
            
            // 件数更新
            updateStoreCount(sortedStores.length);
        }

        // モバイル用: カスタムピンからの距離でパネル更新
        function updatePanelContentWithCustomDistance(tab, sortedStores) {
            const panelContent = document.getElementById('panelContent');
            if (!panelContent) return;
            
            // タブフィルターを適用
            let filteredStores = [...sortedStores];
            if (tab === 'want-to-go') {
                filteredStores = filteredStores.filter(store => {
                    const status = userVisitHistory.get(`${store.id}`);
                    return status === 'want_to_go';
                });
            } else if (tab === 'visited') {
                filteredStores = filteredStores.filter(store => {
                    const status = userVisitHistory.get(`${store.id}`);
                    return status === 'visited';
                });
            }
            
            // 件数更新
            const countEl = document.getElementById('panelStoreCount');
            if (countEl) {
                if (tab === 'all') {
                    countEl.textContent = `📍 目的地から ${filteredStores.length}件`;
                } else if (tab === 'want-to-go') {
                    countEl.textContent = `📍 行きたい ${filteredStores.length}件`;
                } else if (tab === 'visited') {
                    countEl.textContent = `📍 行った ${filteredStores.length}件`;
                }
            }
            
            displayPanelStoreListWithDistance(filteredStores, panelContent);
        }

        // パネル用: 距離付き店舗リスト表示
        function displayPanelStoreListWithDistance(storesData, container) {
            if (!container || !customPinLocation) return;
            
            container.innerHTML = '';
            
            if (storesData.length === 0) {
                container.innerHTML = '<div class="loading-indicator">表示する店舗がありません</div>';
                return;
            }
            
            storesData.forEach(store => {
                if (!store.latitude || !store.longitude) return;
                
                const distance = calculateDistance(
                    customPinLocation.lat,
                    customPinLocation.lng,
                    store.latitude,
                    store.longitude
                );
                
                const distanceText = distance < 1 ? 
                    `${Math.round(distance * 1000)}m` : 
                    `${distance.toFixed(1)}km`;
                
                const card = document.createElement('div');
                card.className = 'panel-store-card';
                card.innerHTML = createPanelStoreCardHTML(store, `📍 ${distanceText}`);
                
                card.addEventListener('click', () => {
                    focusOnStore(store.id);
                    // モバイル版ではパネルを閉じる
                    if (!isDesktop()) {
                        setPanelPosition('collapsed');
                    }
                });
                
                container.appendChild(card);
            });
        }

        // PC用店舗カードHTML生成（距離表示付き）
        function createStoreCardHTML(store, distanceText = '') {
            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            
            // カテゴリ設定を取得
            const config = getCategoryConfig(store.category);
            
            return `
                <div class="store-header">
                    <h3 class="store-name">${storeName}</h3>
                    <div class="store-header-right">
                        <span class="store-category" data-category="${storeCategory}">${config.icon} ${storeCategory}</span>
                        ${distanceText ? `<span class="store-distance">${distanceText}</span>` : ''}
                    </div>
                </div>
                <div class="store-info">
                    <div class="store-address">
                        <i class="fas fa-map-marker-alt"></i>
                        ${storeAddress}
                    </div>
                    ${storeGfOptions ? `<div class="store-gf-options">✨ ${storeGfOptions}</div>` : ''}
                </div>
            `;
        }

        // パネル用店舗カードHTML生成（距離表示付き）
        function createPanelStoreCardHTML(store, distanceText = '') {
            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            
            // カテゴリ設定を取得
            const config = getCategoryConfig(store.category);
            
            // 訪問ステータスをチェック
            const visitStatus = userVisitHistory.get(`${store.id}`);
            const isWantToGo = visitStatus === 'want_to_go';
            const isVisited = visitStatus === 'visited';
            
            return `
                <div class="store-header">
                    <div class="store-name">${storeName}</div>
                    ${distanceText ? `<div class="store-distance">${distanceText}</div>` : ''}
                </div>
                <div class="store-meta">
                    <span class="store-category" data-category="${storeCategory}">${config.icon} ${storeCategory}</span>
                </div>
                <div class="store-info">
                    <div class="info-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${storeAddress}</span>
                    </div>
                    ${storeGfOptions ? `
                    <div class="info-item">
                        <i class="fas fa-star"></i>
                        <span>${storeGfOptions}</span>
                    </div>` : ''}
                </div>
                <div class="store-card-actions">
                    <button class="action-btn want-to-go ${isWantToGo ? 'active' : ''}" 
                            onclick="toggleVisitStatus(${store.id}, 'want_to_go')">
                        🤍 行きたい
                    </button>
                    <button class="action-btn visited ${isVisited ? 'active' : ''}" 
                            onclick="toggleVisitStatus(${store.id}, 'visited')">
                        ✨ 行った
                    </button>
                    <button class="action-btn" onclick="openStoreDetail(${store.id})">
                        📋 詳細
                    </button>
                </div>
            `;
        }
        
        // パフォーマンス測定
        console.log('🚀 埋め込みデータ版グルテンフリーマップ');
        console.log('⚡ 特徴: 即座表示、認証不要、確実動作');
        console.log('📊 店舗数:', embeddedStores.length, '店舗');
        console.log('🧪 Supabaseテスト: コンソールで testSupabase() を実行');
        console.log('🧪 テストデータ挿入: コンソールで insertTestData() を実行');

        // プロフィール関連のイベントリスナー設定
        document.addEventListener('DOMContentLoaded', function() {
            // 文字数カウントのイベントリスナー
            const bioTextarea = document.getElementById('editBio');
            if (bioTextarea) {
                bioTextarea.addEventListener('input', updateCharCount);
            }
            
            // プロフィールモーダル外クリックで閉じる
            const profileModal = document.getElementById('profileModal');
            if (profileModal) {
                profileModal.addEventListener('click', function(e) {
                    if (e.target === profileModal) {
                        closeProfileModal();
                    }
                });
            }
            
            // 店舗詳細モーダル外クリックで閉じる
            const storeDetailModal = document.getElementById('storeDetailModal');
            if (storeDetailModal) {
                storeDetailModal.addEventListener('click', function(e) {
                    if (e.target === storeDetailModal) {
                        closeStoreDetail();
                    }
                });
            }
        });
    </script>

    <!-- 店舗詳細モーダル -->
    <div class="store-detail-modal" id="storeDetailModal" style="display: none;">
        <div class="store-detail-container">
            <div class="store-detail-header">
                <button class="store-detail-close" onclick="closeStoreDetail()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="store-detail-body" id="storeDetailContent">
                <!-- 動的にコンテンツが挿入される -->
            </div>
        </div>
    </div>

    <!-- プロフィールモーダル -->
    <div class="modal-overlay" id="profileModal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-user"></i>
                    プロフィール
                </h2>
                <button class="modal-close-btn" onclick="closeProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- プロフィール表示エリア -->
                <div class="profile-view" id="profileView">
                    <div class="profile-avatar">
                        <div class="avatar-circle" id="userAvatar">👤</div>
                        <button class="avatar-edit-btn" onclick="editProfile()">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                    <div class="profile-info">
                        <div class="profile-field">
                            <label>名前</label>
                            <span id="displayName">-</span>
                        </div>
                        <div class="profile-field">
                            <label>メールアドレス</label>
                            <span id="displayEmail">-</span>
                        </div>
                        <div class="profile-field">
                            <label>加入日</label>
                            <span id="displayJoinDate">-</span>
                        </div>
                        <div class="profile-field">
                            <label>自己紹介</label>
                            <span id="displayBio">自己紹介がまだ設定されていません</span>
                        </div>
                    </div>
                </div>

                <!-- プロフィール編集エリア -->
                <div class="profile-edit" id="profileEdit" style="display: none;">
                    <div class="profile-avatar">
                        <div class="avatar-circle" id="editAvatar">👤</div>
                        
                        <!-- アバター選択タブ -->
                        <div class="avatar-tabs">
                            <button class="avatar-tab active" onclick="showAvatarType('emoji')">
                                <i class="fas fa-smile"></i>
                                絵文字
                            </button>
                            <button class="avatar-tab" onclick="showAvatarType('image')">
                                <i class="fas fa-camera"></i>
                                画像
                            </button>
                        </div>
                        
                        <!-- 絵文字アバター選択 -->
                        <div class="avatar-options" id="emojiAvatars">
                            <button class="avatar-option" onclick="selectAvatar('👤')">👤</button>
                            <button class="avatar-option" onclick="selectAvatar('😊')">😊</button>
                            <button class="avatar-option" onclick="selectAvatar('🌸')">🌸</button>
                            <button class="avatar-option" onclick="selectAvatar('🎀')">🎀</button>
                            <button class="avatar-option" onclick="selectAvatar('🍰')">🍰</button>
                            <button class="avatar-option" onclick="selectAvatar('🌟')">🌟</button>
                        </div>
                        
                        <!-- 画像アップロード -->
                        <div class="image-upload-section" id="imageUpload" style="display: none;">
                            <input type="file" id="avatarImageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                            <button class="upload-btn" onclick="document.getElementById('avatarImageInput').click()">
                                <i class="fas fa-upload"></i>
                                画像を選択
                            </button>
                            <div class="upload-info">
                                <small>JPG, PNG形式 / 最大2MB</small>
                            </div>
                            <div class="image-preview" id="imagePreview" style="display: none;">
                                <img id="previewImg" src="" alt="プレビュー">
                                <button class="remove-image-btn" onclick="removeUploadedImage()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="profile-form">
                        <div class="form-group">
                            <label for="editName">名前</label>
                            <input type="text" id="editName" placeholder="お名前を入力してください">
                        </div>
                        <div class="form-group">
                            <label for="editBio">自己紹介</label>
                            <textarea id="editBio" placeholder="自己紹介を入力してください（100文字以内）" maxlength="100"></textarea>
                            <div class="char-count">
                                <span id="bioCharCount">0</span>/100文字
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-secondary" onclick="cancelEdit()">キャンセル</button>
                            <button class="btn btn-primary" id="saveProfileBtn">保存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>