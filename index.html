<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>グルテンフリーマップ | ビヨフリ倶楽部</title>
    
    <!-- アイコン設定 -->
    <link rel="icon" type="image/png" href="nacoキャラクター.png">
    
    <!-- フォント -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary: #ff6b9d;
            --primary-dark: #e55a8a;
            --secondary: #40e0d0;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-glass: rgba(255, 255, 255, 0.9);
            
            --text-primary: #1a1a1a;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
            
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            
            --gradient-primary: linear-gradient(135deg, #ff6b9d 0%, #40e0d0 100%);
            --gradient-bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            --font-display: 'Inter', 'Noto Sans JP', sans-serif;
            --font-body: 'Noto Sans JP', 'Inter', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--gradient-bg);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* メインアプリ */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-light);
            padding: var(--space-md) var(--space-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .auth-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-lg);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .auth-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* ハンバーガーメニュー */
        .hamburger-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 248, 252, 0.95) 100%);
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 107, 157, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--space-md) var(--space-lg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            position: relative;
            z-index: 1000;
            min-width: 56px;
            height: 56px;
            box-shadow: 0 4px 20px rgba(255, 107, 157, 0.15);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .hamburger-btn:hover {
            background: linear-gradient(135deg, #ffffff 0%, #fff8fc 100%);
            border-color: var(--primary);
            box-shadow: 0 8px 30px rgba(255, 107, 157, 0.3);
            transform: translateY(-2px) scale(1.05);
        }

        .hamburger-btn:active {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
        }

        .hamburger-icon {
            color: var(--text-primary);
            font-size: 1.4rem;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        .hamburger-btn:hover .hamburger-icon {
            color: var(--primary);
            transform: rotate(90deg) scale(1.1);
            filter: drop-shadow(0 2px 4px rgba(255, 107, 157, 0.3));
        }

        .hamburger-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.3px;
            transition: all 0.4s ease;
            white-space: nowrap;
        }

        .hamburger-btn:hover .hamburger-label {
            color: var(--primary);
        }

        /* サイドメニューオーバーレイ */
        .side-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .side-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* サイドメニュー */
        .side-menu {
            position: fixed;
            top: 0;
            right: 0;
            width: 320px;
            height: 100%;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-left: 2px solid var(--border-light);
            box-shadow: var(--shadow-xl);
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .side-menu-overlay.active .side-menu {
            transform: translateX(0);
        }

        .side-menu-header {
            padding: var(--space-xl);
            border-bottom: 2px solid var(--border-light);
            background: var(--gradient-primary);
            color: white;
        }

        .side-menu-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .side-menu-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .side-menu-content {
            padding: var(--space-lg);
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: var(--space-sm);
            border: 2px solid transparent;
        }

        .menu-item:hover {
            background: var(--bg-secondary);
            border-color: var(--border);
            transform: translateX(4px);
        }

        .menu-item-icon {
            width: 24px;
            text-align: center;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .menu-item-text {
            flex: 1;
            color: var(--text-primary);
            font-weight: 500;
        }

        .menu-item-arrow {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .menu-separator {
            height: 2px;
            background: var(--border-light);
            margin: var(--space-lg) 0;
            border-radius: 1px;
        }

        .menu-item.logout {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #fca5a5;
            color: #dc2626;
        }

        .menu-item.logout:hover {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
            border-color: #dc2626;
        }

        .menu-item.logout .menu-item-icon {
            color: #dc2626;
        }

        .menu-item.logout .menu-item-text {
            color: #dc2626;
            font-weight: 600;
        }

        /* プロフィール設定画面 */
        .profile-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg);
        }

        .profile-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .profile-modal {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-2xl);
            padding: var(--space-xl);
            box-shadow: var(--shadow-xl);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .profile-modal-overlay.active .profile-modal {
            transform: scale(1);
        }

        .profile-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-xl);
            padding-bottom: var(--space-lg);
            border-bottom: 2px solid var(--border-light);
        }

        .profile-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .profile-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
        }

        .profile-close-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .profile-section {
            margin-bottom: var(--space-xl);
        }

        .profile-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .profile-input-group {
            margin-bottom: var(--space-lg);
        }

        .profile-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
        }

        .profile-input {
            width: 100%;
            padding: var(--space-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: white;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .profile-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-md);
            margin-top: var(--space-md);
        }

        .avatar-option {
            aspect-ratio: 1;
            border: 3px solid var(--border-light);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .avatar-option:hover {
            border-color: var(--primary);
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .avatar-option.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .profile-save-btn {
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }

        .profile-save-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .profile-save-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* アバターアップロード用スタイル */
        .avatar-tabs {
            display: flex;
            margin-bottom: var(--space-md);
            border-bottom: 2px solid var(--border-light);
        }

        .avatar-tab {
            flex: 1;
            padding: var(--space-md);
            background: none;
            border: none;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }

        .avatar-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            font-weight: 600;
        }

        .avatar-tab:hover {
            color: var(--primary);
            background: rgba(255, 107, 157, 0.05);
        }

        .avatar-content {
            margin-top: var(--space-lg);
        }

        .upload-section {
            text-align: center;
        }

        .current-avatar {
            margin-bottom: var(--space-lg);
            padding: var(--space-lg);
            border: 2px dashed var(--border-light);
            border-radius: var(--radius-lg);
            background: var(--bg-secondary);
        }

        .current-avatar img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: var(--shadow-md);
        }

        .current-avatar #currentAvatarPlaceholder {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .upload-area {
            border: 2px dashed var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            margin-bottom: var(--space-lg);
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(255, 107, 157, 0.02);
        }

        .upload-area i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: var(--space-sm);
            display: block;
        }

        .upload-area p {
            margin: var(--space-xs) 0;
            color: var(--text-primary);
        }

        .upload-hint {
            font-size: 0.8rem !important;
            color: var(--text-secondary) !important;
        }

        .preview-section {
            background: var(--bg-secondary);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            margin-top: var(--space-lg);
        }

        .preview-section h4 {
            margin-bottom: var(--space-md);
            color: var(--text-primary);
        }

        .preview-section img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-md);
        }

        .preview-section #fileInfo {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }

        .upload-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .upload-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .upload-status {
            margin-top: var(--space-md);
            padding: var(--space-sm);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            text-align: center;
        }

        .upload-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .upload-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .upload-status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* メニューアバター画像のレスポンシブ対応 */
        .menu-avatar-image {
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            .menu-avatar-image {
                width: 36px !important;
                height: 36px !important;
                margin-right: 10px !important;
            }
        }

        /* 画像拡大表示モーダル */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: var(--space-lg);
        }

        .image-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .image-modal-content {
            position: relative;
            max-width: 90vw;
            max-height: 85vh;
            animation: zoomIn 0.3s ease;
        }

        .image-modal-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .image-modal-close {
            position: absolute;
            top: -45px;
            right: 0;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            color: #333;
            transition: all 0.2s ease;
        }

        .image-modal-close:hover {
            background: white;
            transform: scale(1.1);
        }

        .image-modal-info {
            position: absolute;
            bottom: -50px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* 店舗画像をクリック可能にするスタイル */
        .store-image-clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .store-image-clickable:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* スマホ版での調整 */
        @media (max-width: 768px) {
            .image-modal {
                padding: var(--space-md);
            }
            
            .image-modal-content {
                max-width: 95vw;
                max-height: 80vh;
            }
            
            .image-modal-close {
                top: -35px;
                width: 35px;
                height: 35px;
                font-size: 1rem;
                /* タッチしやすいように少し大きく */
                width: 40px;
                height: 40px;
            }
            
            .image-modal-info {
                bottom: -40px;
                font-size: 0.8rem;
                padding: 0 var(--space-sm);
            }
            
            /* スマホでのタッチ対応 */
            .store-image-clickable {
                /* ホバー効果を無効化してタッチのみに */
                transform: none;
                transition: transform 0.1s ease;
            }
            
            .store-image-clickable:active {
                transform: scale(0.98);
            }
        }

        /* 極小スマホ対応 */
        @media (max-width: 360px) {
            .image-modal-content {
                max-width: 98vw;
                max-height: 75vh;
            }
            
            .image-modal-close {
                top: -30px;
                width: 36px;
                height: 36px;
            }
            
            .image-modal-info {
                bottom: -35px;
                font-size: 0.75rem;
            }
        }

        .app-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            white-space: nowrap;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .app-title span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }
        
        /* モバイル対応でタイトルサイズ調整 */
        @media (max-width: 480px) {
            .app-title {
                font-size: 1.3rem;
            }
            
            /* 超小型デバイス向けプロフィールモーダル追加対応 */
            .profile-modal {
                margin: var(--space-xs);
                padding: var(--space-md);
                max-height: 98vh;
            }
            
            .profile-modal-title {
                font-size: 1.2rem;
            }
            
            /* アバタータブをさらに小さく */
            .avatar-tabs {
                flex-direction: row; /* 横並びに戻す */
                gap: var(--space-xs);
            }
            
            .avatar-tab {
                padding: var(--space-xs);
                font-size: 0.8rem;
            }
            
            .upload-area {
                padding: var(--space-md);
            }
            
            .upload-area i {
                font-size: 1.3rem;
            }
            
            .current-avatar img {
                width: 50px;
                height: 50px;
            }
            
            .preview-section img {
                width: 70px;
                height: 70px;
            }
        }
        
        @media (max-width: 360px) {
            .app-title {
                font-size: 1.1rem;
            }
        }

        .title-icon {
            width: 50px;
            height: 50px;
            background: transparent;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: float 3s ease-in-out infinite;
        }
        
        .title-icon img {
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.1));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        /* 現在地マーカー用アニメーション */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.6; }
            100% { transform: scale(1); opacity: 1; }
        }

        .current-location-marker {
            animation: pulse 2s ease-in-out infinite;
        }

        /* 現在地マーカー二重円デザイン */
        .location-marker-container {
            position: relative;
            width: 44px;
            height: 44px;
            display: block !important;
        }

        .location-outer-circle {
            position: absolute;
            top: 0;
            left: 0;
            width: 44px;
            height: 44px;
            background: rgba(0, 122, 255, 0.2);
            border: 2px solid rgba(0, 122, 255, 0.4);
            border-radius: 50%;
            display: block;
        }

        .location-inner-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            background: #007AFF;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.5);
            z-index: 10;
            display: block;
        }



        .search-input {
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }

        .filter-chips {
            display: flex;
            gap: var(--space-sm);
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-bottom: var(--space-xs);
        }
        
        .filter-chips::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: var(--space-sm) var(--space-md);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .filter-chip:hover,
        .filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* メインコンテンツ */
        .main-content {
            flex: 1;
            display: flex;
            width: 100%;
            height: calc(100vh - 120px); /* ヘッダーと検索エリアを引く */
            position: relative;
        }


        .map-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            /* スマホでの長押しメニューを無効化 */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* 地図エリア内のすべての要素で長押し選択を無効化 */
        #map {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: pan-x pan-y;
        }

        #map {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }

        .map-controls {
            position: absolute;
            top: calc(var(--space-lg) * 2.5);
            right: var(--space-md);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        /* モバイル版では左上配置を維持 */
        @media (max-width: 1024px) {
            .map-controls {
                top: var(--space-lg);
                left: var(--space-lg);
                right: auto;
            }
        }

        .map-control-btn {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: var(--radius-md);
            padding: var(--space-md);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
        }

        .map-control-btn:hover {
            background: var(--bg-primary);
            transform: translateY(-1px);
        }
        
        /* ズームコントロール */
        .zoom-controls {
            display: flex;
            flex-direction: column;
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-sm);
        }
        
        .zoom-btn {
            background: transparent;
            border-radius: 0;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-primary);
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            box-shadow: none;
        }
        
        .zoom-btn:first-child {
            border-bottom: 1px solid var(--border-light);
        }
        
        .zoom-btn:hover {
            background: var(--bg-primary);
        }
        
        /* モバイル専用現在地ボタン */
        .mobile-location-control {
            position: absolute;
            bottom: 100px; /* オーバーレイパネルの上に配置 */
            right: var(--space-lg);
            z-index: 1000;
            display: flex;
            gap: 8px;
            flex-direction: column;
        }
        
        @media (max-width: 1024px) {
            /* モバイル版ではズームコントロールを非表示（デフォルトのLeafletズームを使用） */
            .zoom-controls {
                display: none;
            }
            
            /* PC版では現在地ボタンを非表示 */
            #locateBtn {
                display: none;
            }
        }
        
        @media (min-width: 1025px) {
            /* PC版ではモバイル現在地ボタンを非表示 */
            .mobile-location-control {
                display: none;
            }
            
        }

        /* 店舗リスト */
        .store-sidebar {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-secondary);
        }


        .sidebar-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .store-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-sm);
        }

        .store-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .store-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .store-card:hover,
        .store-card.selected {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        /* 店舗カード内のアクションボタン */
        .store-card-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-light);
        }
        
        .action-btn {
            flex: 1;
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: white;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
        }
        
        .action-btn:hover {
            background: var(--bg-secondary);
        }
        
        .action-btn.want-to-go {
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .action-btn.visited {
            color: var(--success);
            border-color: var(--success);
        }
        
        .action-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .action-btn.visited.active {
            background: var(--success);
            border-color: var(--success);
        }
        
        /* 店舗詳細ボタンの視認性向上 */
        .action-btn.store-detail {
            background: #f8fafc;
            border: 1.5px solid #64748b;
            color: #334155;
            font-weight: 500;
        }
        
        .action-btn.store-detail:hover {
            background: #e2e8f0;
            border-color: #475569;
            transform: translateY(-1px);
        }

        /* ポップアップ内のアクションボタン */
        .popup-action-btn {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: white;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 40px;
            white-space: nowrap;
        }

        .popup-action-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary);
        }

        .popup-action-btn:active {
            transform: scale(0.95);
            background: var(--primary);
            color: white;
        }

        .popup-action-btn.want-to-go:active {
            background: #ec4899;
            border-color: #ec4899;
        }

        .popup-action-btn.visited:active {
            background: #4ade80;
            border-color: #4ade80;
        }

        .popup-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
            flex-wrap: nowrap;
        }

        /* ポップアップボタンのアクティブ状態 */
        .popup-action-btn.want-to-go.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .popup-action-btn.visited.active {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        /* ボタン押下時のアニメーション */
        @keyframes buttonPress {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.95);
            }
            100% {
                transform: scale(1);
            }
        }

        /* 画像カルーセルのスタイル */
        .store-images {
            margin: 16px 0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            background: var(--bg-light);
        }
        
        .image-carousel {
            position: relative;
            width: 100%;
            height: 200px;
            overflow: hidden;
            border-radius: 12px;
        }
        
        .image-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .image-slide.active {
            opacity: 1;
        }
        
        .image-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: var(--bg-light);
        }
        
        .carousel-nav {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 20px;
        }
        
        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .carousel-dot.active {
            background: white;
            transform: scale(1.2);
        }
        
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            opacity: 0;
        }
        
        .carousel-btn:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-50%) scale(1.1);
        }
        
        .carousel-btn.prev {
            left: 12px;
        }
        
        .carousel-btn.next {
            right: 12px;
        }
        
        .image-carousel:hover .carousel-btn {
            opacity: 1;
        }
        
        .no-images {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            background: var(--bg-light);
            border: 2px dashed var(--border-light);
            border-radius: 12px;
            flex-direction: column;
            gap: 8px;
        }
        
        .image-upload-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }
        
        .image-upload-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }


        /* ボタン押下時の一時的な視覚効果 */
        .action-btn.pressing,
        .popup-action-btn.pressing {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }

        /* PC版店舗カードスタイル */
        .pc-store-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border-light);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .pc-store-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .pc-store-card.selected {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(152, 216, 200, 0.2);
        }

        .pc-store-card .store-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .pc-store-card .store-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.3;
        }

        .pc-store-card .store-distance {
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: var(--bg-light);
            padding: 2px 6px;
            border-radius: 6px;
        }

        .pc-store-card .store-meta {
            margin-bottom: 12px;
        }

        .pc-store-card .store-category {
            font-size: 0.85rem;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            background: var(--primary);
        }

        .pc-store-card .store-info {
            margin-bottom: 12px;
        }

        .pc-store-card .info-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .pc-store-card .info-icon {
            flex-shrink: 0;
            width: 16px;
            text-align: center;
        }

        .pc-store-card .store-card-actions {
            display: flex;
            gap: 6px;
            padding-top: 12px;
            border-top: 1px solid var(--border-light);
        }

        .pc-store-card .action-btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.85rem;
            min-height: 36px;
        }

        .store-card:hover::before,
        .store-card.selected::before {
            transform: scaleY(1);
        }

        .store-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .store-header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--space-xs);
        }

        .store-distance {
            background: rgba(0, 122, 255, 0.1);
            color: #007AFF;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .store-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.4;
            flex: 1;
        }
        
        /* スマホ版: 店名がタップ可能であることを示す */
        @media (max-width: 768px) {
            .store-card .store-name {
                color: var(--primary-dark);
                position: relative;
            }
            
            .store-card .store-name::after {
                content: '';
                position: absolute;
                bottom: -2px;
                left: 0;
                right: 0;
                height: 1px;
                background: var(--primary);
                opacity: 0;
                transition: opacity 0.2s;
            }
            
            .store-card:active .store-name::after {
                opacity: 0.6;
            }
        }

        .store-category {
            color: white;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-xl);
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            margin-left: var(--space-sm);
        }

        /* カテゴリ別色設定（マップマーカーと統一） */
        .store-category[data-category="カフェ"] {
            background: #8B4513;
        }
        .store-category[data-category="和食"] {
            background: #E74C3C;
        }
        .store-category[data-category="洋食"] {
            background: #3498DB;
        }
        .store-category[data-category="パン屋"] {
            background: #F39C12;
        }
        .store-category[data-category="スイーツ"] {
            background: #E91E63;
        }
        .store-category[data-category="販売店"] {
            background: #27AE60;
        }
        .store-category[data-category="その他"] {
            background: #7F8C8D;
        }

        .store-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .store-address {
            color: var(--text-secondary);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        /* スマホ版：住所テキストを小さくして一覧性を向上 */
        @media (max-width: 768px) {
            .store-address {
                font-size: 0.75rem;
                color: #666;
                line-height: 1.2;
            }
            
            /* 店舗カードもコンパクトに */
            .store-card {
                padding: var(--space-md);
                margin-bottom: var(--space-sm);
            }
            
            .store-header {
                margin-bottom: var(--space-sm);
            }
        }

        .store-gf-type {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.875rem;
            color: var(--success);
            font-weight: 500;
        }

        .store-hours {
            color: var(--text-light);
            font-size: 0.8rem;
        }

        /* ポップアップスタイル */
        .popup-content {
            min-width: 250px;
        }

        .popup-header {
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .popup-header-main {
            flex: 1;
        }
        
        .popup-close-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-left: var(--space-sm);
        }
        
        .popup-close-btn:hover {
            background: var(--error);
            border-color: var(--error);
            color: white;
            transform: scale(1.1);
        }
        
        .close-icon {
            font-size: 18px;
            font-weight: bold;
            line-height: 1;
        }

        .popup-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }


        .popup-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .popup-essential-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        .popup-additional-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            padding-top: var(--space-sm);
        }

        .popup-header-fixed {
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .popup-scrollable-content {
            flex: 1;
            overflow-y: auto;
            max-height: calc(100% - 80px);
        }

        .popup-info-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            padding-bottom: var(--space-md);
        }

        .popup-category-row {
            margin-bottom: var(--space-sm);
        }


        .popup-actions {
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: var(--space-sm);
        }

        .visit-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            padding: var(--space-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            background: white;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .visit-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-1px);
        }

        .visit-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .btn-icon {
            font-size: 1rem;
        }

        .popup-row {
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            font-size: 0.875rem;
        }

        .popup-icon {
            color: var(--text-light);
            min-width: 16px;
        }

        .popup-text {
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* カスタムマーカー */
        .custom-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: var(--shadow-md);
            font-size: 14px;
            font-weight: 600;
            color: white;
            transition: all 0.2s ease;
        }

        .custom-marker:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        /* リーフレットポップアップカスタム */
        .leaflet-popup-content-wrapper {
            border-radius: var(--radius-lg) !important;
            box-shadow: var(--shadow-xl) !important;
            max-width: 320px !important;
        }

        .leaflet-popup-content {
            margin: var(--space-lg) !important;
            font-family: var(--font-body) !important;
            line-height: 1.6 !important;
            width: auto !important;
            max-width: none !important;
        }

        /* モバイル用ポップアップ高さ制限 */
        @media (max-width: 1024px) {
            .leaflet-popup-content-wrapper {
                max-height: 35vh !important;
                overflow: hidden !important;
            }
            
            .popup-content {
                max-height: calc(35vh - 32px) !important;
                overflow: hidden !important;
                display: flex !important;
                flex-direction: column !important;
            }
            
            .popup-header-fixed {
                flex-shrink: 0 !important;
            }
            
            .popup-scrollable-content {
                overflow-y: auto !important;
                flex: 1 !important;
                min-height: 0 !important;
            }
        }
        
        /* Leafletのデフォルト閉じるボタンを非表示 */
        .leaflet-popup-close-button {
            display: none !important;
        }

        /* 地図コントロール（ズームボタン）のカスタマイズ */
        .leaflet-control-zoom {
            border: none !important;
            border-radius: var(--radius-lg) !important;
            box-shadow: var(--shadow-lg) !important;
            background: white !important;
            overflow: hidden !important;
        }

        .leaflet-control-zoom a {
            background: white !important;
            border: none !important;
            color: var(--primary) !important;
            font-weight: 600 !important;
            font-size: 18px !important;
            width: 36px !important;
            height: 36px !important;
            line-height: 32px !important;
            text-align: center !important;
            transition: all 0.2s ease !important;
            border-radius: 0 !important;
        }

        .leaflet-control-zoom a:hover {
            background: var(--primary) !important;
            color: white !important;
            transform: scale(1.05) !important;
        }

        .leaflet-control-zoom a:first-child {
            border-top-left-radius: var(--radius-lg) !important;
            border-top-right-radius: var(--radius-lg) !important;
        }

        .leaflet-control-zoom a:last-child {
            border-bottom-left-radius: var(--radius-lg) !important;
            border-bottom-right-radius: var(--radius-lg) !important;
        }

        /* レスポンシブ */

        /* オーバーレイ式店舗リストパネル */
        .overlay-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top-left-radius: var(--radius-2xl);
            border-top-right-radius: var(--radius-2xl);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1100;
            transform: translateY(calc(100% - 60px));
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .overlay-panel.half-open {
            transform: translateY(50%);
        }
        
        .overlay-panel.full-open {
            transform: translateY(0);
        }
        
        .panel-handle {
            padding: var(--space-md) var(--space-lg);
            cursor: grab;
            touch-action: pan-y;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            border-top-left-radius: var(--radius-2xl);
            border-top-right-radius: var(--radius-2xl);
        }
        
        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .panel-controls {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .state-indicators {
            display: flex;
            gap: 4px;
            margin-right: var(--space-sm);
        }
        
        .state-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
            transition: all 0.2s ease;
        }
        
        .state-dot.active {
            background: var(--primary);
            transform: scale(1.2);
        }
        
        .panel-control-btn.compact {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            padding: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .panel-control-btn.compact:hover {
            background: var(--bg-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }
        
        .panel-control-btn.compact:disabled {
            background: var(--bg-secondary);
            color: var(--text-light);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .panel-control-btn.compact .control-icon {
            font-size: 0.9rem;
            line-height: 1;
        }
        
        /* PC用サイドバー */
        .store-sidebar {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            display: none; /* デフォルトは非表示 */
            flex-direction: column;
            overflow: hidden;
            height: 100vh; /* 画面全体の高さに固定 */
            max-height: 100vh;
        }
        
        .sidebar-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-secondary);
            flex-shrink: 0; /* ヘッダーは高さ固定 */
        }
        
        .sidebar-title-row {
            display: flex;
            align-items: center;
            margin-bottom: var(--space-md);
            gap: var(--space-sm);
        }
        
        .sidebar-title {
            flex: 1;
            min-width: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .sidebar-count {
            flex-shrink: 0;
        }
        
        .sidebar-title-row .pin-mode-btn {
            flex-shrink: 0;
        }
        
        /* PC版ピンボタン専用スタイル */
        .pc-pin-btn {
            padding: 8px 16px !important;
            height: auto !important;
            min-width: auto !important;
            font-size: 0.9rem !important;
            border-radius: 12px !important;
            display: flex !important;
            align-items: center !important;
            gap: 6px !important;
            white-space: nowrap;
            font-weight: 500;
        }
        
        .pc-pin-btn .pin-icon {
            font-size: 1rem;
        }
        
        .pc-pin-btn .pin-label {
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        /* PC版ピンボタンの状態表示 */
        .pc-pin-btn.active .pin-label::after {
            content: '設置中';
            margin-left: 4px;
            font-size: 0.75rem;
            opacity: 0.9;
        }
        
        
        .sidebar-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* PC用検索ボックス */
        .sidebar-search {
            margin-bottom: var(--space-lg);
            position: relative;
        }
        
        .sidebar-search-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }
        
        .sidebar-search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* 地名検索候補 */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 2px;
        }

        .suggestion-item {
            padding: var(--space-sm) var(--space-md);
            cursor: pointer;
            border-bottom: 1px solid var(--border-light);
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background-color: var(--bg-secondary);
        }

        .suggestion-item.highlighted {
            background-color: var(--primary-alpha);
        }

        .suggestion-icon {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .suggestion-text {
            flex: 1;
        }

        .suggestion-category {
            font-size: 0.75rem;
            color: var(--text-secondary);
            opacity: 0.8;
        }
        
        /* PC用タブ */
        .sidebar-tabs {
            display: flex;
            gap: var(--space-xs);
            margin: var(--space-md) 0;
            background: var(--bg-light);
            border-radius: var(--radius-md);
            padding: var(--space-xs);
        }
        
        .sidebar-tab {
            flex: 1;
            background: transparent;
            border: none;
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .sidebar-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }
        
        .sidebar-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5);
        }

        /* PC用フィルターチップ */
        .sidebar-filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
            margin-bottom: var(--space-md);
        }
        
        .sidebar-chip {
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            white-space: nowrap;
            font-weight: 500;
        }
        
        .sidebar-chip:hover {
            background: var(--bg-primary);
            border-color: var(--primary);
            color: var(--text-primary);
            transform: translateY(-1px);
        }
        
        .sidebar-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .store-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-sm);
            min-height: 0; /* flex子要素のスクロール有効化 */
            scrollbar-width: thin; /* Firefox用スクロールバー */
            scrollbar-color: var(--primary) var(--bg-secondary); /* Firefox用カラー */
        }
        
        /* Webkit系ブラウザ用スクロールバー */
        .store-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .store-list::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }
        
        .store-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }
        
        .store-list::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* サイドバー用店舗カード */
        .store-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .store-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .store-card:hover,
        .store-card.selected {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .store-card:hover::before,
        .store-card.selected::before {
            transform: scaleY(1);
        }
        
        /* レスポンシブ表示制御 */
        .pc-only {
            display: none;
        }
        
        .mobile-only {
            display: block;
        }
        
        @media (min-width: 1025px) {
            .pc-only {
                display: flex;
            }
            
            .mobile-only {
                display: none;
            }
            
            
            .main-content {
                display: grid !important;
                grid-template-columns: 400px 1fr !important;
                gap: var(--space-xl) !important;
                height: 100vh !important;
                padding: var(--space-xl) !important;
                box-sizing: border-box;
                align-items: stretch;
            }
            
            .map-container {
                border-radius: var(--radius-xl);
                overflow: hidden;
                box-shadow: var(--shadow-lg);
                height: 100%;
                display: flex;
                flex-direction: column;
            }
            
            #map {
                height: 100% !important;
                border-radius: var(--radius-xl);
                flex: 1;
            }
        }
        
        .panel-handle:active {
            cursor: grabbing;
        }
        
        
        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-sm);
        }
        
        .panel-title-left {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .search-toggle-btn {
            background: transparent;
            border: none;
            padding: var(--space-xs);
            cursor: pointer;
            display: flex;
            align-items: center;
            position: relative;
            font-size: 1.2rem;
            transition: transform 0.2s ease;
        }
        
        .search-toggle-btn:hover {
            transform: scale(1.1);
        }
        
        .search-toggle-btn.active {
            transform: rotate(90deg);
        }
        
        .filter-indicator {
            position: absolute;
            top: 0;
            right: 0;
            color: var(--error);
            font-size: 0.6rem;
        }
        
        /* モバイル版検索・フィルター - 完全に独立したレイアウト */
        .mobile-search-filter {
            position: relative;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #fff5f8 0%, #fff 100%);
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
            border-bottom: 0;
            margin: 0;
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.1);
            border-radius: 0 0 12px 12px;
            transform: translateY(-10px);
            opacity: 0;
        }
        
        .panel-tabs {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: var(--space-sm) var(--space-md) var(--space-sm);
            border-bottom: 1px solid var(--border-light);
            background: white;
            flex-shrink: 0;
            position: relative;
        }
        
        .panel-tab {
            flex: 1;
            padding: var(--space-sm) var(--space-xs);
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            text-align: center;
            border-radius: 8px;
        }
        
        .panel-tab:hover {
            color: #ff6b9d;
            background: rgba(255, 107, 157, 0.05);
            transform: translateY(-1px);
        }
        
        .panel-tab.active {
            color: white;
            background: linear-gradient(135deg, #ff6b9d, #4ecdc4);
            box-shadow: 0 2px 8px rgba(255, 107, 157, 0.3);
            transform: translateY(-1px);
        }
        
        .panel-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 3px;
            background: linear-gradient(135deg, #ff6b9d, #4ecdc4);
            border-radius: 2px;
        }
        
        .panel-content {
            flex: 1 1 0;
            overflow-y: auto !important;
            padding: var(--space-sm);
            min-height: 0;
            max-height: 100%;
            -webkit-overflow-scrolling: touch;
            /* デバッグ用: スクロール確認 */
            position: relative;
        }
        
        .mobile-search-filter.show {
            max-height: 200px;
            padding: var(--space-lg) var(--space-lg) var(--space-md);
            border-bottom: 1px solid rgba(255, 107, 157, 0.2);
            transform: translateY(0);
            opacity: 1;
        }
        
        .mobile-search-box {
            margin-bottom: var(--space-md);
            position: relative;
        }
        
        .mobile-search-input {
            width: 100%;
            padding: var(--space-md);
            border: 2px solid rgba(255, 107, 157, 0.2);
            border-radius: 20px;
            font-size: 0.875rem;
            background: white;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(255, 107, 157, 0.05);
        }
        
        .mobile-search-input:focus {
            outline: none;
            border-color: #ff6b9d;
            box-shadow: 0 4px 16px rgba(255, 107, 157, 0.2);
            transform: scale(1.02);
        }
        
        .mobile-filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
        }
        
        .mobile-chip {
            padding: var(--space-xs) var(--space-sm);
            background: white;
            border: 1px solid rgba(255, 107, 157, 0.3);
            border-radius: 15px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            color: var(--text-secondary);
            white-space: nowrap;
            box-shadow: 0 1px 4px rgba(255, 107, 157, 0.1);
        }
        
        .mobile-chip:hover {
            background: rgba(255, 107, 157, 0.1);
            border-color: #ff6b9d;
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(255, 107, 157, 0.2);
        }
        
        .mobile-chip.active {
            background: linear-gradient(135deg, #ff6b9d, #4ecdc4);
            color: white;
            border-color: #ff6b9d;
            transform: translateY(-1px);
            box-shadow: 0 3px 12px rgba(255, 107, 157, 0.3);
        }

        /* モバイル版検索候補 */
        .mobile-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 4px;
        }

        .mobile-suggestion-item {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 107, 157, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mobile-suggestion-item:last-child {
            border-bottom: none;
        }

        .mobile-suggestion-item:hover,
        .mobile-suggestion-item.highlighted {
            background: rgba(255, 107, 157, 0.1);
            color: #c2185b;
        }

        .mobile-suggestion-icon {
            font-size: 16px;
            min-width: 20px;
        }

        .mobile-suggestion-text {
            flex: 1;
            font-weight: 600;
            font-size: 14px;
        }

        .mobile-suggestion-category {
            font-size: 12px;
            color: #666;
            background: rgba(255, 107, 157, 0.1);
            padding: 2px 8px;
            border-radius: 8px;
        }

        /* 訪問履歴ビュー */
        .visit-history-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1100;
            overflow-y: auto;
            padding-bottom: 80px; /* 底部導航の高さ分 */
        }

        .visit-history-view.hidden {
            display: none;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            background: var(--gradient-primary);
            color: white;
        }

        .history-count {
            background: rgba(255, 255, 255, 0.2);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
        }

        .history-list {
            padding: var(--space-md);
        }

        .history-item {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .history-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-sm);
        }

        .history-store-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .history-category {
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
        }

        .history-address {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: var(--space-xs);
        }

        .history-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }

        .history-action-btn {
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            background: white;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-action-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: var(--space-md);
        }

        .empty-message {
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .header-content {
                padding: 0 var(--space-lg);
            }

            .main-content {
                height: calc(100vh - 100px); /* モバイルではヘッダーの高さ調整 */
            }
            
            .search-filter-content {
                flex-direction: column;
                align-items: stretch;
                padding: 0 var(--space-lg);
            }
            
            .main-content {
                padding: var(--space-lg);
                gap: var(--space-lg);
            }
            
            .filter-chips {
                justify-content: center;
            }
        }

        .loading-indicator {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin: var(--space-md);
            text-align: center;
        }

        /* エレガントなマーカースタイル */
        .elegant-marker .marker-icon:hover {
            transform: scale(1.1) !important;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25) !important;
        }

        .elegant-marker .marker-container {
            cursor: pointer;
        }

        /* マーカーアニメーション */
        @keyframes markerPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .elegant-marker:hover .marker-icon {
            animation: markerPulse 0.6s ease-in-out;
        }

        /* モバイル対応のマーカーサイズ調整 */
        @media (max-width: 768px) {
            .elegant-marker .marker-icon {
                width: 36px !important;
                height: 36px !important;
                font-size: 16px !important;
            }
        }

        /* Leafletポップアップのz-index調整 */
        .leaflet-popup {
            z-index: 700 !important;
        }
        
        .leaflet-popup-pane {
            z-index: 700 !important;
        }
        
        
        /* PC版でポップアップ位置調整 */
        @media (min-width: 1025px) {
            .leaflet-popup {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
            
            .leaflet-popup-content-wrapper {
                white-space: normal;
                word-wrap: break-word;
                word-break: break-word;
                box-sizing: border-box;
                min-width: 350px;
                max-width: 420px;
            }
            
            .leaflet-popup-content {
                box-sizing: border-box;
                overflow-wrap: break-word;
            }
            
            /* PC版：ポップアップの情報階層を修正 */
            .desktop-popup .popup-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 1px solid var(--border-light);
            }
            
            .desktop-popup .popup-header-main {
                display: flex;
                flex-direction: column;
                gap: 6px;
                align-items: flex-start;
            }
            
            .desktop-popup .popup-title {
                margin: 0 !important;
                font-size: 1.2rem !important;
                font-weight: 600 !important;
                line-height: 1.3 !important;
                color: var(--text-primary);
            }
            
            .desktop-popup .store-category {
                font-size: 0.85rem;
                font-weight: 500;
                padding: 4px 8px;
                border-radius: 12px;
                color: white;
                background: var(--primary);
            }
            
            .desktop-popup .popup-close-btn {
                background: none;
                border: none;
                font-size: 20px;
                cursor: pointer;
                color: var(--text-secondary);
                padding: 4px;
                line-height: 1;
            }
            
            .desktop-popup .popup-body {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            .desktop-popup .popup-info {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .desktop-popup .popup-row {
                display: flex;
                align-items: flex-start;
                gap: 8px;
                font-size: 0.9rem;
            }
            
            .desktop-popup .popup-icon {
                flex-shrink: 0;
                width: 20px;
                text-align: center;
            }
            
            .desktop-popup .popup-text {
                flex: 1;
                word-wrap: break-word;
                word-break: keep-all;
                line-height: 1.4;
            }
            
            .desktop-popup .popup-row {
                margin-bottom: 8px;
                min-height: 24px;
            }
            
            .desktop-popup .popup-actions {
                display: flex;
                gap: 8px;
                margin-top: 8px;
                padding-top: 12px;
                border-top: 1px solid var(--border-light);
            }
            
            .popup-header-main .store-category {
                font-size: 0.85rem !important;
                margin: 0 !important;
            }
        }
        
        /* モバイルでポップアップ位置調整 */
        @media (max-width: 768px) {
            .leaflet-popup {
                margin-left: 50px !important; /* 左端から離す */
            }
            
            /* カスタムポップアップクラス */
            .custom-popup .leaflet-popup-content-wrapper {
                margin-left: 10px;
            }
            
            .leaflet-popup-content-wrapper {
                min-width: 300px !important;
                max-width: 350px !important;
            }
            
            .popup-action-btn {
                font-size: 13px !important;
                padding: 8px 10px !important;
                min-height: 38px !important;
            }
        }

        /* 底部导航 */
        .bottom-navigation {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid var(--border-light);
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            padding: var(--space-xs) 0;
            z-index: 1000;
            height: 70px;
        }

        .nav-btn {
            flex: 1;
            max-width: 120px;
            background: none;
            border: none;
            padding: var(--space-xs);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-xs);
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: var(--radius-sm);
        }

        .nav-btn:hover {
            background: var(--bg-light);
            color: var(--primary);
        }

        .nav-btn.active {
            color: var(--primary);
            background: var(--bg-light);
        }

        .nav-btn i {
            font-size: 1.2rem;
        }

        /* 底部导航のためのコンテンツ下マージン */
        .main-content {
            margin-bottom: 70px;
        }

        .store-overlay-panel {
            bottom: 70px;
        }

        /* デスクトップでは底部导航を非表示 */
        @media (min-width: 1024px) {
            .bottom-navigation {
                display: none;
            }
            
            .main-content {
                margin-bottom: 0;
            }
            
            .store-overlay-panel {
                bottom: 0;
            }
        }

        /* =====================================
           カスタムピン機能のスタイリング
           ===================================== */
        
        /* マップコンテキストメニュー */
        .map-context-menu {
            position: absolute;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: var(--space-xs);
            z-index: 1001;
            min-width: 180px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .context-menu-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            background: none;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .context-menu-item:hover {
            background: var(--bg-light);
            color: var(--primary);
            transform: translateY(-1px);
        }
        
        .context-menu-item i {
            font-size: 1.1rem;
            color: var(--primary);
        }
        
        
        
        
        /* 高品質カスタムピンマーカー - 洗練されたデザイン */
        .custom-pin-marker {
            width: 32px;
            height: 32px;
            background: linear-gradient(145deg, #FF6B9D 0%, #C44569 100%);
            border-radius: 50%;
            position: relative;
            box-shadow: 
                0 4px 12px rgba(196, 69, 105, 0.25),
                0 2px 6px rgba(196, 69, 105, 0.15),
                inset 0 -2px 6px rgba(255, 255, 255, 0.2);
            animation: pinBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
        }
        
        .custom-pin-marker::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.4) 0%, rgba(255, 255, 255, 0.1) 100%);
            border-radius: 50%;
            box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.5);
        }
        
        .custom-pin-marker::after {
            content: '📍';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
        }
        
        
        /* アニメーション */
        @keyframes slideInFromRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(1);
            }
        }
        
        @keyframes pinPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes pinBounce {
            0% { transform: rotate(-45deg) scale(0) translateY(20px); opacity: 0; }
            50% { transform: rotate(-45deg) scale(1.2) translateY(-5px); opacity: 0.8; }
            100% { transform: rotate(-45deg) scale(1) translateY(0); opacity: 1; }
        }
        
        /* ピン設置モードボタン */
        .pin-mode-btn {
            opacity: 0.6;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 249, 250, 0.85) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 107, 157, 0.2);
            border-radius: 8px;
            padding: 4px 6px;
            min-width: 28px;
            height: 28px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .pin-mode-btn:hover {
            opacity: 0.9;
            transform: scale(1.05);
            border-color: rgba(255, 107, 157, 0.4);
        }
        
        .pin-mode-btn.active {
            opacity: 1;
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
            animation: pulse 2s infinite;
        }
        
        .pin-mode-btn.active .pin-mode-icon {
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.8));
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* ピン設置モードのヒント */
        .pin-mode-hint {
            position: absolute;
            top: calc(var(--space-lg) * 3);
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 107, 157, 0.95) 0%, rgba(196, 69, 105, 0.9) 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
            z-index: 1000;
            animation: slideInFromTop 0.3s ease-out;
            pointer-events: none;
        }
        
        /* PC版でのピンヒント位置調整 */
        @media (min-width: 1024px) {
            .pin-mode-hint {
                top: calc(var(--space-lg) * 2);
                left: calc(320px + 50%);
                transform: translateX(-50%);
            }
            
            .pin-guidance-message {
                top: calc(var(--space-lg) * 2);
                left: calc(320px + 50%);
                transform: translateX(-50%);
            }
        }
        
        /* ピンガイダンスメッセージ（ピンモードOFF時） */
        .pin-guidance-message {
            position: absolute;
            top: calc(var(--space-lg) * 3);
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 140, 0, 0.95) 0%, rgba(255, 165, 0, 0.9) 100%);
            color: white;
            padding: 10px 18px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 140, 0, 0.4);
            z-index: 1000;
            animation: slideInFromTop 0.3s ease-out;
            pointer-events: none;
            text-align: center;
            line-height: 1.4;
        }
        
        /* モバイル用ピン設置ヒント */
        .mobile-pin-hint {
            position: absolute;
            bottom: calc(var(--space-lg) * 6);
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 250, 0.9) 100%);
            backdrop-filter: blur(10px);
            padding: 10px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            font-size: 0.85rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 500;
            animation: slideInFromBottom 0.5s ease-out;
        }
        
        .mobile-pin-hint i {
            color: var(--primary);
            font-size: 1rem;
        }
        
        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* モバイル対応 */
        @media (max-width: 1024px) {
            .pin-control-panel {
                top: calc(var(--space-lg) * 2);
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                justify-content: space-between;
                animation: slideInFromTop 0.3s ease-out;
            }
            
            .map-context-menu {
                min-width: 160px;
            }
            
            .context-menu-item {
                padding: var(--space-md);
            }
        }
        
        /* ユーティリティクラス */
        .hidden {
            display: none !important;
        }

        /* 店舗詳細モーダル/フルスクリーン */
        .store-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: var(--space-lg);
        }

        .store-detail-modal-content {
            background: white;
            border-radius: var(--radius-xl);
            max-width: 800px;
            width: 100%;
            height: 90vh;
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .store-detail-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: white;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .store-detail-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .store-detail-header {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-secondary);
        }

        .store-detail-title h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            margin: 0 0 var(--space-xs) 0;
        }

        .store-detail-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .store-detail-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .store-detail-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-lg);
        }

        .store-detail-images {
            margin-bottom: var(--space-xl);
        }

        .store-detail-info {
            margin-bottom: var(--space-xl);
            padding: var(--space-lg);
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            text-align: left !important;
            display: flex;
            flex-direction: column;
            align-items: flex-start !important;
        }

        .store-detail-info h3 {
            color: var(--text-primary);
            font-size: 1.2rem;
            margin: 0 0 var(--space-md) 0;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .detail-row {
            display: flex;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border-light);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            color: var(--text-secondary);
            width: 120px;
            flex-shrink: 0;
        }

        .detail-value {
            color: var(--text-primary);
            flex: 1;
        }

        .detail-value a {
            color: var(--primary);
            text-decoration: none;
        }

        .detail-value a:hover {
            text-decoration: underline;
        }

        .phone-link {
            color: var(--primary) !important;
            font-weight: 500;
            text-decoration: none;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }

        .phone-link:hover {
            background: var(--bg-hover);
            text-decoration: none !important;
        }

        .gf-options, .store-description {
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
        }

        .no-reviews {
            color: var(--text-secondary);
            font-style: italic;
            margin: 0;
        }

        /* ========== レビューシステムのスタイル ========== */
        .reviews-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
            text-align: left !important;
            align-items: flex-start !important;
            justify-content: flex-start !important;
        }

        /* レビューコンテンツのID指定による強制左揃え */
        [id^="review-content-"] {
            text-align: left !important;
            padding: var(--space-md);
        }

        /* 全てのレビュー関連要素を左揃えに強制 */
        .review-item *,
        .reviews-list *,
        [class*="review-"] {
            text-align: left !important;
        }

        /* 最強の強制ルール - 詳細度を最大に */
        body .store-detail-modal-content .review-content,
        body .store-detail-fullscreen .review-content,
        body [id^="review-content-"],
        body div[id^="review-content-"] {
            text-align: left !important;
            direction: ltr !important;
            unicode-bidi: embed !important;
        }

        .review-item {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
            text-align: left !important;
            align-self: flex-start !important;
            width: 100%;
        }

        .review-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-light);
        }
        
        .review-header-right {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        
        .review-actions {
            display: flex;
            gap: var(--space-xs);
        }
        
        .review-action-btn {
            background: none;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            padding: var(--space-xs);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .review-action-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border-primary);
        }
        
        .review-action-btn.edit-btn:hover {
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
        
        .review-action-btn.delete-btn:hover {
            color: #ef4444;
            border-color: #ef4444;
        }
        
        .review-edit-form {
            width: 100%;
        }
        
        .review-edit-form .review-textarea {
            width: 100%;
            min-height: 80px;
            resize: vertical;
        }

        .review-user {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .review-avatar {
            font-size: 1.5rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border-radius: 50%;
        }

        .review-nickname {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .review-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 400;
        }

        .review-content {
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 0.95rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: left !important;
        }

        /* モバイル対応 */
        @media (max-width: 768px) {
            .review-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-xs);
            }
            
            .review-user {
                width: 100%;
            }
            
            .review-date {
                font-size: 0.8rem;
                margin-left: 40px;
            }
        }

        /* ========== レビュー投稿フォームのスタイル ========== */
        .review-form-container {
            margin: var(--space-lg) 0;
            padding-bottom: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
        }

        .btn-add-review {
            background: linear-gradient(135deg, #ff6b9d 0%, #40e0d0 100%);
            color: white;
            border: none;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .btn-add-review:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
        }

        .review-form {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin-top: var(--space-md);
        }

        .review-textarea {
            width: 100%;
            min-height: 120px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            font-family: inherit;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: border-color 0.2s ease;
            text-align: left !important;
        }

        .review-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }

        .review-textarea::placeholder {
            color: var(--text-secondary);
            font-style: italic;
        }

        .review-form-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-md);
            gap: var(--space-md);
        }

        .char-count {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .review-form-buttons {
            display: flex;
            gap: var(--space-sm);
        }

        .btn-cancel, .btn-submit, .btn-delete {
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .btn-cancel {
            background: var(--bg-primary);
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
        }

        .btn-cancel:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .btn-submit {
            background: linear-gradient(135deg, #ff6b9d 0%, #40e0d0 100%);
            color: white;
        }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-delete {
            background: #fff5f5;
            color: #ef4444;
            border: 1px solid #fecaca;
        }

        .btn-delete:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }


        /* モバイル対応 */
        @media (max-width: 768px) {
            .review-form-footer {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-sm);
            }
            
            .review-form-buttons {
                justify-content: center;
            }
            
            .btn-cancel, .btn-submit, .btn-delete {
                flex: 1;
                max-width: 120px;
            }
        }

        /* ナビゲーションボタン */
        .store-navigation {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-xl);
            justify-content: center;
            padding: 0 var(--space-lg) var(--space-xl) var(--space-lg);
        }

        .nav-btn {
            padding: var(--space-lg) var(--space-xl);
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            min-height: 52px;
            min-width: 140px;
            max-width: 160px;
            white-space: nowrap;
        }

        .nav-btn.google-maps {
            background: #4285f4;
            color: white;
        }

        .nav-btn.google-maps:hover {
            background: #3367d6;
            transform: translateY(-1px);
        }

        .nav-btn.route-search {
            background: #34a853;
            color: white;
        }

        .nav-btn.route-search:hover {
            background: #2d8f47;
            transform: translateY(-1px);
        }


        /* ログインモーダル */
        .login-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            padding: var(--space-lg);
        }

        .login-modal-content {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-2xl);
            padding: var(--space-2xl);
            box-shadow: var(--shadow-xl);
            text-align: center;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .login-modal-content .login-header h1 {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: var(--space-xs);
        }

        .login-modal-content .login-header p {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: var(--space-xl);
        }

        .login-modal-content .login-content h2 {
            color: var(--text-primary);
            font-size: 1.3rem;
            margin-bottom: var(--space-md);
        }

        .login-modal-content .login-content p {
            color: var(--text-secondary);
            margin-bottom: var(--space-xl);
            line-height: 1.6;
        }

        /* 初回ログイン案内スタイル */
        .first-time-notice {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
            border: 2px solid #4caf50;
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-xl);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.1);
        }

        .notice-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }

        .notice-header i {
            color: #4caf50;
            font-size: 1.2rem;
        }

        .notice-header span {
            color: #2e7d32;
            font-weight: 600;
            font-size: 1rem;
        }

        .notice-content p {
            color: #2e7d32;
            font-size: 0.9rem;
            margin: var(--space-xs) 0;
            line-height: 1.4;
            padding-left: var(--space-lg);
        }

        .notice-content p:last-child {
            margin-bottom: 0;
        }

        .login-modal-content .login-form {
            margin-top: var(--space-xl);
        }

        .login-modal-content .input-group {
            margin-bottom: var(--space-lg);
            text-align: left !important;
        }

        .login-modal-content .input-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: var(--space-xs);
            font-weight: 500;
        }

        .login-modal-content .input-group input {
            width: 100%;
            padding: var(--space-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .login-modal-content .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-alpha);
        }

        .login-modal-content .login-error {
            background: #fee;
            color: #c53030;
            padding: var(--space-md);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            margin-bottom: var(--space-md);
            border: 1px solid #fed7d7;
        }

        .login-modal-content .pin-login-btn {
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }

        .login-modal-content .pin-login-btn:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        /* モバイル対応 - 大人の可愛らしさを重視したデザイン */
        /* モバイル版ハンバーガーメニュー */
        @media (max-width: 768px) {
            .side-menu {
                width: 280px;
            }
            
            .hamburger-btn {
                width: 48px;
                height: 48px;
                padding: var(--space-sm);
                min-width: 48px;
            }
            
            .hamburger-icon {
                font-size: 1.3rem;
            }
            
            .hamburger-label {
                display: none;
            }
            
            .side-menu-header {
                padding: var(--space-lg);
            }
            
            .side-menu-content {
                padding: var(--space-md);
            }
            
            .menu-item {
                padding: var(--space-lg) var(--space-md);
            }
            
            .menu-item-text {
                font-size: 1rem;
            }
            
            /* モバイル版プロフィール画面 */
            .profile-modal {
                margin: var(--space-md);
                padding: var(--space-lg);
                max-height: 95vh;
            }
            
            .profile-modal-title {
                font-size: 1.3rem;
            }
            
            .avatar-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: var(--space-sm);
            }
            
            .avatar-option {
                font-size: 1.5rem;
            }
            
            /* アバターアップロード機能のモバイル対応 */
            .avatar-tabs {
                flex-direction: column;
                gap: var(--space-xs);
            }
            
            .avatar-tab {
                padding: var(--space-sm);
                font-size: 0.9rem;
            }
            
            .current-avatar {
                padding: var(--space-md);
                margin-bottom: var(--space-md);
            }
            
            .current-avatar img {
                width: 60px;
                height: 60px;
            }
            
            .upload-area {
                padding: var(--space-lg);
                margin-bottom: var(--space-md);
            }
            
            .upload-area i {
                font-size: 1.5rem;
            }
            
            .upload-area p {
                font-size: 0.9rem;
            }
            
            .upload-hint {
                font-size: 0.75rem !important;
            }
            
            .preview-section {
                padding: var(--space-md);
            }
            
            .preview-section img {
                width: 80px;
                height: 80px;
            }
            
            .upload-btn {
                padding: var(--space-sm);
                font-size: 0.85rem;
            }
            
            .upload-status {
                font-size: 0.8rem;
                padding: var(--space-xs) var(--space-sm);
            }
        }

        @media (max-width: 768px) {
            .login-modal-overlay {
                padding: 0;
                align-items: flex-start;
                background: linear-gradient(135deg, 
                    rgba(255, 192, 203, 0.95) 0%,   /* 優しいピンク */
                    rgba(255, 228, 225, 0.95) 35%,  /* 桜色 */
                    rgba(245, 245, 245, 0.95) 70%,  /* 上品なグレー */
                    rgba(255, 240, 245, 0.95) 100%  /* 薄いローズ */
                );
            }

            .login-modal-content {
                max-height: 100vh;
                height: 100vh;
                border-radius: 0;
                max-width: none;
                width: 100%;
                padding: 3rem 2rem;
                display: flex;
                flex-direction: column;
                justify-content: center;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                box-shadow: none;
            }

            .login-modal-content .login-header {
                margin-bottom: 2.5rem;
            }
            
            .login-modal-content .login-header h1 {
                font-size: 2rem;
                font-weight: 600;
                color: #d63384;
                margin-bottom: 0.5rem;
                letter-spacing: 0.5px;
            }

            .login-modal-content .login-header p {
                font-size: 1.1rem;
                color: #6c757d;
                font-weight: 400;
                margin-bottom: 0;
            }
            
            .login-modal-content .login-content h2 {
                font-size: 1.4rem;
                font-weight: 600;
                color: #495057;
                margin-bottom: 1rem;
            }

            .login-modal-content .login-content p {
                font-size: 1rem;
                color: #6c757d;
                margin-bottom: 2rem;
                line-height: 1.7;
            }

            /* モバイル版初回ログイン案内 */
            .first-time-notice {
                background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
                border: 2px solid #4caf50;
                border-radius: 12px;
                padding: 1.2rem;
                margin-bottom: 2rem;
                box-shadow: 0 3px 10px rgba(76, 175, 80, 0.15);
            }

            .notice-header {
                display: flex;
                align-items: center;
                gap: 0.6rem;
                margin-bottom: 1rem;
            }

            .notice-header i {
                color: #4caf50;
                font-size: 1.3rem;
            }

            .notice-header span {
                color: #2e7d32;
                font-weight: 600;
                font-size: 1.1rem;
            }

            .notice-content p {
                color: #2e7d32;
                font-size: 0.95rem;
                margin: 0.4rem 0;
                line-height: 1.5;
                padding-left: 1.5rem;
            }

            .notice-content p:last-child {
                margin-bottom: 0;
            }
            
            .login-modal-content .input-group {
                margin-bottom: 1.8rem;
            }

            .login-modal-content .input-group label {
                font-size: 1rem;
                font-weight: 500;
                color: #495057;
                margin-bottom: 0.6rem;
            }
            
            .login-modal-content .input-group input {
                padding: 1.2rem 1rem;
                font-size: 1.1rem;
                border: 2px solid #e9ecef;
                border-radius: 12px;
                background: #ffffff;
                color: #495057;
                transition: all 0.3s ease;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }

            .login-modal-content .input-group input:focus {
                border-color: #d63384;
                box-shadow: 0 0 0 3px rgba(214, 51, 132, 0.15);
                background: #fff;
            }

            .login-modal-content .input-group input::placeholder {
                color: #adb5bd;
            }

            /* メールアドレスフィールドの特別スタイル */
            .login-modal-content .input-group input[type="email"] {
                background: linear-gradient(to right, #ffffff 0%, #fef7f7 100%);
            }

            /* PINコードフィールドの特別スタイル */
            .login-modal-content .input-group input[type="password"] {
                background: linear-gradient(to right, #ffffff 0%, #f8f9fa 100%);
                text-align: center;
                font-size: 1.3rem;
                letter-spacing: 0.3rem;
                font-weight: 600;
            }
            
            .login-modal-content .pin-login-btn {
                padding: 1.3rem 2rem;
                font-size: 1.1rem;
                font-weight: 600;
                min-height: 60px;
                background: linear-gradient(135deg, #d63384 0%, #c2185b 100%);
                border: none;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(214, 51, 132, 0.3);
                transition: all 0.3s ease;
                letter-spacing: 0.5px;
            }

            .login-modal-content .pin-login-btn:hover {
                background: linear-gradient(135deg, #c2185b 0%, #ad1457 100%);
                transform: translateY(-2px);
                box-shadow: 0 6px 16px rgba(214, 51, 132, 0.4);
            }

            .login-modal-content .login-error {
                background: linear-gradient(to right, #fff5f5 0%, #fed7d7 100%);
                color: #c53030;
                padding: 1rem 1.2rem;
                border-radius: 10px;
                font-size: 0.95rem;
                margin-bottom: 1.5rem;
                border: 1px solid #fed7d7;
                box-shadow: 0 2px 4px rgba(197, 48, 48, 0.1);
            }

            /* nacoキャラクターの調整 */
            .login-modal-content .login-logo {
                width: 80px;
                height: 80px;
                margin-bottom: 1rem;
                border-radius: 50%;
                box-shadow: 0 4px 12px rgba(214, 51, 132, 0.2);
            }
            .store-detail-modal {
                padding: 0;
            }

            .store-detail-modal-content {
                height: 100vh;
                border-radius: 0;
            }

            .detail-label {
                width: 100px;
            }

            .nav-btn {
                padding: var(--space-lg);
                font-size: 1.1rem;
                min-height: 70px;
            }
            
            /* スマホ版店舗ナビゲーションの下部余白強化 */
            .store-navigation {
                margin-bottom: calc(var(--space-xl) + env(safe-area-inset-bottom, 20px));
                padding-bottom: calc(var(--space-xl) + env(safe-area-inset-bottom, 20px));
            }
            
            /* フルスクリーンモードでのスクロール領域調整 */
            .store-detail-fullscreen .store-detail-content {
                padding-bottom: calc(var(--space-xl) + env(safe-area-inset-bottom, 20px));
            }
        }

        /* マイレビューモーダル - 洗練された大人の女性向けデザイン */
        .my-reviews-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(40, 40, 40, 0.4);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 15000;
            padding: var(--space-lg);
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .my-reviews-content {
            background: #FFFFFF;
            border-radius: 16px;
            max-width: 920px;
            width: 100%;
            max-height: 85vh;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideInUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .my-reviews-header {
            background: linear-gradient(135deg, #FFF8FC 0%, #F8F4F8 100%);
            color: #4A4A4A;
            padding: 32px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            border-bottom: 1px solid rgba(219, 162, 181, 0.15);
            box-shadow: 0 1px 3px rgba(219, 162, 181, 0.08);
        }

        .my-reviews-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }

        .my-reviews-title {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 1.4rem;
            font-weight: 500;
            letter-spacing: 1px;
            font-family: 'Helvetica Neue', 'Yu Gothic', sans-serif;
            color: #3a3a3a;
        }

        .my-reviews-title i {
            font-size: 1.3rem;
            color: #ff6b9d;
            background: linear-gradient(135deg, #ff6b9d 0%, #40e0d0 50%, #ff6b9d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: sparkle 2s ease-in-out infinite alternate;
        }

        .my-reviews-close {
            background: transparent;
            border: 1px solid #D4CFC7;
            color: #8A8A8A;
            font-size: 1rem;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .my-reviews-close:hover {
            background: #F5F2EF;
            border-color: #DBA2B5;
            color: #DBA2B5;
            transform: rotate(90deg);
        }

        .my-reviews-body {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            background: linear-gradient(135deg, #FDFDFD 0%, #F9F8FC 100%);
            position: relative;
        }

        .my-reviews-body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6b9d, #40e0d0, #ff6b9d);
            opacity: 0.3;
        }

        .reviews-empty {
            text-align: center;
            padding: var(--space-2xl) var(--space-xl);
            color: var(--text-secondary);
        }

        .reviews-empty i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: var(--space-lg);
            opacity: 0.7;
        }

        .reviews-empty h3 {
            font-size: 1.2rem;
            margin-bottom: var(--space-md);
            color: var(--text-primary);
        }

        .reviews-empty p {
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .my-review-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-lg);
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .my-review-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .review-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg) var(--space-lg) var(--space-sm) var(--space-lg);
            margin-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-light);
        }

        .store-name-link {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.2s ease;
        }

        .store-name-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(219, 162, 181, 0.1);
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .store-name-link:hover {
            color: var(--primary);
        }

        .store-name-link:hover::before {
            opacity: 1;
        }

        .store-name-link i {
            font-size: 0.9rem;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .store-name-link:hover i {
            color: var(--primary);
        }

        .store-info {
            margin-top: var(--space-xs);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .store-category, .store-address {
            display: inline-block;
            margin-right: var(--space-sm);
        }

        .review-card-body {
            padding: 0 var(--space-lg) var(--space-lg) var(--space-lg);
        }

        .review-content {
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 0.95rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: left !important;
        }

        .review-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-md);
        }

        .review-user {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .review-avatar {
            font-size: 1.5rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border-radius: 50%;
        }

        .review-nickname {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .review-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 400;
        }

        .review-header-right {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .review-actions {
            display: flex;
            gap: var(--space-xs);
        }

        .review-action-btn {
            background: none;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            padding: var(--space-xs);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .review-action-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border-primary);
        }

        .edit-btn:hover {
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        /* 削除ボタンは編集画面内に移動するため、ここでは非表示 */
        .delete-btn {
            display: none;
        }

        /* アニメーション */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes sparkle {
            0% { 
                filter: brightness(1) drop-shadow(0 0 2px rgba(255, 107, 157, 0.3));
            }
            50% { 
                filter: brightness(1.2) drop-shadow(0 0 8px rgba(255, 107, 157, 0.5));
            }
            100% { 
                filter: brightness(1) drop-shadow(0 0 2px rgba(64, 224, 208, 0.3));
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* モバイル対応 - 洗練されたレスポンシブデザイン */
        @media (max-width: 768px) {
            .my-reviews-modal {
                padding: 16px;
            }

            .my-reviews-content {
                max-height: 92vh;
                border-radius: 12px;
            }

            .my-reviews-header {
                padding: 20px 24px;
            }

            .my-reviews-title {
                font-size: 1.1rem;
                letter-spacing: 1px;
            }

            .my-reviews-body {
                padding: 24px;
            }

            .my-review-card {
                margin-bottom: 20px;
                border-radius: 8px;
            }

            .review-card-header, .review-card-body {
                padding: 20px;
            }

            .store-name-link {
                font-size: 1rem;
                letter-spacing: 0.2px;
            }

            .review-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-md);
            }

            .review-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .store-info {
                flex-direction: column;
                gap: var(--space-xs);
            }
        }

        @media (max-width: 480px) {
            .my-reviews-modal {
                padding: var(--space-sm);
            }

            .my-reviews-header {
                padding: var(--space-md);
            }

            .my-reviews-title {
                font-size: 1.1rem;
                gap: var(--space-sm);
            }

            .my-reviews-body {
                padding: var(--space-md);
            }

            .review-card-header, .review-card-body {
                padding: var(--space-md);
            }

            .review-action-btn {
                padding: var(--space-xs) var(--space-sm);
                font-size: 0.8rem;
                min-width: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- メインアプリ -->
    <div class="app-container">
        <!-- ヘッダー -->
        <header class="app-header">
            <div class="header-content">
                <div class="app-title">
                    <div class="title-icon">
                        <img src="nacoキャラクター.png" alt="naco" style="width: 50px; height: 50px; object-fit: contain; background: transparent;">
                    </div>
                    <span>グルテンフリーマップ</span>
                </div>
                <div class="header-actions">
                    <button class="hamburger-btn" onclick="toggleSideMenu()">
                        <i class="fas fa-bars hamburger-icon"></i>
                        <span class="hamburger-label">メニュー</span>
                    </button>
                </div>
            </div>
        </header>


        <!-- メインコンテンツ -->
        <div class="main-content">
            <!-- 店舗リスト（PC用サイドバー） -->
            <div class="store-sidebar pc-only">
                <div class="sidebar-header">
                    <div class="sidebar-title-row">
                        <h2 class="sidebar-title">店舗リスト</h2>
                        <span class="sidebar-count"><span id="storeCount">62</span>件</span>
                        <button class="pin-mode-btn pc-pin-btn" id="pcPinModeBtn" title="ピン設置モード">
                            <span class="pin-icon">📍</span>
                            <span class="pin-label">目的地ピン</span>
                        </button>
                    </div>
                    
                    <!-- PC用検索ボックス -->
                    <div class="sidebar-search">
                        <input type="text" id="sidebarSearchInput" class="sidebar-search-input" placeholder="店名・地名・エリアで検索">
                        <div id="searchSuggestions" class="search-suggestions" style="display: none;"></div>
                    </div>
                    
                    <!-- PC用タブ -->
                    <div class="sidebar-tabs">
                        <button class="sidebar-tab active" data-tab="all">すべて</button>
                        <button class="sidebar-tab" data-tab="want-to-go">行きたい</button>
                        <button class="sidebar-tab" data-tab="visited">行った</button>
                    </div>
                    
                    <!-- PC用フィルターチップ -->
                    <div class="sidebar-filter-chips">
                        <button class="sidebar-chip active" data-category="">すべて</button>
                        <button class="sidebar-chip" data-category="カフェ">☕ カフェ</button>
                        <button class="sidebar-chip" data-category="和食">🍱 和食</button>
                        <button class="sidebar-chip" data-category="洋食">🍽️ 洋食</button>
                        <button class="sidebar-chip" data-category="パン屋">🥐 パン屋</button>
                        <button class="sidebar-chip" data-category="スイーツ">🧁 スイーツ</button>
                        <button class="sidebar-chip" data-category="販売店">🛒 販売店</button>
                    </div>
                </div>
                <div id="storeList" class="store-list">
                    <!-- 店舗リストがここに表示される -->
                </div>
            </div>
            
            <!-- マップ -->
            <div class="map-container">
                <div class="map-controls">
                    <!-- ズームコントロール -->
                    <div class="zoom-controls">
                        <button class="map-control-btn zoom-btn" id="zoomInBtn" title="拡大">+</button>
                        <button class="map-control-btn zoom-btn" id="zoomOutBtn" title="縮小">−</button>
                    </div>
                    <!-- その他のコントロール -->
                    <button class="map-control-btn" id="locateBtn" title="現在地を表示">📍</button>
                </div>
                
                <!-- モバイル専用現在地ボタン（右下角） -->
                <div class="mobile-location-control mobile-only">
                    <button class="map-control-btn" id="mobileLocateBtn" title="現在地を表示">📍</button>
                </div>
                <div id="map"></div>
                
                <!-- カスタムピン用コンテキストメニュー -->
                <div id="mapContextMenu" class="map-context-menu hidden">
                    <button class="context-menu-item" id="setPinBtn">
                        <i class="fas fa-map-pin"></i>
                        <span>ここにピンを設置</span>
                    </button>
                </div>
                
                
            </div>
        </div>
    </div>

    <!-- オーバーレイ式店舗リストパネル（モバイル用） -->
    <div id="overlayPanel" class="overlay-panel mobile-only">
        <div class="panel-handle" id="panelHandle">
            <div class="panel-title">
                <div class="panel-title-left">
                    <span id="panelStoreCount">店舗リスト 62件</span>
                    <button class="search-toggle-btn" id="searchToggleBtn" title="検索・フィルター">
                        <span class="search-icon">🔍</span>
                        <span class="filter-indicator" id="filterIndicator" style="display: none;">●</span>
                    </button>
                    <button class="pin-mode-btn" id="pinModeBtn" title="ピン設置モード">
                        <span class="pin-icon">📍</span>
                    </button>
                </div>
                <div class="panel-controls">
                    <div class="state-indicators">
                        <span class="state-dot active" id="stateDot1"></span>
                        <span class="state-dot" id="stateDot2"></span>
                        <span class="state-dot" id="stateDot3"></span>
                    </div>
                    <button class="panel-control-btn compact" id="panelDownBtn">
                        <span class="control-icon">🔽</span>
                    </button>
                    <button class="panel-control-btn compact" id="panelUpBtn">
                        <span class="control-icon">🔼</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- モバイル版検索・フィルター -->
        <div class="mobile-search-filter" id="mobileSearchFilter">
            <div class="mobile-search-box">
                <input type="text" id="mobileSearchInput" class="mobile-search-input" placeholder="店名・エリアで検索">
                <div id="mobileSuggestions" class="mobile-suggestions"></div>
            </div>
            <div class="mobile-filter-chips">
                <button class="mobile-chip active" data-category="">すべて</button>
                <button class="mobile-chip" data-category="カフェ">☕ カフェ</button>
                <button class="mobile-chip" data-category="和食">🍱 和食</button>
                <button class="mobile-chip" data-category="洋食">🍽️ 洋食</button>
                <button class="mobile-chip" data-category="パン屋">🥐 パン屋</button>
                <button class="mobile-chip" data-category="スイーツ">🧁 スイーツ</button>
                <button class="mobile-chip" data-category="販売店">🛒 販売店</button>
            </div>
        </div>
        
        <div class="panel-tabs">
            <button class="panel-tab active" data-tab="all">すべて</button>
            <button class="panel-tab" data-tab="want-to-go">行きたい</button>
            <button class="panel-tab" data-tab="visited">行った</button>
        </div>
        <div class="panel-content" id="panelContent">
            <!-- 店舗リストがここに表示される -->
        </div>
    </div>

    <!-- 訪問履歴ビュー -->
    <div id="visitHistoryView" class="visit-history-view hidden">
        <div class="history-header">
            <h2 id="historyTitle">行きたいお店</h2>
            <div id="historyCount" class="history-count">0件</div>
        </div>
        <div id="historyList" class="history-list">
            <!-- 履歴リストがここに表示される -->
        </div>
    </div>

    <!-- 底部导航 -->
    <div class="bottom-navigation">
        <button class="nav-btn active" data-tab="map">
            <i class="fas fa-map-marked-alt"></i>
            <span>マップ</span>
        </button>
        <button class="nav-btn" data-tab="want-to-go">
            <i class="fas fa-heart"></i>
            <span>行きたい</span>
        </button>
        <button class="nav-btn" data-tab="visited">
            <i class="fas fa-check-circle"></i>
            <span>行った</span>
        </button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // Supabase設定 - 正しいプロジェクト情報
        const SUPABASE_URL = 'https://hxrmsjfvgctoaxpbukvo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4cm1zamZ2Z2N0b2F4cGJ1a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MTI3NTAsImV4cCI6MjA3MDQ4ODc1MH0.tM1vDVVhYhh7OHlA1BTj071BfsIzeBG_HatijjtxwLw';
        
        // Supabaseクライアント初期化
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ==========================================
        // PINコード認証用ユーザーリスト
        // ==========================================
        const AUTHORIZED_USERS = [
            { email: 'bettger1000@gmail.com', pin: '1234' },
            { email: 'bettger1000@gmail.com', pin: '9999' }, // 追加：9999でもログイン可能
            { email: 'nono511shu123@gmail.com', pin: '5678' },
            { email: 'demo@example.com', pin: '0000' }
            // 必要に応じてユーザーを追加
        ];
        
        // カテゴリー色
        const categoryColors = {
            'カフェ': '#8B4513',
            '和食': '#FF6347',
            '洋食': '#FF4500',
            'パン屋': '#DEB887',
            'スイーツ': '#FF69B4',
            '販売店': '#4169E1',
            'その他': '#666666'
        };

        // カテゴリークラス名生成
        function getCategoryClass(category) {
            const classMap = {
                'カフェ': 'cafe',
                '和食': 'japanese',
                '洋食': 'western',
                'パン屋': 'bakery',
                'スイーツ': 'sweets',
                '販売店': 'shop',
                'その他': 'other'
            };
            return classMap[category] || 'other';
        }

        // カテゴリー別デザイン設定（高コントラスト・視認性重視）
        const categoryConfig = {
            'カフェ': { 
                icon: 'fas fa-coffee', 
                color: '#FFFFFF',
                bgColor: '#8B4513',      // 濃いブラウン
                borderColor: '#5D2F0A'   // さらに濃いブラウン
            },
            '和食': { 
                icon: 'fas fa-utensils', 
                color: '#FFFFFF',
                bgColor: '#E74C3C',      // 鮮やかな赤
                borderColor: '#C0392B'   // 濃い赤
            },
            '洋食': { 
                icon: 'fas fa-pizza-slice', 
                color: '#FFFFFF',
                bgColor: '#3498DB',      // 鮮やかなブルー
                borderColor: '#2980B9'   // 濃いブルー
            },
            'パン屋': { 
                icon: 'fas fa-bread-slice', 
                color: '#FFFFFF',
                bgColor: '#F39C12',      // 鮮やかなオレンジ
                borderColor: '#E67E22'   // 濃いオレンジ
            },
            'スイーツ': { 
                icon: 'fas fa-birthday-cake', 
                color: '#FFFFFF',
                bgColor: '#E91E63',      // 鮮やかなピンク
                borderColor: '#C2185B'   // 濃いピンク
            },
            '販売店': { 
                icon: 'fas fa-store', 
                color: '#FFFFFF',
                bgColor: '#27AE60',      // 鮮やかなグリーン
                borderColor: '#229954'   // 濃いグリーン
            },
            'その他': { 
                icon: 'fas fa-store', 
                color: '#FFFFFF',
                bgColor: '#7F8C8D',      // グレー
                borderColor: '#5D6D6E'   // 濃いグレー
            }
        };

        // 後方互換性のため
        const categoryEmojis = Object.fromEntries(
            Object.entries(categoryConfig).map(([key, value]) => [key, value.icon])
        );

        // 🚀 店舗データ（JSONファイルから読み込み）
        let embeddedStores = [];
        
        // JSONファイルから店舗データを読み込む（パフォーマンス最適化版）
        async function loadStores() {
            try {
                // ローカルファイルの場合はCORSエラーを回避
                if (window.location.protocol === 'file:') {
                    console.log('⚠️ ローカルファイルモード: 埋め込みデータを使用');
                    embeddedStores = getEmbeddedStoresData();
                    console.log('✅ 店舗データ読み込み完了:', embeddedStores.length, '件');
                    return embeddedStores;
                }
                
                // メインデータを読み込み
                const stores = await loadStoresWithOptimization();
                embeddedStores = stores;
                console.log('✅ 店舗データ読み込み完了:', stores.length, '件');
                return stores;
                
            } catch (error) {
                console.error('❌ 店舗データの読み込みに失敗:', error);
                console.log('⚠️ フォールバック: 埋め込みデータを使用');
                // フォールバック: 埋め込みデータを使用
                embeddedStores = getEmbeddedStoresData();
                console.log('✅ 店舗データ読み込み完了:', embeddedStores.length, '件');
                return embeddedStores;
            }
        }
        
        // 最適化されたデータ読み込み
        async function loadStoresWithOptimization() {
            const dataSources = [
                './data/embeddedStores.json',
                './embeddedStores.json'  // バックアップ
            ];
            
            for (const source of dataSources) {
                try {
                    const response = await fetch(source);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const stores = await response.json();
                    
                    // データの検証と最適化
                    const validatedStores = validateAndOptimizeStores(stores);
                    console.log(`📊 データ最適化: ${stores.length} → ${validatedStores.length} 件`);
                    
                    return validatedStores;
                    
                } catch (error) {
                    console.warn(`⚠️ ${source} 読み込み失敗:`, error.message);
                }
            }
            
            throw new Error('すべてのデータソースが利用できません');
        }
        
        // 店舗データの検証と最適化
        function validateAndOptimizeStores(stores) {
            if (!Array.isArray(stores)) {
                throw new Error('データ形式が不正です');
            }
            
            return stores
                .filter(store => {
                    // 必須フィールドのチェック
                    if (!store.id || !store.name || !store.address) {
                        console.warn('不正なデータをスキップ:', store);
                        return false;
                    }
                    return true;
                })
                .map(store => {
                    // データの正規化
                    return {
                        ...store,
                        id: parseInt(store.id),
                        latitude: store.latitude ? parseFloat(store.latitude) : null,
                        longitude: store.longitude ? parseFloat(store.longitude) : null,
                        // 空文字列をnullに変換
                        phone: store.phone || null,
                        website: store.website || null,
                        image_url: store.image_url || null,
                        opening_hours: store.opening_hours || null,
                        gluten_free_options: store.gluten_free_options || null,
                        description: store.description || null
                    };
                })
                .sort((a, b) => a.id - b.id); // ID順でソート
        }
        
        // 埋め込み店舗データを返す関数（CORSエラー回避用）
        function getEmbeddedStoresData() {
            // 最小限のフォールバックデータ（JSONファイル読み込み失敗時のみ使用）
            console.warn('⚠️ フォールバック: 埋め込みデータを使用（JSONファイルが利用できません）');
            return [
                {
                    id: 1,
                    name: "サンプル店舗（フォールバック）",
                    category: "カフェ",
                    address: "愛知県名古屋市中区栄",
                    latitude: 35.1681,
                    longitude: 136.9069,
                    phone: "",
                    website: "",
                    image_url: "",
                    description: "⚠️ これはフォールバックデータです。data/embeddedStores.jsonが読み込めない場合に表示されます。",
                    gluten_free_options: "",
                    opening_hours: ""
                }
            ];
        }
        
        // 埋め込み地名データを返す関数（CORSエラー回避用）
        function getFamousPlacesData() {
            // 主要な地名データを直接返す
            return [
                { "name": "名古屋駅", "kana": "なごやえき", "aliases": ["なごや", "名古屋"], "lat": 35.1709, "lng": 136.8816, "category": "駅・交通" },
                { "name": "栄", "kana": "さかえ", "aliases": [], "lat": 35.1698, "lng": 136.9095, "category": "繁華街" },
                { "name": "大須", "kana": "おおす", "aliases": ["大須観音"], "lat": 35.1596, "lng": 136.9003, "category": "観光地" },
                { "name": "金山駅", "kana": "かなやまえき", "aliases": ["かなやま", "金山"], "lat": 35.1429, "lng": 136.9008, "category": "駅・交通" },
                { "name": "伏見", "kana": "ふしみ", "aliases": [], "lat": 35.1694, "lng": 136.8981, "category": "ビジネス街" }
            ];
        }
        
        // 【バックアップ】元の埋め込み配列（現在は未使用）
        /*
        const embeddedStores_backup = [
          {
            "id": 6,
            "name": "みちのり弁当（Gluten-Free Michinori Bento）",
            "category": "和食",
            "address": "名古屋市西区浄心１丁目４−６",
            "latitude": 35.1938,
            "longitude": 136.8901,
            "phone": "052-5086-615",
            "website": "https://gf-michinori.jp/",
            "description": "📍グルテンフリーのお弁当専門店です。\n     テイクアウトのみでご提供しております🍱\n\n     ご注文をいただいてからお作りいたしますので、\n     事前にお電話でご予約いただくと、スムーズにお渡しできます✨",
            "gluten_free_options": "完全GF",
            "opening_hours": "11時00分～19時00分"
          },
          {
            "id": 7,
            "name": "Biople 名古屋タカシマヤゲートタワーモール店",
            "category": "販売店",
            "address": "名古屋市中村区名駅１丁目１−３ JRゲートタワー タカシマヤ モール B1F",
            "latitude": 35.1722,
            "longitude": 136.882,
            "phone": "052-5666-112",
            "website": "https://store.biople.jp/",
            "description": "ナチュラル＆オーガニックのセルフケアアイテムを幅広く取り扱うセレクトショップです。\n     グルテンフリーの珍しいお菓子など取り扱っています。\n     ・ZENB BREAD\n     ・グルテンフリーお菓子",
            "gluten_free_options": "部分GF",
            "opening_hours": "9時00分～21時00分"
          },
          {
            "id": 8,
            "name": "成城石井 名古屋駅広小路口店",
            "category": "販売店",
            "address": "名古屋市中村区名駅１丁目１−４ 名古屋うまいもん通り 広小路口",
            "latitude": 35.1698,
            "longitude": 136.8835,
            "phone": "052-5872-345",
            "website": "https://shop.seijoishii.co.jp/seijoishii/spot/detail?code=0035",
            "description": "新鮮な野菜・果物、厳選された輸入チーズやワイン、自家製サンドイッチ・お惣\n     菜、パン、スイーツ、オーガニック商品、調味料や冷凍食品も充実しているスーパーマーケットです。",
            "gluten_free_options": "部分GF",
            "opening_hours": "7時30分～22時00分"
          },
          {
            "id": 9,
            "name": "成城石井 名古屋 近鉄パッセ店",
            "category": "販売店",
            "address": "名古屋市中村区名駅１丁目２−２ 近鉄パッセ B1F",
            "latitude": 35.1695,
            "longitude": 136.8842,
            "phone": "",
            "website": "",
            "description": "",
            "gluten_free_options": "部分GF",
            "opening_hours": ""
          },
          {
            "id": 10,
            "name": "ダモンデ ミールシフォン＆スイーツ",
            "category": "スイーツ",
            "address": "名古屋市中区錦２丁目１１−２７ ＴＨ錦ビル 1F",
            "latitude": 35.1711,
            "longitude": 136.9001,
            "phone": "052-2119-333",
            "website": "https://da-monde.co.jp/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-18:00"
          },
          {
            "id": 11,
            "name": "ライラック",
            "category": "スイーツ",
            "address": "名古屋市千種区東山通１丁目１５−２",
            "latitude": 35.164,
            "longitude": 136.9651,
            "phone": "052-8877-818",
            "website": "http://lilacs.jp/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:00-19:00"
          },
          {
            "id": 12,
            "name": "エンキッチンカフェ",
            "category": "洋食",
            "address": "名古屋市中区大井町３−３１",
            "latitude": 35.1507,
            "longitude": 136.9053,
            "phone": "052-8981-015",
            "website": "http://en-kitchen.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:30-19:00"
          },
          {
            "id": 13,
            "name": "スギヤマ調剤薬局 御器所店",
            "category": "販売店",
            "address": "名古屋市昭和区阿由知通４丁目７",
            "latitude": 35.149,
            "longitude": 136.934,
            "phone": "052-8422-112",
            "website": "https://sugiyama-club.jp/shop/detail.asp?Seq=165",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "9:00-19:00,土曜のみ9:00-16:00"
          },
          {
            "id": 14,
            "name": "旬楽膳 名古屋・地アミ店",
            "category": "販売店",
            "address": "名古屋市名東区若葉台１４０２",
            "latitude": 35.1787,
            "longitude": 136.994,
            "phone": "052-7603-071",
            "website": "http://www.shun-rakuzen.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:00-20:00"
          },
          {
            "id": 15,
            "name": "コルポ",
            "category": "洋食",
            "address": "名古屋市中川区荒子１丁目１１６",
            "latitude": 35.1416,
            "longitude": 136.8603,
            "phone": "052-3628-686",
            "website": "https://cafe-corpo.owst.jp/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-18:00"
          },
          {
            "id": 16,
            "name": "カルディコーヒーファーム 名古屋ゲートウォーク店",
            "category": "販売店",
            "address": "名古屋市中村区名駅１丁目１−２ ゲートウォーク B1F",
            "latitude": 35.1743,
            "longitude": 136.8836,
            "phone": "052-5898-552",
            "website": "https://www.kaldi.co.jp/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:00-22:00"
          },
          {
            "id": 17,
            "name": "グルテンフリー 菓子屋 藤ノ宮",
            "category": "販売店",
            "address": "名古屋市中村区千原町４−５０",
            "latitude": 35.1812,
            "longitude": 136.8732,
            "phone": "052-4517-584",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-19:00"
          },
          {
            "id": 18,
            "name": "グルテンフリー＆米粉ベーグル屋 はるのはな",
            "category": "パン屋",
            "address": "名古屋市千種区萱場２丁目１３−２２",
            "latitude": 35.1824,
            "longitude": 136.9452,
            "phone": "",
            "website": "https://haruno-hana.com/shop/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-15:00"
          },
          {
            "id": 19,
            "name": "I 'm donut？（アイムドーナツ？）グルテンフリー",
            "category": "スイーツ",
            "address": "東京都渋谷区神宮前５丁目５３−４",
            "latitude": 35.6611,
            "longitude": 139.7077,
            "phone": "",
            "website": "",
            "description": "本物ドーナツそっくりのふわふわさでとてもよかったです！注文票に使用されてるアレルゲンが記載されてるの素敵だなと思います。",
            "gluten_free_options": "",
            "opening_hours": "11:00-19:00"
          },
          {
            "id": 20,
            "name": "SO TARTE 代々木上原店",
            "category": "カフェ",
            "address": "東京都渋谷区上原１丁目１８−７ 第五大貴ビル",
            "latitude": 35.6685,
            "longitude": 139.6801,
            "phone": "036-4079-260",
            "website": "https://sotarte.jp/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:00-18:00"
          },
          {
            "id": 21,
            "name": "EWALU -お米農家が営む完全グルテンフリー専門店-",
            "category": "パン屋",
            "address": "愛知県弥富市鯏浦町車東23−２",
            "phone": "056-7973-200",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "8:00-17:00"
          },
          {
            "id": 22,
            "name": "pâtisserie Éclat de",
            "category": "スイーツ",
            "address": "兵庫県西宮市上甲子園１丁目３−１０",
            "latitude": 34.7334,
            "longitude": 135.3701,
            "phone": "090-4190-1118",
            "website": "https://eclat-de-sourire.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": ""
          },
          {
            "id": 23,
            "name": "グルテンフリーの⽶粉スイーツ専⾨店 HB Style KIYOKEN",
            "category": "スイーツ",
            "address": "神奈川県横浜市西区南幸１丁目１−１ CIAL横浜 B1",
            "latitude": 35.4662,
            "longitude": 139.6193,
            "phone": "045-6208-600",
            "website": "https://hb-style-kiyoken.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:00-21:00"
          },
          {
            "id": 24,
            "name": "米m BEIEMU 米粉スイーツ&おにぎり（グルテンフリー ）",
            "category": "スイーツ",
            "address": "沖縄県読谷村喜名２３４６−１１",
            "latitude": 26.3929,
            "longitude": 127.7436,
            "phone": "",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": ""
          },
          {
            "id": 25,
            "name": "F&F 自然食品のお店",
            "category": "販売店",
            "address": "東京都千代田区麹町４丁目１−３",
            "latitude": 35.6837,
            "longitude": 139.735,
            "phone": "",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": ""
          },
          {
            "id": 26,
            "name": "ペドラブランカ 戸越銀座店",
            "category": "スイーツ",
            "address": "東京都品川区平塚２丁目１４−８ 1F",
            "latitude": 35.6213,
            "longitude": 139.7151,
            "phone": "",
            "website": "https://pedrabranca-cafe.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:00-20:00"
          },
          {
            "id": 27,
            "name": "出町ふたば",
            "category": "スイーツ",
            "address": "京都府京都市上京区青龍町２３６",
            "phone": "075-2311-658",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "8:30-17:30"
          },
          {
            "id": 28,
            "name": "SOT COFFEE ROASTER Kyoto",
            "category": "カフェ",
            "address": "京都府京都市東山区本町新５丁目１４８−２",
            "latitude": 34.9917,
            "longitude": 135.7669,
            "phone": "080-0808-8288",
            "website": "https://www.sotcoffee.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "8:00-18:00"
          },
          {
            "id": 29,
            "name": "NAYAMACHI DONUTS 君に、あげる",
            "category": "カフェ",
            "address": "京都府京都市伏見区中油掛町１０６−７",
            "latitude": 34.9315,
            "longitude": 135.7575,
            "phone": "075-6061-134",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:00-19:00"
          },
          {
            "id": 30,
            "name": "宮古冷麺",
            "category": "和食",
            "address": "沖縄県宮古島市平良下里３３８−８",
            "latitude": 24.8031,
            "longitude": 125.2697,
            "phone": "",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-15:00"
          },
          {
            "id": 31,
            "name": "OLU OLU Crep",
            "category": "スイーツ",
            "address": "神奈川県相模原市中央区横山４丁目２３−２０ メゾン村山",
            "latitude": 35.5662,
            "longitude": 139.3561,
            "phone": "042-7070-707",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-18:00"
          },
          {
            "id": 32,
            "name": "BEYOND SWEETS （ビヨンドスイーツ）カフェ 表参道店",
            "category": "スイーツ",
            "address": "東京都港区南青山３丁目１３−９",
            "phone": "036-4340-936",
            "website": "https://beyondsweets-shop-cafe.com/",
            "description": "",
            "gluten_free_options": "対応可能",
            "opening_hours": "10:00-19:00"
          },
          {
            "id": 33,
            "name": "Creperiz Stand.Nagoya",
            "category": "スイーツ",
            "address": "名古屋市中区大須３丁目３０−２５ 合点承知ビル １階",
            "latitude": 35.1602,
            "longitude": 136.9084,
            "phone": "",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:00-20:00"
          },
          {
            "id": 34,
            "name": "みちのり亭",
            "category": "和食",
            "address": "名古屋市中村区椿町８−７−２F",
            "latitude": 35.1695,
            "longitude": 136.879,
            "phone": "",
            "website": "https://gf-michinori.jp/pages/michinori-tei",
            "description": "グルテンフリーの定食屋",
            "gluten_free_options": "完全GF",
            "opening_hours": "11:00-15:00(LO14:00)  18:00-22:00(LO21::00"
          },
          {
            "id": 35,
            "name": "2525sweets",
            "category": "スイーツ",
            "address": "愛知県名古屋市中区新栄３丁目３−１ 太陽ビル １F",
            "latitude": 35.1695,
            "longitude": 136.9235,
            "phone": "090-9250-3725",
            "website": "https://2525sweets.base.shop/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "火水木11:00-17:30,金土11:00-18:00"
          },
          {
            "id": 36,
            "name": "甲賀米粉たい焼き 勝川店",
            "category": "スイーツ",
            "address": "愛知県春日井市松新町４丁目8−１",
            "latitude": 35.231,
            "longitude": 136.9568,
            "phone": "090-4426-0940",
            "website": "https://komeko.club/archives/shoplists/970",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-19:00"
          },
          {
            "id": 37,
            "name": "定食 笑いーと",
            "category": "和食",
            "address": "福島県いわき市好間町北好間南町田５５−１",
            "latitude": 37.0766,
            "longitude": 140.8651,
            "phone": "070-8308-6994",
            "website": "https://wara-eat.com/business/teishoku-wara-eat/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "6:00-15:00"
          },
          {
            "id": 38,
            "name": "titbit!(ティットビット)",
            "category": "スイーツ",
            "address": "名古屋市西区那古野１丁目１０−１７",
            "latitude": 35.1771,
            "longitude": 136.8887,
            "phone": "052-5268-133",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-18:00"
          },
          {
            "id": 39,
            "name": "米粉の焼菓子 a\" (エーダブルプライム)",
            "category": "スイーツ",
            "address": "名古屋市昭和区北山本町２丁目１８",
            "latitude": 35.1523,
            "longitude": 136.9246,
            "phone": "",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-17:00"
          },
          {
            "id": 40,
            "name": "グルテンフリー食堂 おみやはん",
            "category": "和食",
            "address": "名古屋市守山区小幡太田３−３２",
            "latitude": 35.1941,
            "longitude": 136.9758,
            "phone": "080-3548-5679",
            "website": "https://www.omiyahan.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": ""
          },
          {
            "id": 41,
            "name": "genuine gluten free Where is a dog?",
            "category": "カフェ",
            "address": "東京都武蔵野市吉祥寺本町２丁目２４−９ SUNO Ecru 103",
            "latitude": 35.7039,
            "longitude": 139.5724,
            "phone": "042-2272-812",
            "website": "",
            "description": "元々パンが大好きだったのでこうしてパンが食べられることができるのがとても幸せでした。",
            "gluten_free_options": "",
            "opening_hours": "月〜金　\t 12時00分～15時00分 17時00分～20時00分／土日\t 12時00分～20時00分"
          },
          {
            "id": 42,
            "name": "米ぱんの店ぱんて",
            "category": "パン屋",
            "address": "福井県福井市文京３丁目９−３４",
            "latitude": 36.0766846,
            "longitude": 136.2076805,
            "phone": "776636781",
            "website": "http://www.pante.jp/?mode=pc",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:00-19:00"
          },
          {
            "id": 43,
            "name": "グルテンフリーラーメン専門店 RYU-Gu 龍旗信",
            "category": "和食",
            "address": "大阪府堺市西区浜寺石津町西２丁７−６ ａｕ石津川",
            "latitude": 34.562,
            "longitude": 135.4503,
            "phone": "",
            "website": "http://www.ryukishin.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-14:30,17:30-20:45"
          },
          {
            "id": 44,
            "name": "月夜野こまもの店",
            "category": "カフェ",
            "address": "長野県上伊那郡辰野町辰野１６１５−３",
            "latitude": 35.9826,
            "longitude": 137.9938,
            "phone": "070-7564-0768",
            "website": "https://tsukikoma-tatsuno.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "日11:00-22:00,金11:00-18:00"
          },
          {
            "id": 45,
            "name": "縁-enishi-",
            "category": "パン屋",
            "address": "長野県長野市若里２丁目１−２３",
            "latitude": 36.6342,
            "longitude": 138.1864,
            "phone": "026-4666-610",
            "website": "https://enishi-sorghum.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "9:00-16:00"
          },
          {
            "id": 46,
            "name": "Buddha グルテンフリー & ヴィーガン専門店",
            "category": "カフェ",
            "address": "大阪府大阪市東成区中道１丁目８−１５ 金井ビル",
            "latitude": 34.6778,
            "longitude": 135.5337,
            "phone": "066-7537-797",
            "website": "https://buddha-online.site/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:30-15:30"
          },
          {
            "id": 47,
            "name": "where is my chou? 田町タワー店",
            "category": "スイーツ",
            "address": "東京都港区芝５丁目３３−１１ 田町タワ １－Ｆ",
            "latitude": 35.6469,
            "longitude": 139.7464,
            "phone": "",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "月〜金11:00-19:00/土日11:00-18:00"
          },
          {
            "id": 48,
            "name": "米粉ヘルシーカフェ セレンペッシュ 心斎橋店",
            "category": "カフェ",
            "address": "大阪府大阪市中央区南船場２丁目４−２０ 大阪福谷ビル 1階",
            "latitude": 34.6758,
            "longitude": 135.5031,
            "phone": "070-2424-3975",
            "website": "https://seren-peche.owst.jp/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "7:30-21:30"
          },
          {
            "id": 49,
            "name": "薬膳スパイスカレー＆グルテンフリーバルSpys Oasis",
            "category": "洋食",
            "address": "大阪府大阪市中央区難波１丁目５−８",
            "latitude": 34.6675,
            "longitude": 135.4993,
            "phone": "066-2115-115",
            "website": "http://spys-oasis.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "日11:30-22:00,月火水金土11:30-15:00,18:00-0:00"
          },
          {
            "id": 50,
            "name": "おやつ 創房優",
            "category": "スイーツ",
            "address": "岐阜県多治見市本町５丁目9−１ 陶都創造館 １階",
            "latitude": 35.3347,
            "longitude": 137.1284,
            "phone": "",
            "website": "https://www.soboyu-design.page/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:00-15:00"
          },
          {
            "id": 51,
            "name": "やまの ひつじ",
            "category": "カフェ",
            "address": "東京都渋谷区恵比寿西１丁目２６−２",
            "latitude": 35.6478,
            "longitude": 139.7032,
            "phone": "080-4710-8870",
            "website": "http://hitsuzi.chagasi.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:30-15:00"
          },
          {
            "id": 52,
            "name": "もんじゃ宝島",
            "category": "和食",
            "address": "東京都中央区月島３丁目５−４",
            "latitude": 35.6633,
            "longitude": 139.7784,
            "phone": "033-5335-700",
            "website": "https://rakukatsu.jp/tsukishima-monjya-takarajima-20210101/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "水木金17:00-22:30/ 土日12:00-16:00,17:00-22:00"
          },
          {
            "id": 53,
            "name": "MOCMO sandwiches (Gluten free sandwiches）",
            "category": "パン屋",
            "address": "東京都三鷹市下連雀１丁目１７−４ GRATO井の頭公園 1F",
            "latitude": 35.7232,
            "longitude": 139.5873,
            "phone": "036-8208-795",
            "website": "https://phoenix-since2018.com/food/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "月〜金11:00-17:00/土日9:00-17:00"
          },
          {
            "id": 54,
            "name": "ソラノイロ ARTISAN NOODLES",
            "category": "和食",
            "address": "東京都千代田区平河町１丁目３−１０ ブルービル本館 1B",
            "latitude": 35.6831,
            "longitude": 139.7369,
            "phone": "033-2635-460",
            "website": "http://soranoiro-vege.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-15:00,17:00-21:30"
          },
          {
            "id": 55,
            "name": "202カリー堂",
            "category": "洋食",
            "address": "東京都世田谷区代田５丁目３４−２１ 202",
            "latitude": 35.6614,
            "longitude": 139.6631,
            "phone": "036-4138-857",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "9:00-20:00"
          },
          {
            "id": 56,
            "name": "TORIBA COFFEE TOKYO",
            "category": "カフェ",
            "address": "東京都中央区八重洲２丁目１−１ YANMAR TOKYO B1F",
            "latitude": 35.6798,
            "longitude": 139.7645,
            "phone": "080-3715-4434",
            "website": "http://www.toriba-coffee.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "月〜金10:00-19:00/ 土日10:00-20:00"
          },
          {
            "id": 57,
            "name": "premium SOW",
            "category": "洋食",
            "address": "東京都渋谷区代官山町１２−１６ シンフォニー代官山 103",
            "latitude": 35.6507,
            "longitude": 139.701,
            "phone": "035-4223-390",
            "website": "http://premium-sow.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-18:00"
          },
          {
            "id": 58,
            "name": "RISO GRAN",
            "category": "パン屋",
            "address": "大阪府大阪市此花区春日出中２丁目１４−２３ マンション住田 1F",
            "latitude": 34.6799,
            "longitude": 135.4473,
            "phone": "070-2215-7547",
            "website": "https://risogran.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-14:00"
          },
          {
            "id": 59,
            "name": "田田田堂",
            "category": "スイーツ",
            "address": "兵庫県神戸市東灘区御影郡家１丁目２３−１２",
            "latitude": 34.7215,
            "longitude": 135.251,
            "phone": "078-8553-358",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:00-18:00"
          },
          {
            "id": 60,
            "name": "阿闍梨餅本舗満月 本店",
            "category": "スイーツ",
            "address": "京都府京都市左京区田中大堰町１３９",
            "latitude": 35.0301,
            "longitude": 135.7755,
            "phone": "075-7914-121",
            "website": "http://www.ajyarimochi.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "9:00-18:00"
          },
          {
            "id": 61,
            "name": "京都炎神",
            "category": "和食",
            "address": "京都府京都市中京区中之町５８０−２",
            "latitude": 35.0045,
            "longitude": 135.7649,
            "phone": "075-6064-234",
            "website": "",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "12:00-22:30"
          },
          {
            "id": 62,
            "name": "和レ和レ和アラシヤマ",
            "category": "和食",
            "address": "京都府京都市右京区嵯峨天龍寺芒ノ馬場町３−１４",
            "latitude": 35.0142,
            "longitude": 135.6745,
            "phone": "075-3349-065",
            "website": "https://www.bread-espresso.jp/shop/warewarewa_arashiyama.html",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "8:00-18:00"
          },
          {
            "id": 63,
            "name": "エスパルスドリームプラザ",
            "category": "販売店",
            "address": "静岡県静岡市清水区入船町１３−１５",
            "latitude": 35.0106,
            "longitude": 138.4902,
            "phone": "054-3543-360",
            "website": "https://www.dream-plaza.co.jp/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:00-20:00"
          },
          {
            "id": 64,
            "name": "グルテンフリースイーツ専門店 NachuRa Yoyogi park",
            "category": "スイーツ",
            "address": "東京都渋谷区富ケ谷１丁目１７−７ 第二山栄ビル １階",
            "latitude": 35.6664,
            "longitude": 139.6893,
            "phone": "070-4680-4217",
            "website": "https://nachura.shop/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "8:00-17:00"
          },
          {
            "id": 65,
            "name": "Linda Lindo SWEETS",
            "category": "スイーツ",
            "address": "岐阜県本巣郡北方町曲路３丁目３９",
            "latitude": 35.4311,
            "longitude": 136.6934,
            "phone": "058-2606-377",
            "website": "https://lindalindo.shop/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:00-18:00"
          },
          {
            "id": 66,
            "name": "cadeau",
            "category": "スイーツ",
            "address": "三重県津市八町２丁目１５−１",
            "latitude": 34.7204,
            "longitude": 136.4946,
            "phone": "059-2021-402",
            "website": "https://malalatete.jp/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "10:30-16:30"
          },
          {
            "id": 67,
            "name": "お米のいいなり",
            "category": "和食",
            "address": "和歌山県和歌山市小松原５丁目６−７",
            "latitude": 34.2332,
            "longitude": 135.1892,
            "phone": "073-4228-228",
            "website": "https://komeno-e-nari.com/",
            "description": "",
            "gluten_free_options": "",
            "opening_hours": "11:30-15:00,18:00-22:00"
          }
        ];
        */

        // グローバル変数
        let map;
        let stores = [];
        let markers = [];
        let famousPlaces = []; // 地名検索用データ
        let searchSuggestionIndex = -1; // キーボード選択用
        let mobileSuggestionIndex = -1; // モバイル版キーボード選択用
        let isComposing = false; // IME変換中フラグ
        let mobileIsComposing = false; // モバイルIME変換中フラグ
        
        // カスタムピン機能用変数
        let customPinMarker = null;
        let customPinLocation = null;
        let mapContextMenu = null;

        // DOM読み込み完了後に即座に初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('⚡ 埋め込みデータ版 - 高速起動');
            
            // デバッグ: 関数の存在確認
            console.log('🔧 showMyReviews関数の存在:', typeof showMyReviews !== 'undefined');
            
            initializeApp();
        });

        // アプリ初期化（認証ガード付き）
        async function initializeApp() {
            console.log('🚀 アプリ初期化開始（認証チェック）');
            console.log('🔍 現在のbody.style:', window.getComputedStyle(document.body).display);
            
            // 1. 認証状態を確認
            const isAuthenticated = await checkAuthenticationStatus();
            console.log('🔍 認証状態:', isAuthenticated);
            
            if (!isAuthenticated) {
                console.log('🔒 未認証ユーザー - ログイン画面を表示');
                // マップを表示してからモーダルを出す
                showMapScreen();
                console.log('🔍 showMapScreen完了後のbody.style:', window.getComputedStyle(document.body).display);
                
                showLoginModal();
                return;
            }
            
            console.log('✅ 認証済みユーザー - マップ画面を表示');
            
            // Phase 2: プロフィール初期化
            await initUserProfile();
            
            showMapScreen();
            
            // 2. 地図を先に初期化
            initMap();
            
            // 3. 地名データを読み込み
            await loadFamousPlaces();
            
            // 4. 訪問履歴データを読み込み
            await initVisitHistory();
            
            // 5. 店舗画像データを並行で読み込み
            await initStoreImages();
            
            // 6. 店舗データを表示（訪問履歴・画像込み）
            await loadEmbeddedStores();
            
            // 7. イベントリスナー設定
            setupEventListeners();
            
            // 8. データベース状態確認
            checkDatabaseStatus();
            
            // 9. 認証ボタンの初期状態を設定
            updateAuthButton();
            
            console.log('✅ アプリ初期化完了 - 全機能利用可能');
        }

        // 地名データを読み込み
        async function loadFamousPlaces() {
            try {
                console.log('📍 地名データを読み込み中...');
                
                // ローカルファイルの場合はCORSエラーを回避
                if (window.location.protocol === 'file:') {
                    console.log('⚠️ ローカルファイルモード: 埋め込みデータを使用');
                    famousPlaces = getFamousPlacesData();
                    console.log(`✅ 地名データ読み込み完了: ${famousPlaces.length}件`);
                    setupSearchFunctionality();
                    return;
                }
                
                const response = await fetch('data/famousPlaces.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                famousPlaces = data.places || [];
                console.log(`✅ 地名データ読み込み完了: ${famousPlaces.length}件`);
                
                // 検索機能を初期化
                setupSearchFunctionality();
            } catch (error) {
                console.error('❌ 地名データ読み込みエラー:', error);
                console.log('⚠️ フォールバック: 埋め込みデータを使用');
                famousPlaces = getFamousPlacesData();
                console.log(`✅ 地名データ読み込み完了: ${famousPlaces.length}件`);
                setupSearchFunctionality();
            }
        }

        // 検索機能のセットアップ
        function setupSearchFunctionality() {
            // PC版検索
            const searchInput = document.getElementById('sidebarSearchInput');
            const suggestions = document.getElementById('searchSuggestions');
            
            if (searchInput && suggestions) {
                // 検索入力イベント
                searchInput.addEventListener('input', handleSearchInput);
                searchInput.addEventListener('keydown', handleSearchKeydown);
                searchInput.addEventListener('blur', hideSuggestions);
                
                // IME対応
                searchInput.addEventListener('compositionstart', () => {
                    isComposing = true;
                });
                searchInput.addEventListener('compositionend', (event) => {
                    isComposing = false;
                    // 変換確定後に検索実行
                    setTimeout(() => handleSearchInput(event), 0);
                });
            }

            // モバイル版検索
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            const mobileSuggestions = document.getElementById('mobileSuggestions');
            
            if (mobileSearchInput && mobileSuggestions) {
                // モバイル検索入力イベント
                mobileSearchInput.addEventListener('input', handleMobileSearchInput);
                mobileSearchInput.addEventListener('keydown', handleMobileSearchKeydown);
                mobileSearchInput.addEventListener('blur', hideMobileSuggestions);
                
                // モバイルIME対応
                mobileSearchInput.addEventListener('compositionstart', () => {
                    mobileIsComposing = true;
                });
                mobileSearchInput.addEventListener('compositionend', (event) => {
                    mobileIsComposing = false;
                    // 変換確定後に検索実行
                    setTimeout(() => handleMobileSearchInput(event), 0);
                });
            }
            
            // 候補クリック外しで非表示
            document.addEventListener('click', (e) => {
                if (searchInput && suggestions && !searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                    hideSuggestions();
                }
                if (mobileSearchInput && mobileSuggestions && !mobileSearchInput.contains(e.target) && !mobileSuggestions.contains(e.target)) {
                    hideMobileSuggestions();
                }
            });
        }

        // 検索入力処理
        function handleSearchInput(event) {
            // IME変換中は処理しない
            if (isComposing) {
                return;
            }
            
            const query = event.target.value.trim();
            const suggestions = document.getElementById('searchSuggestions');
            
            console.log('🔍 PC検索:', query);
            
            if (query.length < 1) {
                hideSuggestions();
                // 通常の店舗検索を実行
                filterStores(query);
                return;
            }

            // 地名検索候補を表示
            const matches = searchFamousPlaces(query);
            
            if (matches.length > 0) {
                showSuggestions(matches);
            } else {
                hideSuggestions();
            }
            
            // 通常の店舗検索も並行実行
            filterStores(query);
        }

        // 地名検索
        function searchFamousPlaces(query) {
            if (!query || famousPlaces.length === 0) return [];
            
            const normalizedQuery = query.toLowerCase().trim();
            
            // 特別なマッチング処理（前方一致を優先）
            const results = famousPlaces.filter(place => {
                // 名前での前方一致検索（優先度高）
                if (place.name.toLowerCase().startsWith(normalizedQuery)) return true;
                
                // ひらがな読みでの前方一致検索
                if (place.kana.startsWith(normalizedQuery)) return true;
                
                // エイリアスでの前方一致検索
                if (place.aliases && place.aliases.some(alias => 
                    alias.toLowerCase().startsWith(normalizedQuery))) return true;
                
                // 部分一致（前方一致でヒットしなかった場合）
                if (place.name.toLowerCase().includes(normalizedQuery)) return true;
                if (place.kana.includes(normalizedQuery)) return true;
                if (place.aliases && place.aliases.some(alias => 
                    alias.toLowerCase().includes(normalizedQuery))) return true;
                
                return false;
            });
            
            // 重複除去と前方一致を優先したソート
            const uniqueResults = results.filter((place, index, arr) => 
                arr.findIndex(p => p.name === place.name) === index
            );
            
            // 前方一致を優先してソート
            uniqueResults.sort((a, b) => {
                const aStartsWithName = a.name.toLowerCase().startsWith(normalizedQuery);
                const bStartsWithName = b.name.toLowerCase().startsWith(normalizedQuery);
                const aStartsWithKana = a.kana.startsWith(normalizedQuery);
                const bStartsWithKana = b.kana.startsWith(normalizedQuery);
                
                if (aStartsWithName && !bStartsWithName) return -1;
                if (!aStartsWithName && bStartsWithName) return 1;
                if (aStartsWithKana && !bStartsWithKana) return -1;
                if (!aStartsWithKana && bStartsWithKana) return 1;
                
                return 0;
            });
            
            return uniqueResults.slice(0, 8); // 最大8件まで表示
        }

        // 検索候補を表示
        function showSuggestions(matches) {
            const suggestions = document.getElementById('searchSuggestions');
            
            suggestions.innerHTML = matches.map((place, index) => {
                const icon = getCategoryIcon(place.category);
                return `
                    <div class="suggestion-item" data-index="${index}" data-place='${JSON.stringify(place)}'>
                        <span class="suggestion-icon">${icon}</span>
                        <span class="suggestion-text">${place.name}</span>
                        <span class="suggestion-category">${place.category}</span>
                    </div>
                `;
            }).join('');
            
            // クリックイベントを追加
            suggestions.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                    const placeData = JSON.parse(item.dataset.place);
                    selectPlace(placeData);
                });
            });
            
            suggestions.style.display = 'block';
            searchSuggestionIndex = -1;
        }

        // 候補を非表示
        function hideSuggestions() {
            const suggestions = document.getElementById('searchSuggestions');
            setTimeout(() => {
                suggestions.style.display = 'none';
                searchSuggestionIndex = -1;
            }, 200);
        }

        // キーボード操作
        function handleSearchKeydown(event) {
            const suggestions = document.getElementById('searchSuggestions');
            const items = suggestions.querySelectorAll('.suggestion-item');
            
            if (items.length === 0) return;
            
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    searchSuggestionIndex = Math.min(searchSuggestionIndex + 1, items.length - 1);
                    updateSuggestionHighlight(items);
                    break;
                    
                case 'ArrowUp':
                    event.preventDefault();
                    searchSuggestionIndex = Math.max(searchSuggestionIndex - 1, -1);
                    updateSuggestionHighlight(items);
                    break;
                    
                case 'Enter':
                    event.preventDefault();
                    if (searchSuggestionIndex >= 0 && items[searchSuggestionIndex]) {
                        const selectedItem = items[searchSuggestionIndex];
                        const placeData = JSON.parse(selectedItem.dataset.place);
                        selectPlace(placeData);
                    }
                    break;
                    
                case 'Escape':
                    hideSuggestions();
                    event.target.blur();
                    break;
            }
        }

        // 候補ハイライト更新
        function updateSuggestionHighlight(items) {
            items.forEach((item, index) => {
                item.classList.toggle('highlighted', index === searchSuggestionIndex);
            });
        }

        // モバイル検索入力処理
        function handleMobileSearchInput(event) {
            // IME変換中は処理しない
            if (mobileIsComposing) {
                return;
            }
            
            const query = event.target.value.trim();
            const mobileSuggestions = document.getElementById('mobileSuggestions');
            
            console.log('📱 モバイル検索:', query);
            
            if (query.length < 1) {
                hideMobileSuggestions();
                // 通常の店舗検索を実行
                filterStores(query);
                return;
            }

            // 地名検索候補を表示
            const matches = searchFamousPlaces(query);
            
            if (matches.length > 0) {
                showMobileSuggestions(matches);
            } else {
                hideMobileSuggestions();
            }
            
            // 通常の店舗検索も並行実行
            filterStores(query);
        }

        // モバイル検索候補を表示
        function showMobileSuggestions(matches) {
            const mobileSuggestions = document.getElementById('mobileSuggestions');
            
            mobileSuggestions.innerHTML = matches.map((place, index) => {
                const icon = getCategoryIcon(place.category);
                return `
                    <div class="mobile-suggestion-item" data-index="${index}" data-place='${JSON.stringify(place)}'>
                        <span class="mobile-suggestion-icon">${icon}</span>
                        <span class="mobile-suggestion-text">${place.name}</span>
                        <span class="mobile-suggestion-category">${place.category}</span>
                    </div>
                `;
            }).join('');
            
            // クリックイベントを追加
            mobileSuggestions.querySelectorAll('.mobile-suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                    const placeData = JSON.parse(item.dataset.place);
                    selectMobilePlace(placeData);
                });
            });
            
            mobileSuggestions.style.display = 'block';
            mobileSuggestionIndex = -1;
        }

        // モバイル候補を非表示
        function hideMobileSuggestions() {
            const mobileSuggestions = document.getElementById('mobileSuggestions');
            setTimeout(() => {
                mobileSuggestions.style.display = 'none';
                mobileSuggestionIndex = -1;
            }, 200);
        }

        // モバイル版キーボード操作
        function handleMobileSearchKeydown(event) {
            const mobileSuggestions = document.getElementById('mobileSuggestions');
            const items = mobileSuggestions.querySelectorAll('.mobile-suggestion-item');
            
            if (items.length === 0) return;
            
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    mobileSuggestionIndex = Math.min(mobileSuggestionIndex + 1, items.length - 1);
                    updateMobileSuggestionHighlight(items);
                    break;
                    
                case 'ArrowUp':
                    event.preventDefault();
                    mobileSuggestionIndex = Math.max(mobileSuggestionIndex - 1, -1);
                    updateMobileSuggestionHighlight(items);
                    break;
                    
                case 'Enter':
                    event.preventDefault();
                    if (mobileSuggestionIndex >= 0 && items[mobileSuggestionIndex]) {
                        const selectedItem = items[mobileSuggestionIndex];
                        const placeData = JSON.parse(selectedItem.dataset.place);
                        selectMobilePlace(placeData);
                    }
                    break;
                    
                case 'Escape':
                    hideMobileSuggestions();
                    event.target.blur();
                    break;
            }
        }

        // モバイル候補ハイライト更新
        function updateMobileSuggestionHighlight(items) {
            items.forEach((item, index) => {
                item.classList.toggle('highlighted', index === mobileSuggestionIndex);
            });
        }

        // モバイル版地名選択時の処理
        function selectMobilePlace(place) {
            console.log('🗾 モバイル地名選択:', place.name);
            
            // 検索入力を更新
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            if (mobileSearchInput) {
                mobileSearchInput.value = place.name;
            }
            hideMobileSuggestions();
            
            // 地図が初期化されているか確認
            if (!map) {
                console.error('❌ 地図が初期化されていません');
                return;
            }
            
            console.log(`📍 ${place.name}へ移動: [${place.lat}, ${place.lng}]`);
            
            // 地図を移動（スムーズアニメーション）
            map.setView([place.lat, place.lng], 14, {
                animate: true,
                duration: 1.5
            });
            
            // モバイルでは地図タブに切り替え
            if (!isDesktop()) {
                // 地図タブに切り替え
                document.querySelectorAll('.bottom-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                const mapTab = document.querySelector('.bottom-tab[data-view="map"]');
                if (mapTab) {
                    mapTab.classList.add('active');
                }
                
                // 地図ビューを表示
                document.getElementById('mapView').style.display = 'block';
                document.getElementById('storeListView').style.display = 'none';
            }
            
            // 選択地点にテンポラリマーカーを表示
            showLocationMarker(place);
        }

        // 地名選択時の処理
        function selectPlace(place) {
            console.log('🗾 地名選択:', place.name);
            
            // 検索入力をクリア
            const searchInput = document.getElementById('sidebarSearchInput');
            if (searchInput) {
                searchInput.value = place.name;
            }
            hideSuggestions();
            
            // 地図が初期化されているか確認
            if (!map) {
                console.error('❌ 地図が初期化されていません');
                return;
            }
            
            console.log(`📍 ${place.name}へ移動: [${place.lat}, ${place.lng}]`);
            
            // 地図を移動（スムーズアニメーション）
            map.setView([place.lat, place.lng], 14, {
                animate: true,
                duration: 1.5
            });
            
            // 選択地点にテンポラリマーカーを表示
            showLocationMarker(place);
        }

        // 地名選択時の位置マーカー表示
        function showLocationMarker(place) {
            // 既存のロケーションマーカーを削除
            if (window.locationMarker) {
                map.removeLayer(window.locationMarker);
            }
            
            // 新しいマーカーを作成
            const icon = getCategoryIcon(place.category);
            window.locationMarker = L.marker([place.lat, place.lng], {
                icon: L.divIcon({
                    html: `
                        <div style="
                            background: linear-gradient(135deg, #ff6b9d 0%, #c2185b 100%);
                            color: white;
                            border-radius: 20px;
                            padding: 8px 12px;
                            font-size: 14px;
                            font-weight: 600;
                            box-shadow: 0 4px 12px rgba(255, 107, 157, 0.4);
                            border: 2px solid white;
                            white-space: nowrap;
                        ">
                            ${icon} ${place.name}
                        </div>
                    `,
                    className: 'location-marker',
                    iconSize: [null, 40],
                    iconAnchor: [null, 40]
                })
            }).addTo(map);
            
            // 3秒後にマーカーをフェードアウト
            setTimeout(() => {
                if (window.locationMarker) {
                    map.removeLayer(window.locationMarker);
                    window.locationMarker = null;
                }
            }, 5000);
        }

        // カテゴリアイコン取得
        function getCategoryIcon(category) {
            const icons = {
                '駅・交通': '🚉',
                '繁華街': '🏙️', 
                '観光地': '🗾',
                '空港': '✈️',
                'テーマパーク': '🎢'
            };
            return icons[category] || '📍';
        }

        // 認証状態チェック（PINコード認証版）
        async function checkAuthenticationStatus() {
            try {
                console.log('🔍 認証状態をチェック中...');
                
                // LocalStorageから認証情報を確認
                const savedAuth = localStorage.getItem('pinAuth');
                if (savedAuth) {
                    try {
                        const authData = JSON.parse(savedAuth);
                        // 保存されている認証情報が有効か確認
                        if (authData && authData.email && authData.timestamp) {
                            // 認証から24時間以内かチェック
                            const authTime = new Date(authData.timestamp);
                            const now = new Date();
                            const hoursPassed = (now - authTime) / (1000 * 60 * 60);
                            
                            if (hoursPassed < 24) {
                                setCurrentUser(authData.email);
                                console.log('✅ 有効なPIN認証セッション:', getCurrentUser());
                                return true;
                            } else {
                                console.log('⏰ PIN認証の有効期限切れ');
                                localStorage.removeItem('pinAuth');
                            }
                        }
                    } catch (e) {
                        console.error('認証データ解析エラー:', e);
                        localStorage.removeItem('pinAuth');
                    }
                }
                
                console.log('❌ 有効な認証セッションなし');
                return false;
                
            } catch (error) {
                console.error('❌ 認証チェックエラー:', error);
                return false;
            }
        }

        // ログイン画面をモーダルで表示（HTMLを書き換えない）
        function showLoginModal() {
            const modalHTML = `
                <div class="login-modal-overlay" id="loginModalOverlay">
                    <div class="login-modal-content">
                        <div class="login-header">
                            <img src="nacoキャラクター.png" alt="naco" class="login-logo">
                            <h1>グルテンフリーマップ</h1>
                            <p>ビヨグル倶楽部</p>
                        </div>
                        <div class="login-content">
                            <!-- 初回ログイン案内 -->
                            <div class="first-time-notice">
                                <div class="notice-header">
                                    <i class="fas fa-info-circle"></i>
                                    <span>初回ログインの方へ</span>
                                </div>
                                <div class="notice-content">
                                    <p>1. 管理者から登録されたメールアドレスを入力</p>
                                    <p>2. 適当な4桁の数字を入力（例：0000）</p>
                                    <p>3. 自動でPIN設定画面が表示されます</p>
                                </div>
                            </div>
                            
                            <h2>会員ログイン</h2>
                            <p>登録済みのメールアドレスと<br>PINコードを入力してください</p>
                            
                            <div class="login-form">
                                <div class="input-group">
                                    <label for="modalEmailInput">メールアドレス</label>
                                    <input type="email" id="modalEmailInput" placeholder="example@email.com" 
                                           onkeypress="if(event.key==='Enter') document.getElementById('modalPinInput').focus()">
                                </div>
                                
                                <div class="input-group">
                                    <label for="modalPinInput">PINコード（4桁）</label>
                                    <input type="password" id="modalPinInput" placeholder="••••" maxlength="4" 
                                           pattern="[0-9]*" inputmode="numeric"
                                           onkeypress="if(event.key==='Enter') performModalPinLogin().catch(console.error)">
                                </div>
                                
                                <div id="modalLoginError" class="login-error" style="display: none;">
                                    メールアドレスまたはPINコードが正しくありません
                                </div>
                                
                                <button id="modalLoginBtn" class="pin-login-btn" onclick="performModalPinLogin().catch(console.error)">
                                    <i class="fas fa-sign-in-alt"></i>
                                    ログイン
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.style.overflow = 'hidden';
        }

        // モーダルログイン処理
        async function performModalPinLogin() {
            const email = document.getElementById('modalEmailInput').value.trim();
            const pin = document.getElementById('modalPinInput').value.trim();
            const errorElement = document.getElementById('modalLoginError');
            const loginButton = document.getElementById('modalLoginBtn');
            
            // 入力チェック
            if (!email || !pin) {
                errorElement.style.display = 'block';
                errorElement.textContent = 'メールアドレスとPINコードを入力してください';
                return;
            }
            
            // PIN形式チェック
            if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                errorElement.style.display = 'block';
                errorElement.textContent = 'PINコードは4桁の数字で入力してください';
                return;
            }
            
            // 承認済みユーザーリストを取得
            const approvedUsers = await getApprovedUsers();
            const user = approvedUsers.find(u => u.email === email);
            
            console.log('🔐 ログイン試行:', { email, approvedUsers, user });
            
            if (!user) {
                console.log('❌ 承認されていないメールアドレス:', email);
                console.log('📋 現在の承認済みユーザー:', approvedUsers.map(u => u.email));
                
                // 緊急措置：よく使われるメールアドレスの場合は自動登録を試行
                const commonEmails = ['bettger1000@gmail.com', 'demo@example.com'];
                if (commonEmails.includes(email)) {
                    console.log('🔄 よく使用されるメールアドレスを自動登録中...');
                    
                    const users = await getApprovedUsers();
                    users.push({
                        id: Date.now(),
                        email: email,
                        registeredAt: new Date().toISOString(),
                        hasPin: false
                    });
                    await saveApprovedUsers(users);
                    
                    console.log('✅ 自動登録完了 - 再試行してください');
                    errorElement.style.display = 'block';
                    errorElement.innerHTML = '初回ログインのため自動登録しました。<br>もう一度ログインボタンを押してください。';
                    return;
                }
                
                errorElement.style.display = 'block';
                errorElement.textContent = 'このメールアドレスは承認されていません';
                return;
            }
            
            // PIN未設定の場合は設定画面に遷移
            if (!user.hasPin) {
                showPinSetupModal(email);
                return;
            }
            
            // PIN認証
            const isValid = await validateUserPin(email, pin);
            
            if (isValid) {
                // 認証成功
                setCurrentUser(email);
                
                // 認証情報を保存
                const authData = {
                    email: email,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('pinAuth', JSON.stringify(authData));
                
                // ユーザー切り替え時の訪問履歴クリア
                userVisitHistory.clear();
                console.log('🔄 ユーザー切り替え - 訪問履歴をクリア');
                
                // モーダルを閉じる
                closeLoginModal();
                
                // アプリを初期化（認証後）
                await initializeApp();
                
                console.log('✅ モーダルログイン成功:', email);
            } else {
                // 認証失敗
                errorElement.style.display = 'block';
                errorElement.textContent = 'メールアドレスまたはPINコードが正しくありません';
                document.getElementById('modalPinInput').value = '';
            }
        }

        // ログインモーダルを閉じる
        function closeLoginModal() {
            const modal = document.getElementById('loginModalOverlay');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }

        // ========== ユーザー認証システム ==========
        
        // 承認済みユーザーリストを取得（Supabase優先、LocalStorageフォールバック）
        async function getApprovedUsers() {
            try {
                // まずSupabaseの既存user_profilesテーブルから取得を試みる
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('email, pin, is_active, created_at')
                    .eq('is_active', true);
                
                if (!error && data) {
                    // Supabaseから取得成功
                    const users = data.map(user => ({
                        id: user.email, // emailをIDとして使用
                        email: user.email,
                        registeredAt: user.created_at || new Date().toISOString(),
                        hasPin: !!user.pin // PINが設定されているかどうか
                    }));
                    
                    // LocalStorageにもキャッシュとして保存
                    localStorage.setItem('approvedUsers', JSON.stringify(users));
                    console.log('✅ Supabaseから承認済みユーザーを取得:', users.length, '人');
                    return users;
                }
                
                // Supabaseから取得失敗時はLocalStorageから取得
                console.warn('⚠️ Supabaseから取得失敗、LocalStorageを使用:', error);
                const savedUsers = localStorage.getItem('approvedUsers');
                console.log('🔍 LocalStorage approvedUsers:', savedUsers);
                
                if (savedUsers) {
                    const users = JSON.parse(savedUsers);
                    console.log('📝 承認済みユーザー一覧:', users);
                    return users;
                } else {
                    console.log('⚠️ LocalStorageにapprovedUsersが見つかりません - 空配列を返します');
                    return [];
                }
            } catch (error) {
                console.error('ユーザーデータ取得エラー:', error);
                // エラー時はLocalStorageから取得
                try {
                    const savedUsers = localStorage.getItem('approvedUsers');
                    if (savedUsers) {
                        return JSON.parse(savedUsers);
                    }
                } catch (e) {
                    console.error('LocalStorage取得も失敗:', e);
                }
                return [];
            }
        }

        // ユーザーデータを保存（Supabaseとローカル両方）
        async function saveApprovedUsers(users) {
            try {
                // LocalStorageに即座に保存（即座の反映のため）
                localStorage.setItem('approvedUsers', JSON.stringify(users));
                
                // Supabaseにも非同期で保存
                for (const user of users) {
                    console.log('🚨 [発見] saveApprovedUsers実行中 - ユーザー:', user.email);
                    
                    // 🛡️ 既存のニックネームを保持する安全な保存
                    // 既存データを取得
                    const { data: existingProfile } = await supabaseClient
                        .from('user_profiles')
                        .select('nickname')
                        .eq('email', user.email)
                        .single();
                    
                    // 既存ニックネームがあれば保持、なければデフォルト
                    const safeNickname = existingProfile?.nickname || (user.email.split('@')[0] || 'ユーザー');
                    console.log('🛡️ [保護] 保持するnickname:', `"${safeNickname}"`);
                    
                    const { error } = await supabaseClient
                        .from('user_profiles')
                        .upsert({
                            email: user.email,
                            nickname: safeNickname, // 既存値を保持
                            is_active: true
                            // pinは別途管理（既存のpinを上書きしない）
                        });
                    
                    if (error) {
                        console.warn('Supabase保存エラー:', error);
                    }
                }
                console.log('✅ 承認済みユーザーをSupabaseに同期');
            } catch (error) {
                console.error('ユーザーデータ保存エラー:', error);
                // エラーでもLocalStorageには保存済みなので処理続行可能
            }
        }

        // デバッグ用：コンソールから実行可能な関数
        window.debugAuth = {
            showUsers: async () => {
                console.log('承認済みユーザー:', await getApprovedUsers());
            },
            addTestUser: async (email) => {
                const users = await getApprovedUsers();
                users.push({
                    id: Date.now(),
                    email: email,
                    registeredAt: new Date().toISOString(),
                    hasPin: false
                });
                await saveApprovedUsers(users);
                console.log('テストユーザーを追加:', email);
            },
            clearUsers: () => {
                localStorage.removeItem('approvedUsers');
                console.log('ユーザーデータをクリア');
            },
            syncFromAdmin: async () => {
                // 管理画面のデータを取得してコピー
                console.log('🔄 管理画面からユーザーデータを同期中...');
                try {
                    // 既知のユーザーアドレスを自動登録（緊急措置）
                    const commonUsers = ['bettger1000@gmail.com', 'demo@example.com'];
                    const currentUsers = await getApprovedUsers();
                    
                    commonUsers.forEach(email => {
                        if (!currentUsers.find(u => u.email === email)) {
                            currentUsers.push({
                                id: Date.now() + Math.random(),
                                email: email,
                                registeredAt: new Date().toISOString(),
                                hasPin: false
                            });
                            console.log('✅ 自動登録:', email);
                        }
                    });
                    
                    await saveApprovedUsers(currentUsers);
                    console.log('🔄 同期完了 - 現在のユーザー:', currentUsers.length, '人');
                } catch (error) {
                    console.error('❌ 同期エラー:', error);
                }
            }
        };

        // ユーザーPIN検証（Supabase優先、LocalStorageフォールバック）
        async function validateUserPin(email, pin) {
            try {
                // まずSupabaseからPINを取得
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('pin')
                    .eq('email', email)
                    .eq('is_active', true)
                    .single();
                
                if (!error && data && data.pin) {
                    const inputHash = btoa(pin + email);
                    const isValid = data.pin === inputHash;
                    console.log('✅ SupabaseからPIN検証:', isValid);
                    return isValid;
                }
                
                // Supabase失敗時はLocalStorageで検証
                console.warn('⚠️ Supabase PIN取得失敗、LocalStorageで検証');
                const userPins = JSON.parse(localStorage.getItem('userPins') || '{}');
                const storedHash = userPins[email];
                
                if (!storedHash) return false;
                
                const inputHash = btoa(pin + email);
                return storedHash === inputHash;
            } catch (error) {
                console.error('PIN検証エラー:', error);
                // エラー時はLocalStorageで検証
                try {
                    const userPins = JSON.parse(localStorage.getItem('userPins') || '{}');
                    const storedHash = userPins[email];
                    if (!storedHash) return false;
                    const inputHash = btoa(pin + email);
                    return storedHash === inputHash;
                } catch (e) {
                    return false;
                }
            }
        }

        // ユーザーPIN設定（Supabase優先、LocalStorageフォールバック）
        async function setUserPin(email, pin) {
            try {
                // 簡易ハッシュ（本来はbcrypt等を使用）
                const pinHash = btoa(pin + email);
                
                // LocalStorageに即座保存（即座の反映のため）
                const userPins = JSON.parse(localStorage.getItem('userPins') || '{}');
                userPins[email] = pinHash;
                localStorage.setItem('userPins', JSON.stringify(userPins));
                
                // Supabaseにも保存
                console.log('🚨 [発見] setUserPin実行中 - ユーザー:', email);
                
                // 🛡️ 既存のニックネームを保持する安全な保存
                const { data: existingProfile } = await supabaseClient
                    .from('user_profiles')
                    .select('nickname')
                    .eq('email', email)
                    .single();
                
                // 既存ニックネームがあれば保持、なければデフォルト
                const safeNickname = existingProfile?.nickname || (email.split('@')[0] || 'ユーザー');
                console.log('🛡️ [保護] 保持するnickname:', `"${safeNickname}"`);
                
                const { error } = await supabaseClient
                    .from('user_profiles')
                    .upsert({
                        email: email,
                        nickname: safeNickname, // 既存値を保持
                        pin: pinHash,
                        is_active: true
                    });
                
                if (error) {
                    console.warn('⚠️ Supabase PIN保存エラー（LocalStorageには保存済み）:', error);
                } else {
                    console.log('✅ PINをSupabaseに保存しました');
                }
                
                // ユーザーデータの hasPin フラグを更新
                const approvedUsers = await getApprovedUsers();
                const user = approvedUsers.find(u => u.email === email);
                if (user) {
                    user.hasPin = true;
                    await saveApprovedUsers(approvedUsers);
                }
                
                return true;
            } catch (error) {
                console.error('PIN設定エラー:', error);
                return false;
            }
        }

        // PIN設定画面を表示
        function showPinSetupModal(email) {
            const modalHTML = `
                <div class="login-modal-overlay" id="pinSetupModalOverlay">
                    <div class="login-modal-content">
                        <div class="login-header">
                            <img src="nacoキャラクター.png" alt="naco" class="login-logo">
                            <h1>PIN設定</h1>
                            <p>初回ログイン</p>
                        </div>
                        <div class="login-content">
                            <h2>PINコードを設定してください</h2>
                            <p>メールアドレス: <strong>${email}</strong><br>
                            4桁の数字でPINコードを設定してください</p>
                            
                            <div class="login-form">
                                <div class="input-group">
                                    <label for="newPinInput">新しいPINコード（4桁）</label>
                                    <input type="password" id="newPinInput" placeholder="••••" maxlength="4" 
                                           pattern="[0-9]*" inputmode="numeric"
                                           onkeypress="if(event.key==='Enter') document.getElementById('confirmPinInput').focus()">
                                </div>
                                
                                <div class="input-group">
                                    <label for="confirmPinInput">PINコード確認</label>
                                    <input type="password" id="confirmPinInput" placeholder="••••" maxlength="4" 
                                           pattern="[0-9]*" inputmode="numeric"
                                           onkeypress="if(event.key==='Enter') performPinSetup('${email}').catch(console.error)">
                                </div>
                                
                                <div id="pinSetupError" class="login-error" style="display: none;">
                                    エラーメッセージ
                                </div>
                                
                                <button type="button" class="pin-login-btn" onclick="performPinSetup('${email}').catch(console.error)">
                                    <i class="fas fa-key"></i>
                                    PINを設定
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 既存のモーダルを削除
            closeLoginModal();
            
            // 新しいモーダルを追加
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.style.overflow = 'hidden';
            
            // フォーカス設定
            setTimeout(() => {
                document.getElementById('newPinInput').focus();
            }, 100);
        }

        // PIN設定処理
        async function performPinSetup(email) {
            const newPin = document.getElementById('newPinInput').value.trim();
            const confirmPin = document.getElementById('confirmPinInput').value.trim();
            const errorElement = document.getElementById('pinSetupError');
            
            // エラーメッセージをリセット
            errorElement.style.display = 'none';
            
            // 入力チェック
            if (!newPin || !confirmPin) {
                errorElement.style.display = 'block';
                errorElement.textContent = 'PINコードを入力してください';
                return;
            }
            
            if (newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
                errorElement.style.display = 'block';
                errorElement.textContent = 'PINコードは4桁の数字で入力してください';
                return;
            }
            
            if (newPin !== confirmPin) {
                errorElement.style.display = 'block';
                errorElement.textContent = 'PINコードが一致しません';
                return;
            }
            
            // PIN設定実行
            if (await setUserPin(email, newPin)) {
                // 成功 - 認証情報を保存してアプリ初期化
                setCurrentUser(email);
                localStorage.setItem('pinAuth', JSON.stringify({
                    email: email,
                    timestamp: new Date().toISOString()
                }));
                
                // ユーザー切り替え時の訪問履歴クリア
                userVisitHistory.clear();
                console.log('🔄 新規ユーザー登録 - 訪問履歴をクリア');
                
                // モーダルを閉じる
                const modal = document.getElementById('pinSetupModalOverlay');
                if (modal) {
                    modal.remove();
                    document.body.style.overflow = '';
                }
                
                // アプリを初期化
                await initializeApp();
                
                console.log('✅ PIN設定完了:', email);
            } else {
                errorElement.style.display = 'block';
                errorElement.textContent = 'PIN設定に失敗しました';
            }
        }

        // 元の関数名は残すが、新しい関数を呼ぶように変更
        function showLoginScreen() {
            showLoginModal();
        }

        // 元の長い関数は削除（非表示にするため）
        function showLoginScreenOld() {
            document.body.innerHTML = `
                <div class="login-container">
                    <div class="login-card">
                        <div class="login-header">
                            <img src="nacoキャラクター.png" alt="naco" class="login-logo">
                            <h1>グルテンフリーマップ</h1>
                            <p>ビヨグル倶楽部</p>
                        </div>
                        <div class="login-content">
                            <h2>会員ログイン</h2>
                            <p>登録済みのメールアドレスと<br>PINコードを入力してください</p>
                            
                            <div class="login-form">
                                <div class="input-group">
                                    <label for="emailInput">メールアドレス</label>
                                    <input type="email" id="emailInput" placeholder="example@email.com" 
                                           onkeypress="if(event.key==='Enter') document.getElementById('pinInput').focus()">
                                </div>
                                
                                <div class="input-group">
                                    <label for="pinInput">PINコード（4桁）</label>
                                    <input type="password" id="pinInput" placeholder="••••" maxlength="4" 
                                           pattern="[0-9]*" inputmode="numeric"
                                           onkeypress="if(event.key==='Enter') performPinLogin()">
                                </div>
                                
                                <div id="loginError" class="login-error" style="display: none;">
                                    メールアドレスまたはPINコードが正しくありません
                                </div>
                                
                                <button id="loginBtn" class="pin-login-btn" onclick="performPinLogin()">
                                    <i class="fas fa-sign-in-alt"></i>
                                    ログイン
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    .login-container {
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: var(--gradient-bg);
                        padding: var(--space-lg);
                    }
                    .login-card {
                        background: var(--bg-glass);
                        backdrop-filter: blur(20px);
                        border-radius: var(--radius-2xl);
                        padding: var(--space-2xl);
                        box-shadow: var(--shadow-xl);
                        text-align: center;
                        max-width: 400px;
                        width: 100%;
                    }
                    .login-logo {
                        width: 80px;
                        height: 80px;
                        object-fit: contain;
                        margin-bottom: var(--space-md);
                    }
                    .login-header h1 {
                        color: var(--primary);
                        font-size: 1.8rem;
                        margin-bottom: var(--space-xs);
                    }
                    .login-header p {
                        color: var(--text-secondary);
                        font-size: 1rem;
                        margin-bottom: var(--space-xl);
                    }
                    .login-content h2 {
                        color: var(--text-primary);
                        font-size: 1.3rem;
                        margin-bottom: var(--space-md);
                    }
                    .login-content p {
                        color: var(--text-secondary);
                        margin-bottom: var(--space-xl);
                        line-height: 1.6;
                    }
                    .login-form {
                        margin-top: var(--space-xl);
                    }
                    .input-group {
                        margin-bottom: var(--space-lg);
                        text-align: left !important;
                    }
                    .input-group label {
                        display: block;
                        color: var(--text-secondary);
                        font-size: 0.9rem;
                        margin-bottom: var(--space-xs);
                        font-weight: 500;
                    }
                    .input-group input {
                        width: 100%;
                        padding: var(--space-md);
                        border: 2px solid var(--border-light);
                        border-radius: var(--radius-md);
                        font-size: 1rem;
                        transition: all 0.3s ease;
                        background: white;
                        color: var(--text-primary);
                    }
                    .input-group input:focus {
                        outline: none;
                        border-color: var(--primary);
                        box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
                    }
                    .login-error {
                        color: var(--error);
                        font-size: 0.9rem;
                        margin-bottom: var(--space-md);
                        padding: var(--space-sm);
                        background: rgba(239, 68, 68, 0.1);
                        border-radius: var(--radius-sm);
                    }
                    .pin-login-btn,
                    .google-login-btn {
                        background: #4285f4;
                        color: white;
                        border: none;
                        padding: var(--space-md) var(--space-xl);
                        border-radius: var(--radius-lg);
                        font-size: 1rem;
                        font-weight: 500;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: var(--space-sm);
                        width: 100%;
                        transition: all 0.2s ease;
                    }
                    .google-login-btn:hover {
                        background: #3367d6;
                        transform: translateY(-1px);
                        box-shadow: var(--shadow-lg);
                    }
                </style>
            `;
        }

        // マップ画面を表示
        function showMapScreen() {
            console.log('📍 マップ画面を表示');
            
            // デバッグ: DOM要素の存在確認
            const bodyElement = document.body;
            const appContainer = document.querySelector('.app-container');
            const header = document.querySelector('.app-header');
            const mainContent = document.querySelector('.main-content');
            
            console.log('🔍 DOM要素チェック:', {
                body: !!bodyElement,
                appContainer: !!appContainer,
                header: !!header,
                mainContent: !!mainContent
            });
            
            // 基本的な表示設定
            if (bodyElement) {
                bodyElement.style.display = 'block';
                bodyElement.style.visibility = 'visible';
                bodyElement.style.opacity = '1';
                console.log('✅ body要素表示設定完了');
            }
            
            if (appContainer) {
                appContainer.style.display = 'flex';
                appContainer.style.visibility = 'visible';
                appContainer.style.opacity = '1';
                console.log('✅ アプリコンテナ表示設定完了');
            } else {
                console.error('❌ アプリコンテナが見つかりません');
            }
            
            if (header) {
                header.style.display = 'block';
                header.style.visibility = 'visible';
                console.log('✅ ヘッダー表示設定完了');
            }
            
            if (mainContent) {
                mainContent.style.display = 'flex';
                mainContent.style.visibility = 'visible';
                console.log('✅ メインコンテンツ表示設定完了');
            }
        }

        // PINコード認証実行
        async function performPinLogin() {
            try {
                console.log('🔐 PINコード認証を開始...');
                
                // 入力値を取得
                const email = document.getElementById('emailInput').value.trim().toLowerCase();
                const pin = document.getElementById('pinInput').value.trim();
                
                console.log('🔍 入力値確認:', { email, pin: pin ? '****' : '(空)' });
                
                // 入力チェック
                if (!email || !pin) {
                    showLoginError('メールアドレスとPINコードを入力してください');
                    return;
                }
                
                if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                    showLoginError('PINコードは4桁の数字で入力してください');
                    return;
                }
                
                // 認証リスト確認（デバッグ用）
                console.log('🔍 認証リスト確認:', AUTHORIZED_USERS.map(u => ({ email: u.email, pinLength: u.pin.length })));
                
                // 認証リストと照合
                const authorizedUser = AUTHORIZED_USERS.find(
                    user => {
                        const emailMatch = user.email.toLowerCase() === email;
                        const pinMatch = user.pin === pin;
                        console.log(`🔍 ユーザー照合 ${user.email}:`, { emailMatch, pinMatch });
                        return emailMatch && pinMatch;
                    }
                );
                
                if (authorizedUser) {
                    console.log('✅ PINコード認証成功:', email);
                    
                    // 認証情報をLocalStorageに保存
                    const authData = {
                        email: authorizedUser.email,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('pinAuth', JSON.stringify(authData));
                    
                    // currentUserを統一設定
                    setCurrentUser(authorizedUser.email);
                    
                    // ログイン成功メッセージ
                    document.getElementById('loginBtn').innerHTML = '<i class="fas fa-check"></i> ログイン成功！';
                    document.getElementById('loginBtn').disabled = true;
                    
                    // 少し待ってからリロード（アプリ初期化）- 無効化
                    console.log('✅ PIN認証成功 - リロードなしで継続');
                    // setTimeout(() => {
                    //     window.location.reload();
                    // }, 1000);
                    
                } else {
                    console.log('❌ PINコード認証失敗');
                    showLoginError('メールアドレスまたはPINコードが正しくありません');
                    
                    // PINコード入力欄をクリア
                    document.getElementById('pinInput').value = '';
                    document.getElementById('pinInput').focus();
                }
                
            } catch (error) {
                console.error('❌ 認証処理エラー:', error);
                showLoginError('認証処理中にエラーが発生しました');
            }
        }
        
        // ログインエラー表示
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                
                // 3秒後に非表示
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // Google認証実行（無効化・バックアップとして残す）
        async function performGoogleLogin() {
            // この関数は使用しないが、コードの整合性のため残しておく
            console.log('⚠️ Google認証は無効化されています');
            alert('現在、PINコード認証のみ利用可能です');
        }

        // データベース状態確認（簡略版）
        async function checkDatabaseStatus() {
            try {
                // 基本接続確認のみ
                const { data, error } = await supabaseClient
                    .from('visit_history')
                    .select('count', { count: 'exact' })
                    .limit(1);
                
                if (error) {
                    console.warn('⚠️ データベース接続確認エラー:', error);
                } else {
                    console.log('✅ データベース接続正常');
                }
            } catch (error) {
                console.warn('⚠️ データベース確認エラー:', error);
            }
        }

        // 埋め込み店舗データ読み込み（即座）
        async function loadEmbeddedStores() {
            console.log('📦 店舗データ読み込み開始');
            
            // JSONファイルから店舗データを読み込み
            const loadedStores = await loadStores();
            stores = loadedStores;
            
            // マップが準備完了していればマーカーを表示
            if (map) {
                displayStores(stores);
            }
            
            // デバイス別UI更新
            if (isDesktop()) {
                // PC用サイドバーに表示
                displayStoreList(stores);
            } else {
                // モバイル用オーバーレイパネルに初期表示
                updatePanelContent('all');
            }
            
            console.log(`✅ ${stores.length}店舗のデータを読み込み完了`);
        }

        // マップ初期化
        function initMap() {
            try {
                console.log('🗺️ 地図初期化開始');
                
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    console.error('マップ要素が見つかりません');
                    return;
                }

                // デフォルト位置（日本全体）
                const defaultCenter = [35.6762, 139.6503];
                const defaultZoom = 6;

                map = L.map('map', {
                    center: defaultCenter,
                    zoom: defaultZoom,
                    zoomControl: false, // 一旦無効にして後で追加
                    scrollWheelZoom: true
                });

                // 現在地を取得して地図の中心に設定
                getCurrentLocationAndCenter();
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(map);


                // マップ準備完了時に店舗マーカーを表示
                map.whenReady(() => {
                    console.log('🗺️ 地図準備完了 - マーカー表示');
                    displayStores(stores);
                    
                    // カスタムピン機能を初期化
                    initCustomPinFeature();
                });

                console.log('✅ 地図初期化完了');
            } catch (error) {
                console.error('地図初期化エラー:', error);
            }
        }

        // マップに店舗表示
        function displayStores(storesData) {
            if (!map) {
                console.log('⏳ 地図準備中のため、マーカー表示を待機');
                return;
            }

            // 既存マーカー削除
            markers.forEach(marker => {
                try {
                    map.removeLayer(marker);
                } catch (e) {
                    console.warn('マーカー削除エラー:', e);
                }
            });
            markers = [];

            for (const store of storesData) {
                if (!store.latitude || !store.longitude) {
                    console.warn(`店舗「${store.name}」の座標が無効です`);
                    continue;
                }

                try {
                    const config = categoryConfig[store.category] || categoryConfig['その他'];

                    const marker = L.marker([store.latitude, store.longitude], {
                        icon: L.divIcon({
                            className: 'elegant-marker',
                            html: `
                                <div class="marker-container">
                                    <div class="marker-icon" style="
                                        background: ${config.bgColor};
                                        border: 3px solid ${config.borderColor};
                                        color: ${config.color};
                                        width: 40px;
                                        height: 40px;
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 18px;
                                        font-weight: bold;
                                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                        transition: transform 0.2s ease;
                                    "><i class="${config.icon}"></i></div>
                                    <div class="marker-pin" style="
                                        width: 0;
                                        height: 0;
                                        border-left: 6px solid transparent;
                                        border-right: 6px solid transparent;
                                        border-top: 8px solid ${config.borderColor};
                                        margin-left: 14px;
                                        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
                                    "></div>
                                </div>
                            `,
                            iconSize: [40, 48],
                            iconAnchor: [20, 48],
                            popupAnchor: isDesktop() ? [0, -55] : [-18, -58]
                        })
                    }).addTo(map);

                    const popupContent = createPopupContent(store);
                    
                    // PC版とスマホ版で異なるポップアップ設定
                    const popupOptions = {
                        className: 'custom-popup'
                    };
                    
                    if (isDesktop()) {
                        // PC版: 少し下に調整
                        popupOptions.offset = [0, -15];
                    } else {
                        // スマホ版: さらに左に調整
                        popupOptions.offset = [-25, -18];
                    }
                    
                    marker.bindPopup(popupContent, popupOptions);

                    marker.on('click', async function() {
                        // 店舗カードを選択
                        selectStoreCard(store.id);
                        
                        // レビュー数を遅延取得・更新
                        await updatePopupReviews(store.id);
                        
                        // まず店舗位置に移動
                        map.setView([store.latitude, store.longitude], map.getZoom(), {
                            animate: true,
                            duration: 0.5
                        });
                        
                        // ポップアップが見える位置に画面を調整
                        setTimeout(() => {
                            const mapContainer = map.getContainer();
                            const containerHeight = mapContainer.clientHeight;
                            
                            // 現在の店舗位置の画面座標を取得
                            const storePoint = map.latLngToContainerPoint([store.latitude, store.longitude]);
                            
                            let targetY;
                            if (isDesktop()) {
                                // PC版: 画面の80%位置に店舗アイコンを配置（店名が確実に見える）
                                targetY = containerHeight * 0.8;
                            } else {
                                // スマホ版: 画面の85%位置に店舗アイコンを配置（店名が確実に見える）
                                targetY = containerHeight * 0.85;
                            }
                            
                            // 必要なパン量を計算
                            const panY = storePoint.y - targetY;
                            
                            if (Math.abs(panY) > 10) { // 10px以上の調整が必要な場合のみ
                                map.panBy([0, panY], { 
                                    animate: true, 
                                    duration: 0.3 
                                });
                            }
                        }, 100);
                    });

                    // マーカーにstoreIdを保存
                    marker.storeId = store.id;
                    markers.push(marker);
                } catch (error) {
                    console.error(`店舗「${store.name}」のマーカー作成エラー:`, error);
                }
            }

            console.log(`📍 ${markers.length}個のマーカーを地図に表示`);
        }

        // 現在地を取得して地図の中心に設定
        function getCurrentLocationAndCenter() {
            console.log('📍 現在地取得を試行中...');

            if (!navigator.geolocation) {
                console.log('❌ Geolocation API がサポートされていません');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5分間キャッシュ
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    console.log(`✅ 現在地取得成功: ${lat.toFixed(6)}, ${lng.toFixed(6)} (精度: ${Math.round(accuracy)}m)`);

                    // 現在地情報を保存
                    currentUserLocation = { lat: lat, lng: lng };

                    // 地図の中心を現在地に移動（徒歩圏内の店舗が見えるレベルに拡大）
                    if (map) {
                        map.setView([lat, lng], 14);

                        // 現在地マーカーを追加（位置問題解決版）
                        console.log(`📍 現在地座標: lat=${lat}, lng=${lng}`);
                        
                        // 通常のLeafletマーカーアイコンを使用（確実に正しい位置に表示）
                        const currentLocationIcon = L.icon({
                            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30">
                                    <circle cx="15" cy="15" r="12" fill="#007AFF" stroke="white" stroke-width="3" opacity="0.9"/>
                                    <circle cx="15" cy="15" r="6" fill="#007AFF" stroke="white" stroke-width="2"/>
                                </svg>
                            `),
                            iconSize: [30, 30],
                            iconAnchor: [15, 15],
                            popupAnchor: [0, -15]
                        });

                        const locationMarker = L.marker([lat, lng], { 
                            icon: currentLocationIcon,
                            zIndexOffset: 1000 
                        });
                        
                        locationMarker.addTo(map);
                        // ポップアップなしでアイコンのみ表示（よりスタイリッシュ）
                        
                        console.log('✅ 現在地マーカー追加完了');

                        // 店舗リストを現在地から近い順で再表示
                        if (stores && stores.length > 0) {
                            displayStoreList(stores);
                            console.log('🔄 店舗リストを現在地順で更新完了');
                        }
                    }
                },
                function(error) {
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '位置情報の取得が拒否されました';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '位置情報が取得できませんでした';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '位置情報の取得がタイムアウトしました';
                            break;
                        default:
                            errorMessage = '不明なエラーが発生しました';
                            break;
                    }
                    console.log(`ℹ️ 現在地取得失敗: ${errorMessage}（デフォルト位置で表示）`);
                },
                options
            );
        }

        // 現在地情報を保存する変数
        let currentUserLocation = null;

        // 2点間の距離計算（Haversine公式）
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球の半径（km）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // 距離（km）
        }

        // 店舗リスト表示（現在地から近い順）
        function displayStoreList(storesData) {
            const container = document.getElementById('storeList');
            if (!container) return;
            
            container.innerHTML = '';

            if (storesData.length === 0) {
                container.innerHTML = '<div class="loading-indicator">表示する店舗がありません</div>';
                return;
            }

            // 現在地から近い順にソート
            let sortedStores = [...storesData];
            if (currentUserLocation) {
                sortedStores = sortedStores.sort((a, b) => {
                    if (!a.latitude || !a.longitude || !b.latitude || !b.longitude) return 0;
                    const distanceA = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, a.latitude, a.longitude);
                    const distanceB = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, b.latitude, b.longitude);
                    return distanceA - distanceB;
                });
                console.log('📍 現在地から近い順でソート完了');
            }

            sortedStores.forEach(store => {
                try {
                    const card = createStoreCard(store);
                    container.appendChild(card);
                } catch (error) {
                    console.error(`店舗「${store.name}」のカード作成エラー:`, error);
                }
            });
        }

        // 店舗カード作成
        function createStoreCard(store) {
            const card = document.createElement('div');
            card.className = 'store-card';
            card.dataset.storeId = store.id;

            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            const storeHours = store.opening_hours ? escapeHtml(store.opening_hours) : '';

            // 現在地からの距離を計算
            let distanceText = '';
            if (currentUserLocation && store.latitude && store.longitude) {
                const distance = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, store.latitude, store.longitude);
                if (distance < 1) {
                    distanceText = `${Math.round(distance * 1000)}m`;
                } else {
                    distanceText = `${distance.toFixed(1)}km`;
                }
            }

            // 訪問ステータスをチェック
            const visitStatus = userVisitHistory.get(`${store.id}`);
            const isWantToGo = visitStatus === 'want_to_go';
            const isVisited = visitStatus === 'visited';

            card.innerHTML = `
                <div class="store-header">
                    <h3 class="store-name">${storeName}</h3>
                    <div class="store-header-right">
                        <span class="store-category" data-category="${storeCategory}">${storeCategory}</span>
                        ${distanceText ? `<span class="store-distance">📍 ${distanceText}</span>` : ''}
                    </div>
                </div>
                <div class="store-info">
                    <div class="store-address">
                        <span class="popup-icon">📍</span>
                        <span>${storeAddress}</span>
                    </div>
                    ${storeGfOptions ? `
                        <div class="store-gf-type">
                            <span>✨</span>
                            <span>${storeGfOptions}</span>
                        </div>
                    ` : ''}
                    ${storeHours ? `
                        <div class="store-hours">
                            <span class="popup-icon">🕒</span>
                            <span>${storeHours}</span>
                        </div>
                    ` : ''}
                </div>
                <div class="store-actions">
                    <button class="action-btn want-to-go ${isWantToGo ? 'active' : ''}" onclick="event.stopPropagation(); toggleVisitStatus(${store.id}, 'want_to_go')">
                        💕 行きたい
                    </button>
                    <button class="action-btn visited ${isVisited ? 'active' : ''}" onclick="event.stopPropagation(); toggleVisitStatus(${store.id}, 'visited')">
                        ✨ 行った
                    </button>
                </div>
            `;

            card.addEventListener('click', function() {
                if (store.latitude && store.longitude && map) {
                    map.setView([store.latitude, store.longitude], 15);
                    const marker = markers.find(m => 
                        Math.abs(m.getLatLng().lat - store.latitude) < 0.00001 && 
                        Math.abs(m.getLatLng().lng - store.longitude) < 0.00001
                    );
                    if (marker) {
                        marker.openPopup();
                    }
                }
                selectStoreCard(store.id);
            });

            return card;
        }

        // レビュー数を遅延取得・更新する関数
        async function updatePopupReviews(storeId) {
            try {
                let reviewCount;
                
                // キャッシュから取得
                if (reviewCache.has(storeId)) {
                    reviewCount = reviewCache.get(storeId);
                } else {
                    // 初回取得：Supabaseからレビューを取得
                    const reviews = await getStoreReviews(storeId);
                    reviewCount = reviews.length;
                    // キャッシュに保存
                    reviewCache.set(storeId, reviewCount);
                }
                
                // レビューテキストを作成
                const reviewText = reviewCount > 0 ? `レビュー${reviewCount}件` : 'レビューなし';
                
                // ポップアップ内のレビュー表示を更新（⭐アイコンの隣の要素を特定）
                const popupContainer = document.querySelector('.leaflet-popup-content');
                if (popupContainer) {
                    const reviewRow = popupContainer.querySelector('.popup-row');
                    if (reviewRow) {
                        const starIcon = reviewRow.querySelector('.popup-icon');
                        if (starIcon && starIcon.textContent === '⭐') {
                            const textElement = reviewRow.querySelector('.popup-text');
                            if (textElement && textElement.textContent === '読み込み中...') {
                                textElement.textContent = reviewText;
                            }
                        }
                    }
                    
                    // より確実な方法：全てのレビュー行を更新
                    const allRows = popupContainer.querySelectorAll('.popup-row');
                    allRows.forEach(row => {
                        const icon = row.querySelector('.popup-icon');
                        const text = row.querySelector('.popup-text');
                        if (icon && icon.textContent === '⭐' && text && text.textContent === '読み込み中...') {
                            text.textContent = reviewText;
                        }
                    });
                }
                
            } catch (error) {
                console.error(`店舗${storeId}のレビュー取得エラー:`, error);
                // エラー時の表示
                const popupContainer = document.querySelector('.leaflet-popup-content');
                if (popupContainer) {
                    const allRows = popupContainer.querySelectorAll('.popup-row');
                    allRows.forEach(row => {
                        const icon = row.querySelector('.popup-icon');
                        const text = row.querySelector('.popup-text');
                        if (icon && icon.textContent === '⭐' && text && text.textContent === '読み込み中...') {
                            text.textContent = 'レビューなし';
                        }
                    });
                }
            }
        }

        // ポップアップコンテンツ作成（初期表示用）
        function createPopupContent(store) {
            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            const storeHours = store.opening_hours ? escapeHtml(store.opening_hours) : '';
            const storePhone = store.phone ? escapeHtml(store.phone) : '';
            const storeWebsite = store.website ? escapeHtml(store.website) : '';
            const storeDescription = store.description ? escapeHtml(store.description) : '';
            
            // 初期表示は「読み込み中...」
            const reviewText = '読み込み中...';
            
            // 訪問ステータスをチェック
            const visitStatus = userVisitHistory.get(`${store.id}`);
            const isWantToGo = visitStatus === 'want_to_go';
            const isVisited = visitStatus === 'visited';
            
            // PC版とモバイル版で異なる情報階層
            if (isDesktop()) {
                // PC版：店舗名が最上部、その下にカテゴリ
                return `
                    <div class="popup-content desktop-popup">
                        <div class="popup-header">
                            <div class="popup-header-main">
                                <h3 class="popup-title">${storeName}</h3>
                                <span class="store-category" data-category="${storeCategory}">${storeCategory}</span>
                            </div>
                            <button class="popup-close-btn" onclick="closePopup()" title="閉じる">×</button>
                        </div>
                        <div class="popup-body">
                            ${createImageCarousel(store.id)}
                            <div class="popup-info">
                                <div class="popup-row">
                                    <span class="popup-icon">📍</span>
                                    <span class="popup-text">${storeAddress}</span>
                                </div>
                                ${storeHours ? `
                                    <div class="popup-row">
                                        <span class="popup-icon">🕒</span>
                                        <span class="popup-text">${storeHours}</span>
                                    </div>
                                ` : ''}
                                <div class="popup-row">
                                    <span class="popup-icon">⭐</span>
                                    <span class="popup-text">${reviewText}</span>
                                </div>
                            </div>
                            <div class="popup-actions">
                                <button class="action-btn want-to-go popup-action-btn ${isWantToGo ? 'active' : ''}" onclick="toggleVisitStatus(${store.id}, 'want_to_go')" data-store-id="${store.id}">
                                    🤍 行きたい
                                </button>
                                <button class="action-btn visited popup-action-btn ${isVisited ? 'active' : ''}" onclick="toggleVisitStatus(${store.id}, 'visited')" data-store-id="${store.id}">
                                    ✨ 行った
                                </button>
                                <button class="action-btn popup-action-btn store-detail" onclick="showStoreDetail(${store.id})">
                                    📍 店舗詳細
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // モバイル版：既存のレイアウトを維持
                return `
                    <div class="popup-content mobile-popup">
                        <div class="popup-header-fixed">
                            <div class="popup-header-main">
                                <h3 class="popup-title">${storeName}</h3>
                            </div>
                            <button class="popup-close-btn" onclick="closePopup()" title="閉じる">
                                <span class="close-icon">×</span>
                            </button>
                        </div>
                        <div class="popup-scrollable-content">
                            ${createImageCarousel(store.id)}
                            <div class="popup-info-section">
                                <div class="popup-category-row">
                                    <span class="store-category" data-category="${storeCategory}">${storeCategory}</span>
                                </div>
                                <div class="popup-row">
                                    <span class="popup-icon">📍</span>
                                    <span class="popup-text">${storeAddress}</span>
                                </div>
                                ${storeHours ? `
                                    <div class="popup-row">
                                        <span class="popup-icon">🕒</span>
                                        <span class="popup-text">${storeHours}</span>
                                    </div>
                                ` : ''}
                                <div class="popup-row">
                                    <span class="popup-icon">⭐</span>
                                    <span class="popup-text">${reviewText}</span>
                                </div>
                            </div>
                            <div class="popup-actions">
                                <button class="action-btn want-to-go popup-action-btn ${isWantToGo ? 'active' : ''}" onclick="toggleVisitStatus(${store.id}, 'want_to_go')" data-store-id="${store.id}">
                                    🤍 行きたい
                                </button>
                                <button class="action-btn visited popup-action-btn ${isVisited ? 'active' : ''}" onclick="toggleVisitStatus(${store.id}, 'visited')" data-store-id="${store.id}">
                                    ✨ 行った
                                </button>
                                <button class="action-btn popup-action-btn store-detail" onclick="showStoreDetail(${store.id})">
                                    📍 店舗詳細
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // 店舗カード選択（PC版専用）
        function selectStoreCard(storeId) {
            if (!isDesktop()) return;
            
            // 既存の選択を解除
            document.querySelectorAll('.store-card').forEach(card => {
                card.classList.remove('selected');
            });

            // 該当する店舗カードを選択
            const selectedCard = document.querySelector(`[data-store-id="${storeId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                // 店舗一覧の一番上にスクロール
                selectedCard.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start',  // 一番上に配置
                    inline: 'nearest' 
                });
            }
        }

        // 店舗数更新
        function updateStoreCount(count) {
            const element = document.getElementById('storeCount');
            if (element) {
                element.textContent = count;
            }
        }

        // フィルタリング
        function filterStores() {
            if (!stores.length) return;

            // 検索テキストを取得（PC用またはモバイル用）
            let searchText = '';
            if (isDesktop()) {
                const sidebarSearchInput = document.getElementById('sidebarSearchInput');
                searchText = sidebarSearchInput ? sidebarSearchInput.value.toLowerCase() : '';
            } else {
                const mobileSearchInput = document.getElementById('mobileSearchInput');
                searchText = mobileSearchInput ? mobileSearchInput.value.toLowerCase() : '';
            }
            
            // カテゴリフィルターを取得（PC用またはモバイル用）
            let selectedCategory = '';
            if (isDesktop()) {
                const activeChip = document.querySelector('.sidebar-chip.active');
                selectedCategory = activeChip ? activeChip.dataset.category : '';
            } else {
                const activeChip = document.querySelector('.mobile-chip.active');
                selectedCategory = activeChip ? activeChip.dataset.category : '';
            }

            // タブフィルターを取得（PC用のみ）
            let selectedTab = 'all';
            if (isDesktop()) {
                const activeTab = document.querySelector('.sidebar-tab.active');
                selectedTab = activeTab ? activeTab.dataset.tab : 'all';
            }

            const filteredStores = stores.filter(store => {
                const matchesCategory = !selectedCategory || store.category === selectedCategory;
                const matchesSearch = !searchText ||
                    (store.name && store.name.toLowerCase().includes(searchText)) ||
                    (store.address && store.address.toLowerCase().includes(searchText)) ||
                    (store.description && store.description.toLowerCase().includes(searchText));
                
                // タブフィルターを適用（PC用）
                let matchesTab = true;
                if (selectedTab === 'want-to-go') {
                    const status = userVisitHistory.get(`${store.id}`);
                    matchesTab = status === 'want_to_go';
                } else if (selectedTab === 'visited') {
                    const status = userVisitHistory.get(`${store.id}`);
                    matchesTab = status === 'visited';
                }

                return matchesCategory && matchesSearch && matchesTab;
            });

            displayStores(filteredStores);
            
            // PC用サイドバーを更新（PC版専用処理）
            if (isDesktop()) {
                displayStoreList(filteredStores);
            }
            
            // モバイル用フィルターインジケーター更新
            if (!isDesktop()) {
                const filterIndicator = document.getElementById('filterIndicator');
                const panelStoreCount = document.getElementById('panelStoreCount');
                
                // フィルターが適用されているかチェック
                const hasFilter = searchText || selectedCategory;
                
                if (filterIndicator) {
                    filterIndicator.style.display = hasFilter ? 'inline' : 'none';
                }
                
                if (panelStoreCount) {
                    if (hasFilter) {
                        panelStoreCount.textContent = `フィルター中 ${filteredStores.length}件`;
                    } else {
                        panelStoreCount.textContent = `店舗リスト ${stores.length}件`;
                    }
                }
            }
            // 注意: モバイル版は直接updatePanelContent()を呼ぶため、ここでは処理しない
        }

        // 現在地取得
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('このブラウザは位置情報に対応していません');
                return;
            }

            if (!map) {
                alert('マップが初期化されていません');
                return;
            }

            getCurrentLocationAndCenter();
        }

        // マップ表示リセット

        // HTMLエスケープ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // デバイス判定
        function isDesktop() {
            return window.innerWidth >= 1025;
        }
        
        // PC用サイドバー店舗リスト表示
        function displayStoreList(storesData) {
            const container = document.getElementById('storeList');
            if (!container || !isDesktop()) return;
            
            container.innerHTML = '';
            
            // 店舗数更新
            const storeCountElement = document.getElementById('storeCount');
            if (storeCountElement) {
                storeCountElement.textContent = storesData.length;
            }
            
            if (storesData.length === 0) {
                container.innerHTML = '<div class="loading-indicator">表示する店舗がありません</div>';
                return;
            }
            
            // 現在地から近い順にソート
            let sortedStores = [...storesData];
            if (currentUserLocation) {
                sortedStores = sortedStores.sort((a, b) => {
                    if (!a.latitude || !a.longitude || !b.latitude || !b.longitude) return 0;
                    const distanceA = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, a.latitude, a.longitude);
                    const distanceB = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, b.latitude, b.longitude);
                    return distanceA - distanceB;
                });
            }
            
            sortedStores.forEach(store => {
                try {
                    const card = createStoreCard(store);
                    container.appendChild(card);
                } catch (error) {
                    console.error(`店舗「${store.name}」のカード作成エラー:`, error);
                }
            });
        }
        
        // PC用店舗カード作成
        function createStoreCard(store) {
            const card = document.createElement('div');
            card.className = 'store-card pc-store-card';
            card.dataset.storeId = store.id;
            
            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            
            // 現在地からの距離を計算
            let distanceText = '';
            if (currentUserLocation && store.latitude && store.longitude) {
                const distance = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, store.latitude, store.longitude);
                if (distance < 1) {
                    distanceText = `${Math.round(distance * 1000)}m`;
                } else {
                    distanceText = `${distance.toFixed(1)}km`;
                }
            }
            
            // 訪問ステータスをチェック
            const visitStatus = userVisitHistory.get(`${store.id}`);
            const isWantToGo = visitStatus === 'want_to_go';
            const isVisited = visitStatus === 'visited';
            
            card.innerHTML = `
                <div class="store-header">
                    <div class="store-name">${storeName}</div>
                    ${distanceText ? `<div class="store-distance">📍 ${distanceText}</div>` : ''}
                </div>
                <div class="store-meta">
                    <span class="store-category" data-category="${storeCategory}">${storeCategory}</span>
                </div>
                <div class="store-info">
                    <div class="info-item">
                        <span class="info-icon">📍</span>
                        <span>${storeAddress}</span>
                    </div>
                    ${storeGfOptions ? `
                        <div class="info-item">
                            <span class="info-icon">✨</span>
                            <span>${storeGfOptions}</span>
                        </div>
                    ` : ''}
                </div>
                <div class="store-card-actions">
                    <button class="action-btn want-to-go ${isWantToGo ? 'active' : ''}" 
                            onclick="event.stopPropagation(); toggleVisitStatus(${store.id}, 'want_to_go')">
                        🤍 行きたい
                    </button>
                    <button class="action-btn visited ${isVisited ? 'active' : ''}" 
                            onclick="event.stopPropagation(); toggleVisitStatus(${store.id}, 'visited')">
                        ✨ 行った
                    </button>
                    <button class="action-btn store-detail" onclick="event.stopPropagation(); showStoreDetail(${store.id})">
                        📍 店舗詳細
                    </button>
                </div>
            `;
            
            card.addEventListener('click', function(event) {
                // ボタンクリック時は処理しない
                if (event.target.closest('.action-btn')) {
                    return;
                }
                
                selectStoreCard(store.id);
                
                // スマホ版では地図タブに切り替えて店舗にフォーカス
                if (!isDesktop()) {
                    // 地図タブに切り替え
                    document.querySelectorAll('.bottom-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    const mapTab = document.querySelector('.bottom-tab[data-view="map"]');
                    if (mapTab) {
                        mapTab.classList.add('active');
                    }
                    
                    // 地図ビューを表示
                    document.getElementById('mapView').style.display = 'block';
                    document.getElementById('storeListView').style.display = 'none';
                    
                    // 店舗にフォーカス（少し遅延させて地図切り替えを待つ）
                    setTimeout(() => {
                        focusOnStore(store.id);
                        
                        // ポップアップを開く
                        const marker = markers.find(m => m.storeId === store.id);
                        if (marker) {
                            marker.openPopup();
                        }
                    }, 100);
                } else {
                    // PC版は従来通り
                    focusOnStore(store.id);
                }
            });
            
            return card;
        }
        
        // 店舗カード選択
        
        // ウィンドウリサイズ処理
        function handleResize() {
            // レスポンシブ切り替え時の処理
            if (isDesktop()) {
                // デスクトップに切り替わった場合
                if (stores && stores.length > 0) {
                    displayStoreList(stores);
                }
            } else {
                // モバイルに切り替わった場合
                if (!document.querySelector('.overlay-panel').classList.contains('initialized')) {
                    initOverlayPanel();
                }
            }
        }
        
        // ポップアップを閉じる関数
        function closePopup() {
            if (map) {
                map.closePopup();
            }
        }


        // グローバル関数として公開（onclick用）
        window.toggleVisitStatus = toggleVisitStatus;
        window.focusOnStore = focusOnStore;
        window.closePopup = closePopup;
        window.selectPlace = selectPlace;

        // イベントリスナー設定
        function setupEventListeners() {
            console.log('🎛️ イベントリスナー設定開始');

            // PC用検索
            const sidebarSearchInput = document.getElementById('sidebarSearchInput');
            if (sidebarSearchInput) {
                sidebarSearchInput.addEventListener('input', () => {
                    filterStores();
                });
            }
            
            // モバイル用検索
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            if (mobileSearchInput) {
                mobileSearchInput.addEventListener('input', () => {
                    if (!isDesktop()) {
                        // モバイル版では直接パネル更新（重複防止）
                        const activeTab = document.querySelector('.panel-tab.active');
                        if (activeTab) {
                            updatePanelContent(activeTab.dataset.tab);
                        }
                    } else {
                        filterStores();
                    }
                });
            }

            // PC用サイドバータブ
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    filterStores(); // 既存のフィルター関数を再利用
                });
            });

            // PC用フィルターチップ
            document.querySelectorAll('.sidebar-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.sidebar-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    filterStores();
                });
            });
            
            // モバイル用フィルターチップ
            document.querySelectorAll('.mobile-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.mobile-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    
                    if (!isDesktop()) {
                        // モバイル版では直接パネル更新（重複防止）
                        const activeTab = document.querySelector('.panel-tab.active');
                        if (activeTab) {
                            updatePanelContent(activeTab.dataset.tab);
                        }
                    } else {
                        filterStores();
                    }
                });
            });

            // マップ制御
            const locateBtn = document.getElementById('locateBtn');
            if (locateBtn) {
                locateBtn.addEventListener('click', getCurrentLocation);
            }
            
            const mobileLocateBtn = document.getElementById('mobileLocateBtn');
            if (mobileLocateBtn) {
                mobileLocateBtn.addEventListener('click', getCurrentLocation);
            }

            
            // ズームコントロール
            const zoomInBtn = document.getElementById('zoomInBtn');
            if (zoomInBtn) {
                zoomInBtn.addEventListener('click', () => {
                    if (map) {
                        map.zoomIn();
                    }
                });
            }
            
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            if (zoomOutBtn) {
                zoomOutBtn.addEventListener('click', () => {
                    if (map) {
                        map.zoomOut();
                    }
                });
            }

            // 訪問履歴機能の初期化
            initVisitHistory();
            
            // デバイス別UI初期化
            if (isDesktop()) {
                // PC用サイドバー初期化
                console.log('🖥️ PC環境を検出 - サイドバー初期化');
            } else {
                // モバイル用オーバーレイパネル初期化
                console.log('📱 モバイル環境を検出 - オーバーレイパネル初期化');
                initOverlayPanel();
            }
            
            // ウィンドウリサイズ時のレスポンシブ対応
            window.addEventListener('resize', handleResize);
            
            // 底部导航イベントリスナー
            setupBottomNavigation();
            
            console.log('✅ イベントリスナー設定完了');
        }

        // 底部导航設定
        function setupBottomNavigation() {
            console.log('📱 底部导航初期化開始');
            
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    console.log('📱 ナビゲーションタブ切り替え:', tab);
                    
                    // アクティブ状態更新
                    navButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // タブ切り替え実行
                    switchTab(tab);
                });
            });
            
            console.log('✅ 底部导航初期化完了');
        }

        // 訪問履歴グローバル変数
        let userVisitHistory = new Map();
        let currentUser = null;
        let storeImages = new Map(); // 店舗画像キャッシュ
        let reviewCache = new Map(); // レビュー数キャッシュ store_id → count
        
        // ユーザー情報の統一管理関数
        function setCurrentUser(email) {
            currentUser = email;
            if (email) {
                localStorage.setItem('currentUser', JSON.stringify({ email: email }));
                console.log('👤 currentUser統一設定:', email);
            } else {
                localStorage.removeItem('currentUser');
                console.log('👤 currentUserクリア');
            }
        }
        
        function getCurrentUser() {
            // グローバル変数を優先し、なければlocalStorageから取得
            if (currentUser) {
                return currentUser;
            }
            
            const stored = localStorage.getItem('currentUser');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    currentUser = parsed.email;
                    return currentUser;
                } catch (e) {
                    console.warn('localStorage currentUserの解析に失敗:', e);
                    localStorage.removeItem('currentUser');
                }
            }
            
            return null;
        }

        // Phase 2: プロフィール関連グローバル変数
        let currentUserProfile = null; // 現在のユーザープロフィール
        
        // プロフィールデータ構造
        const createDefaultProfile = (email) => {
            // メールアドレスからデフォルトニックネームを生成
            const defaultNickname = email.split('@')[0] || 'ユーザー';
            
            return {
                email: email,
                nickname: defaultNickname, // メールアドレスの@より前の部分
                avatar: 'default', // デフォルトアバター
                avatarType: 'preset', // 'preset' または 'custom'
                customAvatarData: null, // Base64画像データ
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
        };

        // デフォルトアバター一覧（可愛らしい絵文字）
        const PRESET_AVATARS = [
            { id: 'default', emoji: '🌸', name: '桜' },
            { id: 'cat', emoji: '🐱', name: 'ねこ' },
            { id: 'rabbit', emoji: '🐰', name: 'うさぎ' },
            { id: 'flower', emoji: '🌺', name: 'お花' },
            { id: 'star', emoji: '⭐', name: 'お星さま' },
            { id: 'heart', emoji: '💕', name: 'ハート' },
            { id: 'cake', emoji: '🍰', name: 'ケーキ' },
            { id: 'tea', emoji: '🍵', name: 'お茶' },
            { id: 'book', emoji: '📚', name: '読書' },
            { id: 'music', emoji: '🎵', name: '音楽' },
            { id: 'art', emoji: '🎨', name: 'アート' },
            { id: 'rainbow', emoji: '🌈', name: '虹' }
        ];
        
        // アバターIDから絵文字を取得する関数
        function getAvatarEmoji(avatarId) {
            if (!avatarId) return '🌸'; // デフォルト
            const preset = PRESET_AVATARS.find(a => a.id === avatarId);
            return preset ? preset.emoji : '🌸';
        }

        // 訪問履歴機能初期化
        async function initVisitHistory() {
            console.log('📝 訪問履歴機能初期化開始');
            
            // Supabaseクライアントの準備を待つ
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // 認証状態変更の監視を設定
            setupAuthStateListener();
            
            // 認証確認を少し遅らせて実行（無効化）
            console.log('🔄 Supabase認証確認無効化 - PIN認証のみ使用');
            // setTimeout(async () => {
            //     await checkAuthentication();
            //     console.log('🔄 遅延認証確認完了');
            // }, 200);
            
            // 一旦デモモードで続行
            if (!getCurrentUser()) {
                setCurrentUser('demo_user@example.com');
                console.log('⏳ 認証確認を並行実行中、デモモードで開始');
            }
            
            // Supabaseから訪問履歴を読み込み
            await loadVisitHistoryFromSupabase();
            
            // ローカルストレージからのフォールバック読み込み（ユーザー別）
            const user = getCurrentUser();
            if (user) {
                const saved = localStorage.getItem(`visit_history_${user}`);
                if (saved && userVisitHistory.size === 0) {
                    try {
                        const parsed = JSON.parse(saved);
                        userVisitHistory = new Map(Object.entries(parsed));
                        console.log('💾 ユーザー別訪問履歴を復元:', user, userVisitHistory.size, '件');
                    } catch (e) {
                        console.warn('⚠️ 訪問履歴の復元に失敗:', e);
                        userVisitHistory = new Map();
                    }
                } else if (userVisitHistory.size === 0) {
                    // 古い共有データがある場合の移行処理
                    const oldData = localStorage.getItem('visit_history');
                    if (oldData) {
                        try {
                            const parsed = JSON.parse(oldData);
                            console.log('🔄 古い共有データを発見 - 削除処理中...');
                            localStorage.removeItem('visit_history');
                            console.log('🗑️ 古い共有データを削除しました（プライバシー保護）');
                        } catch (e) {
                            console.warn('⚠️ 古いデータの削除に失敗:', e);
                        }
                    }
                }
            }
            
            console.log('✅ 訪問履歴機能初期化完了');
        }

        // 店舗画像機能初期化
        async function initStoreImages() {
            console.log('📸 店舗画像機能初期化開始');
            
            try {
                // 全ての店舗の画像を取得
                const { data: images, error } = await supabaseClient
                    .from('store_images')
                    .select('*')
                    .order('store_id', { ascending: true })
                    .order('created_at', { ascending: true });
                
                if (error) {
                    console.warn('⚠️ 画像データ取得エラー:', error);
                    return;
                }
                
                // 店舗IDごとに画像を整理
                storeImages.clear();
                if (images && images.length > 0) {
                    images.forEach(image => {
                        if (!storeImages.has(image.store_id)) {
                            storeImages.set(image.store_id, []);
                        }
                        storeImages.get(image.store_id).push(image);
                    });
                    
                    console.log(`✅ ${images.length}枚の画像を${storeImages.size}店舗に整理`);
                } else {
                    console.log('📷 画像データなし');
                }
                
            } catch (error) {
                console.warn('⚠️ 画像機能初期化エラー:', error);
            }
            
            console.log('📸 店舗画像機能初期化完了');
        }

        // 店舗画像カルーセルHTML生成
        function createImageCarousel(storeId) {
            const images = storeImages.get(storeId) || [];
            
            // 画像がない場合は管理者・一般ユーザー問わず完全非表示
            // 画像追加は管理画面からのみ行う方針
            if (images.length === 0) {
                return '';
            }
            
            const slidesHtml = images.map((image, index) => `
                <div class="image-slide ${index === 0 ? 'active' : ''}" data-slide="${index}">
                    <img src="${image.image_url}" alt="${image.alt_text || '店舗画像'}" loading="lazy">
                </div>
            `).join('');
            
            const dotsHtml = images.length > 1 ? `
                <div class="carousel-nav">
                    ${images.map((_, index) => `
                        <div class="carousel-dot ${index === 0 ? 'active' : ''}" data-slide="${index}" onclick="showSlide(${storeId}, ${index})"></div>
                    `).join('')}
                </div>
            ` : '';
            
            const buttonsHtml = images.length > 1 ? `
                <button class="carousel-btn prev" onclick="prevSlide(${storeId})">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="carousel-btn next" onclick="nextSlide(${storeId})">
                    <i class="fas fa-chevron-right"></i>
                </button>
            ` : '';
            
            return `
                <div class="store-images">
                    <div class="image-carousel" data-store-id="${storeId}" data-current-slide="0">
                        ${slidesHtml}
                        ${dotsHtml}
                        ${buttonsHtml}
                    </div>
                    ${images.length < 3 && isAdminAuthenticated() ? `
                        <button class="image-upload-btn" onclick="showImageUpload(${storeId})">
                            <i class="fas fa-plus"></i>
                            画像を追加 (${images.length}/3)
                        </button>
                    ` : ''}
                </div>
            `;
        }

        // カルーセル操作関数
        function showSlide(storeId, slideIndex) {
            const carousel = document.querySelector(`[data-store-id="${storeId}"]`);
            if (!carousel) return;
            
            const images = storeImages.get(storeId) || [];
            if (slideIndex < 0 || slideIndex >= images.length) return;
            
            // 現在のスライドを更新
            carousel.dataset.currentSlide = slideIndex;
            
            // スライドの表示を更新
            const slides = carousel.querySelectorAll('.image-slide');
            const dots = carousel.querySelectorAll('.carousel-dot');
            
            slides.forEach((slide, index) => {
                slide.classList.toggle('active', index === slideIndex);
            });
            
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === slideIndex);
            });
        }

        function nextSlide(storeId) {
            const carousel = document.querySelector(`[data-store-id="${storeId}"]`);
            if (!carousel) return;
            
            const currentSlide = parseInt(carousel.dataset.currentSlide || '0');
            const images = storeImages.get(storeId) || [];
            const nextIndex = (currentSlide + 1) % images.length;
            
            showSlide(storeId, nextIndex);
        }

        function prevSlide(storeId) {
            const carousel = document.querySelector(`[data-store-id="${storeId}"]`);
            if (!carousel) return;
            
            const currentSlide = parseInt(carousel.dataset.currentSlide || '0');
            const images = storeImages.get(storeId) || [];
            const prevIndex = (currentSlide - 1 + images.length) % images.length;
            
            showSlide(storeId, prevIndex);
        }

        // 管理者認証確認
        function isAdminAuthenticated() {
            const savedAuth = localStorage.getItem('pinAuth');
            if (!savedAuth) return false;
            
            try {
                const authData = JSON.parse(savedAuth);
                if (!authData || !authData.timestamp) return false;
                
                // 認証から24時間以内かチェック
                const authTime = new Date(authData.timestamp);
                const now = new Date();
                const hoursPassed = (now - authTime) / (1000 * 60 * 60);
                
                return hoursPassed < 24;
            } catch (error) {
                console.error('認証状態確認エラー:', error);
                return false;
            }
        }

        // 画像アップロード機能（管理者のみ）
        function showImageUpload(storeId) {
            // 管理者認証チェック
            if (!isAdminAuthenticated()) {
                console.log('📷 管理者のみ画像アップロード可能');
                return;
            }
            
            const currentImages = storeImages.get(storeId) || [];
            if (currentImages.length >= 3) {
                alert('この店舗は既に3枚の画像がアップロードされています。');
                return;
            }
            
            // ファイル選択要素を動的作成
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/jpeg,image/png,image/webp';
            fileInput.multiple = false;
            
            fileInput.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // ファイル検証
                if (!validateImageFile(file)) return;
                
                await uploadStoreImage(storeId, file);
            };
            
            fileInput.click();
        }

        // 画像ファイル検証
        function validateImageFile(file) {
            const maxSize = 2 * 1024 * 1024; // 2MB
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
            
            if (!allowedTypes.includes(file.type)) {
                alert('JPEG、PNG、WebP形式の画像ファイルを選択してください。');
                return false;
            }
            
            if (file.size > maxSize) {
                alert('ファイルサイズは2MB以下にしてください。');
                return false;
            }
            
            return true;
        }

        // 画像アップロード処理
        async function uploadStoreImage(storeId, file) {
            try {
                console.log('📤 画像アップロード開始:', storeId, file.name);
                
                // ローディング表示
                const uploadBtn = document.querySelector(`[onclick="showImageUpload(${storeId})"]`);
                if (uploadBtn) {
                    uploadBtn.textContent = 'アップロード中...';
                    uploadBtn.disabled = true;
                }
                
                // ファイル名生成（衝突回避）
                const fileExt = file.name.split('.').pop();
                const fileName = `store_${storeId}_${Date.now()}.${fileExt}`;
                
                // Supabase Storageにアップロード
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('store-images')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (uploadError) {
                    console.error('Storage upload error:', uploadError);
                    alert('画像のアップロードに失敗しました。');
                    return;
                }
                
                // 公開URLを取得
                const { data: { publicUrl } } = supabaseClient.storage
                    .from('store-images')
                    .getPublicUrl(fileName);
                
                // データベースに画像情報を保存
                const currentImages = storeImages.get(storeId) || [];
                const imageNumber = currentImages.length + 1;
                
                const { data: dbData, error: dbError } = await supabaseClient
                    .from('store_images')
                    .insert({
                        store_id: storeId,
                        image_url: publicUrl,
                        uploaded_by: getCurrentUser() || 'demo_user@example.com',
                        alt_text: `${storeId}番店舗の画像${imageNumber}`
                    })
                    .select()
                    .single();
                
                if (dbError) {
                    console.error('Database insert error:', dbError);
                    alert('画像情報の保存に失敗しました。');
                    return;
                }
                
                // ローカルキャッシュを更新
                if (!storeImages.has(storeId)) {
                    storeImages.set(storeId, []);
                }
                storeImages.get(storeId).push(dbData);
                
                console.log('✅ 画像アップロード完了:', dbData);
                
                // ポップアップが開いている場合は更新
                const popup = document.querySelector('.leaflet-popup');
                if (popup) {
                    const currentStoreId = popup.querySelector('[data-store-id]');
                    if (currentStoreId && currentStoreId.dataset.storeId == storeId) {
                        // ポップアップ内容を再生成して更新
                        refreshPopupImages(storeId);
                    }
                }
                
                alert('画像をアップロードしました！');
                
            } catch (error) {
                console.error('画像アップロードエラー:', error);
                alert('画像のアップロードに失敗しました。');
            } finally {
                // ローディング状態を解除
                const uploadBtn = document.querySelector(`[onclick="showImageUpload(${storeId})"]`);
                if (uploadBtn) {
                    const currentImages = storeImages.get(storeId) || [];
                    uploadBtn.textContent = `画像を追加 (${currentImages.length}/3)`;
                    uploadBtn.disabled = false;
                }
            }
        }

        // ポップアップ内の画像部分のみを更新
        function refreshPopupImages(storeId) {
            const popup = document.querySelector('.leaflet-popup');
            if (!popup) return;
            
            const storeImagesDiv = popup.querySelector('.store-images');
            if (storeImagesDiv) {
                storeImagesDiv.outerHTML = createImageCarousel(storeId);
            }
        }

        // Supabaseから訪問履歴を読み込み
        async function loadVisitHistoryFromSupabase() {
            try {
                console.log('🔄 Supabaseから訪問履歴を読み込み中...');
                
                const { data, error } = await supabaseClient
                    .from('visit_history')
                    .select('store_id, status')
                    .eq('user_email', getCurrentUser());

                if (error) {
                    console.error('❌ Supabase読み込みエラー:', error);
                    throw error;
                }

                if (data) {
                    userVisitHistory.clear();
                    data.forEach(item => {
                        userVisitHistory.set(`${item.store_id}`, item.status);
                    });
                    console.log('✅ Supabaseから訪問履歴を読み込み:', data.length, '件');
                }
            } catch (error) {
                console.error('❌ 訪問履歴読み込み失敗:', error);
                // エラーが発生してもローカルストレージから読み込みを試行
            }
        }

        // 訪問ステータス切り替え
        async function toggleVisitStatus(storeId, status) {
            console.log('📝 訪問ステータス更新:', storeId, status);
            
            // 即座に視覚的フィードバックを提供
            const clickedButton = event.target.closest('.action-btn, .popup-action-btn');
            if (clickedButton) {
                clickedButton.classList.add('pressing');
                setTimeout(() => {
                    clickedButton.classList.remove('pressing');
                }, 100);
            }
            
            if (!getCurrentUser()) {
                alert('ユーザー認証が必要です');
                return;
            }
            
            const key = `${storeId}`;
            const currentStatus = userVisitHistory.get(key);
            
            if (currentStatus === status) {
                // 同じステータスの場合は削除
                userVisitHistory.delete(key);
                await deleteVisitHistoryFromSupabase(storeId);
                console.log('🗑️ 訪問ステータス削除:', storeId);
            } else {
                // 新しいステータスを設定
                userVisitHistory.set(key, status);
                await saveVisitHistoryToSupabase(storeId, status);
                console.log('✅ 訪問ステータス設定:', storeId, status);
            }
            
            // ローカルストレージにもバックアップ保存（ユーザー別）
            const user = getCurrentUser();
            if (user) {
                const obj = Object.fromEntries(userVisitHistory);
                localStorage.setItem(`visit_history_${user}`, JSON.stringify(obj));
                console.log('💾 ユーザー別訪問履歴を保存:', user);
            }
            
            // UIを更新
            updateVisitButtonsForStore(storeId);
            
            // 現在履歴ビューを表示している場合は更新
            const historyView = document.getElementById('visitHistoryView');
            if (historyView && !historyView.classList.contains('hidden')) {
                const activeTab = document.querySelector('.nav-btn.active');
                if (activeTab && activeTab.dataset.tab !== 'map') {
                    updateHistoryView(activeTab.dataset.tab);
                }
            }
            
            console.log('💾 訪問履歴保存完了');
        }

        // Supabaseに訪問履歴を保存
        async function saveVisitHistoryToSupabase(storeId, status) {
            try {
                console.log('💾 Supabaseに保存中...', storeId, status);
                
                // 既存レコードを削除してから挿入（UPSERT的な動作）
                const { error: deleteError } = await supabaseClient
                    .from('visit_history')
                    .delete()
                    .eq('user_email', getCurrentUser())
                    .eq('store_id', storeId);

                if (deleteError) {
                    console.warn('⚠️ 既存レコード削除エラー:', deleteError);
                }

                // 新しいレコードを挿入
                const { data, error } = await supabaseClient
                    .from('visit_history')
                    .insert([
                        {
                            user_email: getCurrentUser(),
                            store_id: storeId,
                            status: status,
                            visited_date: status === 'visited' ? new Date().toISOString().split('T')[0] : null,
                            notes: null
                        }
                    ]);

                if (error) {
                    console.error('❌ Supabase保存エラー:', error);
                    throw error;
                } else {
                    console.log('✅ Supabase保存成功');
                }
            } catch (error) {
                console.error('❌ 訪問履歴保存失敗:', error);
                // エラーが発生してもローカルには保存されているので続行
            }
        }

        // Supabaseから訪問履歴を削除
        async function deleteVisitHistoryFromSupabase(storeId) {
            try {
                console.log('🗑️ Supabaseから削除中...', storeId);
                
                const { error } = await supabaseClient
                    .from('visit_history')
                    .delete()
                    .eq('user_email', getCurrentUser())
                    .eq('store_id', storeId);

                if (error) {
                    console.error('❌ Supabase削除エラー:', error);
                    throw error;
                } else {
                    console.log('✅ Supabase削除成功');
                }
            } catch (error) {
                console.error('❌ 訪問履歴削除失敗:', error);
                // エラーが発生してもローカルからは削除されているので続行
            }
        }

        // 特定店舗の訪問ボタンUI更新
        function updateVisitButtonsForStore(storeId) {
            const status = userVisitHistory.get(`${storeId}`);
            
            // ポップアップ内のボタンを更新（新しいクラス名に対応）
            const popupWantBtns = document.querySelectorAll(`.popup-action-btn.want-to-go[data-store-id="${storeId}"]`);
            const popupVisitedBtns = document.querySelectorAll(`.popup-action-btn.visited[data-store-id="${storeId}"]`);
            
            // 店舗カード内のボタンを更新
            const cardWantBtns = document.querySelectorAll(`.action-btn.want-to-go[onclick*="${storeId}"]`);
            const cardVisitedBtns = document.querySelectorAll(`.action-btn.visited[onclick*="${storeId}"]`);
            
            // ポップアップのボタン更新
            popupWantBtns.forEach(btn => {
                btn.classList.toggle('active', status === 'want_to_go');
                if (status === 'want_to_go') {
                    btn.style.animation = 'buttonPress 0.2s ease';
                }
            });
            
            popupVisitedBtns.forEach(btn => {
                btn.classList.toggle('active', status === 'visited');
                if (status === 'visited') {
                    btn.style.animation = 'buttonPress 0.2s ease';
                }
            });
            
            // 店舗カードのボタン更新
            cardWantBtns.forEach(btn => {
                btn.classList.toggle('active', status === 'want_to_go');
                if (status === 'want_to_go') {
                    btn.style.animation = 'buttonPress 0.2s ease';
                }
            });
            
            cardVisitedBtns.forEach(btn => {
                btn.classList.toggle('active', status === 'visited');
                if (status === 'visited') {
                    btn.style.animation = 'buttonPress 0.2s ease';
                }
            });
            
            // アニメーション終了後にリセット
            setTimeout(() => {
                document.querySelectorAll('.action-btn, .popup-action-btn').forEach(btn => {
                    btn.style.animation = '';
                });
            }, 200);
        }

        // 認証状態変更の監視設定
        function setupAuthStateListener() {
            console.log('👁️ 認証状態変更の監視を開始');
            
            supabaseClient.auth.onAuthStateChange((event, session) => {
                console.log('🔄 認証状態変更:', event, session ? `user: ${session.user.email}` : 'no session');
                
                if (event === 'SIGNED_IN' && session) {
                    setCurrentUser(session.user.email);
                    console.log('✅ ログイン成功:', getCurrentUser());
                    
                    // ログイン成功時はページをリロードしてマップ画面を表示（無効化）
                    console.log('🔄 認証成功によりページをリロード（無効化）');
                    // window.location.reload(); // 無効化
                    
                } else if (event === 'SIGNED_OUT') {
                    console.log('🚪 ログアウト');
                    setCurrentUser('demo_user@example.com');
                    userVisitHistory.clear();
                    updateAuthButton();
                    
                } else if (event === 'TOKEN_REFRESHED' && session) {
                    console.log('🔄 トークン更新:', session.user.email);
                    setCurrentUser(session.user.email);
                    updateAuthButton();
                }
            });
        }

        // 認証確認
        async function checkAuthentication() {
            try {
                console.log('🔐 認証状態を確認中...');
                
                // まずセッションを確認
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError) {
                    console.warn('⚠️ セッション確認エラー:', sessionError.message);
                } else if (session && session.user) {
                    setCurrentUser(session.user.email);
                    console.log('✅ セッションから認証済みユーザーを確認:', getCurrentUser());
                    return;
                }
                
                // セッションがない場合、ユーザー情報を確認
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (userError) {
                    console.warn('⚠️ ユーザー確認エラー、デモモードで続行:', userError.message);
                } else if (user && user.email) {
                    setCurrentUser(user.email);
                    console.log('✅ 認証済みユーザー:', getCurrentUser());
                    return;
                }
                
                // 両方とも失敗した場合、デモモードに設定
                console.log('⚠️ 未認証状態、デモモードで続行');
                setCurrentUser('demo_user@example.com');
                
            } catch (error) {
                console.warn('⚠️ 認証情報エラー、デモモードで実行:', error.message || error);
                setCurrentUser('demo_user@example.com'); // フォールバック
            }
        }

        // Google認証（オプション機能）
        async function signInWithGoogle() {
            try {
                console.log('🔐 Google認証を開始...');
                
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://bettger3000.github.io/naco-gluten-free-map/'
                    }
                });
                
                if (error) {
                    console.error('❌ Google認証エラー:', error);
                    alert('認証に失敗しました。デモモードで続行します。');
                } else {
                    console.log('✅ Google認証成功');
                }
            } catch (error) {
                console.error('❌ 認証処理エラー:', error);
                alert('認証に失敗しました。デモモードで続行します。');
            }
        }

        // 認証ボタンハンドラー（ハンバーガーメニューに移行済み）
        async function handleAuth() {
            console.log('⚠️ 古いhandleAuth関数が呼ばれました - ハンバーガーメニューを使用してください');
            // この関数は無効化済み - ハンバーガーメニューのhandleLogout()を使用
        }

        // 認証状態の表示更新
        function updateAuthButton() {
            // ハンバーガーメニューに移行したため、この関数は不要
            // メニューの表示内容は動的に更新される
            console.log('🔄 認証状態更新:', getCurrentUser() ? '認証済み' : '未認証');
        }

        // ログアウト（PINコード認証版）
        async function signOut() {
            try {
                console.log('✅ ログアウト処理開始');
                
                // LocalStorageから認証情報を削除
                localStorage.removeItem('pinAuth');
                localStorage.removeItem('currentUser');
                
                // メモリ上のデータをクリア
                setCurrentUser(null);
                userVisitHistory.clear();
                
                console.log('✅ ログアウト成功');
                
                // ページをリロードしてログイン画面へ
                location.reload();
                
            } catch (error) {
                console.error('❌ ログアウト処理エラー:', error);
            }
        }

        // オーバーレイパネル初期化
        function initOverlayPanel() {
            console.log('📦 オーバーレイパネル初期化開始');
            
            const panel = document.getElementById('overlayPanel');
            const panelContent = document.getElementById('panelContent');
            
            if (!panel) {
                console.error('オーバーレイパネル要素が見つかりません');
                return;
            }
            
            let panelState = 'collapsed'; // collapsed, half, full
            
            // パネル位置設定
            function setPanelPosition(state) {
                panelState = state;
                panel.classList.remove('half-open', 'full-open');
                
                // パネル位置をCSS変数として設定
                let panelTop = window.innerHeight - 120; // collapsed
                if (state === 'half') {
                    panelTop = window.innerHeight * 0.5;
                } else if (state === 'full') {
                    panelTop = 80;
                }
                document.documentElement.style.setProperty('--panel-top', panelTop + 'px');
                
                // 状態インジケーターを更新
                document.querySelectorAll('.state-dot').forEach(dot => {
                    dot.classList.remove('active');
                });
                
                const downBtn = document.getElementById('panelDownBtn');
                const upBtn = document.getElementById('panelUpBtn');
                
                if (state === 'collapsed') {
                    document.getElementById('stateDot1').classList.add('active');
                    downBtn.disabled = true;
                    upBtn.disabled = false;
                } else if (state === 'half') {
                    panel.classList.add('half-open');
                    document.getElementById('stateDot2').classList.add('active');
                    downBtn.disabled = false;
                    upBtn.disabled = false;
                } else if (state === 'full') {
                    panel.classList.add('full-open');
                    document.getElementById('stateDot3').classList.add('active');
                    downBtn.disabled = false;
                    upBtn.disabled = true;
                }
            }
            
            
            // 検索トグルボタン
            const searchToggleBtn = document.getElementById('searchToggleBtn');
            const mobileSearchFilter = document.getElementById('mobileSearchFilter');
            
            if (searchToggleBtn && mobileSearchFilter) {
                searchToggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // 検索エリアの表示/非表示を切り替え
                    if (mobileSearchFilter.classList.contains('show')) {
                        mobileSearchFilter.classList.remove('show');
                        searchToggleBtn.classList.remove('active');
                        searchToggleBtn.querySelector('.search-icon').textContent = '🔍';
                    } else {
                        mobileSearchFilter.classList.add('show');
                        searchToggleBtn.classList.add('active');
                        searchToggleBtn.querySelector('.search-icon').textContent = '✕';
                    }
                });
            }
            
            // 2ボタンコントロール（上下矢印）
            document.getElementById('panelDownBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                
                // 一段階下げる
                if (panelState === 'full') {
                    setPanelPosition('half');
                } else if (panelState === 'half') {
                    setPanelPosition('collapsed');
                }
            });
            
            document.getElementById('panelUpBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                
                // 一段階上げる
                if (panelState === 'collapsed') {
                    setPanelPosition('half');
                } else if (panelState === 'half') {
                    setPanelPosition('full');
                }
            });
            
            // タブ切り替え
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    updatePanelContent(tab.dataset.tab);
                });
            });
            
            // 初期表示
            updatePanelContent('all');
            setPanelPosition('collapsed'); // 初期状態は閉じた状態
            
            // 初期化フラグを設定
            const overlayPanel = document.getElementById('overlayPanel');
            if (overlayPanel) {
                overlayPanel.classList.add('initialized');
            }
            
            console.log('✅ オーバーレイパネル初期化完了');
        }

        // パネルコンテンツ更新
        function updatePanelContent(tab) {
            console.log('📋 パネルコンテンツ更新:', tab);
            
            const panelContent = document.getElementById('panelContent');
            if (!panelContent) return;
            
            // まず検索・カテゴリフィルターを適用
            let filteredStores = [...stores];
            
            // モバイル版の検索・カテゴリフィルターを適用
            if (!isDesktop()) {
                const mobileSearchInput = document.getElementById('mobileSearchInput');
                const searchText = mobileSearchInput ? mobileSearchInput.value.toLowerCase() : '';
                
                const activeChip = document.querySelector('.mobile-chip.active');
                const selectedCategory = activeChip ? activeChip.dataset.category : '';
                
                filteredStores = filteredStores.filter(store => {
                    const matchesCategory = !selectedCategory || store.category === selectedCategory;
                    const matchesSearch = !searchText ||
                        (store.name && store.name.toLowerCase().includes(searchText)) ||
                        (store.address && store.address.toLowerCase().includes(searchText)) ||
                        (store.description && store.description.toLowerCase().includes(searchText));
                    
                    return matchesCategory && matchesSearch;
                });
            }
            
            // 訪問ステータスフィルターを適用
            if (tab === 'want-to-go') {
                filteredStores = filteredStores.filter(store => {
                    const status = userVisitHistory.get(`${store.id}`);
                    return status === 'want_to_go';
                });
            } else if (tab === 'visited') {
                filteredStores = filteredStores.filter(store => {
                    const status = userVisitHistory.get(`${store.id}`);
                    return status === 'visited';
                });
            }
            
            // 店舗数更新
            const countEl = document.getElementById('panelStoreCount');
            if (countEl) {
                if (tab === 'all') {
                    countEl.textContent = `店舗リスト ${filteredStores.length}件`;
                } else if (tab === 'want-to-go') {
                    countEl.textContent = `行きたい ${filteredStores.length}件`;
                } else if (tab === 'visited') {
                    countEl.textContent = `行った ${filteredStores.length}件`;
                }
            }
            
            displayPanelStoreList(filteredStores, panelContent);
        }
        
        // パネル用店舗リスト表示
        function displayPanelStoreList(storesData, container) {
            if (!container) return;
            
            container.innerHTML = '';
            
            if (storesData.length === 0) {
                container.innerHTML = '<div class="loading-indicator">表示する店舗がありません</div>';
                return;
            }
            
            // 現在地から近い順にソート
            let sortedStores = [...storesData];
            if (currentUserLocation) {
                sortedStores = sortedStores.sort((a, b) => {
                    if (!a.latitude || !a.longitude || !b.latitude || !b.longitude) return 0;
                    const distanceA = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, a.latitude, a.longitude);
                    const distanceB = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, b.latitude, b.longitude);
                    return distanceA - distanceB;
                });
            }
            
            sortedStores.forEach(store => {
                try {
                    const card = createPanelStoreCard(store);
                    container.appendChild(card);
                } catch (error) {
                    console.error(`店舗「${store.name}」のカード作成エラー:`, error);
                }
            });
        }
        
        // パネル用店舗カード作成
        function createPanelStoreCard(store) {
            const card = document.createElement('div');
            card.className = 'store-card';
            card.dataset.storeId = store.id;
            
            const status = userVisitHistory.get(`${store.id}`);
            const isWantToGo = status === 'want_to_go';
            const isVisited = status === 'visited';
            
            // 現在地からの距離を計算
            let distanceText = '';
            if (currentUserLocation && store.latitude && store.longitude) {
                const distance = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, store.latitude, store.longitude);
                if (distance < 1) {
                    distanceText = `${Math.round(distance * 1000)}m`;
                } else {
                    distanceText = `${distance.toFixed(1)}km`;
                }
            }
            
            const categoryConfig = {
                'カフェ': { icon: '☕', color: '#8B4513' },
                '和食': { icon: '🍱', color: '#006400' },
                '洋食': { icon: '🍽️', color: '#FF6347' },
                'パン屋': { icon: '🥐', color: '#FFA500' },
                'スイーツ': { icon: '🧁', color: '#FF69B4' },
                '販売店': { icon: '🛒', color: '#4169E1' },
                'その他': { icon: '🏪', color: '#808080' }
            };
            
            const config = categoryConfig[store.category] || categoryConfig['その他'];
            
            card.innerHTML = `
                <div class="store-header">
                    <div class="store-name">${escapeHtml(store.name || '')}</div>
                    ${distanceText ? `<div class="store-distance">${distanceText}</div>` : ''}
                </div>
                <div class="store-meta">
                    <span class="category-badge" style="background: ${config.color}15; color: ${config.color}; border: 1px solid ${config.color}30;">
                        ${config.icon} ${escapeHtml(store.category || '')}
                    </span>
                </div>
                <div class="store-info">
                    <div class="info-item">
                        <span class="info-icon">📍</span>
                        <span class="info-text">${escapeHtml(store.address || '')}</span>
                    </div>
                    ${store.gluten_free_options ? `
                        <div class="info-item">
                            <span class="info-icon">🌾</span>
                            <span class="info-text">${escapeHtml(store.gluten_free_options)}</span>
                        </div>
                    ` : ''}
                </div>
                <div class="store-card-actions">
                    <button class="action-btn want-to-go ${isWantToGo ? 'active' : ''}" 
                            onclick="toggleVisitStatus(${store.id}, 'want_to_go')">
                        🤍 行きたい
                    </button>
                    <button class="action-btn visited ${isVisited ? 'active' : ''}" 
                            onclick="toggleVisitStatus(${store.id}, 'visited')">
                        ✨ 行った
                    </button>
                    <button class="action-btn store-detail" onclick="showStoreDetail(${store.id})">
                        📍 店舗詳細
                    </button>
                </div>
            `;
            
            return card;
        }
        
        // 店舗にフォーカス
        function focusOnStore(storeId) {
            const store = stores.find(s => s.id === storeId);
            if (store && map) {
                // まず店舗位置に移動
                map.setView([store.latitude, store.longitude], 16, {
                    animate: true,
                    duration: 0.8
                });
                
                // ポップアップが見える位置に画面を調整
                setTimeout(() => {
                    const mapContainer = map.getContainer();
                    const containerHeight = mapContainer.clientHeight;
                    
                    // 現在の店舗位置の画面座標を取得
                    const storePoint = map.latLngToContainerPoint([store.latitude, store.longitude]);
                    
                    let targetY;
                    if (isDesktop()) {
                        // PC版: 画面の80%位置に店舗アイコンを配置（店名が確実に見える）
                        targetY = containerHeight * 0.8;
                    } else {
                        // スマホ版: 画面の85%位置に店舗アイコンを配置（店名が確実に見える）
                        targetY = containerHeight * 0.85;
                    }
                    
                    // 必要なパン量を計算
                    const panY = storePoint.y - targetY;
                    
                    if (Math.abs(panY) > 10) { // 10px以上の調整が必要な場合のみ
                        map.panBy([0, panY], { 
                            animate: true, 
                            duration: 0.3 
                        });
                    }
                }, 200);
                
                // パネルを閉じる
                const panel = document.getElementById('overlayPanel');
                if (panel) {
                    panel.classList.remove('half-open', 'full-open');
                }
                
                // マーカーのポップアップを開く
                setTimeout(() => {
                    const marker = markers.find(m => m.storeId === storeId);
                    if (marker) {
                        marker.openPopup();
                    }
                }, 300);
            }
        }
        
        // タブ切り替え（古い関数、互換性のため残す）
        function switchTab(tab) {
            console.log('🔄 タブ切り替え:', tab);
            
            // 導航ボタンのアクティブ状態更新
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            const mainContent = document.querySelector('.main-content');
            const historyView = document.getElementById('visitHistoryView');
            
            // 要素の存在チェック
            if (!mainContent) {
                console.error('❌ .main-content要素が見つかりません');
                return;
            }
            if (!historyView) {
                console.error('❌ visitHistoryView要素が見つかりません');
                return;
            }
            
            if (tab === 'map') {
                // 地図表示
                mainContent.style.display = 'block';
                historyView.classList.add('hidden');
            } else {
                // 履歴表示
                mainContent.style.display = 'none';
                historyView.classList.remove('hidden');
                updateHistoryView(tab);
            }
        }

        // 履歴ビュー更新
        function updateHistoryView(type) {
            console.log('📝 履歴ビュー更新:', type);
            
            const titleEl = document.getElementById('historyTitle');
            const countEl = document.getElementById('historyCount');
            const listEl = document.getElementById('historyList');
            
            // 要素の存在チェック
            if (!titleEl || !countEl || !listEl) {
                console.error('❌ 履歴ビュー要素が見つかりません:', {
                    titleEl: !!titleEl,
                    countEl: !!countEl,
                    listEl: !!listEl
                });
                return;
            }
            
            // タイトル設定
            titleEl.textContent = type === 'want-to-go' ? '行きたいお店' : '行ったお店';
            
            // フィルタリング
            const filteredStores = stores.filter(store => {
                const status = userVisitHistory.get(`${store.id}`);
                return status === (type === 'want-to-go' ? 'want_to_go' : 'visited');
            });
            
            // 件数更新
            countEl.textContent = `${filteredStores.length}件`;
            
            // リスト生成
            if (filteredStores.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">${type === 'want-to-go' ? '🤍' : '✨'}</div>
                        <div class="empty-message">まだ${type === 'want-to-go' ? '行きたいお店' : '行ったお店'}がありません</div>
                    </div>
                `;
            } else {
                listEl.innerHTML = filteredStores.map(store => createHistoryItem(store, type)).join('');
            }
        }

        // 履歴アイテム生成
        function createHistoryItem(store, type) {
            const categoryClass = getCategoryClass(store.category);
            const categoryColor = categoryColors[store.category] || '#666';
            
            return `
                <div class="history-item" data-store-id="${store.id}">
                    <div class="history-item-header">
                        <div class="history-store-name">${escapeHtml(store.name || '')}</div>
                        <div class="history-category" style="background-color: ${categoryColor}">
                            ${escapeHtml(store.category || '')}
                        </div>
                    </div>
                    <div class="history-address">${escapeHtml(store.address || '')}</div>
                    <div class="history-actions">
                        <button class="history-action-btn" onclick="showStoreOnMap(${store.id})">
                            地図で見る
                        </button>
                        <button class="history-action-btn" onclick="toggleVisitStatus(${store.id}, '${type === 'want-to-go' ? 'want_to_go' : 'visited'}')">
                            削除
                        </button>
                    </div>
                </div>
            `;
        }

        // 地図で店舗を表示
        function showStoreOnMap(storeId) {
            console.log('🗺️ 地図で店舗表示:', storeId);
            
            // 地図タブに切り替え
            switchTab('map');
            
            // 店舗を探してフォーカス
            const store = stores.find(s => s.id === storeId);
            if (store && map) {
                // まず店舗位置に移動
                map.setView([store.latitude, store.longitude], 16, {
                    animate: true,
                    duration: 0.8
                });
                
                // ポップアップが見える位置に画面を調整
                setTimeout(() => {
                    const mapContainer = map.getContainer();
                    const containerHeight = mapContainer.clientHeight;
                    
                    // 現在の店舗位置の画面座標を取得
                    const storePoint = map.latLngToContainerPoint([store.latitude, store.longitude]);
                    
                    let targetY;
                    if (isDesktop()) {
                        // PC版: 画面の80%位置に店舗アイコンを配置（店名が確実に見える）
                        targetY = containerHeight * 0.8;
                    } else {
                        // スマホ版: 画面の85%位置に店舗アイコンを配置（店名が確実に見える）
                        targetY = containerHeight * 0.85;
                    }
                    
                    // 必要なパン量を計算
                    const panY = storePoint.y - targetY;
                    
                    if (Math.abs(panY) > 10) { // 10px以上の調整が必要な場合のみ
                        map.panBy([0, panY], { 
                            animate: true, 
                            duration: 0.3 
                        });
                    }
                }, 200);
                
                // マーカーのポップアップを開く
                setTimeout(() => {
                    const marker = markers.find(m => m.storeId === storeId);
                    if (marker) {
                        marker.openPopup();
                    }
                }, 300);
            }
        }

        // Supabase接続テスト関数
        async function testSupabaseConnection() {
            console.log('🔍 Supabase接続テスト開始...');
            
            try {
                // 1. visit_historyテーブルの存在と構造確認
                console.log('1. visit_historyテーブル確認...');
                const { data: visitHistory, error: visitError } = await supabaseClient
                    .from('visit_history')
                    .select('*')
                    .limit(5);
                    
                if (visitError) {
                    console.error('❌ visit_historyテーブルエラー:', visitError);
                    
                    // テーブルが存在しない場合、作成を試行
                    console.log('🛠️ visit_historyテーブルが存在しない可能性があります');
                } else {
                    console.log('✅ visit_historyテーブル接続成功');
                    console.log('📋 既存の訪問履歴データ:', visitHistory?.length, '件');
                    if (visitHistory && visitHistory.length > 0) {
                        console.log('📊 サンプルデータ:', visitHistory);
                    }
                }
                
                // 2. user_profilesテーブル確認
                console.log('2. user_profilesテーブル確認...');
                const { data: profiles, error: profileError } = await supabaseClient
                    .from('user_profiles')
                    .select('email, nickname')
                    .limit(3);
                    
                if (profileError) {
                    console.error('❌ user_profilesテーブルエラー:', profileError);
                } else {
                    console.log('✅ user_profilesテーブル接続成功:', profiles?.length, '件');
                    console.log('👤 ユーザープロファイル:', profiles);
                }
                
                // 3. storesテーブル確認
                console.log('3. storesテーブル確認...');
                const { data: stores, error: storeError } = await supabaseClient
                    .from('stores')
                    .select('id, name, category_id')
                    .limit(5);
                    
                if (storeError) {
                    console.error('❌ storesテーブルエラー:', storeError);
                } else {
                    console.log('✅ storesテーブル接続成功:', stores?.length, '件');
                    console.log('🏪 店舗データサンプル:', stores);
                }
                
                // 4. テーブルスキーマ情報の取得試行
                console.log('4. データベース情報確認...');
                const { data: schemaInfo, error: schemaError } = await supabaseClient
                    .from('information_schema.tables')
                    .select('table_name')
                    .eq('table_schema', 'public')
                    .in('table_name', ['visit_history', 'user_profiles', 'stores', 'store_categories']);
                
                if (!schemaError && schemaInfo) {
                    console.log('📋 存在するテーブル:', schemaInfo.map(t => t.table_name));
                }
                
                return true;
            } catch (error) {
                console.error('❌ Supabase接続テスト失敗:', error);
                return false;
            }
        }

        // テストデータ挿入機能
        async function insertTestVisitHistory() {
            console.log('🧪 テスト訪問履歴データ挿入開始...');
            
            try {
                const testUser = 'demo_user@example.com';
                const testStoreId = 1; // みちのり亭のID
                
                // 1. user_profilesにテストユーザーを作成
                const { error: userError } = await supabaseClient
                    .from('user_profiles')
                    .upsert({
                        email: testUser,
                        nickname: 'テストユーザー',
                        is_active: true
                    });
                
                if (userError) {
                    console.error('❌ テストユーザー作成エラー:', userError);
                } else {
                    console.log('✅ テストユーザー作成成功');
                }
                
                // 2. visit_historyにテストデータ挿入
                const { data: insertData, error: insertError } = await supabaseClient
                    .from('visit_history')
                    .insert([
                        {
                            user_email: testUser,
                            store_id: testStoreId,
                            status: 'want_to_go',
                            notes: 'テスト用の行きたい店データ'
                        }
                    ])
                    .select();
                
                if (insertError) {
                    console.error('❌ テストデータ挿入エラー:', insertError);
                } else {
                    console.log('✅ テストデータ挿入成功:', insertData);
                }
                
                // 3. データ確認
                const { data: checkData, error: checkError } = await supabaseClient
                    .from('visit_history')
                    .select('*')
                    .eq('user_email', testUser);
                
                if (!checkError && checkData) {
                    console.log('📊 挿入確認結果:', checkData);
                }
                
            } catch (error) {
                console.error('❌ テストデータ挿入失敗:', error);
            }
        }

        // テスト関数をグローバルに公開
        window.insertTestData = insertTestVisitHistory;

        // 認証状態デバッグ機能
        async function debugAuthentication() {
            console.log('🔍=== 認証状態デバッグ開始 ===');
            
            try {
                // 1. Supabaseクライアント確認
                console.log('1. Supabaseクライアント:', supabaseClient ? '✅ 初期化済み' : '❌ 未初期化');
                
                // 2. セッション確認
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                console.log('2. セッション確認:');
                if (sessionError) {
                    console.log('   ❌ セッションエラー:', sessionError);
                } else if (session) {
                    console.log('   ✅ セッション存在:', {
                        user: session.user.email,
                        expires_at: new Date(session.expires_at * 1000),
                        access_token: session.access_token ? '存在' : '不在'
                    });
                } else {
                    console.log('   ⚠️ セッション不在');
                }
                
                // 3. ユーザー確認
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                console.log('3. ユーザー確認:');
                if (userError) {
                    console.log('   ❌ ユーザーエラー:', userError);
                } else if (user) {
                    console.log('   ✅ ユーザー存在:', {
                        email: user.email,
                        id: user.id,
                        created_at: user.created_at
                    });
                } else {
                    console.log('   ⚠️ ユーザー不在');
                }
                
                // 4. 現在の状態
                console.log('4. 現在の認証状態:', {
                    currentUser: getCurrentUser(),
                    isDemo: getCurrentUser() === 'demo_user@example.com'
                });
                
            } catch (error) {
                console.error('❌ デバッグ中にエラー:', error);
            }
            
            console.log('🔍=== 認証状態デバッグ終了 ===');
        }

        // テスト実行用のグローバル関数として公開
        window.testSupabase = testSupabaseConnection;
        window.debugAuthentication = debugAuthentication;

        // =======================================
        // カスタムピン機能の実装
        // =======================================

        // カスタムピン機能初期化
        function initCustomPinFeature() {
            console.log('📍 カスタムピン機能を初期化中...');
            
            // UI要素を取得
            mapContextMenu = document.getElementById('mapContextMenu');
            
            // マップのイベントリスナーを設定
            setupMapEventListeners();
            
            // UI要素のイベントリスナーを設定
            setupPinUIEventListeners();
            
            // 外部クリックでメニュー閉じる
            document.addEventListener('click', hideContextMenu);
            
            
            console.log('✅ カスタムピン機能初期化完了');
        }

        // ピン設置モード管理
        let pinModeActive = false;
        
        // マップイベントリスナー設定
        function setupMapEventListeners() {
            console.log('🗺️ マップイベントリスナー設定中...');
            
            // PC版: クリックでピン設置
            map.on('click', function(e) {
                if (pinModeActive) {
                    console.log('📍 ピン設置モードでクリック');
                    setCustomPin(e.latlng);
                    togglePinMode(); // 設置後は自動でモードOFF
                } else {
                    hideContextMenu();
                }
            });
            
            console.log('✅ マップイベントリスナー設定完了');
        }

        // ピンモード切り替え
        function togglePinMode() {
            pinModeActive = !pinModeActive;
            
            // ボタンの表示を更新
            updatePinModeButtons();
            
            // ヒント表示
            if (pinModeActive) {
                showPinModeHint();
            } else {
                hidePinModeHint();
            }
            
            console.log('🎯 ピンモード:', pinModeActive ? 'ON' : 'OFF');
        }
        
        // ピンモードボタンの表示更新
        function updatePinModeButtons() {
            const buttons = document.querySelectorAll('.pin-mode-btn');
            buttons.forEach(btn => {
                if (pinModeActive) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // ピンモードヒント表示
        function showPinModeHint() {
            // 既存のヒントを削除
            const existingHint = document.querySelector('.pin-mode-hint');
            if (existingHint) {
                existingHint.remove();
            }
            
            // 新しいヒントを作成
            const hint = document.createElement('div');
            hint.className = 'pin-mode-hint';
            
            // PC版とモバイル版、ピンの有無に応じてメッセージを変更
            if (isDesktop()) {
                // PC版
                if (customPinMarker && customPinLocation) {
                    hint.innerHTML = '📍 新しいピン設置・<br>既存ピンダブルクリックで削除';
                } else {
                    hint.innerHTML = '📍 地図クリックでピン設置・<br>ピンダブルクリックで削除';
                }
            } else {
                // モバイル版
                if (customPinMarker && customPinLocation) {
                    hint.textContent = '📍 新しいピン設置・既存ピンダブルタップで削除';
                } else {
                    hint.textContent = '📍 地図タップでピン設置';
                }
            }
            
            const mapContainer = document.querySelector('.map-container');
            mapContainer.appendChild(hint);
            
            // 3秒後に自動で消す（少し長めに）
            setTimeout(() => {
                if (hint && hint.parentNode) {
                    hint.remove();
                }
            }, 3000);
        }
        
        // ピンモードヒント非表示
        function hidePinModeHint() {
            const hint = document.querySelector('.pin-mode-hint');
            if (hint) {
                hint.remove();
            }
        }
        
        // スマホ用ダブルタップ検出
        function setupMobileDoubleTap(marker) {
            let tapCount = 0;
            let tapTimer = null;
            
            marker.on('click', function(e) {
                tapCount++;
                
                if (tapCount === 1) {
                    // 最初のタップ - 300ms待機
                    tapTimer = setTimeout(() => {
                        tapCount = 0;
                        // 単一タップ時：ピンモードOFF時はガイダンス表示
                        if (!pinModeActive) {
                            showPinGuidanceMessage();
                        }
                    }, 300);
                } else if (tapCount === 2) {
                    // ダブルタップ検出 - ピン削除
                    clearTimeout(tapTimer);
                    tapCount = 0;
                    removeCustomPin();
                    e.originalEvent?.preventDefault();
                    e.originalEvent?.stopPropagation();
                }
            });
        }
        
        // ピンガイダンスメッセージ表示（ピンモードOFF時）
        function showPinGuidanceMessage() {
            // 既存のガイダンスを削除
            const existingGuidance = document.querySelector('.pin-guidance-message');
            if (existingGuidance) {
                existingGuidance.remove();
            }
            
            // 新しいガイダンスを作成
            const guidance = document.createElement('div');
            guidance.className = 'pin-guidance-message';
            
            // PC版とモバイル版で異なるメッセージを表示
            if (isDesktop()) {
                guidance.innerHTML = '📍 ピンモードをオンにして、<br>ダブルクリックで削除できます';
            } else {
                guidance.innerHTML = '📍 ダブルタップで削除できます';
            }
            
            const mapContainer = document.querySelector('.map-container');
            mapContainer.appendChild(guidance);
            
            // 4秒後に自動で消す
            setTimeout(() => {
                if (guidance && guidance.parentNode) {
                    guidance.remove();
                }
            }, 4000);
        }
        
        // ピンUI要素のイベントリスナー設定
        function setupPinUIEventListeners() {
            console.log('🎯 ピンUIイベントリスナー設定中...');
            
            // PC版ピンモードボタン（モバイル版）
            const pinModeBtn = document.getElementById('pinModeBtn');
            if (pinModeBtn) {
                pinModeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    togglePinMode();
                });
            }
            
            // PC版ピンモードボタン（サイドバー）
            const pcPinModeBtn = document.getElementById('pcPinModeBtn');
            if (pcPinModeBtn) {
                pcPinModeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    togglePinMode();
                });
            }
            
            
            
            console.log('✅ ピンUIイベントリスナー設定完了');
        }

        // コンテキストメニュー表示
        function showContextMenu(latlng, event) {
            if (!mapContextMenu) return;
            
            // 既存のピンがある場合は削除確認
            if (customPinMarker) {
                removeCustomPin();
            }
            
            // 座標を保存
            mapContextMenu.dataset.latlng = JSON.stringify(latlng);
            
            // メニューを一度表示してサイズを取得
            mapContextMenu.style.left = '0px';
            mapContextMenu.style.top = '0px';
            mapContextMenu.classList.remove('hidden');
            
            // 実際のメニューサイズを取得
            const rect = mapContextMenu.getBoundingClientRect();
            const menuWidth = rect.width;
            const menuHeight = rect.height;
            
            // map-containerの位置を取得
            const mapContainer = document.querySelector('.map-container');
            const mapRect = mapContainer.getBoundingClientRect();
            
            // マウス/タッチ位置をmap-container基準に変換
            let x = (event.clientX || event.touches?.[0]?.clientX || 0) - mapRect.left;
            let y = (event.clientY || event.touches?.[0]?.clientY || 0) - mapRect.top;
            
            // map-container内でのメニュー位置調整
            const containerWidth = mapRect.width;
            const containerHeight = mapRect.height;
            
            // 水平方向の調整（コンテナ内での左端、右端を考慮）
            if (x + menuWidth > containerWidth) {
                x = Math.max(10, containerWidth - menuWidth - 10);
            }
            if (x < 10) {
                x = 10;
            }
            
            // 垂直方向の調整（コンテナ内での上端、下端を考慮）
            if (y + menuHeight > containerHeight) {
                y = Math.max(10, y - menuHeight - 10);
            }
            if (y < 10) {
                y = 10;
            }
            
            // 最終位置を設定
            mapContextMenu.style.left = x + 'px';
            mapContextMenu.style.top = y + 'px';
            
            console.log('📍 コンテキストメニュー表示:', {
                latlng,
                position: { x, y },
                menuSize: { width: menuWidth, height: menuHeight },
                mapContainer: { width: containerWidth, height: containerHeight },
                mousePosition: { clientX: event.clientX, clientY: event.clientY }
            });
        }

        // コンテキストメニュー非表示
        function hideContextMenu() {
            if (mapContextMenu) {
                mapContextMenu.classList.add('hidden');
            }
        }

        // カスタムピン設置
        function setCustomPin(latlng) {
            console.log('📍 カスタムピン設置:', latlng);
            
            // 既存のピンを削除
            if (customPinMarker) {
                map.removeLayer(customPinMarker);
            }
            
            // カスタムピンアイコンを作成
            const customIcon = L.divIcon({
                className: 'custom-pin-marker',
                html: '',
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, -32]
            });
            
            // ピンマーカーを作成
            customPinMarker = L.marker(latlng, { icon: customIcon }).addTo(map);
            customPinLocation = latlng;
            
            // ピンのクリック・ダブルクリックイベントを設定
            if (isDesktop()) {
                // PC版：ピンモードON時のみ削除可能
                customPinMarker.on('click', function() {
                    if (!pinModeActive) {
                        showPinGuidanceMessage();
                    }
                });
                
                customPinMarker.on('dblclick', function() {
                    if (pinModeActive) {
                        removeCustomPin();
                    }
                });
            } else {
                // スマホ版：ピンモードに関係なくダブルタップで削除可能
                setupMobileDoubleTap(customPinMarker);
            }
            
            // ピンモードを無効にする
            if (pinModeActive) {
                togglePinMode();
            }
            
            // 店舗リストを距離順でソート・更新
            sortStoresByCustomPin();
            
            console.log('✅ カスタムピン設置完了');
        }

        // カスタムピン削除
        function removeCustomPin() {
            console.log('🗑️ カスタムピン削除');
            
            if (customPinMarker) {
                map.removeLayer(customPinMarker);
                customPinMarker = null;
            }
            
            customPinLocation = null;
            
            
            // 店舗リストを現在地基準に戻す
            if (isDesktop()) {
                displayStoreList(stores);
            } else {
                const activeTab = document.querySelector('.panel-tab.active');
                if (activeTab) {
                    updatePanelContent(activeTab.dataset.tab);
                }
            }
            
            console.log('✅ カスタムピン削除完了');
        }

        // カスタムピンから距離順で店舗をソート
        function sortStoresByCustomPin() {
            if (!customPinLocation) return;
            
            console.log('📏 カスタムピンからの距離でソート中...');
            
            // 距離を計算して店舗をソート
            const sortedStores = [...stores].sort((a, b) => {
                if (!a.latitude || !a.longitude || !b.latitude || !b.longitude) return 0;
                
                const distanceA = calculateDistance(
                    customPinLocation.lat, 
                    customPinLocation.lng, 
                    a.latitude, 
                    a.longitude
                );
                const distanceB = calculateDistance(
                    customPinLocation.lat, 
                    customPinLocation.lng, 
                    b.latitude, 
                    b.longitude
                );
                
                return distanceA - distanceB;
            });
            
            // PC版・モバイル版それぞれでリスト更新
            if (isDesktop()) {
                displayStoreListWithCustomDistance(sortedStores);
            } else {
                const activeTab = document.querySelector('.panel-tab.active');
                if (activeTab) {
                    updatePanelContentWithCustomDistance(activeTab.dataset.tab, sortedStores);
                }
            }
            
            console.log('✅ 距離順ソート完了');
        }

        // PC用: カスタムピンからの距離付き店舗リスト表示
        function displayStoreListWithCustomDistance(sortedStores) {
            const container = document.getElementById('storeList');
            if (!container) return;
            
            container.innerHTML = '';
            
            sortedStores.forEach(store => {
                if (!store.latitude || !store.longitude) return;
                
                const distance = calculateDistance(
                    customPinLocation.lat,
                    customPinLocation.lng,
                    store.latitude,
                    store.longitude
                );
                
                const distanceText = distance < 1 ? 
                    `${Math.round(distance * 1000)}m` : 
                    `${distance.toFixed(1)}km`;
                
                const card = document.createElement('div');
                card.className = 'store-card';
                card.innerHTML = createStoreCardHTML(store, `📍 ${distanceText}`);
                
                card.addEventListener('click', () => focusOnStore(store.id));
                container.appendChild(card);
            });
            
            // 件数更新
            updateStoreCount(sortedStores.length);
        }

        // モバイル用: カスタムピンからの距離でパネル更新
        function updatePanelContentWithCustomDistance(tab, sortedStores) {
            const panelContent = document.getElementById('panelContent');
            if (!panelContent) return;
            
            // タブフィルターを適用
            let filteredStores = [...sortedStores];
            if (tab === 'want-to-go') {
                filteredStores = filteredStores.filter(store => {
                    const status = userVisitHistory.get(`${store.id}`);
                    return status === 'want_to_go';
                });
            } else if (tab === 'visited') {
                filteredStores = filteredStores.filter(store => {
                    const status = userVisitHistory.get(`${store.id}`);
                    return status === 'visited';
                });
            }
            
            // 件数更新
            const countEl = document.getElementById('panelStoreCount');
            if (countEl) {
                if (tab === 'all') {
                    countEl.textContent = `📍 目的地から ${filteredStores.length}件`;
                } else if (tab === 'want-to-go') {
                    countEl.textContent = `📍 行きたい ${filteredStores.length}件`;
                } else if (tab === 'visited') {
                    countEl.textContent = `📍 行った ${filteredStores.length}件`;
                }
            }
            
            displayPanelStoreListWithDistance(filteredStores, panelContent);
        }

        // パネル用: 距離付き店舗リスト表示
        function displayPanelStoreListWithDistance(storesData, container) {
            if (!container || !customPinLocation) return;
            
            container.innerHTML = '';
            
            if (storesData.length === 0) {
                container.innerHTML = '<div class="loading-indicator">表示する店舗がありません</div>';
                return;
            }
            
            storesData.forEach(store => {
                if (!store.latitude || !store.longitude) return;
                
                const distance = calculateDistance(
                    customPinLocation.lat,
                    customPinLocation.lng,
                    store.latitude,
                    store.longitude
                );
                
                const distanceText = distance < 1 ? 
                    `${Math.round(distance * 1000)}m` : 
                    `${distance.toFixed(1)}km`;
                
                const card = document.createElement('div');
                card.className = 'panel-store-card';
                card.innerHTML = createPanelStoreCardHTML(store, `📍 ${distanceText}`);
                
                card.addEventListener('click', () => {
                    focusOnStore(store.id);
                    // モバイル版ではパネルを閉じる
                    if (!isDesktop()) {
                        setPanelPosition('collapsed');
                    }
                });
                
                container.appendChild(card);
            });
        }

        // PC用店舗カードHTML生成（距離表示付き）
        function createStoreCardHTML(store, distanceText = '') {
            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            
            return `
                <div class="store-header">
                    <h3 class="store-name">${storeName}</h3>
                    <div class="store-header-right">
                        <span class="store-category" data-category="${storeCategory}">${storeCategory}</span>
                        ${distanceText ? `<span class="store-distance">${distanceText}</span>` : ''}
                    </div>
                </div>
                <div class="store-info">
                    <div class="store-address">
                        <i class="fas fa-map-marker-alt"></i>
                        ${storeAddress}
                    </div>
                    ${storeGfOptions ? `<div class="store-gf-options">✨ ${storeGfOptions}</div>` : ''}
                </div>
            `;
        }

        // パネル用店舗カードHTML生成（距離表示付き）
        function createPanelStoreCardHTML(store, distanceText = '') {
            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            
            // 訪問ステータスをチェック
            const visitStatus = userVisitHistory.get(`${store.id}`);
            const isWantToGo = visitStatus === 'want_to_go';
            const isVisited = visitStatus === 'visited';
            
            return `
                <div class="store-header">
                    <div class="store-name">${storeName}</div>
                    ${distanceText ? `<div class="store-distance">${distanceText}</div>` : ''}
                </div>
                <div class="store-meta">
                    <span class="store-category" data-category="${storeCategory}">${storeCategory}</span>
                </div>
                <div class="store-info">
                    <div class="info-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${storeAddress}</span>
                    </div>
                    ${storeGfOptions ? `
                    <div class="info-item">
                        <i class="fas fa-star"></i>
                        <span>${storeGfOptions}</span>
                    </div>` : ''}
                </div>
                <div class="store-card-actions">
                    <button class="action-btn want-to-go ${isWantToGo ? 'active' : ''}" 
                            onclick="toggleVisitStatus(${store.id}, 'want_to_go')">
                        🤍 行きたい
                    </button>
                    <button class="action-btn visited ${isVisited ? 'active' : ''}" 
                            onclick="toggleVisitStatus(${store.id}, 'visited')">
                        ✨ 行った
                    </button>
                    <button class="action-btn store-detail" onclick="showStoreDetail(${store.id})">
                        📍 店舗詳細
                    </button>
                </div>
            `;
        }

        // 店舗詳細表示
        async function showStoreDetail(storeId) {
            console.log('📋 店舗詳細表示:', storeId);
            
            // 店舗データを取得
            const store = stores.find(s => s.id === storeId);
            if (!store) {
                console.error('店舗データが見つかりません:', storeId);
                return;
            }
            
            // レビューデータを取得
            const reviews = await getStoreReviews(storeId);
            console.log('🔍 Debug - 取得したレビュー:', reviews);
            console.log('🔍 Debug - レビュー数:', reviews.length);
            
            // 詳細画面のHTML作成
            const detailHTML = createStoreDetailHTML(store, reviews);
            
            // モーダル/フルスクリーン表示
            if (isDesktop()) {
                showStoreDetailModal(detailHTML);
            } else {
                showStoreDetailFullscreen(detailHTML);
            }
        }

        // 店舗詳細HTMLを生成
        function createStoreDetailHTML(store, reviews = []) {
            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            const storeHours = store.opening_hours ? escapeHtml(store.opening_hours) : '';
            const storePhone = store.phone ? escapeHtml(store.phone) : '';
            const storeWebsite = store.website ? escapeHtml(store.website) : '';
            const storeDescription = store.description ? escapeHtml(store.description) : '';
            
            return `
                <div class="store-detail-content">
                    <div class="store-detail-header">
                        <div class="store-detail-title">
                            <h2>${storeName}</h2>
                            <span class="store-category" data-category="${storeCategory}">${storeCategory}</span>
                        </div>
                        <button class="store-detail-close" onclick="closeStoreDetail()">×</button>
                    </div>
                    
                    <div class="store-detail-body">
                        <!-- 店舗画像ギャラリー -->
                        <div class="store-detail-images">
                            ${createImageCarousel(store.id)}
                        </div>
                        
                        <!-- 基本情報 -->
                        <div class="store-detail-info">
                            <h3>📍 基本情報</h3>
                            <div class="detail-row">
                                <span class="detail-label">住所</span>
                                <span class="detail-value">${storeAddress}</span>
                            </div>
                            ${storeHours ? `
                                <div class="detail-row">
                                    <span class="detail-label">営業時間</span>
                                    <span class="detail-value">${storeHours}</span>
                                </div>
                            ` : ''}
                            ${storePhone ? `
                                <div class="detail-row">
                                    <span class="detail-label">電話番号</span>
                                    <span class="detail-value">
                                        <a href="tel:${storePhone}" class="phone-link">${storePhone}</a>
                                    </span>
                                </div>
                            ` : ''}
                            ${storeWebsite ? `
                                <div class="detail-row">
                                    <span class="detail-label">ウェブサイト</span>
                                    <span class="detail-value"><a href="${storeWebsite}" target="_blank" rel="noopener">公式サイト</a></span>
                                </div>
                            ` : ''}
                        </div>

                        <!-- グルテンフリー対応 -->
                        ${storeGfOptions ? `
                            <div class="store-detail-info">
                                <h3>✨ グルテンフリー対応</h3>
                                <p class="gf-options">${storeGfOptions}</p>
                            </div>
                        ` : ''}

                        <!-- 店舗説明 -->
                        ${storeDescription ? `
                            <div class="store-detail-info">
                                <h3>💬 店舗について</h3>
                                <p class="store-description">${storeDescription}</p>
                            </div>
                        ` : ''}

                        <!-- レビュー -->
                        ${createReviewsHTML(reviews, store.id)}

                        <!-- ナビゲーションボタン -->
                        <div class="store-navigation">
                            <button class="nav-btn google-maps" onclick="openGoogleMaps(${store.latitude}, ${store.longitude})">
                                📍 Googleマップ
                            </button>
                            <button class="nav-btn route-search" onclick="openRouteSearch(${store.latitude}, ${store.longitude})">
                                🧭 ルート検索
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // PC版：モーダル表示
        function showStoreDetailModal(detailHTML) {
            const modalHTML = `
                <div class="store-detail-modal" onclick="closeStoreDetail()">
                    <div class="store-detail-modal-content" onclick="event.stopPropagation()">
                        ${detailHTML}
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.style.overflow = 'hidden';
        }

        // モバイル版：フルスクリーン表示
        function showStoreDetailFullscreen(detailHTML) {
            const fullscreenHTML = `
                <div class="store-detail-fullscreen">
                    ${detailHTML}
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', fullscreenHTML);
            document.body.style.overflow = 'hidden';
        }

        // 詳細画面を閉じる
        function closeStoreDetail() {
            const modal = document.querySelector('.store-detail-modal');
            const fullscreen = document.querySelector('.store-detail-fullscreen');
            
            if (modal) modal.remove();
            if (fullscreen) fullscreen.remove();
            
            document.body.style.overflow = '';
        }

        // Googleマップで開く
        function openGoogleMaps(lat, lng) {
            const url = `https://maps.google.com/maps?q=${lat},${lng}`;
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        // ルート検索
        function openRouteSearch(lat, lng) {
            const url = `https://maps.google.com/maps?saddr=現在地&daddr=${lat},${lng}`;
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        
        // パフォーマンス測定
        console.log('🚀 埋め込みデータ版グルテンフリーマップ');
        console.log('⚡ 特徴: 即座表示、認証不要、確実動作');
        console.log('📊 店舗数:', embeddedStores.length, '店舗');
        console.log('🧪 Supabaseテスト: コンソールで testSupabase() を実行');
        console.log('🧪 テストデータ挿入: コンソールで insertTestData() を実行');

        // ========== Phase 2: プロフィール機能 ==========
        
        // アプリ起動時の自動修復（緊急措置）
        (async function() {
            const criticalUsers = ['bettger1000@gmail.com', 'demo@example.com'];
            const currentUsers = await getApprovedUsers();
            
            criticalUsers.forEach(email => {
                if (!currentUsers.find(u => u.email === email)) {
                    currentUsers.push({
                        id: Date.now() + Math.random(),
                        email: email,
                        registeredAt: new Date().toISOString(),
                        hasPin: false
                    });
                    console.log('🔧 アプリ起動時自動修復:', email);
                }
            });
            
            if (currentUsers.length > 0) {
                await saveApprovedUsers(currentUsers);
            }
        })();
        
        // プロフィールデータを読み込み
        async function loadUserProfile(email) {
            if (!email) {
                console.warn('⚠️ メールアドレスが指定されていません');
                return null;
            }
            
            try {
                // まずSupabaseから読み込みを試行
                const supabaseProfile = await loadProfileFromSupabase(email);
                if (supabaseProfile) {
                    console.log('☁️ Supabaseプロフィールを復元:', email);
                    // LocalStorageへのキャッシュは無効化（データ不整合を防ぐため）
                    // localStorage.setItem(`user_profile_${email}`, JSON.stringify(supabaseProfile));
                    return supabaseProfile;
                }
                
                // Supabaseに無い場合はLocalStorageから読み込み
                const saved = localStorage.getItem(`user_profile_${email}`);
                if (saved) {
                    const profile = JSON.parse(saved);
                    console.log('💾 ローカルプロフィールを復元:', email);
                    console.warn('⚠️ LocalStorageのデータは使用しません（古い可能性があるため）');
                    // LocalStorageの古いデータは削除
                    localStorage.removeItem(`user_profile_${email}`);
                    // Supabaseにはアップロードしない（古いデータで上書きを防ぐ）
                    // await saveProfileToSupabase(profile); // この行を無効化
                    // return profile; // LocalStorageのデータは返さない
                }
                
                // どちらにも無い場合はデフォルト作成
                console.log('🆕 新規プロフィールを作成:', email);
                const defaultProfile = createDefaultProfile(email);
                // アドバイス実装：新規作成時のみ保存を許可（ユーザー操作扱い）
                await saveUserProfile(defaultProfile, { source: 'new_user_creation', isDirty: true });
                return defaultProfile;
                
            } catch (error) {
                console.error('❌ プロフィール読み込みエラー:', error);
                console.error('❌ エラーの詳細:', error.stack);
                console.warn('⚠️ デフォルトプロフィールを作成します:', email);
                return createDefaultProfile(email);
            }
        }

        // Supabaseからプロフィールを読み込み（新機能）
        async function loadProfileFromSupabase(email) {
            try {
                console.log('🔄 Supabaseプロフィール読み込み開始:', email);
                console.log('📊 [診断] loadProfileFromSupabase呼び出し - タイムスタンプ:', new Date().toISOString());
                
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('email', email)
                    .single();

                if (error) {
                    if (error.code === 'PGRST116') {
                        // データが見つからない（正常）
                        console.log('📭 Supabaseにプロフィールなし:', email);
                        return null;
                    } else {
                        console.warn('⚠️ Supabase読み込みエラー:', error);
                        return null;
                    }
                }
                
                if (data) {
                    console.log('📊 Supabase生データ:', data);
                    
                    // アドバイス実装：SSOT原則 - データベース値をそのまま保持
                    const profile = {
                        email: data.email,
                        nickname: data.nickname, // データベース値をそのまま保持（nullも含む）
                        avatar: data.avatar_emoji || 'default',
                        avatarUrl: data.avatar_url || null,
                        avatarType: data.avatar_type || 'preset',
                        bio: data.bio || '',
                        createdAt: data.created_at || new Date().toISOString(),
                        updatedAt: data.updated_at || new Date().toISOString()
                    };
                    
                    console.log('🔄 変換後プロフィール:', profile);
                    console.log('📝 変換後ニックネーム:', `"${profile.nickname}"`);
                    console.log('✅ Supabaseプロフィール読み込み成功:', email);
                    return profile;
                }
                
                return null;
                
            } catch (error) {
                console.warn('⚠️ Supabase読み込み例外:', error);
                return null;
            }
        }

        // プロフィールデータを保存
        async function saveUserProfile(profile, options = {}) {
            if (!profile || !profile.email) {
                console.error('❌ 無効なプロフィールデータ');
                return false;
            }
            
            const { source = 'unknown', isDirty = true } = options;
            
            // アドバイス実装：起動時やクリーンなデータの自動保存を防ぐ
            if (!isDirty) {
                console.log('📊 [セーフティ] クリーンなデータのため保存をスキップ:', profile.email);
                return true; // 保存不要だが成功扱い
            }
            
            if (source === 'startup' || source === 'initialization' || source === 'load') {
                console.warn('⚠️ [セーフティ] 起動時の保存をブロック:', source);
                return true; // 保存不要だが成功扱い
            }
            
            try {
                console.log('📊 [診断] saveUserProfile呼び出し - source:', source, 'isDirty:', isDirty);
                
                // 更新日時を設定
                profile.updatedAt = new Date().toISOString();
                
                // LocalStorageへの保存は無効化（データ不整合を防ぐため）
                // localStorage.setItem(`user_profile_${profile.email}`, JSON.stringify(profile));
                
                // Supabaseにのみ保存
                await saveProfileToSupabase(profile, source);
                
                console.log('💾 プロフィールを保存:', profile.email);
                return true;
                
            } catch (error) {
                console.error('❌ プロフィール保存エラー:', error);
                return false;
            }
        }

        // Supabaseにプロフィールを保存（新機能）
        async function saveProfileToSupabase(profile, source = 'unknown') {
            try {
                console.log('🔄 Supabaseプロフィール保存開始:', profile.email);
                console.log('📊 [診断] saveProfileToSupabase呼び出し元:', source);
                console.log('📊 [診断] 保存タイムスタンプ:', new Date().toISOString());
                console.log('📝 受け取ったプロフィール:', profile);
                console.log('📝 受け取ったnickname:', `"${profile.nickname}"`, '型:', typeof profile.nickname);
                
                // 🚨 呼び出し元のスタックトレースを記録（重要な診断情報）
                console.log('📍 [診断] スタックトレース:', new Error().stack);
                
                // アドバイス実装：起動時の自動保存を禁止
                if (source === 'startup' || source === 'initialization') {
                    console.warn('⚠️ [セーフティ] 起動時の自動保存は禁止されています:', source);
                    return false;
                }
                
                // nicknameがnullまたはundefinedの場合のみ、デフォルト値を設定
                const defaultNickname = profile.email.split('@')[0] || 'ユーザー';
                const safeNickname = (profile.nickname !== null && profile.nickname !== undefined) ? profile.nickname : defaultNickname;
                
                console.log('💾 保存するnickname:', `"${safeNickname}"`);
                
                // 🚨 重要：Supabase書き込み前の最終確認
                const upsertData = {
                    email: profile.email,
                    nickname: safeNickname, // 確実にnullでない値を設定
                    avatar_url: profile.avatarUrl || null, // 実際のカラム名
                    bio: profile.bio || null,
                    avatar_type: profile.avatarType || 'image',
                    avatar_emoji: profile.avatar || null,
                    is_active: true,
                    updated_at: new Date().toISOString()
                };
                
                console.log('🚨 [重要] Supabaseに送信するデータ:', upsertData);
                console.log('🚨 [重要] 送信するnickname:', `"${upsertData.nickname}"`);
                
                // 既存のuser_profilesテーブルの実際のカラム構造に合わせて保存
                const { error } = await supabaseClient
                    .from('user_profiles')
                    .upsert(upsertData);

                if (error) {
                    console.warn('⚠️ Supabase保存エラー（LocalStorageで継続）:', error);
                    return false;
                } else {
                    console.log('✅ Supabaseプロフィール保存成功:', profile.email);
                    return true;
                }
                
            } catch (error) {
                console.warn('⚠️ Supabase保存例外（LocalStorageで継続）:', error);
                return false;
            }
        }

        // アドバイス実装：表示用ニックネーム取得（フォールバック処理を分離）
        function getDisplayNickname(profile) {
            if (!profile) return 'ゲスト';
            if (profile.nickname && profile.nickname.trim() !== '') {
                return profile.nickname;
            }
            // フォールバックはUI表示のみ、データベースには保存しない
            return profile.email ? profile.email.split('@')[0] : 'ユーザー';
        }
        
        // 現在のユーザープロフィールを初期化
        async function initUserProfile() {
            const user = getCurrentUser();
            if (!user) {
                console.warn('⚠️ ユーザー認証されていません');
                return;
            }
            
            console.log('🔄 プロフィール初期化開始:', user);
            
            // 既存のLocalStorageキャッシュを強制クリア
            const cacheKey = `user_profile_${user}`;
            if (localStorage.getItem(cacheKey)) {
                console.warn('🗑️ 既存のLocalStorageキャッシュを削除:', cacheKey);
                localStorage.removeItem(cacheKey);
            }
            
            // 認証直後にユーザー自動修復を実行
            await ensureUserIsRegistered(user);
            
            currentUserProfile = await loadUserProfile(user);
            
            if (currentUserProfile) {
                console.log('✅ プロフィール初期化完了:', {
                    email: currentUserProfile.email,
                    nickname: `"${currentUserProfile.nickname}"` || '未設定',
                    displayNickname: getDisplayNickname(currentUserProfile),
                    avatar: currentUserProfile.avatar
                });
                
                // ハンバーガーメニューのプロフィール表示を更新
                updateMenuProfileDisplay();
            }
        }

        // nickname が null のレコードを修正する緊急措置関数
        async function fixNullNicknames() {
            try {
                console.log('🔍 fixNullNicknames開始: nickname IS NULL のレコードを検索中...');
                
                // nickname が null のレコードを検索（詳細なログ付き）
                const { data: nullNicknameUsers, error: selectError } = await supabaseClient
                    .from('user_profiles')
                    .select('email, nickname')
                    .is('nickname', null);
                
                if (selectError) {
                    console.warn('⚠️ null nickname検索エラー:', selectError);
                    return;
                }
                
                console.log('📊 null nickname検索結果:', nullNicknameUsers);
                console.log('📊 検索件数:', nullNicknameUsers?.length || 0);
                
                if (nullNicknameUsers && nullNicknameUsers.length > 0) {
                    console.log('🔧 null nicknameを修正中:', nullNicknameUsers.length, '件');
                    
                    // 特定のユーザーが含まれているかチェック
                    const targetEmail = 'bettger1000@gmail.com';
                    const targetUser = nullNicknameUsers.find(user => user.email === targetEmail);
                    if (targetUser) {
                        console.error('❗ 問題発見: bettger1000@gmail.comがnull nickname検索に引っかかっています!');
                        console.error('❗ ユーザーデータ:', targetUser);
                        console.error('❗ nickname値:', targetUser.nickname, '型:', typeof targetUser.nickname);
                        console.error('❗ null判定:', targetUser.nickname === null);
                    }
                    
                    // 各レコードを修正
                    for (const user of nullNicknameUsers) {
                        console.log('🔧 処理対象ユーザー:', user.email, 'nickname:', user.nickname);
                        
                        const defaultNickname = user.email.split('@')[0] || 'ユーザー';
                        const { error: updateError } = await supabaseClient
                            .from('user_profiles')
                            .update({ nickname: defaultNickname })
                            .eq('email', user.email);
                        
                        if (updateError) {
                            console.error('❌ nickname修正エラー:', user.email, updateError);
                        } else {
                            console.log('✅ nickname修正完了:', user.email, '->', defaultNickname);
                        }
                    }
                } else {
                    console.log('✅ null nicknameのレコードはありません。処理をスキップします。');
                }
            } catch (error) {
                console.warn('⚠️ fixNullNicknames例外:', error);
            }
        }
        
        // ユーザー登録を確実にする関数（Supabaseのuser_profilesテーブル対応）
        async function ensureUserIsRegistered(email) {
            try {
                console.log('🔧 ユーザー登録確認中:', email);
                
                // fixNullNicknames関数を一時的に無効化（問題解決まで）
                console.log('⚠️ fixNullNicknames関数は一時的に無効化されています');
                // await fixNullNicknames(); // 無効化
                console.log('✅ fixNullNicknames実行スキップ');
                
                // まずSupabaseで確認
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('email, is_active')
                    .eq('email', email)
                    .single();
                
                if (error && error.code === 'PGRST116') {
                    // ユーザーが存在しない場合は作成
                    console.log('🆕 ユーザーが存在しないため新規作成:', email);
                    const defaultNickname = email.split('@')[0] || 'ユーザー';
                    const { error: insertError } = await supabaseClient
                        .from('user_profiles')
                        .insert({
                            email: email,
                            is_active: true,
                            nickname: defaultNickname, // デフォルトニックネームを設定
                            avatar_url: null
                        });
                    
                    if (insertError) {
                        console.warn('⚠️ Supabase挿入エラー:', insertError);
                    } else {
                        console.log('✅ Supabaseにユーザーを作成しました:', email);
                    }
                } else if (!error && data) {
                    console.log('👤 既存ユーザー発見:', data);
                    if (!data.is_active) {
                        // 非アクティブユーザーをアクティブにする
                        console.log('🔄 非アクティブユーザーをアクティブ化:', email);
                        await supabaseClient
                            .from('user_profiles')
                            .update({ is_active: true })
                            .eq('email', email);
                        console.log('✅ ユーザーをアクティブ化しました:', email);
                    } else {
                        console.log('✅ ユーザーは既に登録済みでアクティブです:', email);
                    }
                } else {
                    console.error('❌ ユーザー確認でエラー:', error);
                }
                
                // LocalStorageも更新
                const approvedUsers = await getApprovedUsers();
                const existingUser = approvedUsers.find(u => u.email === email);
                
                if (!existingUser) {
                    approvedUsers.push({
                        id: email,
                        email: email,
                        registeredAt: new Date().toISOString(),
                        hasPin: false
                    });
                    localStorage.setItem('approvedUsers', JSON.stringify(approvedUsers));
                    console.log('✅ LocalStorageも更新しました:', email);
                }
                
            } catch (error) {
                console.error('❌ ユーザー自動修復エラー:', error);
                
                // エラー時はLocalStorageだけでも更新
                try {
                    const approvedUsers = JSON.parse(localStorage.getItem('approvedUsers') || '[]');
                    const existingUser = approvedUsers.find(u => u.email === email);
                    if (!existingUser) {
                        approvedUsers.push({
                            id: email,
                            email: email,
                            registeredAt: new Date().toISOString(),
                            hasPin: false
                        });
                        localStorage.setItem('approvedUsers', JSON.stringify(approvedUsers));
                        console.log('✅ フォールバック: LocalStorageに保存しました:', email);
                    }
                } catch (e) {
                    console.error('❌ フォールバックも失敗:', e);
                }
            }
        }

        // ハンバーガーメニューのプロフィール表示を更新
        function updateMenuProfileDisplay() {
            try {
                const menuTitle = document.querySelector('.side-menu-title');
                const menuSubtitle = document.querySelector('.side-menu-subtitle');
                
                if (currentUserProfile && menuTitle && menuSubtitle) {
                    // アドバイス実装：安全な表示用フォールバック
                    const displayName = getDisplayNickname(currentUserProfile);
                    
                    // 画像アバターの場合は小さな画像を表示
                    if (currentUserProfile.avatarType === 'image' && currentUserProfile.avatarUrl) {
                        menuTitle.innerHTML = `<img src="${currentUserProfile.avatarUrl}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);" onerror="this.style.display='none'; this.nextSibling.style.display='inline';" class="menu-avatar-image">${displayName}`;
                    } else {
                        // プリセット絵文字の場合
                        const avatar = getAvatarDisplay(currentUserProfile);
                        menuTitle.textContent = `${avatar} ${displayName}`;
                    }
                    
                    menuSubtitle.textContent = 'ビヨグル倶楽部';
                } else if (menuTitle && menuSubtitle) {
                    // プロフィール未読み込み時のフォールバック
                    menuTitle.textContent = '🌸 ゲスト';
                    menuSubtitle.textContent = 'ビヨグル倶楽部';
                }
            } catch (error) {
                console.error('❌ メニュー表示更新エラー:', error);
            }
        }

        // アバター表示を取得
        function getAvatarDisplay(profile) {
            if (!profile) return '🌸';
            
            if (profile.avatarType === 'image' && profile.avatarUrl) {
                // アップロード画像の場合は代替として絵文字を返す（表示は別途処理）
                return '📷';
            } else if (profile.avatarType === 'custom' && profile.customAvatarData) {
                // カスタム画像の場合は代替として絵文字を返す（表示は別途処理）
                return '📷';
            } else {
                // プリセット絵文字
                const preset = PRESET_AVATARS.find(a => a.id === profile.avatar);
                return preset ? preset.emoji : '🌸';
            }
        }

        // ニックネーム変更
        async function updateNickname(newNickname) {
            if (!currentUserProfile) {
                console.error('❌ プロフィールが初期化されていません');
                return false;
            }
            
            // バリデーション
            if (!newNickname || newNickname.trim().length === 0) {
                alert('ニックネームを入力してください');
                return false;
            }
            
            if (newNickname.trim().length > 20) {
                alert('ニックネームは20文字以内で入力してください');
                return false;
            }
            
            try {
                currentUserProfile.nickname = newNickname.trim();
                // アドバイス実装：ユーザー操作による明示的な保存
                const success = await saveUserProfile(currentUserProfile, { 
                    source: 'user_action_nickname', 
                    isDirty: true 
                });
                
                if (success) {
                    updateMenuProfileDisplay();
                    console.log('✅ ニックネーム更新完了:', newNickname);
                    return true;
                }
                
            } catch (error) {
                console.error('❌ ニックネーム更新エラー:', error);
                alert('ニックネーム更新に失敗しました');
            }
            
            return false;
        }

        // アバター変更
        async function updateAvatar(avatarId, avatarType = 'image', customData = null) {
            if (!currentUserProfile) {
                console.error('❌ プロフィールが初期化されていません');
                return false;
            }
            
            try {
                if (avatarType === 'image' && customData) {
                    // カスタム画像アップロードの場合
                    currentUserProfile.avatarUrl = customData;
                    currentUserProfile.avatarType = 'image';
                    currentUserProfile.avatar = null; // プリセットIDはクリア
                } else {
                    // プリセットアバターの場合
                    currentUserProfile.avatar = avatarId;
                    currentUserProfile.avatarType = avatarType;
                    currentUserProfile.avatarUrl = null; // カスタムURLはクリア
                }
                currentUserProfile.customAvatarData = customData;
                
                // アドバイス実装：ユーザー操作による明示的な保存
                const success = await saveUserProfile(currentUserProfile, { 
                    source: 'user_action_avatar', 
                    isDirty: true 
                });
                
                if (success) {
                    updateMenuProfileDisplay();
                    console.log('✅ アバター更新完了:', avatarId);
                    return true;
                }
                
            } catch (error) {
                console.error('❌ アバター更新エラー:', error);
                alert('アバター更新に失敗しました');
            }
            
            return false;
        }

        // ========== ハンバーガーメニュー機能 ==========
        
        // サイドメニューを開く
        function toggleSideMenu() {
            const overlay = document.getElementById('sideMenuOverlay');
            if (overlay.classList.contains('active')) {
                closeSideMenu();
            } else {
                openSideMenu();
            }
        }

        function openSideMenu() {
            const overlay = document.getElementById('sideMenuOverlay');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // スクロール無効化
        }

        function closeSideMenu() {
            const overlay = document.getElementById('sideMenuOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = ''; // スクロール復活
        }

        // ESCキーでメニューを閉じる
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeSideMenu();
            }
        });

        // メニュー項目の関数
        function showProfile() {
            closeSideMenu();
            openProfileModal();
        }

        function showMyStats() {
            closeSideMenu();
            console.log('📊 マイ統計画面を開く（Phase 2で実装予定）');
            // TODO: Phase 2で実装
        }

        // マイレビュー画面表示
        async function showMyReviews() {
            console.log('🔍 showMyReviews関数が呼び出されました');
            closeSideMenu();
            console.log('⭐ マイレビュー画面を開く');
            
            const currentUserEmail = getCurrentUser();
            console.log('👤 現在のユーザー:', currentUserEmail);
            console.log('👤 currentUser変数:', currentUser);
            console.log('👤 localStorage:', localStorage.getItem('currentUser'));
            
            if (!currentUserEmail) {
                console.log('❌ ユーザーが見つかりません');
                alert('ログインが必要です');
                return;
            }
            
            console.log('✅ ユーザー確認OK、レビュー取得開始');
            
            try {
                // まずユーザーのレビューを取得（店舗情報なし）
                const { data: reviewsData, error: reviewsError } = await supabaseClient
                    .from('reviews')
                    .select('id, store_id, content, created_at, updated_at')
                    .eq('user_email', currentUserEmail)
                    .eq('is_deleted', false)
                    .order('created_at', { ascending: false });
                
                if (reviewsError) {
                    console.error('マイレビュー取得エラー:', reviewsError);
                    alert('レビューの取得に失敗しました');
                    return;
                }
                
                if (!reviewsData || reviewsData.length === 0) {
                    console.log('📝 レビューなし');
                    showMyReviewsModal([]);
                    return;
                }
                
                // 店舗情報を追加で取得（確実な方法で）
                const storeIds = [...new Set(reviewsData.map(r => r.store_id))];
                console.log('🏪 取得する店舗IDs:', storeIds);
                
                let storesData = [];
                if (storeIds.length > 0) {
                    // 各店舗IDが有効な数値であることを確認
                    const validStoreIds = storeIds.filter(id => id != null && !isNaN(Number(id)));
                    console.log('✅ 有効な店舗IDs:', validStoreIds);
                    
                    if (validStoreIds.length > 0) {
                        // INクエリの代わりに個別クエリを並行実行（確実な方法）
                        const storePromises = validStoreIds.map(async (storeId) => {
                            try {
                                // 確実に数値として扱う
                                const numericStoreId = Number(storeId);
                                console.log(`🔍 店舗ID ${numericStoreId} を取得中...`);
                                
                                const { data: storeData, error: storeError } = await supabaseClient
                                    .from('stores')
                                    .select('id, name, address, category_id')
                                    .eq('id', numericStoreId)
                                    .single();
                                
                                if (storeError) {
                                    console.warn(`⚠️ 店舗ID ${storeId} 取得エラー:`, storeError);
                                    return null;
                                }
                                
                                return storeData;
                            } catch (error) {
                                console.warn(`⚠️ 店舗ID ${storeId} 例外:`, error);
                                return null;
                            }
                        });
                        
                        // 全ての店舗データを並行取得
                        const storeResults = await Promise.all(storePromises);
                        storesData = storeResults.filter(store => store !== null);
                        console.log('✅ 店舗データ取得成功:', storesData.length, '/', validStoreIds.length, '件');
                    }
                }
                
                // レビューと店舗情報を結合
                const reviewsWithStores = reviewsData.map(review => ({
                    ...review,
                    stores: storesData?.find(store => store.id === review.store_id) || {
                        name: '店舗情報なし',
                        address: '',
                        category_id: null
                    }
                }));
                
                console.log('✅ マイレビューデータ準備完了:', reviewsWithStores.length, '件');
                showMyReviewsModal(reviewsWithStores);
                
            } catch (error) {
                console.error('マイレビュー取得例外:', error);
                alert('レビューの取得中にエラーが発生しました');
            }
        }

        // マイレビューモーダル表示
        function showMyReviewsModal(reviews) {
            const modalHTML = `
                <div class="my-reviews-modal" onclick="closeMyReviews()">
                    <div class="my-reviews-content" onclick="event.stopPropagation()">
                        <div class="my-reviews-header">
                            <h2 class="my-reviews-title">
                                <span class="my-reviews-icon">⭐</span>
                                マイレビュー
                            </h2>
                            <button class="close-btn" onclick="closeMyReviews()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="my-reviews-body" id="my-reviews-body">
                            読み込み中...
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.body.style.overflow = 'hidden';
            
            // 非同期でレビューHTML生成
            createMyReviewsHTML(reviews).then(reviewsHTML => {
                const bodyElement = document.getElementById('my-reviews-body');
                if (bodyElement) {
                    bodyElement.innerHTML = reviewsHTML;
                }
            }).catch(error => {
                console.error('マイレビューHTML生成エラー:', error);
                const bodyElement = document.getElementById('my-reviews-body');
                if (bodyElement) {
                    bodyElement.innerHTML = '<p style="color: red;">レビューの表示でエラーが発生しました</p>';
                }
            });
        }

        // マイレビュー HTML生成（非同期でユーザー情報を含む）
        async function createMyReviewsHTML(reviews) {
            if (!reviews || reviews.length === 0) {
                return `
                    <div class="reviews-empty">
                        <i class="fas fa-comment-dots"></i>
                        <h3>まだレビューがありません</h3>
                        <p>お気に入りの店舗で感想を書いてみませんか？</p>
                    </div>
                `;
            }
            
            // 現在のユーザー情報をSupabaseから取得
            const currentUserEmail = getCurrentUser();
            let userProfile = null;
            let avatarEmoji = '🐱'; // デフォルト
            let nickname = currentUserEmail?.split('@')[0] || 'ユーザー'; // フォールバック
            
            try {
                // Supabaseからユーザープロファイルを取得
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('nickname, avatar, avatar_url')
                    .eq('email', currentUserEmail)
                    .single();
                
                if (!error && data) {
                    userProfile = data;
                    nickname = userProfile.nickname || nickname; // Supabaseのnicknameを優先
                    avatarEmoji = getAvatarEmoji(userProfile.avatar || 'cat');
                }
            } catch (error) {
                console.warn('⚠️ ユーザープロファイル取得失敗、デフォルト値使用:', error);
            }
            
            const reviewsHTML = reviews.map(review => {
                const createdDate = new Date(review.created_at).toLocaleDateString('ja-JP');
                const isUpdated = review.updated_at !== review.created_at;
                const storeName = review.stores?.name || '店舗名不明';
                const storeAddress = review.stores?.address || '';
                const storeCategory = review.stores?.category_id || '';
                
                return `
                    <div class="my-review-card">
                        <div class="review-card-header">
                            <div class="store-name-container">
                                <a href="#" class="store-name-link" onclick="goToStoreFromReview(${review.store_id}); return false;">
                                    ${escapeHtml(storeName)}
                                    <i class="fas fa-map-marker-alt"></i>
                                </a>
                                <div class="store-info">
                                    ${storeCategory ? `<span class="store-category">${escapeHtml(storeCategory)}</span>` : ''}
                                    ${storeAddress ? `<span class="store-address">${escapeHtml(storeAddress)}</span>` : ''}
                                </div>
                            </div>
                            <div class="review-header-right">
                                <div class="review-actions">
                                    <button class="review-action-btn edit-btn" onclick="editReview(${review.id}, '${escapeHtml(review.content).replace(/'/g, "\\'")}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="review-card-body">
                            <div class="review-content" id="review-content-${review.id}">
                                ${escapeHtml(review.content)}
                            </div>
                            <div class="review-meta">
                                <div class="review-user">
                                    <div class="review-avatar">${avatarEmoji}</div>
                                    <div>
                                        <div class="review-nickname">${escapeHtml(nickname)}</div>
                                        <div class="review-date">${createdDate}${isUpdated ? ' (編集済み)' : ''}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="my-reviews-list">
                    <div class="my-reviews-count">
                        ${reviews.length}件のレビュー
                    </div>
                    ${reviewsHTML}
                </div>
            `;
        }

        // マイレビュー画面を閉じる
        function closeMyReviews() {
            const modal = document.querySelector('.my-reviews-modal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }

        // レビューから店舗へのナビゲーション
        function goToStoreFromReview(storeId) {
            console.log('🗺️ 店舗へ移動:', storeId);
            
            // マイレビューモーダルを閉じる
            closeMyReviews();
            
            // 少し待ってから店舗詳細を表示
            setTimeout(() => {
                showStoreDetail(storeId);
            }, 300);
        }

        // マイレビューの編集
        function editMyReview(reviewId, currentContent) {
            console.log('📝 マイレビュー編集開始:', reviewId);
            
            const contentElement = document.getElementById(`my-review-content-${reviewId}`);
            if (!contentElement) {
                console.error('マイレビューコンテンツ要素が見つかりません:', reviewId);
                return;
            }
            
            // 編集フォームに置き換え
            const editFormHTML = `
                <div class="my-review-edit-form">
                    <textarea 
                        id="my-edit-textarea-${reviewId}"
                        class="review-textarea"
                        maxlength="2000"
                        placeholder="感想を編集してください..."
                        oninput="updateMyEditCharCount(${reviewId})"
                    >${currentContent}</textarea>
                    <div class="review-form-footer">
                        <span class="char-count" id="my-edit-char-count-${reviewId}">残り: ${2000 - currentContent.length}文字</span>
                        <div class="review-form-buttons">
                            <button class="btn-cancel" onclick="cancelEditMyReview(${reviewId}, '${currentContent.replace(/'/g, "\\'")}')">キャンセル</button>
                            <button class="btn-submit" onclick="saveEditMyReview(${reviewId})">保存</button>
                        </div>
                    </div>
                </div>
            `;
            
            contentElement.innerHTML = editFormHTML;
            
            // テキストエリアにフォーカス
            const textarea = document.getElementById(`my-edit-textarea-${reviewId}`);
            if (textarea) {
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }
        }

        // マイレビュー編集キャンセル
        function cancelEditMyReview(reviewId, originalContent) {
            const contentElement = document.getElementById(`my-review-content-${reviewId}`);
            if (contentElement) {
                contentElement.innerHTML = escapeHtml(originalContent);
            }
        }

        // マイレビュー編集時の文字数カウント更新
        function updateMyEditCharCount(reviewId) {
            const textarea = document.getElementById(`my-edit-textarea-${reviewId}`);
            const charCount = document.getElementById(`my-edit-char-count-${reviewId}`);
            
            if (textarea && charCount) {
                const remaining = 2000 - textarea.value.length;
                charCount.textContent = `残り: ${remaining}文字`;
                charCount.style.color = remaining < 100 ? '#ef4444' : remaining < 300 ? '#f59e0b' : '#6b7280';
            }
        }

        // マイレビュー保存（編集）
        async function saveEditMyReview(reviewId) {
            const textarea = document.getElementById(`my-edit-textarea-${reviewId}`);
            const currentUserEmail = getCurrentUser();
            
            if (!currentUserEmail) {
                alert('ユーザー認証が必要です。再度ログインしてください。');
                return;
            }
            
            if (!textarea) {
                console.error('編集テキストエリアが見つかりません');
                return;
            }
            
            const newContent = textarea.value.trim();
            if (!newContent) {
                alert('感想を入力してください');
                return;
            }
            
            if (newContent.length > 2000) {
                alert('感想は2000文字以内で入力してください');
                return;
            }
            
            try {
                // ボタンを無効化
                const saveBtn = textarea.parentElement.querySelector('.btn-submit');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = '保存中...';
                }
                
                console.log('💾 マイレビュー更新開始:', reviewId);
                
                // Supabaseでレビューを更新
                const { error } = await supabaseClient
                    .from('reviews')
                    .update({
                        content: newContent,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', reviewId)
                    .eq('user_email', currentUserEmail);
                
                if (error) {
                    console.error('マイレビュー更新エラー:', error);
                    alert('レビューの更新に失敗しました。もう一度お試しください。');
                    return;
                }
                
                console.log('✅ マイレビュー更新成功:', reviewId);
                alert('感想を更新しました！');
                
                // マイレビュー画面を再読み込み
                setTimeout(async () => {
                    await showMyReviews();
                }, 500);
                
            } catch (error) {
                console.error('マイレビュー更新例外:', error);
                alert('更新中にエラーが発生しました');
            }
        }

        // マイレビュー削除
        async function deleteMyReview(reviewId) {
            if (!confirm('この感想を削除してもよろしいですか？\n削除した感想は復元できません。')) {
                return;
            }
            
            const currentUserEmail = getCurrentUser();
            
            if (!currentUserEmail) {
                alert('ユーザー認証が必要です。再度ログインしてください。');
                return;
            }
            
            try {
                console.log('🗑️ マイレビュー削除開始:', reviewId);
                
                // Supabaseでレビューを論理削除
                const { error } = await supabaseClient
                    .from('reviews')
                    .update({
                        is_deleted: true,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', reviewId)
                    .eq('user_email', currentUserEmail);
                
                if (error) {
                    console.error('マイレビュー削除エラー:', error);
                    alert('レビューの削除に失敗しました。もう一度お試しください。');
                    return;
                }
                
                console.log('✅ マイレビュー削除成功:', reviewId);
                alert('感想を削除しました');
                
                // マイレビュー画面を再読み込み
                setTimeout(async () => {
                    await showMyReviews();
                }, 500);
                
            } catch (error) {
                console.error('マイレビュー削除例外:', error);
                alert('削除中にエラーが発生しました');
            }
        }

        function showAppInfo() {
            closeSideMenu();
            console.log('ℹ️ アプリ情報画面を開く（Phase 1で実装予定）');
            // TODO: Phase 1で実装
        }

        // ログアウト機能（既存機能を流用）
        function handleLogout() {
            closeSideMenu();
            if (confirm('ログアウトしてもよろしいですか？')) {
                signOut();
            }
        }

        // ========== プロフィール画面操作 ==========
        
        let selectedAvatarId = 'default';

        // プロフィール画面を開く
        function openProfileModal() {
            if (!currentUserProfile) {
                alert('プロフィール情報を読み込み中です。しばらくお待ちください。');
                return;
            }
            
            try {
                const overlay = document.getElementById('profileModalOverlay');
                const nicknameInput = document.getElementById('nicknameInput');
                
                if (!overlay || !nicknameInput) {
                    console.error('❌ プロフィール画面の要素が見つかりません');
                    alert('プロフィール画面を開けませんでした。ページを再読み込みしてください。');
                    return;
                }
                
                // 現在の値を設定
                nicknameInput.value = currentUserProfile.nickname || '';
                selectedAvatarId = currentUserProfile.avatar || 'default';
                
                // アバターグリッドを生成
                generateAvatarGrid();
                
                // モーダルを表示
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // ニックネーム入力にフォーカス
                setTimeout(() => {
                    if (nicknameInput) {
                        nicknameInput.focus();
                    }
                }, 300);
                
            } catch (error) {
                console.error('❌ プロフィール画面オープンエラー:', error);
                alert('プロフィール画面を開けませんでした。');
            }
        }

        // プロフィール画面を閉じる
        function closeProfileModal() {
            const overlay = document.getElementById('profileModalOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        // アバターグリッドを生成
        function generateAvatarGrid() {
            try {
                const avatarGrid = document.getElementById('avatarGrid');
                if (!avatarGrid) {
                    console.error('❌ アバターグリッド要素が見つかりません');
                    return;
                }
                
                avatarGrid.innerHTML = '';
                
                PRESET_AVATARS.forEach(avatar => {
                    const avatarDiv = document.createElement('div');
                    avatarDiv.className = `avatar-option${selectedAvatarId === avatar.id ? ' selected' : ''}`;
                    avatarDiv.innerHTML = avatar.emoji;
                    avatarDiv.title = avatar.name;
                    avatarDiv.onclick = () => selectAvatar(avatar.id);
                    avatarGrid.appendChild(avatarDiv);
                });
                
            } catch (error) {
                console.error('❌ アバターグリッド生成エラー:', error);
            }
        }

        // アバターを選択
        function selectAvatar(avatarId) {
            selectedAvatarId = avatarId;
            
            // 選択状態を更新
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            document.querySelectorAll('.avatar-option').forEach((option, index) => {
                if (PRESET_AVATARS[index].id === avatarId) {
                    option.classList.add('selected');
                }
            });
        }

        // ========== アバターアップロード機能 ==========
        const AVATAR_WORKER_URL = 'https://avatar-upload-worker.bettger1000.workers.dev';
        let selectedFile = null;
        let uploadedAvatarUrl = null;

        // アバタータブの切り替え
        function showAvatarTab(tabType) {
            // タブの状態更新
            document.querySelectorAll('.avatar-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // コンテンツの表示/非表示
            document.getElementById('presetAvatars').style.display = tabType === 'preset' ? 'block' : 'none';
            document.getElementById('uploadAvatar').style.display = tabType === 'upload' ? 'block' : 'none';

            // アップロードタブを開いた時の初期化
            if (tabType === 'upload') {
                updateCurrentAvatarPreview();
            }
        }

        // 現在のアバター表示を更新
        function updateCurrentAvatarPreview() {
            const currentImage = document.getElementById('currentAvatarImage');
            const placeholder = document.getElementById('currentAvatarPlaceholder');

            if (currentUserProfile?.avatarUrl) {
                currentImage.src = currentUserProfile.avatarUrl;
                currentImage.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                currentImage.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }

        // ファイル選択の処理
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('avatarFileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    // ファイルサイズチェック（500KB以下）
                    if (file.size > 500 * 1024) {
                        showUploadStatus('ファイルサイズが大きすぎます（最大500KB）', 'error');
                        return;
                    }

                    // ファイル形式チェック
                    if (!file.type.startsWith('image/')) {
                        showUploadStatus('画像ファイルを選択してください', 'error');
                        return;
                    }

                    selectedFile = file;
                    showPreview(file);
                });
            }
        });

        // プレビュー表示
        function showPreview(file) {
            const previewSection = document.getElementById('previewSection');
            const previewImage = document.getElementById('previewImage');
            const fileInfo = document.getElementById('fileInfo');

            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                fileInfo.textContent = `${file.name} (${Math.round(file.size / 1024)}KB)`;
                previewSection.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // アバターアップロード実行
        async function uploadAvatar() {
            if (!selectedFile) {
                showUploadStatus('ファイルが選択されていません', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> アップロード中...';
            
            showUploadStatus('アップロード中...', 'info');

            try {
                const formData = new FormData();
                formData.append('image', selectedFile);
                formData.append('email', getCurrentUser() || 'anonymous');

                const response = await fetch(`${AVATAR_WORKER_URL}/upload`, {
                    method: 'POST',
                    body: formData,
                    // タイムアウト設定
                    signal: AbortSignal.timeout(30000) // 30秒
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    uploadedAvatarUrl = result.url;
                    showUploadStatus('アップロード成功！保存ボタンをクリックしてプロフィールに反映してください。', 'success');
                    
                    // プレビューを更新
                    document.getElementById('currentAvatarImage').src = result.url;
                    document.getElementById('currentAvatarImage').style.display = 'block';
                    document.getElementById('currentAvatarPlaceholder').style.display = 'none';
                    
                    // アップロードタイプをセット
                    selectedAvatarId = 'uploaded';
                } else {
                    throw new Error(result.error || 'アップロード失敗');
                }
            } catch (error) {
                console.error('アップロードエラー:', error);
                
                // エラーの種類に応じたメッセージ
                let errorMessage = 'アップロードに失敗しました。';
                if (error.name === 'AbortError') {
                    errorMessage = 'アップロードがタイムアウトしました。ネットワーク接続を確認してください。';
                } else if (error.name === 'TypeError') {
                    errorMessage = 'ネットワークエラーが発生しました。接続を確認してください。';
                } else if (error.message.includes('File too large')) {
                    errorMessage = 'ファイルサイズが大きすぎます（最大500KB）。';
                } else if (error.message) {
                    errorMessage = `エラー: ${error.message}`;
                }
                
                showUploadStatus(errorMessage, 'error');
                
                // フォールバック: プリセットタブに戻す提案
                showUploadStatus(errorMessage + '<br><small>プリセットアバターをご利用ください。</small>', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i> アップロード';
            }
        }

        // アップロードステータス表示
        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.className = `upload-status ${type}`;
            statusDiv.innerHTML = message;
        }

        // プロフィールを保存
        async function saveProfile() {
            const nicknameInput = document.getElementById('nicknameInput');
            const saveBtn = document.querySelector('.profile-save-btn');
            
            const newNickname = nicknameInput.value.trim();
            
            // 保存ボタンを無効化
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
            
            try {
                // ニックネーム更新
                if (newNickname !== currentUserProfile.nickname) {
                    const nicknameSuccess = await updateNickname(newNickname);
                    if (!nicknameSuccess && newNickname !== '') {
                        throw new Error('ニックネーム更新に失敗しました');
                    }
                }
                
                // アバター更新
                if (selectedAvatarId === 'uploaded' && uploadedAvatarUrl) {
                    // 画像アップロードの場合
                    const avatarSuccess = await updateAvatar(null, 'image', uploadedAvatarUrl);
                    if (!avatarSuccess) {
                        throw new Error('アバター更新に失敗しました');
                    }
                } else if (selectedAvatarId !== currentUserProfile.avatar) {
                    // プリセットアバターの場合
                    const avatarSuccess = await updateAvatar(selectedAvatarId, 'emoji');
                    if (!avatarSuccess) {
                        throw new Error('アバター更新に失敗しました');
                    }
                }
                
                // 成功メッセージ
                saveBtn.innerHTML = '<i class="fas fa-check"></i> 保存完了！';
                
                setTimeout(() => {
                    closeProfileModal();
                }, 1000);
                
            } catch (error) {
                console.error('❌ プロフィール保存エラー:', error);
                alert('プロフィールの保存に失敗しました。もう一度お試しください。');
                
                // ボタンを復元
                saveBtn.innerHTML = '<i class="fas fa-save"></i> 保存する';
                
            } finally {
                saveBtn.disabled = false;
            }
        }

        // ========== レビューシステム ==========
        
        // 店舗のレビューを安全に取得
        async function getStoreReviews(storeId) {
            try {
                console.log('📝 レビュー取得開始:', storeId);
                
                const { data, error } = await supabaseClient
                    .from('reviews')
                    .select(`
                        id,
                        content,
                        created_at,
                        updated_at,
                        user_email
                    `)
                    .eq('store_id', storeId)
                    .eq('is_deleted', false)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.warn('⚠️ レビュー取得エラー:', error);
                    return [];
                }

                // ユーザー情報と結合
                const reviewsWithUserInfo = await Promise.all(
                    (data || []).map(async (review) => {
                        try {
                            const { data: userProfile } = await supabaseClient
                                .from('user_profiles')
                                .select('nickname, avatar_emoji')
                                .eq('email', review.user_email)
                                .single();

                            return {
                                ...review,
                                user_nickname: userProfile?.nickname || '匿名ユーザー',
                                user_avatar: userProfile?.avatar_emoji || 'default'
                            };
                        } catch (err) {
                            console.warn('ユーザー情報取得エラー:', err);
                            return {
                                ...review,
                                user_nickname: '匿名ユーザー',
                                user_avatar: 'default'
                            };
                        }
                    })
                );

                console.log('✅ レビュー取得成功:', reviewsWithUserInfo.length, '件');
                return reviewsWithUserInfo;

            } catch (error) {
                console.error('❌ レビュー取得例外:', error);
                return [];
            }
        }

        // レビューHTMLを生成（投稿フォーム付き）
        function createReviewsHTML(reviews, storeId) {
            console.log('🔍 Debug - createReviewsHTML called with:', reviews, 'for store:', storeId);
            // 登録済みユーザーのみアクセス可能なので、常に投稿フォームを表示
            const reviewFormHTML = `
                <div class="review-form-container" id="reviewFormContainer">
                    <button class="btn-add-review" onclick="toggleReviewForm(${storeId})">
                        ＋ 感想を書く
                    </button>
                    <div class="review-form" id="reviewForm" style="display: none;">
                        <textarea 
                            id="reviewContent"
                            class="review-textarea"
                            placeholder="グルテンフリーメニューの種類や味、スタッフの対応、お店の雰囲気など..."
                            maxlength="2000"
                            oninput="updateCharCount()"
                        ></textarea>
                        <div class="review-form-footer">
                            <span class="char-count" id="charCount">残り: 2000文字</span>
                            <div class="review-form-buttons">
                                <button class="btn-cancel" onclick="cancelReview()">キャンセル</button>
                                <button class="btn-submit" onclick="submitReview(${storeId})">感想を投稿</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (!reviews || reviews.length === 0) {
                return `
                    <div class="store-detail-info">
                        <h3>💬 みんなの感想</h3>
                        ${reviewFormHTML}
                        <p class="no-reviews">まだ感想が投稿されていません</p>
                    </div>
                `;
            }

            const reviewsHTML = reviews.map(review => {
                console.log('🔍 Debug - Processing review:', review);
                const createdDate = new Date(review.created_at).toLocaleDateString('ja-JP');
                const isUpdated = review.updated_at !== review.created_at;
                
                // 現在のユーザーがレビューの投稿者かチェック
                const currentUserEmail = getCurrentUser();
                const isOwner = currentUserEmail && review.user_email === currentUserEmail;
                
                try {
                    const avatarEmoji = getAvatarEmoji(review.user_avatar || 'default');
                    const nickname = escapeHtml(review.user_nickname || '匿名ユーザー');
                    console.log('🔍 Debug - Avatar emoji:', avatarEmoji, 'Nickname:', nickname);
                    
                    return `
                        <div class="review-item">
                            <div class="review-header">
                                <div class="review-user">
                                    <span class="review-avatar">${avatarEmoji}</span>
                                    <span class="review-nickname">${nickname}</span>
                                </div>
                            <div class="review-header-right">
                                <div class="review-date">
                                    ${createdDate}${isUpdated ? ' (編集済み)' : ''}
                                </div>
                                ${isOwner ? `
                                    <div class="review-actions">
                                        <button class="review-action-btn edit-btn" onclick="editReview(${review.id}, '${escapeHtml(review.content).replace(/'/g, "\\'")}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="review-action-btn delete-btn" onclick="deleteReview(${review.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            </div>
                            <div class="review-content" id="review-content-${review.id}">
                                ${escapeHtml(review.content)}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('🔍 Debug - Review HTML generation error:', error);
                    return `<div class="review-item">Error processing review</div>`;
                }
            }).join('');

            return `
                <div class="store-detail-info">
                    <h3>💬 みんなの感想 (${reviews.length}件)</h3>
                    ${reviewFormHTML}
                    <div class="reviews-list">
                        ${reviewsHTML}
                    </div>
                </div>
            `;
        }

        // レビュー投稿フォーム操作
        function toggleReviewForm(storeId) {
            const form = document.getElementById('reviewForm');
            const btn = document.querySelector('.btn-add-review');
            
            // デバッグ: 現在のユーザー情報確認
            const currentUserEmail = getCurrentUser();
            console.log('フォーム表示時のユーザー情報:', currentUserEmail);
            console.log('localStorage確認:', localStorage.getItem('currentUser'));
            
            if (form.style.display === 'none') {
                form.style.display = 'block';
                btn.style.display = 'none';
                document.getElementById('reviewContent').focus();
            }
        }

        function cancelReview() {
            const form = document.getElementById('reviewForm');
            const btn = document.querySelector('.btn-add-review');
            const textarea = document.getElementById('reviewContent');
            
            // 確認ダイアログ（内容がある場合のみ）
            if (textarea.value.trim() && !confirm('入力中の内容が失われますが、よろしいですか？')) {
                return;
            }
            
            form.style.display = 'none';
            btn.style.display = 'block';
            textarea.value = '';
            updateCharCount();
        }

        function updateCharCount() {
            const textarea = document.getElementById('reviewContent');
            const charCount = document.getElementById('charCount');
            const remaining = 2000 - textarea.value.length;
            
            charCount.textContent = `残り: ${remaining}文字`;
            charCount.style.color = remaining < 100 ? '#ef4444' : remaining < 300 ? '#f59e0b' : '#6b7280';
        }

        // レビュー投稿処理
        async function submitReview(storeId) {
            const currentUserEmail = getCurrentUser();
            
            // 安全性チェック
            if (!currentUserEmail) {
                alert('ユーザー情報が見つかりません。再度ログインしてください。');
                console.error('currentUser:', currentUserEmail);
                return;
            }

            const content = document.getElementById('reviewContent').value.trim();
            if (!content) {
                alert('感想を入力してください');
                return;
            }

            if (content.length > 2000) {
                alert('感想は2000文字以内で入力してください');
                return;
            }

            const submitBtn = document.querySelector('.btn-submit');
            const originalText = submitBtn.textContent;
            
            try {
                // ボタン無効化
                submitBtn.disabled = true;
                submitBtn.textContent = '投稿中...';

                console.log('レビュー投稿開始:', {
                    store_id: storeId,
                    user_email: currentUserEmail,
                    content_length: content.length
                });

                // Supabaseに投稿
                const { error } = await supabaseClient
                    .from('reviews')
                    .insert({
                        store_id: storeId,
                        user_email: currentUserEmail,
                        content: content,
                        is_deleted: false,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });

                if (error) {
                    console.error('レビュー投稿エラー:', error);
                    console.error('エラー詳細:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code
                    });
                    
                    // より詳細なエラーメッセージ
                    let errorMessage = '投稿に失敗しました。';
                    if (error.message.includes('duplicate')) {
                        errorMessage = '既にレビューを投稿済みです。';
                    } else if (error.message.includes('permission') || error.message.includes('unauthorized')) {
                        errorMessage = '投稿する権限がありません。再度ログインしてください。';
                    } else if (error.message.includes('foreign key')) {
                        errorMessage = '店舗情報が見つかりません。';
                    } else if (error.message.includes('network')) {
                        errorMessage = 'ネットワークエラーです。接続を確認してください。';
                    }
                    
                    alert(errorMessage);
                    return;
                }

                // 成功
                alert('感想を投稿しました！');
                
                // フォームをクリア
                cancelReview();
                
                // レビューを再読み込みして表示更新
                await refreshStoreReviews(storeId);

            } catch (error) {
                console.error('レビュー投稿例外:', error);
                alert('投稿中にエラーが発生しました');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // レビューの再読み込みと表示更新
        async function refreshStoreReviews(storeId) {
            try {
                const reviews = await getStoreReviews(storeId);
                const reviewsContainer = document.querySelector('.store-detail-info:has(.reviews-list), .store-detail-info:has(.no-reviews)');
                
                if (reviewsContainer) {
                    reviewsContainer.outerHTML = createReviewsHTML(reviews, storeId);
                }
            } catch (error) {
                console.error('レビュー更新エラー:', error);
            }
        }

        // レビュー編集機能
        function editReview(reviewId, currentContent) {
            console.log('📝 レビュー編集開始:', reviewId);
            
            // 現在のレビューコンテンツ要素を取得
            const contentElement = document.getElementById(`review-content-${reviewId}`);
            if (!contentElement) {
                console.error('レビューコンテンツ要素が見つかりません:', reviewId);
                return;
            }
            
            // 編集フォームに置き換え
            const editFormHTML = `
                <div class="review-edit-form">
                    <textarea 
                        id="edit-textarea-${reviewId}"
                        class="review-textarea"
                        maxlength="2000"
                        placeholder="感想を編集してください..."
                        oninput="updateEditCharCount(${reviewId})"
                    >${currentContent}</textarea>
                    <div class="review-form-footer">
                        <span class="char-count" id="edit-char-count-${reviewId}">残り: ${2000 - currentContent.length}文字</span>
                        <div class="review-form-buttons">
                            <button class="btn-cancel" onclick="cancelEditReview(${reviewId}, '${currentContent.replace(/'/g, "\\'")}')">キャンセル</button>
                            <button class="btn-submit" onclick="saveEditReview(${reviewId})">保存</button>
                            <button class="btn-delete" onclick="confirmDeleteFromEdit(${reviewId})">削除</button>
                        </div>
                    </div>
                </div>
            `;
            
            contentElement.innerHTML = editFormHTML;
            
            // テキストエリアにフォーカス
            const textarea = document.getElementById(`edit-textarea-${reviewId}`);
            if (textarea) {
                textarea.focus();
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }
        }

        // 編集キャンセル
        function cancelEditReview(reviewId, originalContent) {
            const contentElement = document.getElementById(`review-content-${reviewId}`);
            if (contentElement) {
                contentElement.innerHTML = escapeHtml(originalContent);
            }
        }

        // 編集時の文字数カウント更新
        function updateEditCharCount(reviewId) {
            const textarea = document.getElementById(`edit-textarea-${reviewId}`);
            const charCount = document.getElementById(`edit-char-count-${reviewId}`);
            
            if (textarea && charCount) {
                const remaining = 2000 - textarea.value.length;
                charCount.textContent = `残り: ${remaining}文字`;
                charCount.style.color = remaining < 100 ? '#ef4444' : remaining < 300 ? '#f59e0b' : '#6b7280';
            }
        }

        // レビュー保存（編集）
        async function saveEditReview(reviewId) {
            const textarea = document.getElementById(`edit-textarea-${reviewId}`);
            const currentUserEmail = getCurrentUser();
            
            if (!currentUserEmail) {
                alert('ユーザー認証が必要です。再度ログインしてください。');
                return;
            }
            
            if (!textarea) {
                console.error('編集テキストエリアが見つかりません');
                return;
            }
            
            const newContent = textarea.value.trim();
            if (!newContent) {
                alert('感想を入力してください');
                return;
            }
            
            if (newContent.length > 2000) {
                alert('感想は2000文字以内で入力してください');
                return;
            }
            
            try {
                // ボタンを無効化
                const saveBtn = textarea.parentElement.querySelector('.btn-submit');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = '保存中...';
                }
                
                console.log('💾 レビュー更新開始:', reviewId);
                
                // Supabaseでレビューを更新
                const { error } = await supabaseClient
                    .from('reviews')
                    .update({
                        content: newContent,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', reviewId)
                    .eq('user_email', currentUserEmail); // セキュリティ: 所有者のみ更新可能
                
                if (error) {
                    console.error('レビュー更新エラー:', error);
                    alert('レビューの更新に失敗しました。もう一度お試しください。');
                    return;
                }
                
                console.log('✅ レビュー更新成功:', reviewId);
                alert('感想を更新しました！');
                
                // レビュー表示を更新
                const storeId = getCurrentStoreId();
                if (storeId) {
                    await refreshStoreReviews(storeId);
                }
                
            } catch (error) {
                console.error('レビュー更新例外:', error);
                alert('更新中にエラーが発生しました');
            }
        }

        // レビュー削除機能
        async function deleteReview(reviewId) {
            if (!confirm('この感想を削除してもよろしいですか？\n削除した感想は復元できません。')) {
                return;
            }
            
            const currentUserEmail = getCurrentUser();
            
            if (!currentUserEmail) {
                alert('ユーザー認証が必要です。再度ログインしてください。');
                return;
            }
            
            try {
                console.log('🗑️ レビュー削除開始:', reviewId);
                
                // Supabaseでレビューを論理削除
                const { error } = await supabaseClient
                    .from('reviews')
                    .update({
                        is_deleted: true,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', reviewId)
                    .eq('user_email', currentUserEmail); // セキュリティ: 所有者のみ削除可能
                
                if (error) {
                    console.error('レビュー削除エラー:', error);
                    alert('レビューの削除に失敗しました。もう一度お試しください。');
                    return;
                }
                
                console.log('✅ レビュー削除成功:', reviewId);
                alert('感想を削除しました');
                
                // レビュー表示を更新
                const storeId = getCurrentStoreId();
                if (storeId) {
                    await refreshStoreReviews(storeId);
                }
                
            } catch (error) {
                console.error('レビュー削除例外:', error);
                alert('削除中にエラーが発生しました');
            }
        }

        // 編集画面からの削除確認
        async function confirmDeleteFromEdit(reviewId) {
            if (!confirm('この感想を削除してもよろしいですか？\n削除した感想は復元できません。')) {
                return;
            }
            
            const currentUserEmail = getCurrentUser();
            
            if (!currentUserEmail) {
                alert('ユーザー認証が必要です。再度ログインしてください。');
                return;
            }
            
            try {
                console.log('🗑️ 編集画面からレビュー削除開始:', reviewId);
                
                // Supabaseでレビューを論理削除
                const { error } = await supabaseClient
                    .from('reviews')
                    .update({
                        is_deleted: true,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', reviewId)
                    .eq('user_email', currentUserEmail); // セキュリティ: 所有者のみ削除可能
                
                if (error) {
                    console.error('レビュー削除エラー:', error);
                    alert('レビューの削除に失敗しました。もう一度お試しください。');
                    return;
                }
                
                console.log('✅ 編集画面からレビュー削除成功:', reviewId);
                alert('感想を削除しました');
                
                // レビュー表示を更新
                const storeId = getCurrentStoreId();
                if (storeId) {
                    await refreshStoreReviews(storeId);
                }
                
            } catch (error) {
                console.error('編集画面からレビュー削除例外:', error);
                alert('削除中にエラーが発生しました');
            }
        }

        // 現在表示中の店舗IDを取得するヘルパー関数
        function getCurrentStoreId() {
            // URL fragment やモーダルから店舗IDを取得
            const modal = document.querySelector('.store-detail-modal, .store-detail-fullscreen');
            if (modal) {
                // レビューコンテナから店舗IDを推測
                const reviewForm = modal.querySelector('.review-form-container');
                if (reviewForm) {
                    const submitBtn = reviewForm.querySelector('.btn-submit[onclick*="submitReview"]');
                    if (submitBtn) {
                        const match = submitBtn.getAttribute('onclick').match(/submitReview\((\d+)\)/);
                        return match ? parseInt(match[1]) : null;
                    }
                }
            }
            return null;
        }

        // ===========================================
        // レベル1 画像拡大表示機能
        // ===========================================
        
        // 画像モーダルを表示
        function showImageModal(imageSrc, storeName, storeAddress) {
            // モーダルHTML構造を作成
            const modalHTML = `
                <div class="image-modal" id="imageModal" onclick="closeImageModal()">
                    <div class="image-modal-content" onclick="event.stopPropagation()">
                        <div class="image-modal-header">
                            <button class="image-modal-close" onclick="closeImageModal()" ontouchend="closeImageModal()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="image-modal-body">
                            <img src="${imageSrc}" alt="${storeName}" class="image-modal-img" />
                        </div>
                        <div class="image-modal-info">
                            <div class="image-modal-store-name">${storeName}</div>
                            <div class="image-modal-store-address">${storeAddress}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // DOMに追加
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // アニメーション開始
            const modal = document.getElementById('imageModal');
            requestAnimationFrame(() => {
                modal.classList.add('active');
            });
            
            // スマホでのボディスクロールを無効化
            document.body.style.overflow = 'hidden';
            
            // ESCキーで閉じる
            document.addEventListener('keydown', escapeHandler);
        }
        
        // 画像モーダルを閉じる
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.classList.remove('active');
                
                // アニメーション完了後にDOMから削除
                setTimeout(() => {
                    if (modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                }, 300);
            }
            
            // ボディスクロールを復元
            document.body.style.overflow = '';
            
            // ESCキーハンドラーを削除
            document.removeEventListener('keydown', escapeHandler);
        }
        
        // ESCキー処理
        function escapeHandler(event) {
            if (event.key === 'Escape') {
                closeImageModal();
            }
        }
        
        // 店舗画像をクリック可能にする（既存の画像に適用）
        function makeStoreImagesClickable() {
            // 店舗詳細の画像を取得
            const storeImages = document.querySelectorAll('.store-image, .store-detail-image, .store-detail-content img');
            
            storeImages.forEach(img => {
                // 既にクリック可能な場合はスキップ
                if (img.classList.contains('clickable-image')) {
                    return;
                }
                
                // クリック可能にマーク
                img.classList.add('clickable-image');
                
                // クリック・タッチイベントを追加
                const handleImageClick = function(e) {
                    e.preventDefault(); // デフォルトの画像保存などを防ぐ
                    
                    // 店舗情報を取得
                    const storeContainer = img.closest('.store-detail-modal, .store-detail-fullscreen, .store-item');
                    let storeName = '店舗画像';
                    let storeAddress = '';
                    
                    if (storeContainer) {
                        const nameElement = storeContainer.querySelector('.store-name, .store-detail-name, h3');
                        const addressElement = storeContainer.querySelector('.store-address, .store-detail-address');
                        
                        if (nameElement) {
                            storeName = nameElement.textContent.trim();
                        }
                        if (addressElement) {
                            storeAddress = addressElement.textContent.trim();
                        }
                    }
                    
                    // 画像モーダルを表示
                    showImageModal(img.src, storeName, storeAddress);
                };
                
                img.addEventListener('click', handleImageClick);
                img.addEventListener('touchend', handleImageClick); // タッチデバイス対応
                
                // ホバーエフェクトのスタイルを追加
                img.style.cursor = 'pointer';
            });
        }
        
        // ページ読み込み時に実行
        document.addEventListener('DOMContentLoaded', function() {
            makeStoreImagesClickable();
        });
        
        // 動的に追加される店舗詳細モーダルの画像も対応
        const originalShowStoreDetail = window.showStoreDetail;
        if (originalShowStoreDetail) {
            window.showStoreDetail = function(storeId) {
                const result = originalShowStoreDetail.apply(this, arguments);
                
                // モーダル表示後に画像をクリック可能にする
                setTimeout(() => {
                    makeStoreImagesClickable();
                }, 100);
                
                return result;
            };
        }

        // ESCキーでプロフィール画面を閉じる
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const profileModal = document.getElementById('profileModalOverlay');
                if (profileModal.classList.contains('active')) {
                    closeProfileModal();
                }
            }
        });
    </script>

    <!-- サイドメニュー -->
    <div class="side-menu-overlay" id="sideMenuOverlay" onclick="closeSideMenu()">
        <div class="side-menu" onclick="event.stopPropagation()">
            <div class="side-menu-header">
                <div class="side-menu-title">マイページ</div>
                <div class="side-menu-subtitle">ビヨグル倶楽部</div>
            </div>
            <div class="side-menu-content">
                <div class="menu-item" onclick="showProfile()">
                    <div class="menu-item-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="menu-item-text">プロフィール</div>
                    <div class="menu-item-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                
                <div class="menu-item" onclick="showMyStats()">
                    <div class="menu-item-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="menu-item-text">マイ統計</div>
                    <div class="menu-item-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                
                <div class="menu-item" onclick="console.log('🖱️ マイレビューがクリックされました'); showMyReviews();">
                    <div class="menu-item-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="menu-item-text">マイレビュー</div>
                    <div class="menu-item-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                
                <div class="menu-separator"></div>
                
                <div class="menu-item" onclick="showAppInfo()">
                    <div class="menu-item-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="menu-item-text">アプリについて</div>
                    <div class="menu-item-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
                
                <div class="menu-separator"></div>
                
                <div class="menu-item logout" onclick="handleLogout()">
                    <div class="menu-item-icon">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <div class="menu-item-text">ログアウト</div>
                </div>
            </div>
        </div>
    </div>

    <!-- プロフィール設定画面 -->
    <div class="profile-modal-overlay" id="profileModalOverlay" onclick="closeProfileModal()">
        <div class="profile-modal" onclick="event.stopPropagation()">
            <div class="profile-modal-header">
                <div class="profile-modal-title">
                    <i class="fas fa-user"></i>
                    プロフィール設定
                </div>
                <button class="profile-close-btn" onclick="closeProfileModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="profile-section">
                <div class="profile-section-title">
                    <i class="fas fa-signature"></i>
                    ニックネーム
                </div>
                <div class="profile-input-group">
                    <label class="profile-label">表示名（20文字以内）</label>
                    <input type="text" id="nicknameInput" class="profile-input" placeholder="素敵なニックネームを入力してください" maxlength="20">
                </div>
            </div>

            <div class="profile-section">
                <div class="profile-section-title">
                    <i class="fas fa-smile"></i>
                    アバター
                </div>
                
                <!-- アバター選択タブ -->
                <div class="avatar-tabs">
                    <button class="avatar-tab active" onclick="showAvatarTab('preset')">
                        <i class="fas fa-smile"></i> プリセット
                    </button>
                    <button class="avatar-tab" onclick="showAvatarTab('upload')">
                        <i class="fas fa-upload"></i> 画像アップロード
                    </button>
                </div>
                
                <!-- プリセットアバター -->
                <div class="avatar-content" id="presetAvatars">
                    <div class="avatar-grid" id="avatarGrid">
                        <!-- JavaScriptで動的生成 -->
                    </div>
                </div>
                
                <!-- 画像アップロード -->
                <div class="avatar-content" id="uploadAvatar" style="display: none;">
                    <div class="upload-section">
                        <div class="current-avatar" id="currentAvatarPreview">
                            <img id="currentAvatarImage" src="" alt="現在のアバター" style="display: none;">
                            <div id="currentAvatarPlaceholder">現在のアバター画像はありません</div>
                        </div>
                        
                        <div class="upload-area" onclick="document.getElementById('avatarFileInput').click()">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>クリックして画像を選択</p>
                            <p class="upload-hint">JPG, PNG, GIF (最大500KB)</p>
                        </div>
                        
                        <input type="file" id="avatarFileInput" accept="image/*" style="display: none;">
                        
                        <div class="preview-section" id="previewSection" style="display: none;">
                            <h4>プレビュー</h4>
                            <img id="previewImage" alt="プレビュー">
                            <p id="fileInfo"></p>
                            <button class="upload-btn" id="uploadBtn" onclick="uploadAvatar()">
                                <i class="fas fa-upload"></i> アップロード
                            </button>
                        </div>
                        
                        <div class="upload-status" id="uploadStatus"></div>
                    </div>
                </div>
            </div>

            <button class="profile-save-btn" onclick="saveProfile()">
                <i class="fas fa-save"></i>
                保存する
            </button>
        </div>
    </div>

</body>
</html>