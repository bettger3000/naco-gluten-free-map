<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Ç∞„É´„ÉÜ„É≥„Éï„É™„Éº„Éû„ÉÉ„Éó | naco's community</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, 'Hiragino Sans', sans-serif;
            background: #fef5f5;
            color: #333;
        }
        
        /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #ffc0cb 0%, #ffb6c1 50%, #ffd1dc 100%);
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 25px;
            padding: 40px 30px;
            max-width: 380px;
            width: 100%;
            text-align: center;
            box-shadow: 0 15px 35px rgba(255,182,193,0.3);
        }
        
        .login-logo {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .login-title {
            font-size: 1.8rem;
            color: #d63384;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .login-subtitle {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 30px;
        }
        
        .email-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #ffd1dc;
            border-radius: 30px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .email-input:focus {
            outline: none;
            border-color: #ffb6c1;
            box-shadow: 0 0 0 3px rgba(255,182,193,0.2);
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255,105,180,0.3);
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,105,180,0.4);
        }
        
        .error-msg {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 15px;
            display: none;
        }
        
        /* „É°„Ç§„É≥„Ç¢„Éó„É™ */
        .app-container {
            display: none;
            height: 100vh;
            overflow: hidden;
        }
        
        /* „Éò„ÉÉ„ÉÄ„Éº */
        .app-header {
            background: white;
            padding: 12px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-logo {
            font-size: 1.5rem;
            color: #d63384;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-email {
            color: #666;
            font-size: 0.85rem;
            display: none;
        }
        
        @media (min-width: 768px) {
            .user-email {
                display: block;
            }
        }
        
        .menu-btn {
            padding: 8px;
            background: #fff;
            border: 2px solid #ffd1dc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .menu-btn:hover {
            background: #ffd1dc;
        }
        
        /* Ê§úÁ¥¢„Éê„Éº */
        .search-section {
            background: white;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .search-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            border: 2px solid #ffd1dc;
            border-radius: 25px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #ffb6c1;
            box-shadow: 0 0 0 3px rgba(255,182,193,0.2);
        }
        
        .search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: #ff69b4;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            color: white;
            font-size: 1.1rem;
        }
        
        /* „Éï„Ç£„É´„Çø„Éº„Çø„Éñ */
        .filter-tabs {
            display: flex;
            gap: 10px;
            padding: 10px 15px;
            background: white;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .filter-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .filter-chip {
            padding: 8px 16px;
            background: white;
            border: 2px solid #ffd1dc;
            border-radius: 20px;
            white-space: nowrap;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        
        .filter-chip.active {
            background: #ff69b4;
            color: white;
            border-color: #ff69b4;
        }
        
        /* „Éû„ÉÉ„Éó„Ç≥„É≥„ÉÜ„Éä */
        .map-container {
            position: relative;
            height: calc(100vh - 220px);
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        /* ÁèæÂú®Âú∞„Éú„Çø„É≥ */
        .location-btn {
            position: absolute;
            bottom: 100px;
            right: 15px;
            background: white;
            border: 2px solid #ff69b4;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 999;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* „Éú„Éà„É†„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #f0f0f0;
            padding: 8px 0;
            display: flex;
            justify-content: space-around;
            z-index: 1000;
        }
        
        .nav-item {
            background: none;
            border: none;
            padding: 8px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: #999;
        }
        
        .nav-item.active {
            color: #ff69b4;
        }
        
        .nav-icon {
            font-size: 1.3rem;
        }
        
        .nav-label {
            font-size: 0.75rem;
        }
        
        /* Â∫óËàóË©≥Á¥∞„É¢„Éº„ÉÄ„É´ */
        .store-modal {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 25px 25px 0 0;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 2000;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .store-modal.active {
            transform: translateY(0);
        }
        
        .modal-handle {
            width: 40px;
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 0 auto 20px;
        }
        
        .store-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .store-title {
            font-size: 1.3rem;
            color: #333;
            font-weight: 600;
        }
        
        .store-category {
            display: inline-block;
            padding: 4px 12px;
            background: #ffd1dc;
            color: #d63384;
            border-radius: 15px;
            font-size: 0.85rem;
            margin-top: 8px;
        }
        
        .store-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ffd1dc;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .action-btn.active {
            background: #ff69b4;
            color: white;
            border-color: #ff69b4;
        }
        
        .action-btn:hover {
            background: #ffd1dc;
        }
        
        /* „É¨„Éì„É•„Éº„Çª„ÇØ„Ç∑„Éß„É≥ */
        .review-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .review-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .add-review-btn {
            padding: 8px 16px;
            background: #ff69b4;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .review-form {
            display: none;
            margin-bottom: 20px;
            padding: 15px;
            background: #fef5f5;
            border-radius: 15px;
        }
        
        .review-form.active {
            display: block;
        }
        
        .review-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffd1dc;
            border-radius: 10px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }
        
        .review-submit {
            padding: 10px 20px;
            background: #ff69b4;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .review-item {
            padding: 12px;
            background: #fef5f5;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .review-author {
            font-weight: 600;
            color: #d63384;
            font-size: 0.9rem;
        }
        
        .review-date {
            color: #999;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .review-text {
            margin-top: 8px;
            line-height: 1.5;
        }
        
        /* „Çµ„Ç§„Éâ„É°„Éã„É•„Éº */
        .side-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 280px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s;
            z-index: 3000;
            overflow-y: auto;
        }
        
        .side-menu.active {
            right: 0;
        }
        
        .menu-header {
            padding: 20px;
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: white;
        }
        
        .menu-title {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .menu-email {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .menu-items {
            padding: 20px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            font-size: 0.95rem;
        }
        
        .menu-item:hover {
            background: #ffd1dc;
        }
        
        .menu-icon {
            font-size: 1.2rem;
        }
        
        /* „Ç™„Éº„Éê„Éº„É¨„Ç§ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 2500;
        }
        
        .overlay.active {
            display: block;
        }
        
        /* „É™„Çπ„Éà„Éì„É•„Éº */
        .list-view {
            display: none;
            height: calc(100vh - 220px);
            overflow-y: auto;
            padding: 15px;
            background: #fef5f5;
        }
        
        .list-view.active {
            display: block;
        }
        
        .store-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .store-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-logo">üå∏</div>
            <h1 class="login-title">Gluten Free Map</h1>
            <p class="login-subtitle">naco's community members only</p>
            <input type="email" id="emailInput" class="email-input" placeholder="ÁôªÈå≤Ê∏à„Åø„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ">
            <button onclick="login()" class="login-btn">„É≠„Ç∞„Ç§„É≥</button>
            <p id="errorMsg" class="error-msg">„Åì„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÅØÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
        </div>
    </div>
    
    <!-- „É°„Ç§„É≥„Ç¢„Éó„É™ -->
    <div id="app" class="app-container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="app-header">
            <div class="header-content">
                <div class="app-logo">
                    <span>üå∏</span>
                    <span>GF Map</span>
                </div>
                <div class="user-menu">
                    <span id="userEmail" class="user-email"></span>
                    <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
                </div>
            </div>
        </header>
        
        <!-- Ê§úÁ¥¢„Éê„Éº -->
        <div class="search-section">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Â∫óÂêç„Éª„Ç®„É™„Ç¢„ÅßÊ§úÁ¥¢">
                <button class="search-btn" onclick="search()">üîç</button>
            </div>
        </div>
        
        <!-- „Éï„Ç£„É´„Çø„Éº„Çø„Éñ -->
        <div class="filter-tabs">
            <button class="filter-chip active" onclick="filterCategory('all')">„Åô„Åπ„Å¶</button>
            <button class="filter-chip" onclick="filterCategory('„Ç´„Éï„Çß')">‚òï „Ç´„Éï„Çß</button>
            <button class="filter-chip" onclick="filterCategory('„É¨„Çπ„Éà„É©„É≥')">üçΩÔ∏è „É¨„Çπ„Éà„É©„É≥</button>
            <button class="filter-chip" onclick="filterCategory('„Éë„É≥Â±ã')">ü•ê „Éë„É≥Â±ã</button>
            <button class="filter-chip" onclick="filterCategory('„Çπ„Ç§„Éº„ÉÑ')">üßÅ „Çπ„Ç§„Éº„ÉÑ</button>
            <button class="filter-chip" onclick="filterCategory('Ë≤©Â£≤Â∫ó')">üõí Ë≤©Â£≤Â∫ó</button>
        </div>
        
        <!-- „Éû„ÉÉ„Éó -->
        <div class="map-container">
            <div id="map"></div>
            <button class="location-btn" onclick="getCurrentLocation()">üìç</button>
        </div>
        
        <!-- „É™„Çπ„Éà„Éì„É•„Éº -->
        <div id="listView" class="list-view">
            <div id="storeList"></div>
        </div>
        
        <!-- „Éú„Éà„É†„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="showView('map')">
                <span class="nav-icon">üó∫Ô∏è</span>
                <span class="nav-label">„Éû„ÉÉ„Éó</span>
            </button>
            <button class="nav-item" onclick="showView('list')">
                <span class="nav-icon">üìã</span>
                <span class="nav-label">„É™„Çπ„Éà</span>
            </button>
            <button class="nav-item" onclick="showView('want')">
                <span class="nav-icon">üíù</span>
                <span class="nav-label">Ë°å„Åç„Åü„ÅÑ</span>
            </button>
            <button class="nav-item" onclick="showView('visited')">
                <span class="nav-icon">‚úÖ</span>
                <span class="nav-label">Ë°å„Å£„Åü</span>
            </button>
        </nav>
        
        <!-- Â∫óËàóË©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
        <div id="storeModal" class="store-modal">
            <div class="modal-handle"></div>
            <div id="modalContent"></div>
        </div>
        
        <!-- „Çµ„Ç§„Éâ„É°„Éã„É•„Éº -->
        <div id="sideMenu" class="side-menu">
            <div class="menu-header">
                <div class="menu-title">„É°„Éã„É•„Éº</div>
                <div id="menuEmail" class="menu-email"></div>
            </div>
            <div class="menu-items">
                <button class="menu-item" onclick="showMyData()">
                    <span class="menu-icon">üìä</span>
                    <span>„Éû„Ç§„Éá„Éº„Çø</span>
                </button>
                <button class="menu-item" onclick="exportData()">
                    <span class="menu-icon">üíæ</span>
                    <span>„Éá„Éº„Çø‰øùÂ≠ò</span>
                </button>
                <button class="menu-item" onclick="importData()">
                    <span class="menu-icon">üì•</span>
                    <span>„Éá„Éº„ÇøË™≠Ëæº</span>
                </button>
                <button class="menu-item" onclick="logout()">
                    <span class="menu-icon">üëã</span>
                    <span>„É≠„Ç∞„Ç¢„Ç¶„Éà</span>
                </button>
            </div>
        </div>
        
        <!-- „Ç™„Éº„Éê„Éº„É¨„Ç§ -->
        <div id="overlay" class="overlay" onclick="closeMenu()"></div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ÊâøË™çÊ∏à„Åø„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ
        const AUTHORIZED_EMAILS = [
            'test@example.com',  // „ÉÜ„Çπ„ÉàÁî®
            // „Åì„Åì„Å´ÂÆüÈöõ„ÅÆ„É°„É≥„Éê„Éº„ÅÆ„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„ÇíËøΩÂä†
        ];
        
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let map;
        let currentUser = null;
        let markers = [];
        let stores = [];
        let userData = {
            wantToGo: [],
            visited: [],
            reviews: {}
        };
        
        // Â∫óËàó„Éá„Éº„ÇøÔºàÂÖ®ÂõΩÁâà„Çµ„É≥„Éó„É´Ôºâ
        const sampleStores = [
            {
                id: 1,
                name: '„Ç∞„É´„ÉÜ„É≥„Éï„É™„Éº„Ç´„Éï„Çß Ê∏ãË∞∑',
                category: '„Ç´„Éï„Çß',
                area: 'Èñ¢Êù±',
                address: 'Êù±‰∫¨ÈÉΩÊ∏ãË∞∑Âå∫',
                lat: 35.6595,
                lng: 139.7004,
                description: 'ÂÆåÂÖ®„Ç∞„É´„ÉÜ„É≥„Éï„É™„Éº„ÅÆÂ∞ÇÈñÄ„Ç´„Éï„Çß'
            },
            {
                id: 2,
                name: 'Á±≥Á≤â„Éë„É≥Â∑•Êàø Â§ßÈò™',
                category: '„Éë„É≥Â±ã',
                area: 'Èñ¢Ë•ø',
                address: 'Â§ßÈò™Â∫úÂ§ßÈò™Â∏Ç',
                lat: 34.6937,
                lng: 135.5023,
                description: 'ÊØéÊó•ÁÑº„Åç„Åü„Å¶„ÅÆÁ±≥Á≤â„Éë„É≥'
            },
            {
                id: 3,
                name: '„Ç™„Éº„Ç¨„Éã„ÉÉ„ÇØ„É¨„Çπ„Éà„É©„É≥ ÂêçÂè§Â±ã',
                category: '„É¨„Çπ„Éà„É©„É≥',
                area: '‰∏≠ÈÉ®',
                address: 'ÊÑõÁü•ÁúåÂêçÂè§Â±ãÂ∏Ç',
                lat: 35.1815,
                lng: 136.9066,
                description: '„Ç∞„É´„ÉÜ„É≥„Éï„É™„Éº„É°„Éã„É•„ÉºË±äÂØå'
            },
            {
                id: 4,
                name: '„Çπ„Ç§„Éº„ÉÑ„Ç∑„Éß„ÉÉ„Éó Á¶èÂ≤°',
                category: '„Çπ„Ç§„Éº„ÉÑ',
                area: '‰πùÂ∑û',
                address: 'Á¶èÂ≤°ÁúåÁ¶èÂ≤°Â∏Ç',
                lat: 33.5904,
                lng: 130.4017,
                description: 'Á±≥Á≤â„Çπ„Ç§„Éº„ÉÑÂ∞ÇÈñÄÂ∫ó'
            },
            {
                id: 5,
                name: 'Ëá™ÁÑ∂È£üÂìÅÂ∫ó Êú≠Âπå',
                category: 'Ë≤©Â£≤Â∫ó',
                area: 'ÂåóÊµ∑ÈÅì',
                address: 'ÂåóÊµ∑ÈÅìÊú≠ÂπåÂ∏Ç',
                lat: 43.0642,
                lng: 141.3469,
                description: '„Ç∞„É´„ÉÜ„É≥„Éï„É™„ÉºÈ£üÊùêË±äÂØå'
            }
        ];
        
        // „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
        function login() {
            const email = document.getElementById('emailInput').value.trim();
            
            if (AUTHORIZED_EMAILS.includes(email)) {
                currentUser = email;
                localStorage.setItem('userEmail', email);
                loadUserData();
                showApp();
            } else {
                document.getElementById('errorMsg').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('errorMsg').style.display = 'none';
                }, 3000);
            }
        }
        
        // „Ç¢„Éó„É™Ë°®Á§∫
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('userEmail').textContent = currentUser;
            document.getElementById('menuEmail').textContent = currentUser;
            
            // „Éû„ÉÉ„ÉóÂàùÊúüÂåñ
            if (!map) {
                initMap();
            }
        }
        
        // „Éû„ÉÉ„ÉóÂàùÊúüÂåñ
        function initMap() {
            map = L.map('map').setView([35.6762, 139.6503], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Â∫óËàó„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
            stores = sampleStores;
            displayStores(stores);
        }
        
        // Â∫óËàóË°®Á§∫
        function displayStores(storeList) {
            // „Éû„Éº„Ç´„Éº„ÇØ„É™„Ç¢
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            storeList.forEach(store => {
                const isWant = userData.wantToGo.includes(store.id);
                const isVisited = userData.visited.includes(store.id);
                
                let color = '#ff69b4';  // „Éá„Éï„Ç©„É´„Éà
                if (isVisited) color = '#4CAF50';  // Ë°å„Å£„Åü
                else if (isWant) color = '#FFC107';  // Ë°å„Åç„Åü„ÅÑ
                
                const marker = L.circleMarker([store.lat, store.lng], {
                    radius: 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                marker.on('click', () => showStoreDetail(store));
                markers.push(marker);
            });
            
            // „É™„Çπ„Éà„Éì„É•„ÉºÊõ¥Êñ∞
            updateListView(storeList);
        }
        
        // Â∫óËàóË©≥Á¥∞Ë°®Á§∫
        function showStoreDetail(store) {
            const isWant = userData.wantToGo.includes(store.id);
            const isVisited = userData.visited.includes(store.id);
            const reviews = userData.reviews[store.id] || [];
            
            const modalContent = `
                <div class="store-header">
                    <div>
                        <h2 class="store-title">${store.name}</h2>
                        <span class="store-category">${store.category}</span>
                    </div>
                </div>
                <p>${store.address}</p>
                <p>${store.description}</p>
                
                <div class="store-actions">
                    <button class="action-btn ${isWant ? 'active' : ''}" onclick="toggleWant(${store.id})">
                        <span>üíù</span>
                        <span>Ë°å„Åç„Åü„ÅÑ</span>
                    </button>
                    <button class="action-btn ${isVisited ? 'active' : ''}" onclick="toggleVisited(${store.id})">
                        <span>‚úÖ</span>
                        <span>Ë°å„Å£„Åü</span>
                    </button>
                </div>
                
                <div class="review-section">
                    <div class="review-header">
                        <h3 class="review-title">„É¨„Éì„É•„Éº</h3>
                        <button class="add-review-btn" onclick="toggleReviewForm(${store.id})">„É¨„Éì„É•„Éº„ÇíÊõ∏„Åè</button>
                    </div>
                    
                    <div id="reviewForm${store.id}" class="review-form">
                        <textarea class="review-textarea" id="reviewText${store.id}" placeholder="ÊÑüÊÉ≥„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ"></textarea>
                        <button class="review-submit" onclick="submitReview(${store.id})">ÊäïÁ®ø</button>
                    </div>
                    
                    <div id="reviewList${store.id}">
                        ${reviews.map(r => `
                            <div class="review-item">
                                <span class="review-author">${r.author}</span>
                                <span class="review-date">${new Date(r.date).toLocaleDateString()}</span>
                                <p class="review-text">${r.text}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = modalContent;
            document.getElementById('storeModal').classList.add('active');
        }
        
        // Ë°å„Åç„Åü„ÅÑÂàá„ÇäÊõø„Åà
        function toggleWant(storeId) {
            const index = userData.wantToGo.indexOf(storeId);
            if (index > -1) {
                userData.wantToGo.splice(index, 1);
            } else {
                userData.wantToGo.push(storeId);
                // Ë°å„Å£„Åü„Åã„ÇâÂâäÈô§
                const visitedIndex = userData.visited.indexOf(storeId);
                if (visitedIndex > -1) {
                    userData.visited.splice(visitedIndex, 1);
                }
            }
            saveUserData();
            displayStores(stores);
            showStoreDetail(stores.find(s => s.id === storeId));
        }
        
        // Ë°å„Å£„ÅüÂàá„ÇäÊõø„Åà
        function toggleVisited(storeId) {
            const index = userData.visited.indexOf(storeId);
            if (index > -1) {
                userData.visited.splice(index, 1);
            } else {
                userData.visited.push(storeId);
                // Ë°å„Åç„Åü„ÅÑ„Åã„ÇâÂâäÈô§
                const wantIndex = userData.wantToGo.indexOf(storeId);
                if (wantIndex > -1) {
                    userData.wantToGo.splice(wantIndex, 1);
                }
            }
            saveUserData();
            displayStores(stores);
            showStoreDetail(stores.find(s => s.id === storeId));
        }
        
        // „É¨„Éì„É•„Éº„Éï„Ç©„Éº„É†Ë°®Á§∫Âàá„ÇäÊõø„Åà
        function toggleReviewForm(storeId) {
            const form = document.getElementById(`reviewForm${storeId}`);
            form.classList.toggle('active');
        }
        
        // „É¨„Éì„É•„ÉºÊäïÁ®ø
        function submitReview(storeId) {
            const text = document.getElementById(`reviewText${storeId}`).value;
            if (!text) return;
            
            if (!userData.reviews[storeId]) {
                userData.reviews[storeId] = [];
            }
            
            userData.reviews[storeId].push({
                author: currentUser.split('@')[0],
                date: new Date().toISOString(),
                text: text
            });
            
            saveUserData();
            showStoreDetail(stores.find(s => s.id === storeId));
        }
        
        // „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø‰øùÂ≠ò
        function saveUserData() {
            const key = `gfmap_${currentUser}`;
            localStorage.setItem(key, JSON.stringify(userData));
        }
        
        // „É¶„Éº„Ç∂„Éº„Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        function loadUserData() {
            const key = `gfmap_${currentUser}`;
            const saved = localStorage.getItem(key);
            if (saved) {
                userData = JSON.parse(saved);
            }
        }
        
        // „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
        function exportData() {
            const dataStr = JSON.stringify(userData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportName = `gfmap_${currentUser}_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportName);
            linkElement.click();
        }
        
        // „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        userData = JSON.parse(event.target.result);
                        saveUserData();
                        displayStores(stores);
                        alert('„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
                    } catch (err) {
                        alert('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // „Éì„É•„ÉºÂàá„ÇäÊõø„Åà
        function showView(view) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            const mapContainer = document.querySelector('.map-container');
            const listView = document.getElementById('listView');
            
            if (view === 'map') {
                mapContainer.style.display = 'block';
                listView.classList.remove('active');
                displayStores(stores);
            } else if (view === 'list') {
                mapContainer.style.display = 'none';
                listView.classList.add('active');
                displayStores(stores);
            } else if (view === 'want') {
                const wantStores = stores.filter(s => userData.wantToGo.includes(s.id));
                displayStores(wantStores);
            } else if (view === 'visited') {
                const visitedStores = stores.filter(s => userData.visited.includes(s.id));
                displayStores(visitedStores);
            }
        }
        
        // „É™„Çπ„Éà„Éì„É•„ÉºÊõ¥Êñ∞
        function updateListView(storeList) {
            const listHtml = storeList.map(store => `
                <div class="store-card" onclick="showStoreDetail(${JSON.stringify(store).replace(/"/g, '&quot;')})">
                    <h3>${store.name}</h3>
                    <span class="store-category">${store.category}</span>
                    <p>${store.address}</p>
                    <p>${store.description}</p>
                </div>
            `).join('');
            
            document.getElementById('storeList').innerHTML = listHtml;
        }
        
        // „É°„Éã„É•„ÉºÈñãÈñâ
        function toggleMenu() {
            document.getElementById('sideMenu').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }
        
        function closeMenu() {
            document.getElementById('sideMenu').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }
        
        // „Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø
        function filterCategory(category) {
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (category === 'all') {
                displayStores(stores);
            } else {
                const filtered = stores.filter(s => s.category === category);
                displayStores(filtered);
            }
        }
        
        // ÁèæÂú®Âú∞ÂèñÂæó
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 13);
                    
                    L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'current-location',
                            html: 'üìç',
                            iconSize: [30, 30]
                        })
                    }).addTo(map);
                });
            }
        }
        
        // „É≠„Ç∞„Ç¢„Ç¶„Éà
        function logout() {
            localStorage.removeItem('userEmail');
            location.reload();
        }
        
        // ÂàùÊúüÂåñ
        window.onload = function() {
            const savedEmail = localStorage.getItem('userEmail');
            if (savedEmail && AUTHORIZED_EMAILS.includes(savedEmail)) {
                currentUser = savedEmail;
                loadUserData();
                showApp();
            }
        };
    </script>
</body>
</html>