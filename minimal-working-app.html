<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Ç∞„É´„ÉÜ„É≥„Éï„É™„Éº„Éû„ÉÉ„Éó - Âãï‰ΩúÁ¢∫Ë™çÁâà</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Hiragino Sans', 'Yu Gothic UI', sans-serif;
            background: #f5f5f5;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-form {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 400px;
            text-align: center;
        }
        
        .app-title {
            color: #ff6b9d;
            font-size: 2rem;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin: 20px 0;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .login-btn {
            background: linear-gradient(45deg, #ff6b9d, #4ecdc4);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 20px 0;
        }
        
        .login-btn:hover {
            opacity: 0.9;
        }
        
        .error {
            color: #dc3545;
            margin: 10px 0;
        }
        
        .app-container {
            display: none;
            height: 100vh;
        }
        
        .header {
            background: #ff6b9d;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .content {
            display: flex;
            height: calc(100vh - 60px);
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }
        
        .map-container {
            flex: 1;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .store-card {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .store-card:hover {
            background: #f8f9fa;
        }
        
        .store-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .store-category {
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
    <div id="loginScreen" class="login-container">
        <div class="login-form">
            <h1 class="app-title">üç∞ „Ç∞„É´„ÉÜ„É≥„Éï„É™„Éº„Éû„ÉÉ„Éó</h1>
            <p style="margin-bottom: 30px; color: #666;">„Éì„É®„Ç∞„É™ÂÄ∂Ê•ΩÈÉ®</p>
            
            <div class="form-group">
                <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                <input type="email" id="email" value="bettger1000@gmail.com">
            </div>
            
            <div class="form-group">
                <label>PIN (4Ê°Å)</label>
                <input type="text" id="pin" value="1234" maxlength="4">
            </div>
            
            <button class="login-btn" onclick="login()">üîì „É≠„Ç∞„Ç§„É≥</button>
            
            <div id="error" class="error" style="display: none;"></div>
        </div>
    </div>
    
    <!-- „Ç¢„Éó„É™ÁîªÈù¢ -->
    <div id="appScreen" class="app-container">
        <div class="header">
            <h1>üç∞ „Ç∞„É´„ÉÜ„É≥„Éï„É™„Éº„Éû„ÉÉ„Éó</h1>
            <button onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
        </div>
        
        <div class="content">
            <div class="sidebar">
                <div style="padding: 20px; border-bottom: 1px solid #eee;">
                    <h3>Â∫óËàó„É™„Çπ„Éà <span id="storeCount">0</span>‰ª∂</h3>
                </div>
                <div id="storeList"></div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>
    
    <script>
        // SupabaseË®≠ÂÆö
        const SUPABASE_URL = 'https://hxrmsjfvgctoaxpbukvo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4cm1zamZ2Z2N0b2F4cGJ1a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MTI3NTAsImV4cCI6MjA3MDQ4ODc1MH0.tM1vDVVhYhh7OHlA1BTj071BfsIzeBG_HatijjtxwLw';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: false,
                autoRefreshToken: false
            }
        });
        
        let map;
        let currentUser = null;
        
        // Âüã„ÇÅËæº„ÅøÂ∫óËàó„Éá„Éº„ÇøÔºàÁ∞°Áï•ÁâàÔºâ
        const stores = [
            {
                id: 1,
                name: "„Åø„Å°„ÅÆ„ÇäÂºÅÂΩìÔºàGluten-Free Michinori BentoÔºâ",
                category: "ÂíåÈ£ü",
                address: "ÂêçÂè§Â±ãÂ∏ÇË•øÂå∫ÊµÑÂøÉÔºë‰∏ÅÁõÆÔºî‚àíÔºñ",
                latitude: 35.2040,
                longitude: 136.8922
            },
            {
                id: 2,
                name: "Gluten Free Bakery „Åü„Çì„ÅΩ„ÅΩ",
                category: "„Éë„É≥Â±ã",
                address: "ÂêçÂè§Â±ãÂ∏Ç‰∏≠Âå∫Èå¶‰∏â‰∏ÅÁõÆÔºë‚àíÔºì",
                latitude: 35.1685,
                longitude: 136.9062
            },
            {
                id: 3,
                name: "Ëá™ÁÑ∂È£ü„Ç´„Éï„Çß „Åø„Å©„Çä",
                category: "„Ç´„Éï„Çß",
                address: "ÂêçÂè§Â±ãÂ∏ÇÊù±Âå∫Ê≥âÔºë‰∏ÅÁõÆÔºí‚àíÔºì",
                latitude: 35.1794,
                longitude: 136.9186
            }
        ];
        
        // „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
        async function login() {
            const email = document.getElementById('email').value.trim();
            const pin = document.getElementById('pin').value.trim();
            const errorDiv = document.getElementById('error');
            
            errorDiv.style.display = 'none';
            
            if (!email || !pin) {
                showError('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Å®PIN„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            try {
                console.log('üîê PINË™çË®ºÈñãÂßã:', email);
                
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('email, nickname, is_active')
                    .eq('email', email.toLowerCase())
                    .eq('pin', pin)
                    .eq('is_active', true)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        showError('„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ„Åæ„Åü„ÅØPIN„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
                    } else {
                        showError('„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                        console.error('Ë™çË®º„Ç®„É©„Éº:', error);
                    }
                } else if (data) {
                    console.log('‚úÖ PINË™çË®ºÊàêÂäü:', data);
                    currentUser = data.email;
                    showApp();
                } else {
                    showError('Ë™çË®º„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (e) {
                console.error('Ë™çË®º„Ç®„É©„Éº:', e);
                showError('„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            }
        }
        
        // „Ç®„É©„ÉºË°®Á§∫
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        // „Ç¢„Éó„É™ÁîªÈù¢Ë°®Á§∫
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            
            initMap();
            displayStores();
        }
        
        // Âú∞Âõ≥ÂàùÊúüÂåñ
        function initMap() {
            if (map) return;
            
            map = L.map('map').setView([35.1815, 136.9066], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // „Éû„Éº„Ç´„ÉºËøΩÂä†
            stores.forEach(store => {
                if (store.latitude && store.longitude) {
                    const marker = L.marker([store.latitude, store.longitude])
                        .addTo(map)
                        .bindPopup(`<strong>${store.name}</strong><br>${store.category}<br>${store.address}`);
                }
            });
        }
        
        // Â∫óËàó„É™„Çπ„ÉàË°®Á§∫
        function displayStores() {
            const storeList = document.getElementById('storeList');
            const storeCount = document.getElementById('storeCount');
            
            storeCount.textContent = stores.length;
            
            storeList.innerHTML = stores.map(store => `
                <div class="store-card" onclick="focusStore(${store.id})">
                    <div class="store-name">${store.name}</div>
                    <div class="store-category">${store.category}</div>
                </div>
            `).join('');
        }
        
        // Â∫óËàó„Å´„Éï„Ç©„Éº„Ç´„Çπ
        function focusStore(storeId) {
            const store = stores.find(s => s.id === storeId);
            if (store && store.latitude && store.longitude) {
                map.setView([store.latitude, store.longitude], 16);
            }
        }
        
        // „É≠„Ç∞„Ç¢„Ç¶„Éà
        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appScreen').style.display = 'none';
            
            // „Éï„Ç©„Éº„É†„É™„Çª„ÉÉ„Éà
            document.getElementById('email').value = 'bettger1000@gmail.com';
            document.getElementById('pin').value = '1234';
            document.getElementById('error').style.display = 'none';
        }
        
        // Enter„Ç≠„Éº„Åß„É≠„Ç∞„Ç§„É≥
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('loginScreen').style.display !== 'none') {
                login();
            }
        });
    </script>
</body>
</html>