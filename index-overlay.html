<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>グルテンフリーマップ | ビヨフリ倶楽部</title>
    
    <!-- アイコン設定 -->
    <link rel="icon" type="image/png" href="nacoキャラクター.png">
    
    <!-- フォント -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary: #ff6b9d;
            --primary-dark: #e55a8a;
            --secondary: #40e0d0;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-glass: rgba(255, 255, 255, 0.9);
            
            --text-primary: #1a1a1a;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
            
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            
            --gradient-primary: linear-gradient(135deg, #ff6b9d 0%, #40e0d0 100%);
            --gradient-bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            
            --font-display: 'Inter', 'Noto Sans JP', sans-serif;
            --font-body: 'Noto Sans JP', 'Inter', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--gradient-bg);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* メインアプリ */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-light);
            padding: var(--space-md) var(--space-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .app-title {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            white-space: nowrap;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .app-title span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }
        
        /* モバイル対応でタイトルサイズ調整 */
        @media (max-width: 480px) {
            .app-title {
                font-size: 1.3rem;
            }
        }
        
        @media (max-width: 360px) {
            .app-title {
                font-size: 1.1rem;
            }
        }

        .title-icon {
            width: 50px;
            height: 50px;
            background: transparent;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: float 3s ease-in-out infinite;
        }
        
        .title-icon img {
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.1));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        /* 現在地マーカー用アニメーション */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.6; }
            100% { transform: scale(1); opacity: 1; }
        }

        .current-location-marker {
            animation: pulse 2s ease-in-out infinite;
        }

        /* 現在地マーカー二重円デザイン */
        .location-marker-container {
            position: relative;
            width: 44px;
            height: 44px;
            display: block !important;
        }

        .location-outer-circle {
            position: absolute;
            top: 0;
            left: 0;
            width: 44px;
            height: 44px;
            background: rgba(0, 122, 255, 0.2);
            border: 2px solid rgba(0, 122, 255, 0.4);
            border-radius: 50%;
            display: block;
        }

        .location-inner-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 18px;
            height: 18px;
            background: #007AFF;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.5);
            z-index: 10;
            display: block;
        }


        /* 検索とフィルター */
        .search-filter-container {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            padding: var(--space-md) var(--space-lg);
        }

        .search-filter-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: var(--space-lg);
            align-items: flex-start;
            flex-direction: column;
        }
        
        @media (min-width: 768px) {
            .search-filter-content {
                flex-direction: row;
                align-items: center;
            }
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }

        .filter-chips {
            display: flex;
            gap: var(--space-sm);
            overflow-x: auto;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding-bottom: var(--space-xs);
        }
        
        .filter-chips::-webkit-scrollbar {
            display: none;
        }

        .filter-chip {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            padding: var(--space-sm) var(--space-md);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .filter-chip:hover,
        .filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* メインコンテンツ */
        .main-content {
            flex: 1;
            display: flex;
            width: 100%;
            height: calc(100vh - 120px); /* ヘッダーと検索エリアを引く */
            position: relative;
        }


        .map-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
        }

        #map {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }

        .map-controls {
            position: absolute;
            top: var(--space-lg);
            left: var(--space-lg);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .map-control-btn {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: var(--radius-md);
            padding: var(--space-md);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
        }

        .map-control-btn:hover {
            background: var(--bg-primary);
            transform: translateY(-1px);
        }

        /* 店舗リスト */
        .store-sidebar {
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-secondary);
        }

        .sidebar-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }

        .sidebar-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .store-list {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-sm);
        }

        .store-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .store-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .store-card:hover,
        .store-card.selected {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        /* 店舗カード内のアクションボタン */
        .store-card-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-light);
        }
        
        .action-btn {
            flex: 1;
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            background: white;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
        }
        
        .action-btn:hover {
            background: var(--bg-secondary);
        }
        
        .action-btn.want-to-go {
            color: var(--primary);
            border-color: var(--primary);
        }
        
        .action-btn.visited {
            color: var(--success);
            border-color: var(--success);
        }
        
        .action-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .action-btn.visited.active {
            background: var(--success);
            border-color: var(--success);
        }

        .store-card:hover::before,
        .store-card.selected::before {
            transform: scaleY(1);
        }

        .store-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .store-header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--space-xs);
        }

        .store-distance {
            background: rgba(0, 122, 255, 0.1);
            color: #007AFF;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .store-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.4;
            flex: 1;
        }

        .store-category {
            color: white;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-xl);
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            margin-left: var(--space-sm);
        }

        /* カテゴリ別色設定（マップマーカーと統一） */
        .store-category[data-category="カフェ"] {
            background: #8B4513;
        }
        .store-category[data-category="和食"] {
            background: #E74C3C;
        }
        .store-category[data-category="洋食"] {
            background: #3498DB;
        }
        .store-category[data-category="パン屋"] {
            background: #F39C12;
        }
        .store-category[data-category="スイーツ"] {
            background: #E91E63;
        }
        .store-category[data-category="販売店"] {
            background: #27AE60;
        }
        .store-category[data-category="その他"] {
            background: #7F8C8D;
        }

        .store-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .store-address {
            color: var(--text-secondary);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .store-gf-type {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 0.875rem;
            color: var(--success);
            font-weight: 500;
        }

        .store-hours {
            color: var(--text-light);
            font-size: 0.8rem;
        }

        /* ポップアップスタイル */
        .popup-content {
            min-width: 250px;
        }

        .popup-header {
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-light);
        }

        .popup-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
        }

        .popup-category {
            background: var(--gradient-primary);
            color: white;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }

        .popup-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .popup-actions {
            margin-top: var(--space-md);
            padding-top: var(--space-md);
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: var(--space-sm);
        }

        .visit-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            padding: var(--space-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            background: white;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .visit-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-1px);
        }

        .visit-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .btn-icon {
            font-size: 1rem;
        }

        .popup-row {
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            font-size: 0.875rem;
        }

        .popup-icon {
            color: var(--text-light);
            min-width: 16px;
        }

        .popup-text {
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* カスタムマーカー */
        .custom-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: var(--shadow-md);
            font-size: 14px;
            font-weight: 600;
            color: white;
            transition: all 0.2s ease;
        }

        .custom-marker:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        /* リーフレットポップアップカスタム */
        .leaflet-popup-content-wrapper {
            border-radius: var(--radius-lg) !important;
            box-shadow: var(--shadow-xl) !important;
        }

        .leaflet-popup-content {
            margin: var(--space-lg) !important;
            font-family: var(--font-body) !important;
            line-height: 1.6 !important;
        }

        /* レスポンシブ */

        /* オーバーレイ式店舗リストパネル */
        .overlay-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top-left-radius: var(--radius-2xl);
            border-top-right-radius: var(--radius-2xl);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1100;
            transform: translateY(calc(100% - 60px));
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .overlay-panel.half-open {
            transform: translateY(50%);
        }
        
        .overlay-panel.full-open {
            transform: translateY(0);
        }
        
        .panel-handle {
            padding: var(--space-md) var(--space-lg);
            cursor: grab;
            touch-action: pan-y;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            border-top-left-radius: var(--radius-2xl);
            border-top-right-radius: var(--radius-2xl);
        }
        
        .panel-handle:active {
            cursor: grabbing;
        }
        
        .handle-bar {
            width: 40px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin-bottom: var(--space-sm);
        }
        
        .panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .panel-tabs {
            display: flex;
            gap: var(--space-md);
            padding: 0 var(--space-lg) var(--space-sm);
            border-bottom: 1px solid var(--border-light);
        }
        
        .panel-tab {
            padding: var(--space-sm) var(--space-md);
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
        }
        
        .panel-tab.active {
            color: var(--primary);
        }
        
        .panel-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-sm);
        }

        /* 訪問履歴ビュー */
        .visit-history-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1100;
            overflow-y: auto;
            padding-bottom: 80px; /* 底部導航の高さ分 */
        }

        .visit-history-view.hidden {
            display: none;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            background: var(--gradient-primary);
            color: white;
        }

        .history-count {
            background: rgba(255, 255, 255, 0.2);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
        }

        .history-list {
            padding: var(--space-md);
        }

        .history-item {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            margin-bottom: var(--space-md);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .history-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-sm);
        }

        .history-store-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .history-category {
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            color: white;
        }

        .history-address {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: var(--space-xs);
        }

        .history-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }

        .history-action-btn {
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            background: white;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-action-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: var(--space-md);
        }

        .empty-message {
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            .header-content {
                padding: 0 var(--space-lg);
            }

            .main-content {
                height: calc(100vh - 100px); /* モバイルではヘッダーの高さ調整 */
            }
            
            .search-filter-content {
                flex-direction: column;
                align-items: stretch;
                padding: 0 var(--space-lg);
            }
            
            .main-content {
                padding: var(--space-lg);
                gap: var(--space-lg);
            }
            
            .filter-chips {
                justify-content: center;
            }
        }

        .loading-indicator {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: var(--space-md);
            border-radius: var(--radius-md);
            margin: var(--space-md);
            text-align: center;
        }

        /* エレガントなマーカースタイル */
        .elegant-marker .marker-icon:hover {
            transform: scale(1.1) !important;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25) !important;
        }

        .elegant-marker .marker-container {
            cursor: pointer;
        }

        /* マーカーアニメーション */
        @keyframes markerPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .elegant-marker:hover .marker-icon {
            animation: markerPulse 0.6s ease-in-out;
        }

        /* モバイル対応のマーカーサイズ調整 */
        @media (max-width: 768px) {
            .elegant-marker .marker-icon {
                width: 36px !important;
                height: 36px !important;
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <!-- メインアプリ -->
    <div class="app-container">
        <!-- ヘッダー -->
        <header class="app-header">
            <div class="header-content">
                <div class="app-title">
                    <div class="title-icon">
                        <img src="nacoキャラクター.png" alt="naco" style="width: 50px; height: 50px; object-fit: contain; background: transparent;">
                    </div>
                    <span>グルテンフリーマップ</span>
                </div>
            </div>
        </header>

        <!-- 検索・フィルター -->
        <div class="search-filter-container">
            <div class="search-filter-content">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="店名・エリアで検索">
                </div>
                <div class="filter-chips">
                    <button class="filter-chip active" data-category="">すべて</button>
                    <button class="filter-chip" data-category="カフェ">☕ カフェ</button>
                    <button class="filter-chip" data-category="和食">🍱 和食</button>
                    <button class="filter-chip" data-category="洋食">🍽️ 洋食</button>
                    <button class="filter-chip" data-category="パン屋">🥐 パン屋</button>
                    <button class="filter-chip" data-category="スイーツ">🧁 スイーツ</button>
                    <button class="filter-chip" data-category="販売店">🛒 販売店</button>
                </div>
            </div>
        </div>

        <!-- メインコンテンツ -->
        <div class="main-content">
            <!-- マップ（全画面） -->
            <div class="map-container">
                <div class="map-controls">
                    <button class="map-control-btn" id="locateBtn" title="現在地を表示">📍</button>
                    <button class="map-control-btn" id="resetViewBtn" title="全体表示">🗾</button>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- オーバーレイ式店舗リストパネル -->
    <div id="overlayPanel" class="overlay-panel">
        <div class="panel-handle" id="panelHandle">
            <div class="handle-bar"></div>
            <div class="panel-title">
                <span>グルテンフリー店舗</span>
                <span id="panelStoreCount">全国62店舗</span>
            </div>
        </div>
        <div class="panel-tabs">
            <button class="panel-tab active" data-tab="all">すべて</button>
            <button class="panel-tab" data-tab="want-to-go">行きたい</button>
            <button class="panel-tab" data-tab="visited">行った</button>
        </div>
        <div class="panel-content" id="panelContent">
            <!-- 店舗リストがここに表示される -->
        </div>
    </div>


    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // Supabase設定 - 正しいプロジェクト情報
        const SUPABASE_URL = 'https://hxrmsjfvgctoaxpbukvo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4cm1zamZ2Z2N0b2F4cGJ1a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MTI3NTAsImV4cCI6MjA3MDQ4ODc1MH0.tM1vDVVhYhh7OHlA1BTj071BfsIzeBG_HatijjtxwLw';
        
        // Supabaseクライアント初期化
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // カテゴリー色
        const categoryColors = {
            'カフェ': '#8B4513',
            '和食': '#FF6347',
            '洋食': '#FF4500',
            'パン屋': '#DEB887',
            'スイーツ': '#FF69B4',
            '販売店': '#4169E1',
            'その他': '#666666'
        };

        // カテゴリークラス名生成
        function getCategoryClass(category) {
            const classMap = {
                'カフェ': 'cafe',
                '和食': 'japanese',
                '洋食': 'western',
                'パン屋': 'bakery',
                'スイーツ': 'sweets',
                '販売店': 'shop',
                'その他': 'other'
            };
            return classMap[category] || 'other';
        }

        // カテゴリー別デザイン設定（高コントラスト・視認性重視）
        const categoryConfig = {
            'カフェ': { 
                icon: 'fas fa-coffee', 
                color: '#FFFFFF',
                bgColor: '#8B4513',      // 濃いブラウン
                borderColor: '#5D2F0A'   // さらに濃いブラウン
            },
            '和食': { 
                icon: 'fas fa-utensils', 
                color: '#FFFFFF',
                bgColor: '#E74C3C',      // 鮮やかな赤
                borderColor: '#C0392B'   // 濃い赤
            },
            '洋食': { 
                icon: 'fas fa-pizza-slice', 
                color: '#FFFFFF',
                bgColor: '#3498DB',      // 鮮やかなブルー
                borderColor: '#2980B9'   // 濃いブルー
            },
            'パン屋': { 
                icon: 'fas fa-bread-slice', 
                color: '#FFFFFF',
                bgColor: '#F39C12',      // 鮮やかなオレンジ
                borderColor: '#E67E22'   // 濃いオレンジ
            },
            'スイーツ': { 
                icon: 'fas fa-birthday-cake', 
                color: '#FFFFFF',
                bgColor: '#E91E63',      // 鮮やかなピンク
                borderColor: '#C2185B'   // 濃いピンク
            },
            '販売店': { 
                icon: 'fas fa-store', 
                color: '#FFFFFF',
                bgColor: '#27AE60',      // 鮮やかなグリーン
                borderColor: '#229954'   // 濃いグリーン
            },
            'その他': { 
                icon: 'fas fa-store', 
                color: '#FFFFFF',
                bgColor: '#7F8C8D',      // グレー
                borderColor: '#5D6D6E'   // 濃いグレー
            }
        };

        // 後方互換性のため
        const categoryEmojis = Object.fromEntries(
            Object.entries(categoryConfig).map(([key, value]) => [key, value.icon])
        );

        // 🚀 埋め込み店舗データ（即座表示）
        const embeddedStores = [
          {
                    "id": 6,
                    "name": "みちのり弁当（Gluten-Free Michinori Bento）",
                    "category": "和食",
                    "address": "名古屋市西区浄心１丁目４−６",
                    "latitude": 35.1938,
                    "longitude": 136.8901,
                    "phone": "052-5086-615",
                    "website": "https://gf-michinori.jp/",
                    "description": "📍グルテンフリーのお弁当専門店です。\n     テイクアウトのみでご提供しております🍱\n\n     ご注文をいただいてからお作りいたしますので、\n     事前にお電話でご予約いただくと、スムーズにお渡しできます✨",
                    "gluten_free_options": "完全GF",
                    "opening_hours": "11時00分～19時00分"
          },
          {
                    "id": 7,
                    "name": "Biople 名古屋タカシマヤゲートタワーモール店",
                    "category": "販売店",
                    "address": "名古屋市中村区名駅１丁目１−３ JRゲートタワー タカシマヤ モール B1F",
                    "latitude": 35.1722,
                    "longitude": 136.882,
                    "phone": "052-5666-112",
                    "website": "https://store.biople.jp/",
                    "description": "ナチュラル＆オーガニックのセルフケアアイテムを幅広く取り扱うセレクトショップです。\n     グルテンフリーの珍しいお菓子など取り扱っています。\n     ・ZENB BREAD\n     ・グルテンフリーお菓子",
                    "gluten_free_options": "部分GF",
                    "opening_hours": "9時00分～21時00分"
          },
          {
                    "id": 8,
                    "name": "成城石井 名古屋駅広小路口店",
                    "category": "販売店",
                    "address": "名古屋市中村区名駅１丁目１−４ 名古屋うまいもん通り 広小路口",
                    "latitude": 35.1698,
                    "longitude": 136.8835,
                    "phone": "052-5872-345",
                    "website": "https://shop.seijoishii.co.jp/seijoishii/spot/detail?code=0035",
                    "description": "新鮮な野菜・果物、厳選された輸入チーズやワイン、自家製サンドイッチ・お惣\n     菜、パン、スイーツ、オーガニック商品、調味料や冷凍食品も充実しているスーパーマーケットです。",
                    "gluten_free_options": "部分GF",
                    "opening_hours": "7時30分～22時00分"
          },
          {
                    "id": 9,
                    "name": "成城石井 名古屋 近鉄パッセ店",
                    "category": "販売店",
                    "address": "名古屋市中村区名駅１丁目２−２ 近鉄パッセ B1F",
                    "latitude": 35.1695,
                    "longitude": 136.8842,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "部分GF",
                    "opening_hours": ""
          },
          {
                    "id": 10,
                    "name": "ダモンデ ミールシフォン＆スイーツ",
                    "category": "スイーツ",
                    "address": "名古屋市中区錦２丁目１１−２７ ＴＨ錦ビル 1F",
                    "latitude": 35.1711,
                    "longitude": 136.9001,
                    "phone": "052-2119-333",
                    "website": "https://da-monde.co.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-18:00"
          },
          {
                    "id": 11,
                    "name": "ライラック",
                    "category": "スイーツ",
                    "address": "名古屋市千種区東山通１丁目１５−２",
                    "latitude": 35.164,
                    "longitude": 136.9651,
                    "phone": "052-8877-818",
                    "website": "http://lilacs.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-19:00"
          },
          {
                    "id": 12,
                    "name": "エンキッチンカフェ",
                    "category": "洋食",
                    "address": "名古屋市中区大井町３−３１",
                    "latitude": 35.1507,
                    "longitude": 136.9053,
                    "phone": "052-8981-015",
                    "website": "http://en-kitchen.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:30-19:00"
          },
          {
                    "id": 13,
                    "name": "スギヤマ調剤薬局 御器所店",
                    "category": "販売店",
                    "address": "名古屋市昭和区阿由知通４丁目７",
                    "latitude": 35.149,
                    "longitude": 136.934,
                    "phone": "052-8422-112",
                    "website": "https://sugiyama-club.jp/shop/detail.asp?Seq=165",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "9:00-19:00,土曜のみ9:00-16:00"
          },
          {
                    "id": 14,
                    "name": "旬楽膳 名古屋・地アミ店",
                    "category": "販売店",
                    "address": "名古屋市名東区若葉台１４０２",
                    "latitude": 35.1787,
                    "longitude": 136.994,
                    "phone": "052-7603-071",
                    "website": "http://www.shun-rakuzen.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-20:00"
          },
          {
                    "id": 15,
                    "name": "コルポ",
                    "category": "洋食",
                    "address": "名古屋市中川区荒子１丁目１１６",
                    "latitude": 35.1416,
                    "longitude": 136.8603,
                    "phone": "052-3628-686",
                    "website": "https://cafe-corpo.owst.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-18:00"
          },
          {
                    "id": 16,
                    "name": "カルディコーヒーファーム 名古屋ゲートウォーク店",
                    "category": "販売店",
                    "address": "名古屋市中村区名駅１丁目１−２ ゲートウォーク B1F",
                    "latitude": 35.1743,
                    "longitude": 136.8836,
                    "phone": "052-5898-552",
                    "website": "https://www.kaldi.co.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-22:00"
          },
          {
                    "id": 17,
                    "name": "グルテンフリー 菓子屋 藤ノ宮",
                    "category": "販売店",
                    "address": "名古屋市中村区千原町４−５０",
                    "latitude": 35.1812,
                    "longitude": 136.8732,
                    "phone": "052-4517-584",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-19:00"
          },
          {
                    "id": 18,
                    "name": "グルテンフリー＆米粉ベーグル屋 はるのはな",
                    "category": "パン屋",
                    "address": "名古屋市千種区萱場２丁目１３−２２",
                    "latitude": 35.1824,
                    "longitude": 136.9452,
                    "phone": "",
                    "website": "https://haruno-hana.com/shop/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-15:00"
          },
          {
                    "id": 19,
                    "name": "I 'm donut？（アイムドーナツ？）グルテンフリー",
                    "category": "スイーツ",
                    "address": "東京都渋谷区神宮前５丁目５３−４",
                    "latitude": 35.6611,
                    "longitude": 139.7077,
                    "phone": "",
                    "website": "",
                    "description": "本物ドーナツそっくりのふわふわさでとてもよかったです！注文票に使用されてるアレルゲンが記載されてるの素敵だなと思います。",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-19:00"
          },
          {
                    "id": 20,
                    "name": "SO TARTE 代々木上原店",
                    "category": "カフェ",
                    "address": "東京都渋谷区上原１丁目１８−７ 第五大貴ビル",
                    "latitude": 35.6685,
                    "longitude": 139.6801,
                    "phone": "036-4079-260",
                    "website": "https://sotarte.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-18:00"
          },
          {
                    "id": 21,
                    "name": "EWALU -お米農家が営む完全グルテンフリー専門店-",
                    "category": "パン屋",
                    "address": "愛知県弥富市鯏浦町車東23−２",
                    "phone": "056-7973-200",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "8:00-17:00"
          },
          {
                    "id": 22,
                    "name": "pâtisserie Éclat de",
                    "category": "スイーツ",
                    "address": "兵庫県西宮市上甲子園１丁目３−１０",
                    "latitude": 34.7334,
                    "longitude": 135.3701,
                    "phone": "090-4190-1118",
                    "website": "https://eclat-de-sourire.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": ""
          },
          {
                    "id": 23,
                    "name": "グルテンフリーの⽶粉スイーツ専⾨店 HB Style KIYOKEN",
                    "category": "スイーツ",
                    "address": "神奈川県横浜市西区南幸１丁目１−１ CIAL横浜 B1",
                    "latitude": 35.4662,
                    "longitude": 139.6193,
                    "phone": "045-6208-600",
                    "website": "https://hb-style-kiyoken.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-21:00"
          },
          {
                    "id": 24,
                    "name": "米m BEIEMU 米粉スイーツ&おにぎり（グルテンフリー ）",
                    "category": "スイーツ",
                    "address": "沖縄県読谷村喜名２３４６−１１",
                    "latitude": 26.3929,
                    "longitude": 127.7436,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": ""
          },
          {
                    "id": 25,
                    "name": "F&F 自然食品のお店",
                    "category": "販売店",
                    "address": "東京都千代田区麹町４丁目１−３",
                    "latitude": 35.6837,
                    "longitude": 139.735,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": ""
          },
          {
                    "id": 26,
                    "name": "ペドラブランカ 戸越銀座店",
                    "category": "スイーツ",
                    "address": "東京都品川区平塚２丁目１４−８ 1F",
                    "latitude": 35.6213,
                    "longitude": 139.7151,
                    "phone": "",
                    "website": "https://pedrabranca-cafe.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-20:00"
          },
          {
                    "id": 27,
                    "name": "出町ふたば",
                    "category": "スイーツ",
                    "address": "京都府京都市上京区青龍町２３６",
                    "phone": "075-2311-658",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "8:30-17:30"
          },
          {
                    "id": 28,
                    "name": "SOT COFFEE ROASTER Kyoto",
                    "category": "カフェ",
                    "address": "京都府京都市東山区本町新５丁目１４８−２",
                    "latitude": 34.9917,
                    "longitude": 135.7669,
                    "phone": "080-0808-8288",
                    "website": "https://www.sotcoffee.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "8:00-18:00"
          },
          {
                    "id": 29,
                    "name": "NAYAMACHI DONUTS 君に、あげる",
                    "category": "カフェ",
                    "address": "京都府京都市伏見区中油掛町１０６−７",
                    "latitude": 34.9315,
                    "longitude": 135.7575,
                    "phone": "075-6061-134",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-19:00"
          },
          {
                    "id": 30,
                    "name": "宮古冷麺",
                    "category": "和食",
                    "address": "沖縄県宮古島市平良下里３３８−８",
                    "latitude": 24.8031,
                    "longitude": 125.2697,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-15:00"
          },
          {
                    "id": 31,
                    "name": "OLU OLU Crep",
                    "category": "スイーツ",
                    "address": "神奈川県相模原市中央区横山４丁目２３−２０ メゾン村山",
                    "latitude": 35.5662,
                    "longitude": 139.3561,
                    "phone": "042-7070-707",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-18:00"
          },
          {
                    "id": 32,
                    "name": "BEYOND SWEETS （ビヨンドスイーツ）カフェ 表参道店",
                    "category": "スイーツ",
                    "address": "東京都港区南青山３丁目１３−９",
                    "phone": "036-4340-936",
                    "website": "https://beyondsweets-shop-cafe.com/",
                    "description": "",
                    "gluten_free_options": "対応可能",
                    "opening_hours": "10:00-19:00"
          },
          {
                    "id": 33,
                    "name": "Creperiz Stand.Nagoya",
                    "category": "スイーツ",
                    "address": "名古屋市中区大須３丁目３０−２５ 合点承知ビル １階",
                    "latitude": 35.1602,
                    "longitude": 136.9084,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-20:00"
          },
          {
                    "id": 34,
                    "name": "みちのり亭",
                    "category": "和食",
                    "address": "名古屋市中村区椿町８−７−２F",
                    "latitude": 35.1695,
                    "longitude": 136.879,
                    "phone": "",
                    "website": "https://gf-michinori.jp/pages/michinori-tei",
                    "description": "グルテンフリーの定食屋",
                    "gluten_free_options": "完全GF",
                    "opening_hours": "11:00-15:00(LO14:00)  18:00-22:00(LO21::00"
          },
          {
                    "id": 35,
                    "name": "2525sweets",
                    "category": "スイーツ",
                    "address": "愛知県名古屋市中区新栄３丁目３−１ 太陽ビル １F",
                    "latitude": 35.1695,
                    "longitude": 136.9235,
                    "phone": "090-9250-3725",
                    "website": "https://2525sweets.base.shop/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "火水木11:00-17:30,金土11:00-18:00"
          },
          {
                    "id": 36,
                    "name": "甲賀米粉たい焼き 勝川店",
                    "category": "スイーツ",
                    "address": "愛知県春日井市松新町４丁目8−１",
                    "latitude": 35.231,
                    "longitude": 136.9568,
                    "phone": "090-4426-0940",
                    "website": "https://komeko.club/archives/shoplists/970",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-19:00"
          },
          {
                    "id": 37,
                    "name": "定食 笑いーと",
                    "category": "和食",
                    "address": "福島県いわき市好間町北好間南町田５５−１",
                    "latitude": 37.0766,
                    "longitude": 140.8651,
                    "phone": "070-8308-6994",
                    "website": "https://wara-eat.com/business/teishoku-wara-eat/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "6:00-15:00"
          },
          {
                    "id": 38,
                    "name": "titbit!(ティットビット)",
                    "category": "スイーツ",
                    "address": "名古屋市西区那古野１丁目１０−１７",
                    "latitude": 35.1771,
                    "longitude": 136.8887,
                    "phone": "052-5268-133",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-18:00"
          },
          {
                    "id": 39,
                    "name": "米粉の焼菓子 a\" (エーダブルプライム)",
                    "category": "スイーツ",
                    "address": "名古屋市昭和区北山本町２丁目１８",
                    "latitude": 35.1523,
                    "longitude": 136.9246,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-17:00"
          },
          {
                    "id": 40,
                    "name": "グルテンフリー食堂 おみやはん",
                    "category": "和食",
                    "address": "名古屋市守山区小幡太田３−３２",
                    "latitude": 35.1941,
                    "longitude": 136.9758,
                    "phone": "080-3548-5679",
                    "website": "https://www.omiyahan.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": ""
          },
          {
                    "id": 41,
                    "name": "genuine gluten free Where is a dog?",
                    "category": "カフェ",
                    "address": "東京都武蔵野市吉祥寺本町２丁目２４−９ SUNO Ecru 103",
                    "latitude": 35.7039,
                    "longitude": 139.5724,
                    "phone": "042-2272-812",
                    "website": "",
                    "description": "元々パンが大好きだったのでこうしてパンが食べられることができるのがとても幸せでした。",
                    "gluten_free_options": "",
                    "opening_hours": "月〜金　\t 12時00分～15時00分 17時00分～20時00分／土日\t 12時00分～20時00分"
          },
          {
                    "id": 42,
                    "name": "米ぱんの店ぱんて",
                    "category": "パン屋",
                    "address": "福井県福井市文京３丁目９−３４",
                    "latitude": 36.0766846,
                    "longitude": 136.2076805,
                    "phone": "776636781",
                    "website": "http://www.pante.jp/?mode=pc",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-19:00"
          },
          {
                    "id": 43,
                    "name": "グルテンフリーラーメン専門店 RYU-Gu 龍旗信",
                    "category": "和食",
                    "address": "大阪府堺市西区浜寺石津町西２丁７−６ ａｕ石津川",
                    "latitude": 34.562,
                    "longitude": 135.4503,
                    "phone": "",
                    "website": "http://www.ryukishin.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-14:30,17:30-20:45"
          },
          {
                    "id": 44,
                    "name": "月夜野こまもの店",
                    "category": "カフェ",
                    "address": "長野県上伊那郡辰野町辰野１６１５−３",
                    "latitude": 35.9826,
                    "longitude": 137.9938,
                    "phone": "070-7564-0768",
                    "website": "https://tsukikoma-tatsuno.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "日11:00-22:00,金11:00-18:00"
          },
          {
                    "id": 45,
                    "name": "縁-enishi-",
                    "category": "パン屋",
                    "address": "長野県長野市若里２丁目１−２３",
                    "latitude": 36.6342,
                    "longitude": 138.1864,
                    "phone": "026-4666-610",
                    "website": "https://enishi-sorghum.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "9:00-16:00"
          },
          {
                    "id": 46,
                    "name": "Buddha グルテンフリー & ヴィーガン専門店",
                    "category": "カフェ",
                    "address": "大阪府大阪市東成区中道１丁目８−１５ 金井ビル",
                    "latitude": 34.6778,
                    "longitude": 135.5337,
                    "phone": "066-7537-797",
                    "website": "https://buddha-online.site/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:30-15:30"
          },
          {
                    "id": 47,
                    "name": "where is my chou? 田町タワー店",
                    "category": "スイーツ",
                    "address": "東京都港区芝５丁目３３−１１ 田町タワ １－Ｆ",
                    "latitude": 35.6469,
                    "longitude": 139.7464,
                    "phone": "",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "月〜金11:00-19:00/土日11:00-18:00"
          },
          {
                    "id": 48,
                    "name": "米粉ヘルシーカフェ セレンペッシュ 心斎橋店",
                    "category": "カフェ",
                    "address": "大阪府大阪市中央区南船場２丁目４−２０ 大阪福谷ビル 1階",
                    "latitude": 34.6758,
                    "longitude": 135.5031,
                    "phone": "070-2424-3975",
                    "website": "https://seren-peche.owst.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "7:30-21:30"
          },
          {
                    "id": 49,
                    "name": "薬膳スパイスカレー＆グルテンフリーバルSpys Oasis",
                    "category": "洋食",
                    "address": "大阪府大阪市中央区難波１丁目５−８",
                    "latitude": 34.6675,
                    "longitude": 135.4993,
                    "phone": "066-2115-115",
                    "website": "http://spys-oasis.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "日11:30-22:00,月火水金土11:30-15:00,18:00-0:00"
          },
          {
                    "id": 50,
                    "name": "おやつ 創房優",
                    "category": "スイーツ",
                    "address": "岐阜県多治見市本町５丁目9−１ 陶都創造館 １階",
                    "latitude": 35.3347,
                    "longitude": 137.1284,
                    "phone": "",
                    "website": "https://www.soboyu-design.page/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-15:00"
          },
          {
                    "id": 51,
                    "name": "やまの ひつじ",
                    "category": "カフェ",
                    "address": "東京都渋谷区恵比寿西１丁目２６−２",
                    "latitude": 35.6478,
                    "longitude": 139.7032,
                    "phone": "080-4710-8870",
                    "website": "http://hitsuzi.chagasi.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:30-15:00"
          },
          {
                    "id": 52,
                    "name": "もんじゃ宝島",
                    "category": "和食",
                    "address": "東京都中央区月島３丁目５−４",
                    "latitude": 35.6633,
                    "longitude": 139.7784,
                    "phone": "033-5335-700",
                    "website": "https://rakukatsu.jp/tsukishima-monjya-takarajima-20210101/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "水木金17:00-22:30/ 土日12:00-16:00,17:00-22:00"
          },
          {
                    "id": 53,
                    "name": "MOCMO sandwiches (Gluten free sandwiches）",
                    "category": "パン屋",
                    "address": "東京都三鷹市下連雀１丁目１７−４ GRATO井の頭公園 1F",
                    "latitude": 35.7232,
                    "longitude": 139.5873,
                    "phone": "036-8208-795",
                    "website": "https://phoenix-since2018.com/food/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "月〜金11:00-17:00/土日9:00-17:00"
          },
          {
                    "id": 54,
                    "name": "ソラノイロ ARTISAN NOODLES",
                    "category": "和食",
                    "address": "東京都千代田区平河町１丁目３−１０ ブルービル本館 1B",
                    "latitude": 35.6831,
                    "longitude": 139.7369,
                    "phone": "033-2635-460",
                    "website": "http://soranoiro-vege.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-15:00,17:00-21:30"
          },
          {
                    "id": 55,
                    "name": "202カリー堂",
                    "category": "洋食",
                    "address": "東京都世田谷区代田５丁目３４−２１ 202",
                    "latitude": 35.6614,
                    "longitude": 139.6631,
                    "phone": "036-4138-857",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "9:00-20:00"
          },
          {
                    "id": 56,
                    "name": "TORIBA COFFEE TOKYO",
                    "category": "カフェ",
                    "address": "東京都中央区八重洲２丁目１−１ YANMAR TOKYO B1F",
                    "latitude": 35.6798,
                    "longitude": 139.7645,
                    "phone": "080-3715-4434",
                    "website": "http://www.toriba-coffee.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "月〜金10:00-19:00/ 土日10:00-20:00"
          },
          {
                    "id": 57,
                    "name": "premium SOW",
                    "category": "洋食",
                    "address": "東京都渋谷区代官山町１２−１６ シンフォニー代官山 103",
                    "latitude": 35.6507,
                    "longitude": 139.701,
                    "phone": "035-4223-390",
                    "website": "http://premium-sow.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-18:00"
          },
          {
                    "id": 58,
                    "name": "RISO GRAN",
                    "category": "パン屋",
                    "address": "大阪府大阪市此花区春日出中２丁目１４−２３ マンション住田 1F",
                    "latitude": 34.6799,
                    "longitude": 135.4473,
                    "phone": "070-2215-7547",
                    "website": "https://risogran.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-14:00"
          },
          {
                    "id": 59,
                    "name": "田田田堂",
                    "category": "スイーツ",
                    "address": "兵庫県神戸市東灘区御影郡家１丁目２３−１２",
                    "latitude": 34.7215,
                    "longitude": 135.251,
                    "phone": "078-8553-358",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:00-18:00"
          },
          {
                    "id": 60,
                    "name": "阿闍梨餅本舗満月 本店",
                    "category": "スイーツ",
                    "address": "京都府京都市左京区田中大堰町１３９",
                    "latitude": 35.0301,
                    "longitude": 135.7755,
                    "phone": "075-7914-121",
                    "website": "http://www.ajyarimochi.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "9:00-18:00"
          },
          {
                    "id": 61,
                    "name": "京都炎神",
                    "category": "和食",
                    "address": "京都府京都市中京区中之町５８０−２",
                    "latitude": 35.0045,
                    "longitude": 135.7649,
                    "phone": "075-6064-234",
                    "website": "",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "12:00-22:30"
          },
          {
                    "id": 62,
                    "name": "和レ和レ和アラシヤマ",
                    "category": "和食",
                    "address": "京都府京都市右京区嵯峨天龍寺芒ノ馬場町３−１４",
                    "latitude": 35.0142,
                    "longitude": 135.6745,
                    "phone": "075-3349-065",
                    "website": "https://www.bread-espresso.jp/shop/warewarewa_arashiyama.html",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "8:00-18:00"
          },
          {
                    "id": 63,
                    "name": "エスパルスドリームプラザ",
                    "category": "販売店",
                    "address": "静岡県静岡市清水区入船町１３−１５",
                    "latitude": 35.0106,
                    "longitude": 138.4902,
                    "phone": "054-3543-360",
                    "website": "https://www.dream-plaza.co.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-20:00"
          },
          {
                    "id": 64,
                    "name": "グルテンフリースイーツ専門店 NachuRa Yoyogi park",
                    "category": "スイーツ",
                    "address": "東京都渋谷区富ケ谷１丁目１７−７ 第二山栄ビル １階",
                    "latitude": 35.6664,
                    "longitude": 139.6893,
                    "phone": "070-4680-4217",
                    "website": "https://nachura.shop/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "8:00-17:00"
          },
          {
                    "id": 65,
                    "name": "Linda Lindo SWEETS",
                    "category": "スイーツ",
                    "address": "岐阜県本巣郡北方町曲路３丁目３９",
                    "latitude": 35.4311,
                    "longitude": 136.6934,
                    "phone": "058-2606-377",
                    "website": "https://lindalindo.shop/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:00-18:00"
          },
          {
                    "id": 66,
                    "name": "cadeau",
                    "category": "スイーツ",
                    "address": "三重県津市八町２丁目１５−１",
                    "latitude": 34.7204,
                    "longitude": 136.4946,
                    "phone": "059-2021-402",
                    "website": "https://malalatete.jp/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "10:30-16:30"
          },
          {
                    "id": 67,
                    "name": "お米のいいなり",
                    "category": "和食",
                    "address": "和歌山県和歌山市小松原５丁目６−７",
                    "latitude": 34.2332,
                    "longitude": 135.1892,
                    "phone": "073-4228-228",
                    "website": "https://komeno-e-nari.com/",
                    "description": "",
                    "gluten_free_options": "",
                    "opening_hours": "11:30-15:00,18:00-22:00"
          }
];

        // グローバル変数
        let map;
        let stores = [];
        let markers = [];

        // DOM読み込み完了後に即座に初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('⚡ 埋め込みデータ版 - 高速起動');
            initializeApp();
        });

        // アプリ初期化（超高速）
        function initializeApp() {
            console.log('🚀 アプリ初期化開始（埋め込みデータ版）');
            
            // 1. 即座に店舗データを表示
            loadEmbeddedStores();
            
            // 2. 地図を初期化
            initMap();
            
            // 3. イベントリスナー設定
            setupEventListeners();
            
            // 4. データベース状態確認
            checkDatabaseStatus();
            
            console.log('✅ アプリ初期化完了 - 全機能利用可能');
        }

        // データベース状態確認（簡略版）
        async function checkDatabaseStatus() {
            try {
                // 基本接続確認のみ
                const { data, error } = await supabaseClient
                    .from('visit_history')
                    .select('count', { count: 'exact' })
                    .limit(1);
                
                if (error) {
                    console.warn('⚠️ データベース接続確認エラー:', error);
                } else {
                    console.log('✅ データベース接続正常');
                }
            } catch (error) {
                console.warn('⚠️ データベース確認エラー:', error);
            }
        }

        // 埋め込み店舗データ読み込み（即座）
        function loadEmbeddedStores() {
            console.log('📦 埋め込みデータ読み込み開始');
            
            stores = embeddedStores;
            
            displayStores(stores);
            // オーバーレイパネルに初期表示
            updatePanelContent('all');
            updateStoreCount(stores.length);
            
            console.log(`✅ ${stores.length}店舗のデータを即座に表示完了`);
        }

        // マップ初期化
        function initMap() {
            try {
                console.log('🗺️ 地図初期化開始');
                
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    console.error('マップ要素が見つかりません');
                    return;
                }

                // デフォルト位置（日本全体）
                const defaultCenter = [35.6762, 139.6503];
                const defaultZoom = 6;

                map = L.map('map', {
                    center: defaultCenter,
                    zoom: defaultZoom,
                    zoomControl: true,
                    scrollWheelZoom: true
                });

                // 現在地を取得して地図の中心に設定
                getCurrentLocationAndCenter();
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(map);

                // マップ準備完了時に店舗マーカーを表示
                map.whenReady(() => {
                    console.log('🗺️ 地図準備完了 - マーカー表示');
                    displayStores(stores);
                });

                console.log('✅ 地図初期化完了');
            } catch (error) {
                console.error('地図初期化エラー:', error);
            }
        }

        // マップに店舗表示
        function displayStores(storesData) {
            if (!map) {
                console.log('⏳ 地図準備中のため、マーカー表示を待機');
                return;
            }

            // 既存マーカー削除
            markers.forEach(marker => {
                try {
                    map.removeLayer(marker);
                } catch (e) {
                    console.warn('マーカー削除エラー:', e);
                }
            });
            markers = [];

            storesData.forEach(store => {
                if (!store.latitude || !store.longitude) {
                    console.warn(`店舗「${store.name}」の座標が無効です`);
                    return;
                }

                try {
                    const config = categoryConfig[store.category] || categoryConfig['その他'];

                    const marker = L.marker([store.latitude, store.longitude], {
                        icon: L.divIcon({
                            className: 'elegant-marker',
                            html: `
                                <div class="marker-container">
                                    <div class="marker-icon" style="
                                        background: ${config.bgColor};
                                        border: 3px solid ${config.borderColor};
                                        color: ${config.color};
                                        width: 40px;
                                        height: 40px;
                                        border-radius: 50%;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        font-size: 18px;
                                        font-weight: bold;
                                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                        transition: transform 0.2s ease;
                                    "><i class="${config.icon}"></i></div>
                                    <div class="marker-pin" style="
                                        width: 0;
                                        height: 0;
                                        border-left: 6px solid transparent;
                                        border-right: 6px solid transparent;
                                        border-top: 8px solid ${config.borderColor};
                                        margin-left: 14px;
                                        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
                                    "></div>
                                </div>
                            `,
                            iconSize: [40, 48],
                            iconAnchor: [20, 48],
                            popupAnchor: [0, -48]
                        })
                    }).addTo(map);

                    const popupContent = createPopupContent(store);
                    marker.bindPopup(popupContent);

                    marker.on('click', function() {
                        selectStoreCard(store.id);
                    });

                    // マーカーにstoreIdを保存
                    marker.storeId = store.id;
                    markers.push(marker);
                } catch (error) {
                    console.error(`店舗「${store.name}」のマーカー作成エラー:`, error);
                }
            });

            console.log(`📍 ${markers.length}個のマーカーを地図に表示`);
        }

        // 現在地を取得して地図の中心に設定
        function getCurrentLocationAndCenter() {
            console.log('📍 現在地取得を試行中...');

            if (!navigator.geolocation) {
                console.log('❌ Geolocation API がサポートされていません');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5分間キャッシュ
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;

                    console.log(`✅ 現在地取得成功: ${lat.toFixed(6)}, ${lng.toFixed(6)} (精度: ${Math.round(accuracy)}m)`);

                    // 現在地情報を保存
                    currentUserLocation = { lat: lat, lng: lng };

                    // 地図の中心を現在地に移動（徒歩圏内の店舗が見えるレベルに拡大）
                    if (map) {
                        map.setView([lat, lng], 14);

                        // 現在地マーカーを追加（位置問題解決版）
                        console.log(`📍 現在地座標: lat=${lat}, lng=${lng}`);
                        
                        // 通常のLeafletマーカーアイコンを使用（確実に正しい位置に表示）
                        const currentLocationIcon = L.icon({
                            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30">
                                    <circle cx="15" cy="15" r="12" fill="#007AFF" stroke="white" stroke-width="3" opacity="0.9"/>
                                    <circle cx="15" cy="15" r="6" fill="#007AFF" stroke="white" stroke-width="2"/>
                                </svg>
                            `),
                            iconSize: [30, 30],
                            iconAnchor: [15, 15],
                            popupAnchor: [0, -15]
                        });

                        const locationMarker = L.marker([lat, lng], { 
                            icon: currentLocationIcon,
                            zIndexOffset: 1000 
                        });
                        
                        locationMarker.addTo(map);
                        // ポップアップなしでアイコンのみ表示（よりスタイリッシュ）
                        
                        console.log('✅ 現在地マーカー追加完了');

                        // 店舗リストを現在地から近い順で再表示
                        if (stores && stores.length > 0) {
                            displayStoreList(stores);
                            console.log('🔄 店舗リストを現在地順で更新完了');
                        }
                    }
                },
                function(error) {
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '位置情報の取得が拒否されました';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '位置情報が取得できませんでした';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '位置情報の取得がタイムアウトしました';
                            break;
                        default:
                            errorMessage = '不明なエラーが発生しました';
                            break;
                    }
                    console.log(`ℹ️ 現在地取得失敗: ${errorMessage}（デフォルト位置で表示）`);
                },
                options
            );
        }

        // 現在地情報を保存する変数
        let currentUserLocation = null;

        // 2点間の距離計算（Haversine公式）
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球の半径（km）
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // 距離（km）
        }

        // 店舗リスト表示（現在地から近い順）
        function displayStoreList(storesData) {
            const container = document.getElementById('storeList');
            if (!container) return;
            
            container.innerHTML = '';

            if (storesData.length === 0) {
                container.innerHTML = '<div class="loading-indicator">表示する店舗がありません</div>';
                return;
            }

            // 現在地から近い順にソート
            let sortedStores = [...storesData];
            if (currentUserLocation) {
                sortedStores = sortedStores.sort((a, b) => {
                    if (!a.latitude || !a.longitude || !b.latitude || !b.longitude) return 0;
                    const distanceA = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, a.latitude, a.longitude);
                    const distanceB = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, b.latitude, b.longitude);
                    return distanceA - distanceB;
                });
                console.log('📍 現在地から近い順でソート完了');
            }

            sortedStores.forEach(store => {
                try {
                    const card = createStoreCard(store);
                    container.appendChild(card);
                } catch (error) {
                    console.error(`店舗「${store.name}」のカード作成エラー:`, error);
                }
            });
        }

        // 店舗カード作成
        function createStoreCard(store) {
            const card = document.createElement('div');
            card.className = 'store-card';
            card.dataset.storeId = store.id;

            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            const storeHours = store.opening_hours ? escapeHtml(store.opening_hours) : '';

            // 現在地からの距離を計算
            let distanceText = '';
            if (currentUserLocation && store.latitude && store.longitude) {
                const distance = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, store.latitude, store.longitude);
                if (distance < 1) {
                    distanceText = `${Math.round(distance * 1000)}m`;
                } else {
                    distanceText = `${distance.toFixed(1)}km`;
                }
            }

            card.innerHTML = `
                <div class="store-header">
                    <h3 class="store-name">${storeName}</h3>
                    <div class="store-header-right">
                        <span class="store-category" data-category="${storeCategory}">${storeCategory}</span>
                        ${distanceText ? `<span class="store-distance">📍 ${distanceText}</span>` : ''}
                    </div>
                </div>
                <div class="store-info">
                    <div class="store-address">
                        <span class="popup-icon">📍</span>
                        <span>${storeAddress}</span>
                    </div>
                    ${storeGfOptions ? `
                        <div class="store-gf-type">
                            <span>✨</span>
                            <span>${storeGfOptions}</span>
                        </div>
                    ` : ''}
                    ${storeHours ? `
                        <div class="store-hours">
                            <span class="popup-icon">🕒</span>
                            <span>${storeHours}</span>
                        </div>
                    ` : ''}
                </div>
            `;

            card.addEventListener('click', function() {
                if (store.latitude && store.longitude && map) {
                    map.setView([store.latitude, store.longitude], 15);
                    const marker = markers.find(m => 
                        Math.abs(m.getLatLng().lat - store.latitude) < 0.00001 && 
                        Math.abs(m.getLatLng().lng - store.longitude) < 0.00001
                    );
                    if (marker) {
                        marker.openPopup();
                    }
                }
                selectStoreCard(store.id);
            });

            return card;
        }

        // ポップアップコンテンツ作成
        function createPopupContent(store) {
            const storeName = escapeHtml(store.name || '');
            const storeAddress = escapeHtml(store.address || '');
            const storeCategory = escapeHtml(store.category || '');
            const storeGfOptions = store.gluten_free_options ? escapeHtml(store.gluten_free_options) : '';
            const storeHours = store.opening_hours ? escapeHtml(store.opening_hours) : '';
            const storePhone = store.phone ? escapeHtml(store.phone) : '';
            const storeWebsite = store.website ? escapeHtml(store.website) : '';
            const storeDescription = store.description ? escapeHtml(store.description) : '';

            return `
                <div class="popup-content">
                    <div class="popup-header">
                        <h3 class="popup-title">${storeName}</h3>
                        <span class="popup-category">${storeCategory}</span>
                    </div>
                    <div class="popup-info">
                        <div class="popup-row">
                            <span class="popup-icon">📍</span>
                            <span class="popup-text">${storeAddress}</span>
                        </div>
                        ${storeGfOptions ? `
                            <div class="popup-row">
                                <span class="popup-icon">✨</span>
                                <span class="popup-text">${storeGfOptions}</span>
                            </div>
                        ` : ''}
                        ${storeHours ? `
                            <div class="popup-row">
                                <span class="popup-icon">🕒</span>
                                <span class="popup-text">${storeHours}</span>
                            </div>
                        ` : ''}
                        ${storePhone ? `
                            <div class="popup-row">
                                <span class="popup-icon">📞</span>
                                <span class="popup-text">${storePhone}</span>
                            </div>
                        ` : ''}
                        ${storeWebsite ? `
                            <div class="popup-row">
                                <span class="popup-icon">🌐</span>
                                <span class="popup-text"><a href="${storeWebsite}" target="_blank" rel="noopener">ウェブサイト</a></span>
                            </div>
                        ` : ''}
                        ${storeDescription ? `
                            <div class="popup-row">
                                <span class="popup-icon">💬</span>
                                <span class="popup-text">${storeDescription}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="popup-actions">
                        <button class="visit-btn want-to-go-btn" onclick="toggleVisitStatus(${store.id}, 'want_to_go')" data-store-id="${store.id}">
                            <span class="btn-icon">🤍</span>
                            <span class="btn-text">行きたい</span>
                        </button>
                        <button class="visit-btn visited-btn" onclick="toggleVisitStatus(${store.id}, 'visited')" data-store-id="${store.id}">
                            <span class="btn-icon">✨</span>
                            <span class="btn-text">行った</span>
                        </button>
                    </div>
                </div>
            `;
        }

        // 店舗カード選択
        function selectStoreCard(storeId) {
            document.querySelectorAll('.store-card').forEach(card => {
                card.classList.remove('selected');
            });

            const selectedCard = document.querySelector(`[data-store-id="${storeId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                selectedCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // 店舗数更新
        function updateStoreCount(count) {
            const element = document.getElementById('storeCount');
            if (element) {
                element.textContent = count;
            }
        }

        // フィルタリング
        function filterStores() {
            if (!stores.length) return;

            const searchInput = document.getElementById('searchInput');
            const searchText = searchInput ? searchInput.value.toLowerCase() : '';
            const activeChip = document.querySelector('.filter-chip.active');
            const selectedCategory = activeChip ? activeChip.dataset.category : '';

            const filteredStores = stores.filter(store => {
                const matchesCategory = !selectedCategory || store.category === selectedCategory;
                const matchesSearch = !searchText ||
                    (store.name && store.name.toLowerCase().includes(searchText)) ||
                    (store.address && store.address.toLowerCase().includes(searchText)) ||
                    (store.description && store.description.toLowerCase().includes(searchText));

                return matchesCategory && matchesSearch;
            });

            displayStores(filteredStores);
            // オーバーレイパネルを更新
            const activeTab = document.querySelector('.panel-tab.active');
            if (activeTab) {
                updatePanelContent(activeTab.dataset.tab);
            }
            updateStoreCount(filteredStores.length);
        }

        // 現在地取得
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('このブラウザは位置情報に対応していません');
                return;
            }

            if (!map) {
                alert('マップが初期化されていません');
                return;
            }

            getCurrentLocationAndCenter();
        }

        // マップ表示リセット
        function resetMapView() {
            if (map) {
                map.setView([35.6762, 139.6503], 6);
            }
        }

        // HTMLエスケープ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // グローバル関数として公開（onclick用）
        window.toggleVisitStatus = toggleVisitStatus;
        window.focusOnStore = focusOnStore;

        // イベントリスナー設定
        function setupEventListeners() {
            console.log('🎛️ イベントリスナー設定開始');

            // 検索
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', filterStores);
            }

            // フィルターチップ
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    filterStores();
                });
            });

            // マップ制御
            const locateBtn = document.getElementById('locateBtn');
            if (locateBtn) {
                locateBtn.addEventListener('click', getCurrentLocation);
            }

            const resetBtn = document.getElementById('resetViewBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', resetMapView);
            }

            // 訪問履歴機能の初期化
            initVisitHistory();
            
            // オーバーレイパネルの初期化
            initOverlayPanel();
            
            console.log('✅ イベントリスナー設定完了');
        }

        // 訪問履歴グローバル変数
        let userVisitHistory = new Map();
        let currentUser = null;

        // 訪問履歴機能初期化
        async function initVisitHistory() {
            console.log('📝 訪問履歴機能初期化開始');
            
            // 現在のユーザーを設定（Google認証確認）
            await checkAuthentication();
            
            // Supabaseから訪問履歴を読み込み
            await loadVisitHistoryFromSupabase();
            
            // ローカルストレージからのフォールバック読み込み
            const saved = localStorage.getItem('visit_history');
            if (saved && userVisitHistory.size === 0) {
                try {
                    const parsed = JSON.parse(saved);
                    userVisitHistory = new Map(Object.entries(parsed));
                    console.log('💾 ローカル訪問履歴を復元:', userVisitHistory.size, '件');
                } catch (e) {
                    console.warn('⚠️ 訪問履歴の復元に失敗:', e);
                    userVisitHistory = new Map();
                }
            }
            
            console.log('✅ 訪問履歴機能初期化完了');
        }

        // Supabaseから訪問履歴を読み込み
        async function loadVisitHistoryFromSupabase() {
            try {
                console.log('🔄 Supabaseから訪問履歴を読み込み中...');
                
                const { data, error } = await supabaseClient
                    .from('visit_history')
                    .select('store_id, status')
                    .eq('user_email', currentUser);

                if (error) {
                    console.error('❌ Supabase読み込みエラー:', error);
                    throw error;
                }

                if (data) {
                    userVisitHistory.clear();
                    data.forEach(item => {
                        userVisitHistory.set(`${item.store_id}`, item.status);
                    });
                    console.log('✅ Supabaseから訪問履歴を読み込み:', data.length, '件');
                }
            } catch (error) {
                console.error('❌ 訪問履歴読み込み失敗:', error);
                // エラーが発生してもローカルストレージから読み込みを試行
            }
        }

        // 訪問ステータス切り替え
        async function toggleVisitStatus(storeId, status) {
            console.log('📝 訪問ステータス更新:', storeId, status);
            
            if (!currentUser) {
                alert('ユーザー認証が必要です');
                return;
            }
            
            const key = `${storeId}`;
            const currentStatus = userVisitHistory.get(key);
            
            if (currentStatus === status) {
                // 同じステータスの場合は削除
                userVisitHistory.delete(key);
                await deleteVisitHistoryFromSupabase(storeId);
                console.log('🗑️ 訪問ステータス削除:', storeId);
            } else {
                // 新しいステータスを設定
                userVisitHistory.set(key, status);
                await saveVisitHistoryToSupabase(storeId, status);
                console.log('✅ 訪問ステータス設定:', storeId, status);
            }
            
            // ローカルストレージにもバックアップ保存
            const obj = Object.fromEntries(userVisitHistory);
            localStorage.setItem('visit_history', JSON.stringify(obj));
            
            // UIを更新
            updateVisitButtonsForStore(storeId);
            
            // 現在履歴ビューを表示している場合は更新
            const historyView = document.getElementById('visitHistoryView');
            if (historyView && !historyView.classList.contains('hidden')) {
                const activeTab = document.querySelector('.nav-btn.active');
                if (activeTab && activeTab.dataset.tab !== 'map') {
                    updateHistoryView(activeTab.dataset.tab);
                }
            }
            
            console.log('💾 訪問履歴保存完了');
        }

        // Supabaseに訪問履歴を保存
        async function saveVisitHistoryToSupabase(storeId, status) {
            try {
                console.log('💾 Supabaseに保存中...', storeId, status);
                
                // 既存レコードを削除してから挿入（UPSERT的な動作）
                const { error: deleteError } = await supabaseClient
                    .from('visit_history')
                    .delete()
                    .eq('user_email', currentUser)
                    .eq('store_id', storeId);

                if (deleteError) {
                    console.warn('⚠️ 既存レコード削除エラー:', deleteError);
                }

                // 新しいレコードを挿入
                const { data, error } = await supabaseClient
                    .from('visit_history')
                    .insert([
                        {
                            user_email: currentUser,
                            store_id: storeId,
                            status: status,
                            visited_date: status === 'visited' ? new Date().toISOString().split('T')[0] : null,
                            notes: null
                        }
                    ]);

                if (error) {
                    console.error('❌ Supabase保存エラー:', error);
                    throw error;
                } else {
                    console.log('✅ Supabase保存成功');
                }
            } catch (error) {
                console.error('❌ 訪問履歴保存失敗:', error);
                // エラーが発生してもローカルには保存されているので続行
            }
        }

        // Supabaseから訪問履歴を削除
        async function deleteVisitHistoryFromSupabase(storeId) {
            try {
                console.log('🗑️ Supabaseから削除中...', storeId);
                
                const { error } = await supabaseClient
                    .from('visit_history')
                    .delete()
                    .eq('user_email', currentUser)
                    .eq('store_id', storeId);

                if (error) {
                    console.error('❌ Supabase削除エラー:', error);
                    throw error;
                } else {
                    console.log('✅ Supabase削除成功');
                }
            } catch (error) {
                console.error('❌ 訪問履歴削除失敗:', error);
                // エラーが発生してもローカルからは削除されているので続行
            }
        }

        // 特定店舗の訪問ボタンUI更新
        function updateVisitButtonsForStore(storeId) {
            const status = userVisitHistory.get(`${storeId}`);
            
            // ポップアップ内のボタンを更新
            const wantBtn = document.querySelector(`.want-to-go-btn[data-store-id="${storeId}"]`);
            const visitedBtn = document.querySelector(`.visited-btn[data-store-id="${storeId}"]`);
            
            if (wantBtn) {
                wantBtn.classList.toggle('active', status === 'want_to_go');
            }
            if (visitedBtn) {
                visitedBtn.classList.toggle('active', status === 'visited');
            }
        }

        // 認証確認
        async function checkAuthentication() {
            try {
                console.log('🔐 認証状態を確認中...');
                
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error) {
                    console.warn('⚠️ 認証確認エラー、デモモードで続行:', error.message || error);
                    currentUser = 'demo_user@example.com';
                    return;
                }
                
                if (user && user.email) {
                    currentUser = user.email;
                    console.log('✅ 認証済みユーザー:', currentUser);
                } else {
                    console.log('⚠️ 未認証ユーザー、デモモードで続行');
                    currentUser = 'demo_user@example.com';
                }
            } catch (error) {
                console.warn('⚠️ 認証情報エラー、デモモードで実行:', error.message || error);
                currentUser = 'demo_user@example.com'; // フォールバック
            }
        }

        // Google認証（オプション機能）
        async function signInWithGoogle() {
            try {
                console.log('🔐 Google認証を開始...');
                
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin
                    }
                });
                
                if (error) {
                    console.error('❌ Google認証エラー:', error);
                    alert('認証に失敗しました。デモモードで続行します。');
                } else {
                    console.log('✅ Google認証成功');
                }
            } catch (error) {
                console.error('❌ 認証処理エラー:', error);
                alert('認証に失敗しました。デモモードで続行します。');
            }
        }

        // ログアウト
        async function signOut() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) {
                    console.error('❌ ログアウトエラー:', error);
                } else {
                    console.log('✅ ログアウト成功');
                    currentUser = 'demo_user';
                    userVisitHistory.clear();
                    location.reload();
                }
            } catch (error) {
                console.error('❌ ログアウト処理エラー:', error);
            }
        }

        // オーバーレイパネル初期化
        function initOverlayPanel() {
            console.log('📦 オーバーレイパネル初期化開始');
            
            const panel = document.getElementById('overlayPanel');
            const handle = document.getElementById('panelHandle');
            const panelContent = document.getElementById('panelContent');
            
            if (!panel || !handle) {
                console.error('オーバーレイパネル要素が見つかりません');
                return;
            }
            
            let isDragging = false;
            let startY = 0;
            let currentTranslateY = 0;
            let panelState = 'collapsed'; // collapsed, half, full
            
            // パネル位置設定
            function setPanelPosition(state) {
                panelState = state;
                panel.classList.remove('half-open', 'full-open');
                
                if (state === 'half') {
                    panel.classList.add('half-open');
                } else if (state === 'full') {
                    panel.classList.add('full-open');
                }
            }
            
            // ドラッグ開始
            handle.addEventListener('touchstart', (e) => {
                isDragging = true;
                startY = e.touches[0].clientY;
                panel.style.transition = 'none';
            });
            
            handle.addEventListener('mousedown', (e) => {
                isDragging = true;
                startY = e.clientY;
                panel.style.transition = 'none';
            });
            
            // ドラッグ中
            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                
                const deltaY = e.touches[0].clientY - startY;
                const newTranslateY = Math.max(0, Math.min(window.innerHeight - 60, currentTranslateY + deltaY));
                panel.style.transform = `translateY(${newTranslateY}px)`;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaY = e.clientY - startY;
                const newTranslateY = Math.max(0, Math.min(window.innerHeight - 60, currentTranslateY + deltaY));
                panel.style.transform = `translateY(${newTranslateY}px)`;
            });
            
            // ドラッグ終了
            function handleDragEnd() {
                if (!isDragging) return;
                isDragging = false;
                panel.style.transition = '';
                
                const panelRect = panel.getBoundingClientRect();
                const panelTop = panelRect.top;
                const windowHeight = window.innerHeight;
                
                if (panelTop < windowHeight * 0.2) {
                    setPanelPosition('full');
                } else if (panelTop < windowHeight * 0.6) {
                    setPanelPosition('half');
                } else {
                    setPanelPosition('collapsed');
                }
            }
            
            document.addEventListener('touchend', handleDragEnd);
            document.addEventListener('mouseup', handleDragEnd);
            
            // タップで展開
            handle.addEventListener('click', (e) => {
                if (isDragging) return;
                
                if (panelState === 'collapsed') {
                    setPanelPosition('half');
                } else if (panelState === 'half') {
                    setPanelPosition('full');
                } else {
                    setPanelPosition('collapsed');
                }
            });
            
            // タブ切り替え
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    updatePanelContent(tab.dataset.tab);
                });
            });
            
            // 初期表示
            updatePanelContent('all');
            
            console.log('✅ オーバーレイパネル初期化完了');
        }

        // パネルコンテンツ更新
        function updatePanelContent(tab) {
            console.log('📋 パネルコンテンツ更新:', tab);
            
            const panelContent = document.getElementById('panelContent');
            if (!panelContent) return;
            
            let filteredStores = [...stores];
            
            if (tab === 'want-to-go') {
                filteredStores = stores.filter(store => {
                    const status = userVisitHistory.get(`${store.id}`);
                    return status === 'want_to_go';
                });
            } else if (tab === 'visited') {
                filteredStores = stores.filter(store => {
                    const status = userVisitHistory.get(`${store.id}`);
                    return status === 'visited';
                });
            }
            
            // 店舗数更新
            const countEl = document.getElementById('panelStoreCount');
            if (countEl) {
                if (tab === 'all') {
                    countEl.textContent = `全国${filteredStores.length}店舗`;
                } else if (tab === 'want-to-go') {
                    countEl.textContent = `行きたい${filteredStores.length}店舗`;
                } else if (tab === 'visited') {
                    countEl.textContent = `行った${filteredStores.length}店舗`;
                }
            }
            
            displayPanelStoreList(filteredStores, panelContent);
        }
        
        // パネル用店舗リスト表示
        function displayPanelStoreList(storesData, container) {
            if (!container) return;
            
            container.innerHTML = '';
            
            if (storesData.length === 0) {
                container.innerHTML = '<div class="loading-indicator">表示する店舗がありません</div>';
                return;
            }
            
            // 現在地から近い順にソート
            let sortedStores = [...storesData];
            if (currentUserLocation) {
                sortedStores = sortedStores.sort((a, b) => {
                    if (!a.latitude || !a.longitude || !b.latitude || !b.longitude) return 0;
                    const distanceA = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, a.latitude, a.longitude);
                    const distanceB = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, b.latitude, b.longitude);
                    return distanceA - distanceB;
                });
            }
            
            sortedStores.forEach(store => {
                try {
                    const card = createPanelStoreCard(store);
                    container.appendChild(card);
                } catch (error) {
                    console.error(`店舗「${store.name}」のカード作成エラー:`, error);
                }
            });
        }
        
        // パネル用店舗カード作成
        function createPanelStoreCard(store) {
            const card = document.createElement('div');
            card.className = 'store-card';
            card.dataset.storeId = store.id;
            
            const status = userVisitHistory.get(`${store.id}`);
            const isWantToGo = status === 'want_to_go';
            const isVisited = status === 'visited';
            
            // 現在地からの距離を計算
            let distanceText = '';
            if (currentUserLocation && store.latitude && store.longitude) {
                const distance = calculateDistance(currentUserLocation.lat, currentUserLocation.lng, store.latitude, store.longitude);
                if (distance < 1) {
                    distanceText = `${Math.round(distance * 1000)}m`;
                } else {
                    distanceText = `${distance.toFixed(1)}km`;
                }
            }
            
            const categoryConfig = {
                'カフェ': { icon: '☕', color: '#8B4513' },
                '和食': { icon: '🍱', color: '#006400' },
                '洋食': { icon: '🍽️', color: '#FF6347' },
                'パン屋': { icon: '🥐', color: '#FFA500' },
                'スイーツ': { icon: '🧁', color: '#FF69B4' },
                '販売店': { icon: '🛒', color: '#4169E1' },
                'その他': { icon: '🏪', color: '#808080' }
            };
            
            const config = categoryConfig[store.category] || categoryConfig['その他'];
            
            card.innerHTML = `
                <div class="store-header">
                    <div class="store-name">${escapeHtml(store.name || '')}</div>
                    ${distanceText ? `<div class="store-distance">${distanceText}</div>` : ''}
                </div>
                <div class="store-meta">
                    <span class="category-badge" style="background: ${config.color}15; color: ${config.color}; border: 1px solid ${config.color}30;">
                        ${config.icon} ${escapeHtml(store.category || '')}
                    </span>
                </div>
                <div class="store-info">
                    <div class="info-item">
                        <span class="info-icon">📍</span>
                        <span class="info-text">${escapeHtml(store.address || '')}</span>
                    </div>
                    ${store.gluten_free_options ? `
                        <div class="info-item">
                            <span class="info-icon">🌾</span>
                            <span class="info-text">${escapeHtml(store.gluten_free_options)}</span>
                        </div>
                    ` : ''}
                </div>
                <div class="store-card-actions">
                    <button class="action-btn want-to-go ${isWantToGo ? 'active' : ''}" 
                            onclick="toggleVisitStatus(${store.id}, 'want_to_go')">
                        🤍 行きたい
                    </button>
                    <button class="action-btn visited ${isVisited ? 'active' : ''}" 
                            onclick="toggleVisitStatus(${store.id}, 'visited')">
                        ✨ 行った
                    </button>
                    <button class="action-btn" onclick="focusOnStore(${store.id})">
                        🗺️ 地図
                    </button>
                </div>
            `;
            
            return card;
        }
        
        // 店舗にフォーカス
        function focusOnStore(storeId) {
            const store = stores.find(s => s.id === storeId);
            if (store && map) {
                map.setView([store.latitude, store.longitude], 16);
                
                // パネルを閉じる
                const panel = document.getElementById('overlayPanel');
                if (panel) {
                    panel.classList.remove('half-open', 'full-open');
                }
                
                // マーカーのポップアップを開く
                setTimeout(() => {
                    const marker = markers.find(m => m.storeId === storeId);
                    if (marker) {
                        marker.openPopup();
                    }
                }, 300);
            }
        }
        
        // タブ切り替え（古い関数、互換性のため残す）
        function switchTab(tab) {
            console.log('🔄 タブ切り替え:', tab);
            
            // 導航ボタンのアクティブ状態更新
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            const mainContent = document.querySelector('.main-content');
            const historyView = document.getElementById('visitHistoryView');
            
            // 要素の存在チェック
            if (!mainContent) {
                console.error('❌ .main-content要素が見つかりません');
                return;
            }
            if (!historyView) {
                console.error('❌ visitHistoryView要素が見つかりません');
                return;
            }
            
            if (tab === 'map') {
                // 地図表示
                mainContent.style.display = 'block';
                historyView.classList.add('hidden');
            } else {
                // 履歴表示
                mainContent.style.display = 'none';
                historyView.classList.remove('hidden');
                updateHistoryView(tab);
            }
        }

        // 履歴ビュー更新
        function updateHistoryView(type) {
            console.log('📝 履歴ビュー更新:', type);
            
            const titleEl = document.getElementById('historyTitle');
            const countEl = document.getElementById('historyCount');
            const listEl = document.getElementById('historyList');
            
            // 要素の存在チェック
            if (!titleEl || !countEl || !listEl) {
                console.error('❌ 履歴ビュー要素が見つかりません:', {
                    titleEl: !!titleEl,
                    countEl: !!countEl,
                    listEl: !!listEl
                });
                return;
            }
            
            // タイトル設定
            titleEl.textContent = type === 'want-to-go' ? '行きたいお店' : '行ったお店';
            
            // フィルタリング
            const filteredStores = stores.filter(store => {
                const status = userVisitHistory.get(`${store.id}`);
                return status === (type === 'want-to-go' ? 'want_to_go' : 'visited');
            });
            
            // 件数更新
            countEl.textContent = `${filteredStores.length}件`;
            
            // リスト生成
            if (filteredStores.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">${type === 'want-to-go' ? '🤍' : '✨'}</div>
                        <div class="empty-message">まだ${type === 'want-to-go' ? '行きたいお店' : '行ったお店'}がありません</div>
                    </div>
                `;
            } else {
                listEl.innerHTML = filteredStores.map(store => createHistoryItem(store, type)).join('');
            }
        }

        // 履歴アイテム生成
        function createHistoryItem(store, type) {
            const categoryClass = getCategoryClass(store.category);
            const categoryColor = categoryColors[store.category] || '#666';
            
            return `
                <div class="history-item" data-store-id="${store.id}">
                    <div class="history-item-header">
                        <div class="history-store-name">${escapeHtml(store.name || '')}</div>
                        <div class="history-category" style="background-color: ${categoryColor}">
                            ${escapeHtml(store.category || '')}
                        </div>
                    </div>
                    <div class="history-address">${escapeHtml(store.address || '')}</div>
                    <div class="history-actions">
                        <button class="history-action-btn" onclick="showStoreOnMap(${store.id})">
                            地図で見る
                        </button>
                        <button class="history-action-btn" onclick="toggleVisitStatus(${store.id}, '${type === 'want-to-go' ? 'want_to_go' : 'visited'}')">
                            削除
                        </button>
                    </div>
                </div>
            `;
        }

        // 地図で店舗を表示
        function showStoreOnMap(storeId) {
            console.log('🗺️ 地図で店舗表示:', storeId);
            
            // 地図タブに切り替え
            switchTab('map');
            
            // 店舗を探してフォーカス
            const store = stores.find(s => s.id === storeId);
            if (store && map) {
                map.setView([store.latitude, store.longitude], 16);
                
                // マーカーのポップアップを開く
                setTimeout(() => {
                    const marker = markers.find(m => m.storeId === storeId);
                    if (marker) {
                        marker.openPopup();
                    }
                }, 300);
            }
        }

        // Supabase接続テスト関数
        async function testSupabaseConnection() {
            console.log('🔍 Supabase接続テスト開始...');
            
            try {
                // 1. visit_historyテーブルの存在と構造確認
                console.log('1. visit_historyテーブル確認...');
                const { data: visitHistory, error: visitError } = await supabaseClient
                    .from('visit_history')
                    .select('*')
                    .limit(5);
                    
                if (visitError) {
                    console.error('❌ visit_historyテーブルエラー:', visitError);
                    
                    // テーブルが存在しない場合、作成を試行
                    console.log('🛠️ visit_historyテーブルが存在しない可能性があります');
                } else {
                    console.log('✅ visit_historyテーブル接続成功');
                    console.log('📋 既存の訪問履歴データ:', visitHistory?.length, '件');
                    if (visitHistory && visitHistory.length > 0) {
                        console.log('📊 サンプルデータ:', visitHistory);
                    }
                }
                
                // 2. user_profilesテーブル確認
                console.log('2. user_profilesテーブル確認...');
                const { data: profiles, error: profileError } = await supabaseClient
                    .from('user_profiles')
                    .select('email, nickname')
                    .limit(3);
                    
                if (profileError) {
                    console.error('❌ user_profilesテーブルエラー:', profileError);
                } else {
                    console.log('✅ user_profilesテーブル接続成功:', profiles?.length, '件');
                    console.log('👤 ユーザープロファイル:', profiles);
                }
                
                // 3. storesテーブル確認
                console.log('3. storesテーブル確認...');
                const { data: stores, error: storeError } = await supabaseClient
                    .from('stores')
                    .select('id, name, category_id')
                    .limit(5);
                    
                if (storeError) {
                    console.error('❌ storesテーブルエラー:', storeError);
                } else {
                    console.log('✅ storesテーブル接続成功:', stores?.length, '件');
                    console.log('🏪 店舗データサンプル:', stores);
                }
                
                // 4. テーブルスキーマ情報の取得試行
                console.log('4. データベース情報確認...');
                const { data: schemaInfo, error: schemaError } = await supabaseClient
                    .from('information_schema.tables')
                    .select('table_name')
                    .eq('table_schema', 'public')
                    .in('table_name', ['visit_history', 'user_profiles', 'stores', 'store_categories']);
                
                if (!schemaError && schemaInfo) {
                    console.log('📋 存在するテーブル:', schemaInfo.map(t => t.table_name));
                }
                
                return true;
            } catch (error) {
                console.error('❌ Supabase接続テスト失敗:', error);
                return false;
            }
        }

        // テストデータ挿入機能
        async function insertTestVisitHistory() {
            console.log('🧪 テスト訪問履歴データ挿入開始...');
            
            try {
                const testUser = 'demo_user@example.com';
                const testStoreId = 1; // みちのり亭のID
                
                // 1. user_profilesにテストユーザーを作成
                const { error: userError } = await supabaseClient
                    .from('user_profiles')
                    .upsert({
                        email: testUser,
                        nickname: 'テストユーザー',
                        is_active: true
                    });
                
                if (userError) {
                    console.error('❌ テストユーザー作成エラー:', userError);
                } else {
                    console.log('✅ テストユーザー作成成功');
                }
                
                // 2. visit_historyにテストデータ挿入
                const { data: insertData, error: insertError } = await supabaseClient
                    .from('visit_history')
                    .insert([
                        {
                            user_email: testUser,
                            store_id: testStoreId,
                            status: 'want_to_go',
                            notes: 'テスト用の行きたい店データ'
                        }
                    ])
                    .select();
                
                if (insertError) {
                    console.error('❌ テストデータ挿入エラー:', insertError);
                } else {
                    console.log('✅ テストデータ挿入成功:', insertData);
                }
                
                // 3. データ確認
                const { data: checkData, error: checkError } = await supabaseClient
                    .from('visit_history')
                    .select('*')
                    .eq('user_email', testUser);
                
                if (!checkError && checkData) {
                    console.log('📊 挿入確認結果:', checkData);
                }
                
            } catch (error) {
                console.error('❌ テストデータ挿入失敗:', error);
            }
        }

        // テスト関数をグローバルに公開
        window.insertTestData = insertTestVisitHistory;

        // テスト実行用のグローバル関数として公開
        window.testSupabase = testSupabaseConnection;
        
        // パフォーマンス測定
        console.log('🚀 埋め込みデータ版グルテンフリーマップ');
        console.log('⚡ 特徴: 即座表示、認証不要、確実動作');
        console.log('📊 店舗数:', embeddedStores.length, '店舗');
        console.log('🧪 Supabaseテスト: コンソールで testSupabase() を実行');
        console.log('🧪 テストデータ挿入: コンソールで insertTestData() を実行');
    </script>
</body>
</html>