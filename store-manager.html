<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç®¡ç†ç”»é¢ - ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #ff6b9d;
            --primary-dark: #e55a8a;
            --secondary: #40e0d0;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-primary: #fdf2f8;
            --bg-secondary: #f9fafb;
            --bg-glass: rgba(255, 255, 255, 0.95);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-light: #e5e7eb;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --space-xs: 0.5rem;
            --space-sm: 0.75rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg);
        }
        
        .login-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-lg);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        .login-title {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: var(--space-md);
        }
        
        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: var(--space-xl);
        }
        
        .input-group {
            margin-bottom: var(--space-lg);
            text-align: left;
        }
        
        .input-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: var(--space-xs);
            font-weight: 500;
        }
        
        .input-group input {
            width: 100%;
            padding: var(--space-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: var(--space-md);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .login-error {
            color: var(--error);
            font-size: 0.9rem;
            margin-bottom: var(--space-md);
            padding: var(--space-sm);
            background: rgba(239, 68, 68, 0.1);
            border-radius: var(--radius-sm);
            display: none;
        }
        
        /* ç®¡ç†ç”»é¢ */
        .admin-container {
            display: none;
            min-height: 100vh;
            background: var(--bg-secondary);
        }
        
        .admin-header {
            background: white;
            box-shadow: var(--shadow-md);
            padding: var(--space-md) var(--space-lg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .admin-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
        }

        .tab-btn {
            flex: 1;
            padding: var(--space-md) var(--space-lg);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .tab-btn:hover {
            background: rgba(255, 107, 157, 0.1);
            color: var(--primary);
        }

        .tab-btn.active {
            background: white;
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            font-weight: 600;
        }

        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ‘ãƒãƒ« */
        .users-panel {
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-light);
            transition: background-color 0.2s ease;
        }

        .user-item:hover {
            background: var(--bg-secondary);
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-info {
            flex: 1;
        }

        .user-email {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .user-meta {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            font-size: 0.85rem;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-registered {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .user-date {
            color: var(--text-secondary);
        }

        .user-actions {
            display: flex;
            gap: var(--space-xs);
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .btn-error {
            background: var(--error);
            color: white;
            border: 1px solid var(--error);
        }

        .btn-error:hover {
            background: #dc2626;
            border-color: #dc2626;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 700;
        }
        
        .header-actions {
            display: flex;
            gap: var(--space-md);
        }
        
        .btn {
            padding: var(--space-sm) var(--space-md);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
        }
        
        .btn-danger {
            background: var(--error);
            color: white;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .admin-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-lg);
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: var(--space-lg);
        }
        
        /* åº—èˆ—ãƒªã‚¹ãƒˆ */
        .stores-panel {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }
        
        .panel-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .store-count {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .search-box {
            padding: 0 var(--space-lg) var(--space-md);
        }
        
        .search-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }
        
        .stores-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .store-item {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .store-item:hover {
            background: var(--bg-primary);
        }
        
        .store-item.selected {
            background: var(--bg-primary);
            border-left: 4px solid var(--primary);
        }
        
        .store-info {
            flex: 1;
        }
        
        .store-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .store-category {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .store-address {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .store-actions {
            display: flex;
            gap: var(--space-xs);
        }
        
        .icon-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .icon-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .icon-btn.delete:hover {
            background: var(--error);
        }
        
        /* ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  */
        .edit-panel {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--space-lg);
            position: sticky;
            top: 80px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: var(--space-lg);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--space-xs);
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--space-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }
        
        /* åœ°å›³ */
        .map-container {
            margin-bottom: var(--space-lg);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 2px solid var(--border-light);
        }
        
        #editMap {
            height: 300px;
            width: 100%;
        }
        
        .map-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ ãƒœã‚¿ãƒ³ */
        .form-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-xl);
        }
        
        .form-actions .btn {
            flex: 1;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 1.3rem;
            margin-bottom: var(--space-md);
            color: var(--primary);
        }
        
        .modal-body {
            margin-bottom: var(--space-lg);
        }
        
        .modal-actions {
            display: flex;
            gap: var(--space-sm);
            justify-content: flex-end;
        }
        
        /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
        .toast {
            position: fixed;
            bottom: var(--space-lg);
            right: var(--space-lg);
            background: var(--success);
            color: white;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: var(--space-sm);
            z-index: 2000;
        }
        
        .toast.show {
            display: flex;
            animation: slideIn 0.3s ease;
        }
        
        .toast.error {
            background: var(--error);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 1024px) {
            .admin-content {
                grid-template-columns: 1fr;
            }
            
            #storesTab > div {
                grid-template-columns: 1fr !important;
            }
            
            .edit-panel {
                position: static;
                max-height: none;
                margin-top: var(--space-lg);
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <h1 class="login-title">ğŸ” ç®¡ç†ç”»é¢</h1>
            <p class="login-subtitle">ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—åº—èˆ—ç®¡ç†</p>
            
            <div class="input-group">
                <label for="adminPin">ç®¡ç†è€…PINã‚³ãƒ¼ãƒ‰ï¼ˆ6æ¡ï¼‰</label>
                <input type="password" id="adminPin" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="6" pattern="[0-9]*" inputmode="numeric">
            </div>
            
            <div id="loginError" class="login-error">
                PINã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“
            </div>
            
            <button class="login-btn" onclick="adminLogin()">
                <i class="fas fa-sign-in-alt"></i>
                ãƒ­ã‚°ã‚¤ãƒ³
            </button>
        </div>
    </div>
    
    <!-- ç®¡ç†ç”»é¢ -->
    <div id="adminContainer" class="admin-container">
        <header class="admin-header">
            <div class="header-content">
                <h1 class="header-title">ğŸ—ºï¸ ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—ç®¡ç†ç”»é¢</h1>
                <div class="header-actions">
                    <button class="btn btn-success" onclick="exportJSON()">
                        <i class="fas fa-download"></i>
                        JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-primary" onclick="generateEmbeddedCode()">
                        <i class="fas fa-code"></i>
                        åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                    </button>
                    <button class="btn btn-warning" onclick="autoSaveToGitHub()" id="autoSaveBtn">
                        <i class="fas fa-cloud-upload-alt"></i>
                        è‡ªå‹•ä¿å­˜
                    </button>
                    <button class="btn btn-secondary" onclick="importJSON()">
                        <i class="fas fa-upload"></i>
                        JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </div>
            </div>
        </header>
        
        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="admin-tabs">
            <button class="tab-btn active" data-tab="stores" onclick="switchTab('stores')">
                <i class="fas fa-store"></i>
                åº—èˆ—ç®¡ç†
            </button>
            <button class="tab-btn" data-tab="users" onclick="switchTab('users')">
                <i class="fas fa-users"></i>
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
            </button>
        </nav>
        
        <div class="admin-content">
            <!-- åº—èˆ—ç®¡ç†ã‚¿ãƒ– -->
            <div id="storesTab" class="tab-content active">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg);">
                    <!-- åº—èˆ—ãƒªã‚¹ãƒˆ -->
                    <div class="stores-panel">
                <div class="panel-header">
                    <h2 class="panel-title">åº—èˆ—ä¸€è¦§</h2>
                    <span class="store-count">å…¨<span id="storeCount">0</span>ä»¶</span>
                </div>
                
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="åº—åãƒ»ä½æ‰€ã§æ¤œç´¢..." onkeyup="filterStores()">
                </div>
                
                <div class="stores-list" id="storesList">
                    <!-- åº—èˆ—ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
                
                <div style="padding: var(--space-md); border-top: 1px solid var(--border-light);">
                    <button class="btn btn-primary" style="width: 100%;" onclick="addNewStore()">
                        <i class="fas fa-plus"></i>
                        æ–°è¦åº—èˆ—ã‚’è¿½åŠ 
                    </button>
                </div>
                    </div>
                    
                    <!-- ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div class="edit-panel">
                <h3 style="margin-bottom: var(--space-lg);">åº—èˆ—æƒ…å ±ç·¨é›†</h3>
                
                <form id="editForm">
                    <input type="hidden" id="storeId">
                    
                    <div class="form-group">
                        <label class="form-label">åº—èˆ—å *</label>
                        <input type="text" class="form-input" id="storeName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼ *</label>
                        <select class="form-select" id="storeCategory" required>
                            <option value="ã‚«ãƒ•ã‚§">â˜• ã‚«ãƒ•ã‚§</option>
                            <option value="å’Œé£Ÿ">ğŸ± å’Œé£Ÿ</option>
                            <option value="æ´‹é£Ÿ">ğŸ½ï¸ æ´‹é£Ÿ</option>
                            <option value="ãƒ‘ãƒ³å±‹">ğŸ¥ ãƒ‘ãƒ³å±‹</option>
                            <option value="ã‚¹ã‚¤ãƒ¼ãƒ„">ğŸ§ ã‚¹ã‚¤ãƒ¼ãƒ„</option>
                            <option value="è²©å£²åº—">ğŸ›’ è²©å£²åº—</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ä½æ‰€ *</label>
                        <input type="text" class="form-input" id="storeAddress" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">åº§æ¨™ï¼ˆåœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨­å®šï¼‰</label>
                        <div class="map-container">
                            <div id="editMap"></div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm);">
                            <div>
                                <label class="form-label">ç·¯åº¦</label>
                                <input type="number" class="form-input" id="storeLat" step="0.0001">
                            </div>
                            <div>
                                <label class="form-label">çµŒåº¦</label>
                                <input type="number" class="form-input" id="storeLng" step="0.0001">
                            </div>
                        </div>
                        <p class="map-hint">ğŸ’¡ åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½ç½®ã‚’è¨­å®šã™ã‚‹ã‹ã€åº§æ¨™ã‚’ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é›»è©±ç•ªå·</label>
                        <input type="tel" class="form-input" id="storePhone">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</label>
                        <input type="url" class="form-input" id="storeWebsite">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç”»åƒURL</label>
                        <input type="url" class="form-input" id="storeImageUrl" placeholder="åº—èˆ—ç”»åƒã®URL">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å–¶æ¥­æ™‚é–“</label>
                        <input type="text" class="form-input" id="storeHours" placeholder="ä¾‹: 11:00-20:00">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼å¯¾å¿œ</label>
                        <textarea class="form-textarea" id="storeGfOptions" placeholder="ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è©³ç´°ãªã©"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">èª¬æ˜</label>
                        <textarea class="form-textarea" id="storeDescription" placeholder="ãŠåº—ã®ç‰¹å¾´ãªã©"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-success" onclick="saveStore()">
                            <i class="fas fa-save"></i>
                            ä¿å­˜
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-times"></i>
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </form>
                    </div>
                </div>
            </div> <!-- åº—èˆ—ç®¡ç†ã‚¿ãƒ–çµ‚äº† -->
            
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ– -->
            <div id="usersTab" class="tab-content">
                <div class="users-panel">
                    <div class="panel-header">
                        <h2 class="panel-title">æ‰¿èªæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
                        <span class="user-count">å…¨<span id="userCount">0</span>ä»¶</span>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" class="search-input" id="userSearchInput" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ¤œç´¢..." onkeyup="filterUsers()">
                    </div>
                    
                    <div class="users-list" id="usersList">
                        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                    
                    <div style="padding: var(--space-md); border-top: 1px solid var(--border-light);">
                        <button class="btn btn-primary" style="width: 100%;" onclick="addNewUser()">
                            <i class="fas fa-user-plus"></i>
                            æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
                        </button>
                    </div>
                </div>
            </div>
    </div>
    
    <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">å‰Šé™¤ç¢ºèª</h3>
            <div class="modal-body">
                <p>ã“ã®åº—èˆ—ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <p style="color: var(--error); margin-top: var(--space-sm);">â€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-danger" onclick="confirmDelete()">å‰Šé™¤ã™ã‚‹</button>
            </div>
        </div>
    </div>
    
    <!-- åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="embeddedCodeModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
            <h3 class="modal-title">ğŸ“‹ åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ï¼ˆindex.htmlç”¨ï¼‰</h3>
            <div class="modal-body">
                <p style="margin-bottom: var(--space-md); color: var(--text-secondary);">
                    ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’index.htmlã®<code>const embeddedStores = [</code>ã‹ã‚‰<code>];</code>ã¾ã§ç½®ãæ›ãˆã¦ãã ã•ã„
                </p>
                
                <div style="margin-bottom: var(--space-md);">
                    <button class="btn btn-primary" onclick="copyEmbeddedCode()" style="width: 100%;">
                        <i class="fas fa-copy"></i>
                        ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                    </button>
                </div>
                
                <textarea id="embeddedCodeText" readonly style="
                    width: 100%; 
                    height: 400px; 
                    font-family: 'Courier New', monospace; 
                    font-size: 0.85rem; 
                    border: 1px solid var(--border-light); 
                    border-radius: var(--radius-sm); 
                    padding: var(--space-md);
                    background: #f8f9fa;
                    resize: vertical;
                "></textarea>
                
                <div style="margin-top: var(--space-md); padding: var(--space-md); background: #e3f2fd; border-radius: var(--radius-sm);">
                    <h4 style="margin-bottom: var(--space-sm); color: #1976d2;">ğŸ“ æ›´æ–°æ‰‹é †</h4>
                    <ol style="margin-left: var(--space-lg); color: var(--text-secondary);">
                        <li>ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</li>
                        <li>index.htmlã‚’é–‹ã</li>
                        <li><code>const embeddedStores = [</code>ã‚’æ¤œç´¢</li>
                        <li>é…åˆ—ã®ä¸­èº«ï¼ˆ<code>[</code>ã‹ã‚‰<code>];</code>ã¾ã§ï¼‰ã‚’ç½®ãæ›ãˆ</li>
                        <li>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦Gitã«ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥</li>
                    </ol>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEmbeddedCodeModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
    
    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">ä¿å­˜ã—ã¾ã—ãŸ</span>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase JSï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†åŒæœŸç”¨ï¼‰ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabaseè¨­å®šï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ã§å®‰å…¨ï¼‰
        const SUPABASE_URL = 'https://hxrmsjfvgctoaxpbukvo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4cm1zamZ2Z2N0b2F4cGJ1a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MTI3NTAsImV4cCI6MjA3MDQ4ODc1MH0.tM1vDVVhYhh7OHlA1BTj071BfsIzeBG_HatijjtxwLw';
        
        // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ï¼ˆå¿…è¦æœ€å°é™ã®æ¨©é™ï¼‰
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ç®¡ç†è€…PINã‚³ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®é‹ç”¨ã§ã¯ç’°å¢ƒå¤‰æ•°ç­‰ã§ç®¡ç†ï¼‰
        const ADMIN_PIN = '999999';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let stores = [];
        let editMap = null;
        let editMarker = null;
        let selectedStoreId = null;
        let deleteTargetId = null;
        let approvedUsers = []; // æ‰¿èªæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            const isAuthenticated = localStorage.getItem('adminAuth');
            if (isAuthenticated) {
                await showAdminPanel();
            }
            
            // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³PIN
            document.getElementById('adminPin').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') adminLogin();
            });
        });
        
        // ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
        async function adminLogin() {
            const pin = document.getElementById('adminPin').value;
            
            if (pin === ADMIN_PIN) {
                localStorage.setItem('adminAuth', 'true');
                await showAdminPanel();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('adminPin').value = '';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            }
        }
        
        // ç®¡ç†ç”»é¢è¡¨ç¤º
        async function showAdminPanel() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            await loadStoresData();
            await loadUsersData();
            
            // åœ°å›³åˆæœŸåŒ–
            initEditMap();
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        function logout() {
            localStorage.removeItem('adminAuth');
            location.reload();
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function switchTab(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ãƒœã‚¿ãƒ³ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }
        
        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadStoresData() {
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ç·¨é›†ä¸­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°èª­ã¿è¾¼ã¿
            const savedData = localStorage.getItem('editingStores');
            if (savedData) {
                stores = JSON.parse(savedData);
                showToast('ç·¨é›†ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ', false);
            } else {
                // index.htmlã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
                stores = await getInitialStores();
            }
            
            displayStores();
        }
        
        // åˆæœŸåº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’index.htmlã‹ã‚‰å–å¾—
        async function getInitialStores() {
            try {
                // index.htmlã‹ã‚‰embeddedStoresãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const response = await fetch('./index.html');
                const htmlText = await response.text();
                
                // embeddedStoresã®é…åˆ—éƒ¨åˆ†ã‚’æŠ½å‡º
                const storesMatch = htmlText.match(/const embeddedStores = \[([\s\S]*?)\];/);
                
                if (storesMatch) {
                    // JSONå½¢å¼ã«å¤‰æ›ã—ã¦è§£æ
                    const storesArrayText = '[' + storesMatch[1] + ']';
                    const storesData = eval(storesArrayText); // æ³¨æ„: æœ¬ç•ªã§ã¯å®‰å…¨ãªæ–¹æ³•ã‚’ä½¿ç”¨
                    
                    console.log(`âœ… ${storesData.length}åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                    return storesData;
                }
            } catch (error) {
                console.warn('âš ï¸ index.htmlã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—:', error);
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬çš„ãªã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
            return [
                {
                    id: 1,
                    name: "æˆåŸçŸ³äº• åå¤å±‹è¿‘é‰„ãƒ‘ãƒƒã‚»åº—",
                    category: "è²©å£²åº—",
                    address: "æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­æ‘åŒºåé§…ï¼‘ä¸ç›®ï¼’âˆ’ï¼’ è¿‘é‰„ãƒ‘ãƒƒã‚»B1F",
                    latitude: 35.1709,
                    longitude: 136.8815,
                    phone: "052-5660-701",
                    website: "https://www.seijoishii.co.jp/",
                    description: "",
                    gluten_free_options: "",
                    opening_hours: "10:00-21:00"
                }
            ];
        }
        
        // åº—èˆ—ãƒªã‚¹ãƒˆè¡¨ç¤º
        function displayStores() {
            const list = document.getElementById('storesList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            const filteredStores = stores.filter(store => 
                store.name.toLowerCase().includes(searchTerm) ||
                store.address.toLowerCase().includes(searchTerm)
            );
            
            list.innerHTML = filteredStores.map(store => `
                <div class="store-item ${selectedStoreId === store.id ? 'selected' : ''}" onclick="selectStore(${store.id})">
                    <div class="store-info">
                        <div class="store-name">${store.name}</div>
                        <span class="store-category">${store.category}</span>
                        <div class="store-address">${store.address}</div>
                    </div>
                    <div class="store-actions">
                        <button class="icon-btn" onclick="editStore(${store.id}); event.stopPropagation();">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn delete" onclick="deleteStore(${store.id}); event.stopPropagation();">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('storeCount').textContent = filteredStores.length;
        }
        
        // åº—èˆ—æ¤œç´¢
        function filterStores() {
            displayStores();
        }
        
        // åº—èˆ—é¸æŠ
        function selectStore(id) {
            selectedStoreId = id;
            editStore(id);
        }
        
        // åº—èˆ—ç·¨é›†
        function editStore(id) {
            console.log('ç·¨é›†é–‹å§‹ - åº—èˆ—ID:', id);
            const store = stores.find(s => s.id === id);
            if (!store) {
                console.error('åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', id);
                return;
            }
            
            selectedStoreId = id;
            
            try {
                // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
                document.getElementById('storeId').value = store.id;
                document.getElementById('storeName').value = store.name;
                document.getElementById('storeCategory').value = store.category;
                document.getElementById('storeAddress').value = store.address;
                document.getElementById('storeLat').value = store.latitude || '';
                document.getElementById('storeLng').value = store.longitude || '';
                document.getElementById('storePhone').value = store.phone || '';
                document.getElementById('storeWebsite').value = store.website || '';
                document.getElementById('storeImageUrl').value = store.image_url || '';
                document.getElementById('storeHours').value = store.opening_hours || '';
                document.getElementById('storeGfOptions').value = store.gluten_free_options || '';
                document.getElementById('storeDescription').value = store.description || '';
                
                console.log('ãƒ•ã‚©ãƒ¼ãƒ å€¤è¨­å®šå®Œäº†');
                
                // åœ°å›³æ›´æ–°ï¼ˆã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ãƒ•ã‚©ãƒ¼ãƒ ã¯å‹•ä½œã™ã‚‹ã‚ˆã†ã«ï¼‰
                if (store.latitude && store.longitude && typeof updateMapMarker === 'function') {
                    try {
                        updateMapMarker(store.latitude, store.longitude);
                    } catch (mapError) {
                        console.warn('åœ°å›³ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ç·¨é›†ã¯ç¶šè¡Œã§ãã¾ã™:', mapError);
                    }
                }
                
                displayStores();
                showToast('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã™', false);
            } catch (error) {
                console.error('ç·¨é›†ã‚¨ãƒ©ãƒ¼:', error);
                alert('ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        // æ–°è¦åº—èˆ—è¿½åŠ 
        function addNewStore() {
            const newId = Math.max(...stores.map(s => s.id), 0) + 1;
            
            const newStore = {
                id: newId,
                name: 'æ–°è¦åº—èˆ—',
                category: 'ã‚«ãƒ•ã‚§',
                address: '',
                latitude: null,
                longitude: null,
                phone: '',
                website: '',
                image_url: '',
                description: '',
                gluten_free_options: '',
                opening_hours: ''
            };
            
            stores.push(newStore);
            displayStores();
            editStore(newId);
            
            // åº—åå…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            document.getElementById('storeName').focus();
            document.getElementById('storeName').select();
        }
        
        // åº—èˆ—ä¿å­˜
        function saveStore() {
            const id = parseInt(document.getElementById('storeId').value);
            const storeIndex = stores.findIndex(s => s.id === id);
            
            if (storeIndex === -1) return;
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å€¤ã‚’å–å¾—
            stores[storeIndex] = {
                id: id,
                name: document.getElementById('storeName').value,
                category: document.getElementById('storeCategory').value,
                address: document.getElementById('storeAddress').value,
                latitude: parseFloat(document.getElementById('storeLat').value) || null,
                longitude: parseFloat(document.getElementById('storeLng').value) || null,
                phone: document.getElementById('storePhone').value,
                website: document.getElementById('storeWebsite').value,
                image_url: document.getElementById('storeImageUrl').value,
                opening_hours: document.getElementById('storeHours').value,
                gluten_free_options: document.getElementById('storeGfOptions').value,
                description: document.getElementById('storeDescription').value
            };
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            localStorage.setItem('editingStores', JSON.stringify(stores));
            
            displayStores();
            showToast('ä¿å­˜ã—ã¾ã—ãŸ');
        }
        
        // åº—èˆ—å‰Šé™¤
        function deleteStore(id) {
            deleteTargetId = id;
            document.getElementById('deleteModal').classList.add('active');
        }
        
        // å‰Šé™¤ç¢ºèª
        function confirmDelete() {
            if (deleteTargetId) {
                stores = stores.filter(s => s.id !== deleteTargetId);
                localStorage.setItem('editingStores', JSON.stringify(stores));
                
                if (selectedStoreId === deleteTargetId) {
                    resetForm();
                }
                
                displayStores();
                showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
                closeDeleteModal();
            }
        }
        
        // å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteTargetId = null;
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'deleteModal') {
                    closeDeleteModal();
                } else if (e.target.id === 'embeddedCodeModal') {
                    closeEmbeddedCodeModal();
                }
            }
        });
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetForm() {
            document.getElementById('editForm').reset();
            document.getElementById('storeId').value = '';
            selectedStoreId = null;
            
            if (editMarker) {
                editMap.removeLayer(editMarker);
                editMarker = null;
            }
            
            displayStores();
        }
        
        // åœ°å›³åˆæœŸåŒ–
        function initEditMap() {
            try {
                const mapElement = document.getElementById('editMap');
                if (!mapElement) {
                    console.warn('åœ°å›³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                editMap = L.map('editMap').setView([35.6762, 139.6503], 10);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(editMap);
                
                // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                editMap.on('click', function(e) {
                    updateMapMarker(e.latlng.lat, e.latlng.lng);
                    document.getElementById('storeLat').value = e.latlng.lat.toFixed(4);
                    document.getElementById('storeLng').value = e.latlng.lng.toFixed(4);
                });
                
                console.log('åœ°å›³åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('åœ°å›³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                console.warn('åœ°å›³æ©Ÿèƒ½ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ãŒã€ãã®ä»–ã®ç·¨é›†ã¯å¯èƒ½ã§ã™');
            }
        }
        
        // åœ°å›³ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
        function updateMapMarker(lat, lng) {
            try {
                if (!editMap) {
                    console.warn('åœ°å›³ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                if (editMarker) {
                    editMap.removeLayer(editMarker);
                }
                
                editMarker = L.marker([lat, lng]).addTo(editMap);
                editMap.setView([lat, lng], 15);
            } catch (error) {
                console.error('ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        function generateEmbeddedCode() {
            // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’JavaScripté…åˆ—å½¢å¼ã§ç”Ÿæˆ
            const embeddedCode = generateEmbeddedStoresArray();
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤º
            document.getElementById('embeddedCodeText').value = embeddedCode;
            document.getElementById('embeddedCodeModal').classList.add('active');
        }
        
        // embeddedStoresé…åˆ—ã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        function generateEmbeddedStoresArray() {
            let code = 'const embeddedStores = [\n';
            
            stores.forEach((store, index) => {
                code += '          {\n';
                code += `                    "id": ${store.id},\n`;
                code += `                    "name": "${escapeString(store.name)}",\n`;
                code += `                    "category": "${escapeString(store.category)}",\n`;
                code += `                    "address": "${escapeString(store.address)}",\n`;
                
                if (store.latitude) {
                    code += `                    "latitude": ${store.latitude},\n`;
                }
                if (store.longitude) {
                    code += `                    "longitude": ${store.longitude},\n`;
                }
                if (store.phone) {
                    code += `                    "phone": "${escapeString(store.phone)}",\n`;
                }
                if (store.website) {
                    code += `                    "website": "${escapeString(store.website)}",\n`;
                }
                if (store.description) {
                    code += `                    "description": "${escapeString(store.description)}",\n`;
                }
                if (store.gluten_free_options) {
                    code += `                    "gluten_free_options": "${escapeString(store.gluten_free_options)}",\n`;
                }
                if (store.opening_hours) {
                    code += `                    "opening_hours": "${escapeString(store.opening_hours)}"\n`;
                } else {
                    // æœ€å¾Œã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
                    code = code.replace(/,\n$/, '\n');
                }
                
                code += '          }';
                
                // æœ€å¾Œã®è¦ç´ ä»¥å¤–ã¯ã‚«ãƒ³ãƒã‚’è¿½åŠ 
                if (index < stores.length - 1) {
                    code += ',';
                }
                code += '\n';
            });
            
            code += '];';
            
            return code;
        }
        
        // æ–‡å­—åˆ—ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeString(str) {
            if (!str) return '';
            return str
                .replace(/\\/g, '\\\\')
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/\t/g, '\\t');
        }
        
        // åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        async function copyEmbeddedCode() {
            const codeText = document.getElementById('embeddedCodeText').value;
            
            try {
                await navigator.clipboard.writeText(codeText);
                showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            } catch (err) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’é¸æŠ
                document.getElementById('embeddedCodeText').select();
                document.execCommand('copy');
                showToast('ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã—ãŸã€‚Ctrl+Cã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„');
            }
        }
        
        // åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeEmbeddedCodeModal() {
            document.getElementById('embeddedCodeModal').classList.remove('active');
        }
        
        // JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportJSON() {
            const dataStr = JSON.stringify(stores, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `stores_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        }
        
        // JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        stores = importedData;
                        localStorage.setItem('editingStores', JSON.stringify(stores));
                        displayStores();
                        showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
                    } catch (error) {
                        showToast('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // è‡ªå‹•ä¿å­˜è¨­å®š
        const CLOUDFLARE_WORKER_URL = 'https://gluten-free-store-updater.bettger1000.workers.dev';
        
        // GitHubè‡ªå‹•ä¿å­˜æ©Ÿèƒ½
        async function autoSaveToGitHub() {
            const btn = document.getElementById('autoSaveBtn');
            const originalText = btn.innerHTML;
            
            // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';
            
            try {
                // 1. ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
                if (!stores || stores.length === 0) {
                    throw new Error('ä¿å­˜ã™ã‚‹åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                }
                
                // 2. Cloudflare WorkerçµŒç”±ã§GitHubã«ä¿å­˜
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stores: stores,
                        commitMessage: `ç®¡ç†ç”»é¢ã‹ã‚‰åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–° (${stores.length}ä»¶)`
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                // 3. æˆåŠŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                showToast(`âœ… è‡ªå‹•ä¿å­˜å®Œäº†ï¼${result.stores_count}ä»¶ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ`, false);
                console.log('âœ… GitHubæ›´æ–°æˆåŠŸ:', result);
                
                // 4. ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«æˆåŠŸçŠ¶æ…‹ã«
                btn.innerHTML = '<i class="fas fa-check"></i> ä¿å­˜å®Œäº†';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-warning');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-warning');
                    btn.disabled = false;
                }, 3000);
                
            } catch (error) {
                console.error('âŒ è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                showToast(`âŒ è‡ªå‹•ä¿å­˜å¤±æ•—: ${error.message}`, true);
                
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
                console.error('è©³ç´°ã‚¨ãƒ©ãƒ¼æƒ…å ±:', {
                    message: error.message,
                    workerUrl: CLOUDFLARE_WORKER_URL,
                    storesCount: stores ? stores.length : 'undefined'
                });
            }
        }
        
        // è‡ªå‹•ä¿å­˜ã®å¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        async function checkAutoSaveAvailability() {
            try {
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'OPTIONS'
                });
                
                if (response.ok) {
                    console.log('âœ… è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™');
                } else {
                    console.warn('âš ï¸ è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆWorkeræœªãƒ‡ãƒ—ãƒ­ã‚¤ã®å¯èƒ½æ€§ï¼‰');
                    document.getElementById('autoSaveBtn').style.opacity = '0.6';
                }
            } catch (error) {
                console.warn('âš ï¸ è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ã®ç¢ºèªã«å¤±æ•—:', error.message);
                document.getElementById('autoSaveBtn').style.opacity = '0.6';
            }
        }
        
        // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.toggle('error', isError);
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ ==========
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadUsersData() {
            try {
                // LocalStorageã‹ã‚‰æ‰¿èªæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
                const savedUsers = localStorage.getItem('approvedUsers');
                if (savedUsers) {
                    approvedUsers = JSON.parse(savedUsers);
                } else {
                    // åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
                    approvedUsers = [
                        {
                            id: 1,
                            email: 'demo@example.com',
                            registeredAt: new Date().toISOString(),
                            hasPin: false
                        }
                    ];
                    saveUsersData();
                }
                
                displayUsersList();
                updateUserCount();
                
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                approvedUsers = [];
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆSupabaseã¨ã‚‚åŒæœŸï¼‰
        async function saveUsersData() {
            // LocalStorageã«ä¿å­˜
            localStorage.setItem('approvedUsers', JSON.stringify(approvedUsers));
            
            // Supabaseã«ã‚‚åŒæœŸï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã—ãªãŒã‚‰ï¼‰
            try {
                for (const user of approvedUsers) {
                    // æ—¢å­˜ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¿è­·
                    const { data: existingProfile } = await supabaseClient
                        .from('user_profiles')
                        .select('nickname')
                        .eq('email', user.email)
                        .single();
                    
                    const safeNickname = existingProfile?.nickname || (user.email.split('@')[0] || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼');
                    
                    await supabaseClient
                        .from('user_profiles')
                        .upsert({
                            email: user.email,
                            nickname: safeNickname,
                            is_active: true
                        });
                }
                console.log('âœ… Supabaseã¨åŒæœŸå®Œäº†');
            } catch (error) {
                console.warn('âš ï¸ SupabaseåŒæœŸã‚¨ãƒ©ãƒ¼ï¼ˆLocalStorageã«ã¯ä¿å­˜æ¸ˆã¿ï¼‰:', error);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º
        function displayUsersList() {
            const usersList = document.getElementById('usersList');
            
            if (approvedUsers.length === 0) {
                usersList.innerHTML = `
                    <div style="padding: var(--space-xl); text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: var(--space-md); opacity: 0.3;"></i>
                        <p>æ‰¿èªæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }

            usersList.innerHTML = approvedUsers.map(user => `
                <div class="user-item" data-user-id="${user.id}">
                    <div class="user-info">
                        <div class="user-email">
                            <i class="fas fa-envelope"></i>
                            ${user.email}
                        </div>
                        <div class="user-meta">
                            <span class="user-status ${user.hasPin ? 'status-registered' : 'status-pending'}">
                                <i class="fas ${user.hasPin ? 'fa-check-circle' : 'fa-clock'}"></i>
                                ${user.hasPin ? 'PINè¨­å®šæ¸ˆã¿' : 'PINæœªè¨­å®š'}
                            </span>
                            <span class="user-date">
                                ç™»éŒ²: ${new Date(user.registeredAt).toLocaleDateString('ja-JP')}
                            </span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-sm btn-secondary" onclick="resetUserPin(${user.id})" title="PIN ãƒªã‚»ãƒƒãƒˆ">
                            <i class="fas fa-key"></i>
                        </button>
                        <button class="btn btn-sm btn-error" onclick="deleteUser(${user.id})" title="å‰Šé™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°æ›´æ–°
        function updateUserCount() {
            document.getElementById('userCount').textContent = approvedUsers.length;
        }

        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
        function addNewUser() {
            const email = prompt('æ‰¿èªã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!email) return;

            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (approvedUsers.some(user => user.email === email)) {
                alert('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
            const newUser = {
                id: Date.now(),
                email: email,
                registeredAt: new Date().toISOString(),
                hasPin: false
            };

            approvedUsers.push(newUser);
            saveUsersData();
            displayUsersList();
            updateUserCount();

            showToast(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${email}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
        function deleteUser(userId) {
            const user = approvedUsers.find(u => u.id === userId);
            if (!user) return;

            if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.email}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                approvedUsers = approvedUsers.filter(u => u.id !== userId);
                saveUsersData();
                displayUsersList();
                updateUserCount();

                showToast(`ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.email}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼PINãƒªã‚»ãƒƒãƒˆ
        function resetUserPin(userId) {
            const user = approvedUsers.find(u => u.id === userId);
            if (!user) return;

            if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.email}ã€ã®PINã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ`)) {
                user.hasPin = false;
                saveUsersData();
                displayUsersList();

                showToast(`ğŸ”‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.email}ã€ã®PINã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ`);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const userItems = document.querySelectorAll('.user-item');

            userItems.forEach(item => {
                const email = item.querySelector('.user-email').textContent.toLowerCase();
                if (email.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ã®å¯ç”¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            setTimeout(checkAutoSaveAvailability, 1000); // 1ç§’å¾Œã«ãƒã‚§ãƒƒã‚¯
        });
    </script>
</body>
</html>