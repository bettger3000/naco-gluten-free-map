<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>管理画面 - グルテンフリーマップ</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #ff6b9d;
            --primary-dark: #e55a8a;
            --secondary: #40e0d0;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-primary: #fdf2f8;
            --bg-secondary: #f9fafb;
            --bg-glass: rgba(255, 255, 255, 0.95);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-light: #e5e7eb;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --space-xs: 0.5rem;
            --space-sm: 0.75rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }
        
        /* ログイン画面 */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg);
        }
        
        .login-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-lg);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        .login-title {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: var(--space-md);
        }
        
        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: var(--space-xl);
        }
        
        .input-group {
            margin-bottom: var(--space-lg);
            text-align: left;
        }
        
        .input-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: var(--space-xs);
            font-weight: 500;
        }
        
        .input-group input {
            width: 100%;
            padding: var(--space-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: var(--space-md);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .login-error {
            color: var(--error);
            font-size: 0.9rem;
            margin-bottom: var(--space-md);
            padding: var(--space-sm);
            background: rgba(239, 68, 68, 0.1);
            border-radius: var(--radius-sm);
            display: none;
        }
        
        /* 管理画面 */
        .admin-container {
            display: none;
            min-height: 100vh;
            background: var(--bg-secondary);
        }
        
        .admin-header {
            background: white;
            box-shadow: var(--shadow-md);
            padding: var(--space-md) var(--space-lg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* タブナビゲーション */
        .admin-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
        }

        .tab-btn {
            flex: 1;
            padding: var(--space-md) var(--space-lg);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .tab-btn:hover {
            background: rgba(255, 107, 157, 0.1);
            color: var(--primary);
        }

        .tab-btn.active {
            background: white;
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            font-weight: 600;
        }

        /* タブコンテンツ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ユーザー管理パネル */
        .users-panel {
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-light);
            transition: background-color 0.2s ease;
        }

        .user-item:hover {
            background: var(--bg-secondary);
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-info {
            flex: 1;
        }

        .user-email {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .user-meta {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            font-size: 0.85rem;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-registered {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .user-date {
            color: var(--text-secondary);
        }

        .user-actions {
            display: flex;
            gap: var(--space-xs);
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .btn-error {
            background: var(--error);
            color: white;
            border: 1px solid var(--error);
        }

        .btn-error:hover {
            background: #dc2626;
            border-color: #dc2626;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 700;
        }
        
        .header-actions {
            display: flex;
            gap: var(--space-md);
        }
        
        .btn {
            padding: var(--space-sm) var(--space-md);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
        }
        
        .btn-danger {
            background: var(--error);
            color: white;
        }
        
        /* メインコンテンツ */
        .admin-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-lg);
        }
        
        /* 店舗リスト */
        .stores-panel {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }
        
        .panel-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .store-count {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .search-box {
            padding: 0 var(--space-lg) var(--space-md);
        }
        
        .search-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }
        
        .stores-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .store-item {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .store-item:hover {
            background: var(--bg-primary);
        }
        
        .store-item.selected {
            background: var(--bg-primary);
            border-left: 4px solid var(--primary);
        }
        
        .store-info {
            flex: 1;
        }
        
        .store-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .store-category {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .store-address {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .store-actions {
            display: flex;
            gap: var(--space-xs);
        }
        
        .icon-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .icon-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .icon-btn.delete:hover {
            background: var(--error);
        }
        
        /* 編集フォーム */
        .edit-panel {
            background: white;
            border: 2px solid var(--primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--space-lg);
            min-height: 500px;
            overflow-y: auto;
            display: block !important;
            visibility: visible !important;
        }
        
        .form-group {
            margin-bottom: var(--space-lg);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--space-xs);
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--space-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }
        
        /* 地図 */
        .map-container {
            margin-bottom: var(--space-lg);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 2px solid var(--border-light);
        }
        
        #editMap {
            height: 300px;
            width: 100%;
        }
        
        .map-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }
        
        /* フォームボタン */
        .form-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-xl);
        }
        
        .form-actions .btn {
            flex: 1;
        }
        
        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 1.3rem;
            margin-bottom: var(--space-md);
            color: var(--primary);
        }
        
        .modal-body {
            margin-bottom: var(--space-lg);
        }
        
        .modal-actions {
            display: flex;
            gap: var(--space-sm);
            justify-content: flex-end;
        }
        
        /* トースト通知 */
        .toast {
            position: fixed;
            bottom: var(--space-lg);
            right: var(--space-lg);
            background: var(--success);
            color: white;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: var(--space-sm);
            z-index: 2000;
        }
        
        .toast.show {
            display: flex;
            animation: slideIn 0.3s ease;
        }
        
        .toast.error {
            background: var(--error);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* レスポンシブ */
        @media (max-width: 1024px) {
            #storesTab > div {
                grid-template-columns: 1fr !important;
            }
            
            .edit-panel {
                position: static;
                max-height: none;
                margin-top: var(--space-lg);
            }
        }
    </style>
</head>
<body>
    <!-- ログイン画面 -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <h1 class="login-title">🔐 管理画面</h1>
            <p class="login-subtitle">グルテンフリーマップ店舗管理</p>
            
            <div class="input-group">
                <label for="adminPin">管理者PINコード（6桁）</label>
                <input type="password" id="adminPin" placeholder="••••••" maxlength="6" pattern="[0-9]*" inputmode="numeric" onkeypress="if(event.key==='Enter'){
                    document.querySelector('.login-btn').click();
                }">
            </div>
            
            <div id="loginError" class="login-error">
                PINコードが正しくありません
            </div>
            
            <button class="login-btn" onclick="(async function(){
                const pin = document.getElementById('adminPin').value;
                if (pin === '999999') {
                    localStorage.setItem('adminAuth', 'true');
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('adminContainer').style.display = 'block';
                    
                    // 管理画面の初期化
                    if (typeof window.showAdminPanel === 'function') {
                        await window.showAdminPanel();
                    } else {
                        // フォールバック：基本的な初期化
                        if (typeof loadStoresData === 'function') await loadStoresData();
                        if (typeof loadUsersData === 'function') await loadUsersData();
                        if (typeof initEditMap === 'function') initEditMap();
                        if (typeof initializeGitHubFeatures === 'function') initializeGitHubFeatures();
                        if (typeof displayStoresList === 'function') displayStoresList();
                        
                        // CSVボタンのイベントリスナーを設定
                        setTimeout(() => {
                            const csvBtn = document.getElementById('csvUploadBtn');
                            if (csvBtn) {
                                csvBtn.onclick = function() {
                                    console.log('CSV button clicked via onclick');
                                    if (typeof window.showCsvUploadModal === 'function') {
                                        window.showCsvUploadModal();
                                    }
                                };
                                console.log('CSV button onclick handler attached');
                            }
                        }, 100);
                    }
                } else {
                    document.getElementById('loginError').style.display = 'block';
                    document.getElementById('adminPin').value = '';
                    setTimeout(() => {
                        document.getElementById('loginError').style.display = 'none';
                    }, 3000);
                }
            })()">
                <i class="fas fa-sign-in-alt"></i>
                ログイン
            </button>
        </div>
    </div>
    
    <!-- 管理画面 -->
    <div id="adminContainer" class="admin-container">
        <header class="admin-header">
            <div class="header-content">
                <h1 class="header-title">🗺️ グルテンフリーマップ管理画面</h1>
                <div class="header-actions">
                    <button class="btn btn-success" onclick="exportJSON()">
                        <i class="fas fa-download"></i>
                        JSONエクスポート
                    </button>
                    <button class="btn btn-primary" onclick="showGitHubSetup()" id="githubBtn">
                        <i class="fas fa-github"></i>
                        <span id="githubBtnText">GitHub連携</span>
                    </button>
                    <button class="btn btn-warning" onclick="deployToGitHub()" id="deployBtn" style="display: none;">
                        <i class="fas fa-rocket"></i>
                        本番デプロイ
                    </button>
                    <button class="btn btn-primary" onclick="generateEmbeddedCode()">
                        <i class="fas fa-code"></i>
                        埋め込みコード生成
                    </button>
                    <button class="btn btn-warning" onclick="autoSaveToGitHub()" id="autoSaveBtn">
                        <i class="fas fa-cloud-upload-alt"></i>
                        自動保存
                    </button>
                    <button class="btn btn-secondary" onclick="importJSON()">
                        <i class="fas fa-upload"></i>
                        JSONインポート
                    </button>
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        ログアウト
                    </button>
                </div>
            </div>
        </header>
        
        <!-- タブナビゲーション -->
        <nav class="admin-tabs">
            <button class="tab-btn active" data-tab="stores" onclick="switchTab('stores')">
                <i class="fas fa-store"></i>
                店舗管理
            </button>
            <button class="tab-btn" data-tab="users" onclick="switchTab('users')">
                <i class="fas fa-users"></i>
                ユーザー管理
            </button>
        </nav>
        
        <div class="admin-content">
            <!-- 店舗管理タブ -->
            <div id="storesTab" class="tab-content active">
                <div style="display: grid; grid-template-columns: 1fr 400px; gap: 20px; align-items: start;">
                    <!-- 店舗リスト -->
                    <div class="stores-panel">
                <div class="panel-header">
                    <h2 class="panel-title">店舗一覧</h2>
                    <span class="store-count">全<span id="storeCount">0</span>件</span>
                </div>
                
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="店名・住所で検索..." onkeyup="filterStores()">
                </div>
                
                <div class="stores-list" id="storesList">
                    <!-- 店舗リストがここに表示される -->
                </div>
                
                <div style="padding: var(--space-md); border-top: 1px solid var(--border-light);">
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: var(--space-sm);" onclick="addNewStore()">
                        <i class="fas fa-plus"></i>
                        新規店舗を追加
                    </button>
                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: var(--space-sm);" onclick="showGoogleMapModal()">
                        <i class="fab fa-google"></i>
                        Googleマップから追加
                    </button>
                    <button class="btn btn-success" id="csvUploadBtn" style="width: 100%;">
                        <i class="fas fa-file-csv"></i>
                        CSV一括アップロード
                    </button>
                </div>
                    </div>
                    
                    <!-- 編集フォーム -->
                    <div class="edit-panel">
                <h3 style="margin-bottom: var(--space-lg);">店舗情報編集</h3>
                
                <form id="editForm">
                    <input type="hidden" id="storeId">
                    
                    <div class="form-group">
                        <label class="form-label">店舗名 *</label>
                        <input type="text" class="form-input" id="storeName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">カテゴリー *</label>
                        <select class="form-select" id="storeCategory" required>
                            <option value="カフェ">☕ カフェ</option>
                            <option value="和食">🍱 和食</option>
                            <option value="洋食">🍽️ 洋食</option>
                            <option value="パン屋">🥐 パン屋</option>
                            <option value="スイーツ">🧁 スイーツ</option>
                            <option value="販売店">🛒 販売店</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">住所 *</label>
                        <input type="text" class="form-input" id="storeAddress" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">座標（地図をクリックして設定）</label>
                        <div class="map-container">
                            <div id="editMap"></div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm);">
                            <div>
                                <label class="form-label">緯度</label>
                                <input type="number" class="form-input" id="storeLat" step="0.0001">
                            </div>
                            <div>
                                <label class="form-label">経度</label>
                                <input type="number" class="form-input" id="storeLng" step="0.0001">
                            </div>
                        </div>
                        <p class="map-hint">💡 地図をクリックして位置を設定するか、座標を直接入力してください</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">電話番号</label>
                        <input type="tel" class="form-input" id="storePhone">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ウェブサイト</label>
                        <input type="url" class="form-input" id="storeWebsite">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Instagram URL</label>
                        <input type="url" class="form-input" id="storeInstagram" placeholder="https://instagram.com/...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">画像URL</label>
                        <input type="url" class="form-input" id="storeImageUrl" placeholder="店舗画像のURL">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">営業時間</label>
                        <input type="text" class="form-input" id="storeHours" placeholder="例: 11:00-20:00">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">グルテンフリー対応</label>
                        <textarea class="form-textarea" id="storeGfOptions" placeholder="グルテンフリーメニューの詳細など"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">説明</label>
                        <textarea class="form-textarea" id="storeDescription" placeholder="お店の特徴など"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-success" onclick="saveStore()">
                            <i class="fas fa-save"></i>
                            保存
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-times"></i>
                            キャンセル
                        </button>
                    </div>
                </form>
                    </div>
                </div>
            </div> <!-- 店舗管理タブ終了 -->
            
            <!-- ユーザー管理タブ -->
            <div id="usersTab" class="tab-content">
                <div class="users-panel">
                    <div class="panel-header">
                        <h2 class="panel-title">承認済みユーザー一覧</h2>
                        <span class="user-count">全<span id="userCount">0</span>件</span>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" class="search-input" id="userSearchInput" placeholder="メールアドレスで検索..." onkeyup="filterUsers()">
                    </div>
                    
                    <div class="users-list" id="usersList">
                        <!-- ユーザーリストがここに表示される -->
                    </div>
                    
                    <div style="padding: var(--space-md); border-top: 1px solid var(--border-light);">
                        <button class="btn btn-primary" style="width: 100%;" onclick="addNewUser()">
                            <i class="fas fa-user-plus"></i>
                            新規ユーザーを追加
                        </button>
                    </div>
                </div>
            </div>
    </div>
    
    <!-- 削除確認モーダル -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">削除確認</h3>
            <div class="modal-body">
                <p>この店舗を削除してもよろしいですか？</p>
                <p style="color: var(--error); margin-top: var(--space-sm);">※この操作は取り消せません</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">キャンセル</button>
                <button class="btn btn-danger" onclick="confirmDelete()">削除する</button>
            </div>
        </div>
    </div>

    <!-- GitHub設定モーダル -->
    <div id="githubModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">🚀 GitHub連携設定</h3>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">GitHub Personal Access Token</label>
                    <input type="password" class="form-input" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        <strong>必要な権限:</strong> repo (フルアクセス)<br>
                        <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--primary);">
                            <i class="fas fa-external-link-alt"></i> Personal Access Tokenを作成
                        </a>
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">リポジトリ情報</label>
                    <input type="text" class="form-input" id="repoOwner" placeholder="ユーザー名" value="bettger3000">
                    <input type="text" class="form-input" id="repoName" placeholder="リポジトリ名" style="margin-top: 0.5rem;" value="naco-gluten-free-map">
                    <input type="text" class="form-input" id="filePath" placeholder="ファイルパス" style="margin-top: 0.5rem;" value="data/embeddedStores.json">
                </div>
                
                <div id="githubStatus" style="margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; display: none;">
                    <i class="fas fa-info-circle"></i>
                    <span id="githubStatusText"></span>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeGitHubModal()">キャンセル</button>
                <button class="btn btn-success" onclick="testGitHubConnection()">接続テスト</button>
                <button class="btn btn-primary" onclick="saveGitHubSettings()">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 埋め込みコード表示モーダル -->
    <div id="embeddedCodeModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
            <h3 class="modal-title">📋 埋め込みコード（index.html用）</h3>
            <div class="modal-body">
                <p style="margin-bottom: var(--space-md); color: var(--text-secondary);">
                    以下のコードをindex.htmlの<code>const embeddedStores = [</code>から<code>];</code>まで置き換えてください
                </p>
                
                <div style="margin-bottom: var(--space-md);">
                    <button class="btn btn-primary" onclick="copyEmbeddedCode()" style="width: 100%;">
                        <i class="fas fa-copy"></i>
                        クリップボードにコピー
                    </button>
                </div>
                
                <textarea id="embeddedCodeText" readonly style="
                    width: 100%; 
                    height: 400px; 
                    font-family: 'Courier New', monospace; 
                    font-size: 0.85rem; 
                    border: 1px solid var(--border-light); 
                    border-radius: var(--radius-sm); 
                    padding: var(--space-md);
                    background: #f8f9fa;
                    resize: vertical;
                "></textarea>
                
                <div style="margin-top: var(--space-md); padding: var(--space-md); background: #e3f2fd; border-radius: var(--radius-sm);">
                    <h4 style="margin-bottom: var(--space-sm); color: #1976d2;">📝 更新手順</h4>
                    <ol style="margin-left: var(--space-lg); color: var(--text-secondary);">
                        <li>上記のコードをコピー</li>
                        <li>index.htmlを開く</li>
                        <li><code>const embeddedStores = [</code>を検索</li>
                        <li>配列の中身（<code>[</code>から<code>];</code>まで）を置き換え</li>
                        <li>ファイルを保存してGitにコミット・プッシュ</li>
                    </ol>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEmbeddedCodeModal()">閉じる</button>
            </div>
        </div>
    </div>
    
    <!-- トースト通知 -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">保存しました</span>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase JS（ユーザー管理同期用） -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- CSV Upload Module -->
    <script src="csv-upload.js"></script>
    
    <script>
        // Supabase設定（読み取り専用で安全）
        const SUPABASE_URL = 'https://hxrmsjfvgctoaxpbukvo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4cm1zamZ2Z2N0b2F4cGJ1a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MTI3NTAsImV4cCI6MjA3MDQ4ODc1MH0.tM1vDVVhYhh7OHlA1BTj071BfsIzeBG_HatijjtxwLw';
        
        // Supabaseクライアント初期化（必要最小限の権限）
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // 管理者PINコード（実際の運用では環境変数等で管理）
        const ADMIN_PIN = '999999';
        
        // グローバル変数
        let stores = [];
        let editMap = null;
        let editMarker = null;
        let selectedStoreId = null;
        let deleteTargetId = null;
        let approvedUsers = []; // 承認済みユーザー一覧
        
        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            // 認証チェック
            const isAuthenticated = localStorage.getItem('adminAuth');
            if (isAuthenticated) {
                await showAdminPanel();
            }
            
            // ログインボタンのイベントリスナー
            const loginBtn = document.getElementById('loginButton');
            if (loginBtn) {
                loginBtn.addEventListener('click', adminLogin);
            }
            
            // EnterキーでログインPIN
            const pinInput = document.getElementById('adminPin');
            if (pinInput) {
                pinInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') adminLogin();
                });
            }
        });
        
        // 管理者ログイン
        window.adminLogin = async function() {
            const pin = document.getElementById('adminPin').value;
            
            if (pin === ADMIN_PIN) {
                localStorage.setItem('adminAuth', 'true');
                await showAdminPanel();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('adminPin').value = '';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            }
        }
        
        // 管理画面表示
        window.showAdminPanel = async function() {
            console.log('showAdminPanel called');
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            
            // データ読み込み
            console.log('About to load stores data');
            await loadStoresData();
            console.log('Stores data loaded');
            await loadUsersData();
            
            // 地図初期化
            initEditMap();
            
            // GitHub機能初期化
            initializeGitHubFeatures();
            
            // CSVアップロードボタンのイベントリスナーを設定
            setTimeout(() => {
                const csvBtn = document.getElementById('csvUploadBtn');
                if (csvBtn) {
                    // 既存のイベントリスナーを削除
                    csvBtn.removeEventListener('click', csvBtn.csvClickHandler);
                    
                    // 新しいイベントリスナーを設定
                    csvBtn.csvClickHandler = function() {
                        console.log('CSV button clicked - calling showCsvUploadModal');
                        if (typeof window.showCsvUploadModal === 'function') {
                            window.showCsvUploadModal();
                        } else {
                            console.error('showCsvUploadModal function not found');
                        }
                    };
                    csvBtn.addEventListener('click', csvBtn.csvClickHandler);
                    console.log('CSV button event listener attached in showAdminPanel');
                } else {
                    console.error('CSV button not found in showAdminPanel');
                }
            }, 100);
            
            console.log('Admin panel initialization complete');
        }
        
        // ログアウト
        window.logout = function() {
            localStorage.removeItem('adminAuth');
            location.reload();
        }

        // タブ切り替え機能
        window.switchTab = function(tabName) {
            // すべてのタブボタンからactiveクラスを削除
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // すべてのタブコンテンツを非表示
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 選択されたタブボタンにactiveクラスを追加
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // 選択されたタブコンテンツを表示
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }
        
        // 店舗データ読み込み
        async function loadStoresData() {
            console.log('loadStoresData called');
            // ローカルストレージから編集中データがあれば読み込み
            const savedData = localStorage.getItem('editingStores');
            if (savedData) {
                stores = JSON.parse(savedData);
                console.log('Loaded from localStorage:', stores.length, 'stores');
                showToast('編集中のデータを復元しました', false);
            } else {
                // index.htmlからデータをコピー
                console.log('Loading initial stores...');
                stores = await getInitialStores();
                console.log('Loaded initial stores:', stores.length);
            }
            
            console.log('About to call displayStoresList');
            displayStoresList();
        }
        
        // 初期店舗データをJSONファイルから安全に取得
        async function getInitialStores() {
            const fallbackChain = [
                './data/embeddedStores.json',
                './embeddedStores.json', // バックアップ場所
            ];
            
            for (const url of fallbackChain) {
                try {
                    console.log(`📡 データ読み込み試行: ${url}`);
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const storesData = await response.json();
                    
                    // データ検証
                    if (!Array.isArray(storesData) || storesData.length === 0) {
                        throw new Error('無効なデータ形式または空のデータ');
                    }
                    
                    // 必須フィールドチェック
                    const validStores = storesData.filter(store => 
                        store.id && store.name && store.address
                    );
                    
                    if (validStores.length !== storesData.length) {
                        console.warn(`⚠️ ${storesData.length - validStores.length}件の不正なデータをスキップしました`);
                    }
                    
                    console.log(`✅ ${validStores.length}店舗のデータを読み込みました (${url})`);
                    return validStores;
                    
                } catch (error) {
                    console.warn(`⚠️ ${url}からのデータ読み込み失敗:`, error.message);
                }
            }
            
            // 最終フォールバック: 最小限のサンプルデータ
            console.error('❌ すべてのデータソースが利用できません。サンプルデータを使用します。');
            return getMinimalSampleData();
        }
        
        // 最小限のサンプルデータ
        function getMinimalSampleData() {
            return [
                {
                    id: 1,
                    name: "サンプル店舗",
                    category: "カフェ",
                    address: "愛知県名古屋市中区栄",
                    latitude: 35.1681,
                    longitude: 136.9069,
                    phone: "",
                    website: "",
                    image_url: "",
                    description: "これはサンプルデータです。実際のデータを読み込んでください。",
                    gluten_free_options: "",
                    opening_hours: ""
                }
            ];
        }
        
        // 店舗リスト表示
        function displayStoresList() {
            console.log('displayStoresList called, stores count:', stores.length);
            const list = document.getElementById('storesList');
            if (!list) {
                console.error('storesList element not found!');
                return;
            }
            
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            const filteredStores = stores.filter(store => 
                store.name.toLowerCase().includes(searchTerm) ||
                store.address.toLowerCase().includes(searchTerm)
            );
            console.log('Filtered stores count:', filteredStores.length);
            
            list.innerHTML = filteredStores.map(store => `
                <div class="store-item ${selectedStoreId === store.id ? 'selected' : ''}" onclick="selectStore(${store.id})">
                    <div class="store-info">
                        <div class="store-name">${store.name}</div>
                        <span class="store-category">${store.category}</span>
                        <div class="store-address">${store.address}</div>
                    </div>
                    <div class="store-actions">
                        <button class="icon-btn" onclick="editStore(${store.id}); event.stopPropagation();">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn delete" onclick="deleteStore(${store.id}); event.stopPropagation();">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('storeCount').textContent = filteredStores.length;
        }
        
        // 店舗検索
        function filterStores() {
            displayStoresList();
        }
        
        // 店舗選択
        function selectStore(id) {
            selectedStoreId = id;
            editStore(id);
        }
        
        // 店舗編集
        function editStore(id) {
            console.log('編集開始 - 店舗ID:', id);
            const store = stores.find(s => s.id === id);
            if (!store) {
                console.error('店舗が見つかりません:', id);
                return;
            }
            
            selectedStoreId = id;
            
            try {
                // フォームに値をセット
                const formElements = {
                    storeId: document.getElementById('storeId'),
                    storeName: document.getElementById('storeName'),
                    storeCategory: document.getElementById('storeCategory'),
                    storeAddress: document.getElementById('storeAddress'),
                    storeLat: document.getElementById('storeLat'),
                    storeLng: document.getElementById('storeLng'),
                    storePhone: document.getElementById('storePhone'),
                    storeWebsite: document.getElementById('storeWebsite'),
                    storeInstagram: document.getElementById('storeInstagram'),
                    storeImageUrl: document.getElementById('storeImageUrl'),
                    storeHours: document.getElementById('storeHours'),
                    storeGfOptions: document.getElementById('storeGfOptions'),
                    storeDescription: document.getElementById('storeDescription')
                };
                
                // 要素の存在チェック
                for (const [key, element] of Object.entries(formElements)) {
                    if (!element) {
                        console.error(`フォーム要素が見つかりません: ${key}`);
                    }
                }
                
                // 値の設定
                if (formElements.storeId) formElements.storeId.value = store.id;
                if (formElements.storeName) formElements.storeName.value = store.name;
                if (formElements.storeCategory) formElements.storeCategory.value = store.category;
                if (formElements.storeAddress) formElements.storeAddress.value = store.address;
                if (formElements.storeLat) formElements.storeLat.value = store.latitude || '';
                if (formElements.storeLng) formElements.storeLng.value = store.longitude || '';
                if (formElements.storePhone) formElements.storePhone.value = store.phone || '';
                if (formElements.storeWebsite) formElements.storeWebsite.value = store.website || '';
                if (formElements.storeInstagram) formElements.storeInstagram.value = store.instagram || '';
                if (formElements.storeImageUrl) formElements.storeImageUrl.value = store.image_url || '';
                if (formElements.storeHours) formElements.storeHours.value = store.opening_hours || '';
                if (formElements.storeGfOptions) formElements.storeGfOptions.value = store.gluten_free_options || '';
                if (formElements.storeDescription) formElements.storeDescription.value = store.description || '';
                
                // 編集パネルを表示（visibility確認）
                const editPanel = document.querySelector('.edit-panel');
                if (editPanel) {
                    console.log('編集パネルの表示状態:', {
                        display: window.getComputedStyle(editPanel).display,
                        visibility: window.getComputedStyle(editPanel).visibility,
                        opacity: window.getComputedStyle(editPanel).opacity
                    });
                    
                    // スクロールして編集フォームを表示
                    editPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                console.log('フォーム値設定完了 - 店舗名:', formElements.storeName?.value);
                
                // 入力フィールドが編集可能かチェック
                if (formElements.storeName) {
                    console.log('店舗名フィールドの状態:', {
                        disabled: formElements.storeName.disabled,
                        readOnly: formElements.storeName.readOnly,
                        value: formElements.storeName.value,
                        type: formElements.storeName.type
                    });
                    
                    // 強制的に編集可能にする
                    formElements.storeName.disabled = false;
                    formElements.storeName.readOnly = false;
                }
                
                // 地図更新（エラーがあってもフォームは動作するように）
                if (store.latitude && store.longitude && typeof updateMapMarker === 'function') {
                    try {
                        updateMapMarker(store.latitude, store.longitude);
                    } catch (mapError) {
                        console.warn('地図の更新に失敗しましたが、編集は続行できます:', mapError);
                    }
                }
                
                displayStoresList();
                showToast('編集モードです', false);
                
                // 最初の入力フィールドにフォーカス
                setTimeout(() => {
                    if (formElements.storeName && !formElements.storeName.disabled) {
                        formElements.storeName.focus();
                        formElements.storeName.select();
                        console.log('店舗名フィールドにフォーカスを設定しました');
                    }
                }, 100);
            } catch (error) {
                console.error('編集エラー:', error);
                alert('編集フォームの表示に失敗しました。コンソールを確認してください。');
            }
        }
        
        // 新規店舗追加
        function addNewStore() {
            const newId = Math.max(...stores.map(s => s.id), 0) + 1;
            
            const newStore = {
                id: newId,
                name: '新規店舗',
                category: 'カフェ',
                address: '',
                latitude: null,
                longitude: null,
                phone: '',
                website: '',
                image_url: '',
                description: '',
                gluten_free_options: '',
                opening_hours: ''
            };
            
            stores.push(newStore);
            displayStoresList();
            editStore(newId);
            
            // 店名入力欄にフォーカス
            document.getElementById('storeName').focus();
            document.getElementById('storeName').select();
        }
        
        // 店舗保存（エラーハンドリング強化）
        function saveStore() {
            try {
                const id = parseInt(document.getElementById('storeId').value);
                if (!id || isNaN(id)) {
                    throw new Error('無効な店舗IDです');
                }
                
                const storeIndex = stores.findIndex(s => s.id === id);
                if (storeIndex === -1) {
                    throw new Error('店舗が見つかりません');
                }
                
                // フォームデータの検証
                const formData = getFormData();
                validateStoreData(formData);
                
                // データを更新
                stores[storeIndex] = formData;
                
                // ローカルストレージに保存
                localStorage.setItem('editingStores', JSON.stringify(stores));
                localStorage.setItem('lastSaved', new Date().toISOString());
                
                displayStoresList();
                showToast(`店舗「${formData.name}」を保存しました`, false);
                
                console.log('✅ 店舗保存完了:', formData.name);
                
            } catch (error) {
                console.error('❌ 店舗保存エラー:', error);
                showToast(`保存に失敗しました: ${error.message}`, true);
            }
        }
        
        // フォームデータを安全に取得
        function getFormData() {
            const getValue = (id) => {
                const element = document.getElementById(id);
                return element ? element.value.trim() : '';
            };
            
            const getNumberValue = (id) => {
                const value = getValue(id);
                return value ? parseFloat(value) : null;
            };
            
            return {
                id: parseInt(getValue('storeId')),
                name: getValue('storeName'),
                category: getValue('storeCategory'),
                address: getValue('storeAddress'),
                latitude: getNumberValue('storeLat'),
                longitude: getNumberValue('storeLng'),
                phone: getValue('storePhone'),
                website: getValue('storeWebsite'),
                instagram: getValue('storeInstagram'),
                image_url: getValue('storeImageUrl'),
                opening_hours: getValue('storeHours'),
                gluten_free_options: getValue('storeGfOptions'),
                description: getValue('storeDescription')
            };
        }
        
        // 店舗データの検証
        function validateStoreData(data) {
            if (!data.name) {
                throw new Error('店舗名は必須です');
            }
            
            if (!data.category) {
                throw new Error('カテゴリーは必須です');
            }
            
            if (!data.address) {
                throw new Error('住所は必須です');
            }
            
            if (data.latitude && (data.latitude < -90 || data.latitude > 90)) {
                throw new Error('緯度は-90から90の間で入力してください');
            }
            
            if (data.longitude && (data.longitude < -180 || data.longitude > 180)) {
                throw new Error('経度は-180から180の間で入力してください');
            }
            
            if (data.website && !isValidUrl(data.website)) {
                throw new Error('ウェブサイトのURLが無効です');
            }
            
            if (data.image_url && !isValidUrl(data.image_url)) {
                throw new Error('画像URLが無効です');
            }
        }
        
        // URL検証
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        // 店舗削除
        function deleteStore(id) {
            deleteTargetId = id;
            document.getElementById('deleteModal').classList.add('active');
        }
        
        // 削除確認
        function confirmDelete() {
            if (deleteTargetId) {
                stores = stores.filter(s => s.id !== deleteTargetId);
                localStorage.setItem('editingStores', JSON.stringify(stores));
                
                if (selectedStoreId === deleteTargetId) {
                    resetForm();
                }
                
                displayStoresList();
                showToast('削除しました');
                closeDeleteModal();
            }
        }
        
        // 削除モーダルを閉じる
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteTargetId = null;
        }
        
        // モーダル外クリックで閉じる
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'deleteModal') {
                    closeDeleteModal();
                } else if (e.target.id === 'embeddedCodeModal') {
                    closeEmbeddedCodeModal();
                }
            }
        });
        
        // フォームリセット
        function resetForm() {
            document.getElementById('editForm').reset();
            document.getElementById('storeId').value = '';
            selectedStoreId = null;
            
            if (editMarker) {
                editMap.removeLayer(editMarker);
                editMarker = null;
            }
            
            displayStoresList();
        }
        
        // 地図初期化
        function initEditMap() {
            try {
                const mapElement = document.getElementById('editMap');
                if (!mapElement) {
                    console.warn('地図要素が見つかりません');
                    return;
                }
                
                editMap = L.map('editMap').setView([35.6762, 139.6503], 10);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(editMap);
                
                // 地図クリックイベント
                editMap.on('click', function(e) {
                    updateMapMarker(e.latlng.lat, e.latlng.lng);
                    document.getElementById('storeLat').value = e.latlng.lat.toFixed(4);
                    document.getElementById('storeLng').value = e.latlng.lng.toFixed(4);
                });
                
                console.log('地図初期化完了');
            } catch (error) {
                console.error('地図の初期化に失敗しました:', error);
                console.warn('地図機能は使用できませんが、その他の編集は可能です');
            }
        }
        
        // 地図マーカー更新
        function updateMapMarker(lat, lng) {
            try {
                if (!editMap) {
                    console.warn('地図が初期化されていません');
                    return;
                }
                
                if (editMarker) {
                    editMap.removeLayer(editMarker);
                }
                
                editMarker = L.marker([lat, lng]).addTo(editMap);
                editMap.setView([lat, lng], 15);
            } catch (error) {
                console.error('マーカー更新エラー:', error);
            }
        }
        
        // 埋め込みコード生成
        function generateEmbeddedCode() {
            // 店舗データをJavaScript配列形式で生成
            const embeddedCode = generateEmbeddedStoresArray();
            
            // モーダルに表示
            document.getElementById('embeddedCodeText').value = embeddedCode;
            document.getElementById('embeddedCodeModal').classList.add('active');
        }
        
        // embeddedStores配列のコード生成
        function generateEmbeddedStoresArray() {
            let code = 'const embeddedStores = [\n';
            
            stores.forEach((store, index) => {
                code += '          {\n';
                code += `                    "id": ${store.id},\n`;
                code += `                    "name": "${escapeString(store.name)}",\n`;
                code += `                    "category": "${escapeString(store.category)}",\n`;
                code += `                    "address": "${escapeString(store.address)}",\n`;
                
                if (store.latitude) {
                    code += `                    "latitude": ${store.latitude},\n`;
                }
                if (store.longitude) {
                    code += `                    "longitude": ${store.longitude},\n`;
                }
                if (store.phone) {
                    code += `                    "phone": "${escapeString(store.phone)}",\n`;
                }
                if (store.website) {
                    code += `                    "website": "${escapeString(store.website)}",\n`;
                    code += `                    "instagram": "${escapeString(store.instagram)}",\n`;
                }
                if (store.description) {
                    code += `                    "description": "${escapeString(store.description)}",\n`;
                }
                if (store.gluten_free_options) {
                    code += `                    "gluten_free_options": "${escapeString(store.gluten_free_options)}",\n`;
                }
                if (store.opening_hours) {
                    code += `                    "opening_hours": "${escapeString(store.opening_hours)}"\n`;
                } else {
                    // 最後のカンマを削除
                    code = code.replace(/,\n$/, '\n');
                }
                
                code += '          }';
                
                // 最後の要素以外はカンマを追加
                if (index < stores.length - 1) {
                    code += ',';
                }
                code += '\n';
            });
            
            code += '];';
            
            return code;
        }
        
        // 文字列エスケープ
        function escapeString(str) {
            if (!str) return '';
            return str
                .replace(/\\/g, '\\\\')
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/\t/g, '\\t');
        }
        
        // 埋め込みコードをクリップボードにコピー
        async function copyEmbeddedCode() {
            const codeText = document.getElementById('embeddedCodeText').value;
            
            try {
                await navigator.clipboard.writeText(codeText);
                showToast('クリップボードにコピーしました');
            } catch (err) {
                // フォールバック: テキストエリアを選択
                document.getElementById('embeddedCodeText').select();
                document.execCommand('copy');
                showToast('コードを選択しました。Ctrl+Cでコピーしてください');
            }
        }
        
        // 埋め込みコードモーダルを閉じる
        function closeEmbeddedCodeModal() {
            document.getElementById('embeddedCodeModal').classList.remove('active');
        }
        
        // JSONエクスポート
        function exportJSON() {
            const dataStr = JSON.stringify(stores, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `stores_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('JSONファイルをダウンロードしました');
        }

        // ===========================================
        // GitHub API統合機能
        // ===========================================
        
        // GitHub設定モーダルを表示
        function showGitHubSetup() {
            loadGitHubSettings();
            document.getElementById('githubModal').classList.add('active');
        }
        
        // GitHub設定モーダルを閉じる
        function closeGitHubModal() {
            document.getElementById('githubModal').classList.remove('active');
        }
        
        // GitHub設定を読み込み
        function loadGitHubSettings() {
            const settings = getGitHubSettings();
            if (settings) {
                document.getElementById('githubToken').value = settings.token || '';
                document.getElementById('repoOwner').value = settings.owner || 'bettger3000';
                document.getElementById('repoName').value = settings.repo || 'naco-gluten-free-map';
                document.getElementById('filePath').value = settings.filePath || 'data/embeddedStores.json';
            }
            updateGitHubUI();
        }
        
        // GitHub設定を取得
        function getGitHubSettings() {
            const settings = localStorage.getItem('githubSettings');
            return settings ? JSON.parse(settings) : null;
        }
        
        // GitHub設定を保存
        function saveGitHubSettings() {
            const settings = {
                token: document.getElementById('githubToken').value.trim(),
                owner: document.getElementById('repoOwner').value.trim(),
                repo: document.getElementById('repoName').value.trim(),
                filePath: document.getElementById('filePath').value.trim()
            };
            
            if (!settings.token || !settings.owner || !settings.repo || !settings.filePath) {
                showGitHubStatus('すべての項目を入力してください', 'error');
                return;
            }
            
            localStorage.setItem('githubSettings', JSON.stringify(settings));
            updateGitHubUI();
            closeGitHubModal();
            showToast('GitHub設定を保存しました', false);
        }
        
        // GitHub接続テスト
        async function testGitHubConnection() {
            const settings = {
                token: document.getElementById('githubToken').value.trim(),
                owner: document.getElementById('repoOwner').value.trim(),
                repo: document.getElementById('repoName').value.trim(),
                filePath: document.getElementById('filePath').value.trim()
            };
            
            if (!settings.token || !settings.owner || !settings.repo) {
                showGitHubStatus('必要な情報を入力してください', 'error');
                return;
            }
            
            showGitHubStatus('接続テスト中...', 'info');
            
            try {
                // リポジトリ情報を取得してテスト
                const response = await fetch(`https://api.github.com/repos/${settings.owner}/${settings.repo}`, {
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`${response.status}: ${error.message || response.statusText}`);
                }
                
                const repoData = await response.json();
                showGitHubStatus(`✅ 接続成功: ${repoData.full_name}`, 'success');
                
                // ファイルの存在確認
                await testFileAccess(settings);
                
            } catch (error) {
                console.error('GitHub接続エラー:', error);
                showGitHubStatus(`❌ 接続失敗: ${error.message}`, 'error');
            }
        }
        
        // ファイルアクセステスト
        async function testFileAccess(settings) {
            try {
                const response = await fetch(`https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.filePath}`, {
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    showGitHubStatus('✅ 接続成功: ファイルアクセス確認', 'success');
                } else if (response.status === 404) {
                    showGitHubStatus('⚠️ 接続成功: ファイルが存在しません（新規作成されます）', 'warning');
                } else {
                    throw new Error(`ファイルアクセス失敗: ${response.status}`);
                }
            } catch (error) {
                showGitHubStatus(`⚠️ ファイルアクセス確認失敗: ${error.message}`, 'warning');
            }
        }
        
        // GitHubステータス表示
        function showGitHubStatus(message, type) {
            const statusDiv = document.getElementById('githubStatus');
            const statusText = document.getElementById('githubStatusText');
            
            statusDiv.style.display = 'block';
            statusText.textContent = message;
            
            statusDiv.className = '';
            statusDiv.style.backgroundColor = {
                'success': '#d4edda',
                'error': '#f8d7da',
                'warning': '#fff3cd',
                'info': '#d1ecf1'
            }[type] || '#f8f9fa';
            
            statusDiv.style.color = {
                'success': '#155724',
                'error': '#721c24',
                'warning': '#856404',
                'info': '#0c5460'
            }[type] || '#333';
        }
        
        // GitHub UI更新
        function updateGitHubUI() {
            const settings = getGitHubSettings();
            const githubBtn = document.getElementById('githubBtn');
            const githubBtnText = document.getElementById('githubBtnText');
            const deployBtn = document.getElementById('deployBtn');
            
            if (settings && settings.token) {
                githubBtnText.textContent = '⚡ GitHub連携済み';
                githubBtn.classList.remove('btn-primary');
                githubBtn.classList.add('btn-success');
                deployBtn.style.display = 'inline-block';
            } else {
                githubBtnText.textContent = 'GitHub連携';
                githubBtn.classList.remove('btn-success');
                githubBtn.classList.add('btn-primary');
                deployBtn.style.display = 'none';
            }
        }

        // 本番デプロイ（GitHub経由）
        async function deployToGitHub() {
            const settings = getGitHubSettings();
            if (!settings || !settings.token) {
                showToast('GitHub設定が必要です', true);
                showGitHubSetup();
                return;
            }
            
            if (!confirm(`🚀 本番デプロイを実行しますか？\n\n${stores.length}店舗のデータが本番サイトに反映されます。\n\n※この操作は取り消せません。`)) {
                return;
            }
            
            const deployBtn = document.getElementById('deployBtn');
            const originalText = deployBtn.innerHTML;
            
            try {
                deployBtn.disabled = true;
                deployBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> デプロイ中...';
                
                console.log('🚀 デプロイ開始:', stores.length, '店舗');
                
                // 1. 現在のファイル情報を取得
                const currentFile = await getCurrentFileInfo(settings);
                
                // 2. データを準備
                const jsonData = JSON.stringify(stores, null, 2);
                const base64Content = btoa(unescape(encodeURIComponent(jsonData)));
                
                // 3. GitHubにプッシュ
                const commitMessage = `店舗データ更新 (${stores.length}店舗) - ${new Date().toLocaleString('ja-JP')}`;
                await updateGitHubFile(settings, base64Content, commitMessage, currentFile?.sha);
                
                console.log('✅ デプロイ完了');
                showToast('🚀 本番デプロイが完了しました！', false);
                
                // 4. GitHub Pages の更新を待つ
                setTimeout(() => {
                    showToast('GitHub Pagesの更新には1-2分かかります', false);
                }, 2000);
                
            } catch (error) {
                console.error('❌ デプロイエラー:', error);
                showToast(`デプロイに失敗しました: ${error.message}`, true);
            } finally {
                deployBtn.disabled = false;
                deployBtn.innerHTML = originalText;
            }
        }
        
        // 現在のファイル情報を取得
        async function getCurrentFileInfo(settings) {
            try {
                const response = await fetch(`https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.filePath}`, {
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const fileData = await response.json();
                    console.log('📄 現在のファイル情報取得:', fileData.name);
                    return fileData;
                } else if (response.status === 404) {
                    console.log('📄 新規ファイルとして作成します');
                    return null;
                } else {
                    throw new Error(`ファイル情報取得失敗: ${response.status}`);
                }
            } catch (error) {
                console.error('ファイル情報取得エラー:', error);
                return null;
            }
        }
        
        // GitHubファイルを更新
        async function updateGitHubFile(settings, content, message, sha) {
            const requestBody = {
                message: message,
                content: content,
                branch: 'main'
            };
            
            // 既存ファイルの場合はSHAを追加
            if (sha) {
                requestBody.sha = sha;
            }
            
            const response = await fetch(`https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.filePath}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${settings.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(`GitHub API エラー: ${error.message || response.statusText}`);
            }
            
            const result = await response.json();
            console.log('✅ ファイル更新完了:', result.commit.sha);
            return result;
        }
        
        // 管理画面読み込み時の初期化
        function initializeGitHubFeatures() {
            updateGitHubUI();
            
            // GitHub設定がある場合、接続状態を表示
            const settings = getGitHubSettings();
            if (settings && settings.token) {
                console.log('⚡ GitHub連携が設定されています');
            }
        }
        
        // JSONインポート
        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        stores = importedData;
                        localStorage.setItem('editingStores', JSON.stringify(stores));
                        displayStoresList();
                        showToast('インポートしました');
                    } catch (error) {
                        showToast('JSONファイルの読み込みに失敗しました', true);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // 自動保存設定
        const CLOUDFLARE_WORKER_URL = 'https://gluten-free-store-updater.bettger1000.workers.dev';
        
        // GitHub自動保存機能
        async function autoSaveToGitHub() {
            const btn = document.getElementById('autoSaveBtn');
            const originalText = btn.innerHTML;
            
            // ボタンをローディング状態に
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
            
            try {
                // 1. データ検証
                if (!stores || stores.length === 0) {
                    throw new Error('保存する店舗データがありません');
                }
                
                // 2. Cloudflare Worker経由でGitHubに保存
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stores: stores,
                        commitMessage: `管理画面から店舗データを更新 (${stores.length}件)`
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                // 3. 成功フィードバック
                showToast(`✅ 自動保存完了！${result.stores_count}件の店舗データを更新しました`, false);
                console.log('✅ GitHub更新成功:', result);
                
                // 4. ボタンを一時的に成功状態に
                btn.innerHTML = '<i class="fas fa-check"></i> 保存完了';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-warning');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-warning');
                    btn.disabled = false;
                }, 3000);
                
            } catch (error) {
                console.error('❌ 自動保存エラー:', error);
                
                // エラーフィードバック
                showToast(`❌ 自動保存失敗: ${error.message}`, true);
                
                // ボタンを元の状態に戻す
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // エラー詳細をコンソールに表示
                console.error('詳細エラー情報:', {
                    message: error.message,
                    workerUrl: CLOUDFLARE_WORKER_URL,
                    storesCount: stores ? stores.length : 'undefined'
                });
            }
        }
        
        // 自動保存の可用性チェック（オプション）
        async function checkAutoSaveAvailability() {
            try {
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'OPTIONS'
                });
                
                if (response.ok) {
                    console.log('✅ 自動保存機能が利用可能です');
                } else {
                    console.warn('⚠️ 自動保存機能が利用できません（Worker未デプロイの可能性）');
                    document.getElementById('autoSaveBtn').style.opacity = '0.6';
                }
            } catch (error) {
                console.warn('⚠️ 自動保存機能の確認に失敗:', error.message);
                document.getElementById('autoSaveBtn').style.opacity = '0.6';
            }
        }
        
        // トースト通知
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.toggle('error', isError);
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ========== ユーザー管理機能 ==========
        
        // ユーザーデータ読み込み
        async function loadUsersData() {
            try {
                // LocalStorageから承認済みユーザー一覧を読み込み
                const savedUsers = localStorage.getItem('approvedUsers');
                if (savedUsers) {
                    approvedUsers = JSON.parse(savedUsers);
                } else {
                    // 初期データ（デモ用）
                    approvedUsers = [
                        {
                            id: 1,
                            email: 'demo@example.com',
                            registeredAt: new Date().toISOString(),
                            hasPin: false
                        }
                    ];
                    saveUsersData();
                }
                
                displayUsersList();
                updateUserCount();
                
            } catch (error) {
                console.error('ユーザーデータ読み込みエラー:', error);
                approvedUsers = [];
            }
        }

        // ユーザーデータ保存（Supabaseとも同期）
        async function saveUsersData() {
            // LocalStorageに保存
            localStorage.setItem('approvedUsers', JSON.stringify(approvedUsers));
            
            // Supabaseにも同期（既存データを保護しながら）
            try {
                for (const user of approvedUsers) {
                    // 既存のニックネームを保護
                    const { data: existingProfile } = await supabaseClient
                        .from('user_profiles')
                        .select('nickname')
                        .eq('email', user.email)
                        .single();
                    
                    const safeNickname = existingProfile?.nickname || (user.email.split('@')[0] || 'ユーザー');
                    
                    await supabaseClient
                        .from('user_profiles')
                        .upsert({
                            email: user.email,
                            nickname: safeNickname,
                            is_active: true
                        });
                }
                console.log('✅ Supabaseと同期完了');
            } catch (error) {
                console.warn('⚠️ Supabase同期エラー（LocalStorageには保存済み）:', error);
            }
        }

        // ユーザー一覧表示
        function displayUsersList() {
            const usersList = document.getElementById('usersList');
            
            if (approvedUsers.length === 0) {
                usersList.innerHTML = `
                    <div style="padding: var(--space-xl); text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: var(--space-md); opacity: 0.3;"></i>
                        <p>承認済みユーザーがありません</p>
                    </div>
                `;
                return;
            }

            usersList.innerHTML = approvedUsers.map(user => `
                <div class="user-item" data-user-id="${user.id}">
                    <div class="user-info">
                        <div class="user-email">
                            <i class="fas fa-envelope"></i>
                            ${user.email}
                        </div>
                        <div class="user-meta">
                            <span class="user-status ${user.hasPin ? 'status-registered' : 'status-pending'}">
                                <i class="fas ${user.hasPin ? 'fa-check-circle' : 'fa-clock'}"></i>
                                ${user.hasPin ? 'PIN設定済み' : 'PIN未設定'}
                            </span>
                            <span class="user-date">
                                登録: ${new Date(user.registeredAt).toLocaleDateString('ja-JP')}
                            </span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-sm btn-secondary" onclick="resetUserPin(${user.id})" title="PIN リセット">
                            <i class="fas fa-key"></i>
                        </button>
                        <button class="btn btn-sm btn-error" onclick="deleteUser(${user.id})" title="削除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ユーザー数更新
        function updateUserCount() {
            document.getElementById('userCount').textContent = approvedUsers.length;
        }

        // 新規ユーザー追加
        function addNewUser() {
            const email = prompt('承認するメールアドレスを入力してください:');
            if (!email) return;

            // メールアドレスの形式チェック
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('有効なメールアドレスを入力してください。');
                return;
            }

            // 重複チェック
            if (approvedUsers.some(user => user.email === email)) {
                alert('このメールアドレスは既に登録されています。');
                return;
            }

            // ユーザー追加
            const newUser = {
                id: Date.now(),
                email: email,
                registeredAt: new Date().toISOString(),
                hasPin: false
            };

            approvedUsers.push(newUser);
            saveUsersData();
            displayUsersList();
            updateUserCount();

            showToast(`✅ ユーザー「${email}」を追加しました`);
        }

        // ユーザー削除
        function deleteUser(userId) {
            const user = approvedUsers.find(u => u.id === userId);
            if (!user) return;

            if (confirm(`ユーザー「${user.email}」を削除しますか？`)) {
                approvedUsers = approvedUsers.filter(u => u.id !== userId);
                saveUsersData();
                displayUsersList();
                updateUserCount();

                showToast(`🗑️ ユーザー「${user.email}」を削除しました`);
            }
        }

        // ユーザーPINリセット
        function resetUserPin(userId) {
            const user = approvedUsers.find(u => u.id === userId);
            if (!user) return;

            if (confirm(`ユーザー「${user.email}」のPINをリセットしますか？`)) {
                user.hasPin = false;
                saveUsersData();
                displayUsersList();

                showToast(`🔑 ユーザー「${user.email}」のPINをリセットしました`);
            }
        }

        // ユーザー検索
        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const userItems = document.querySelectorAll('.user-item');

            userItems.forEach(item => {
                const email = item.querySelector('.user-email').textContent.toLowerCase();
                if (email.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Googleマップモーダル表示
        function showGoogleMapModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3><i class="fab fa-google"></i> Googleマップから店舗情報取得</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">GoogleマップURL</label>
                            <input type="url" class="form-input" id="googleMapUrl" 
                                   placeholder="https://maps.google.com/..." 
                                   style="margin-bottom: var(--space-sm);">
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                💡 Googleマップで店舗を検索し、URLをコピーして貼り付けてください
                            </div>
                        </div>
                        
                        <div style="margin: var(--space-lg) 0;">
                            <button class="btn btn-primary" onclick="fetchGoogleMapData()" style="width: 100%;">
                                <i class="fas fa-download"></i>
                                店舗情報を取得
                            </button>
                        </div>
                        
                        <div id="googleMapResult" style="display: none;">
                            <h4 style="margin-bottom: var(--space-md);">取得した店舗情報</h4>
                            <div id="googleMapPreview" class="form-preview"></div>
                            <div style="margin-top: var(--space-lg);">
                                <button class="btn btn-success" onclick="useGoogleMapData()" style="width: 100%;">
                                    <i class="fas fa-check"></i>
                                    この情報で店舗を追加
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Googleマップデータ取得
        let googleMapStoreData = null;
        
        async function fetchGoogleMapData() {
            const url = document.getElementById('googleMapUrl').value.trim();
            if (!url) {
                showToast('❌ GoogleマップURLを入力してください', 'error');
                return;
            }

            if (!url.includes('maps.google') && !url.includes('goo.gl/maps')) {
                showToast('❌ 有効なGoogleマップURLを入力してください', 'error');
                return;
            }

            try {
                showToast('🔍 店舗情報を取得中...', 'info');
                
                // GoogleマップURLから店舗情報を解析
                const storeInfo = await parseGoogleMapUrl(url);
                
                if (storeInfo) {
                    googleMapStoreData = storeInfo;
                    displayGoogleMapPreview(storeInfo);
                    document.getElementById('googleMapResult').style.display = 'block';
                    showToast('✅ 店舗情報を取得しました', 'success');
                } else {
                    showToast('❌ 店舗情報の取得に失敗しました', 'error');
                }
            } catch (error) {
                console.error('Google Map data fetch error:', error);
                showToast('❌ エラー: ' + error.message, 'error');
            }
        }

        // GoogleマップURL解析
        async function parseGoogleMapUrl(url) {
            try {
                // URLから座標とplace_idを抽出
                let lat, lng, placeName, placeId;
                
                // 座標の抽出（@緯度,経度の形式）
                const coordMatch = url.match(/@([+-]?\d+\.\d+),([+-]?\d+\.\d+)/);
                if (coordMatch) {
                    lat = parseFloat(coordMatch[1]);
                    lng = parseFloat(coordMatch[2]);
                }
                
                // place_idの抽出
                const placeIdMatch = url.match(/place_id:([A-Za-z0-9_-]+)/);
                if (placeIdMatch) {
                    placeId = placeIdMatch[1];
                }
                
                // URLから店舗名を推測（簡易版）
                const nameMatch = url.match(/place\/([^\/]+)/);
                if (nameMatch) {
                    placeName = decodeURIComponent(nameMatch[1]).replace(/\+/g, ' ');
                }

                // 基本的な店舗情報を作成
                const storeData = {
                    name: placeName || '取得した店舗',
                    latitude: lat || 35.6762,
                    longitude: lng || 139.6503,
                    address: '住所を確認してください',
                    phone: '',
                    hours: '',
                    website: '',
                    image_url: '',
                    category: 'その他',
                    gluten_free_level: '要確認',
                    gluten_free_menu: '',
                    notes: '',
                    place_id: placeId || ''
                };

                return storeData;
            } catch (error) {
                console.error('URL parsing error:', error);
                throw new Error('URLの解析に失敗しました');
            }
        }

        // Googleマップ取得結果プレビュー
        function displayGoogleMapPreview(storeInfo) {
            const preview = document.getElementById('googleMapPreview');
            preview.innerHTML = `
                <div style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md);">
                    <div style="margin-bottom: var(--space-sm);"><strong>店舗名:</strong> ${storeInfo.name}</div>
                    <div style="margin-bottom: var(--space-sm);"><strong>緯度:</strong> ${storeInfo.latitude}</div>
                    <div style="margin-bottom: var(--space-sm);"><strong>経度:</strong> ${storeInfo.longitude}</div>
                    <div style="margin-bottom: var(--space-sm);"><strong>住所:</strong> ${storeInfo.address}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: var(--space-md);">
                        ⚠️ 取得後に詳細情報（営業時間、電話番号、グルテンフリー対応等）を手動で追加してください
                    </div>
                </div>
            `;
        }

        // Googleマップデータを使用して店舗追加
        function useGoogleMapData() {
            if (!googleMapStoreData) {
                showToast('❌ 店舗データがありません', 'error');
                return;
            }

            // 新規店舗として追加
            const newId = Math.max(...stores.map(s => s.id), 0) + 1;
            const newStore = {
                id: newId,
                ...googleMapStoreData
            };

            stores.push(newStore);
            saveStoresData();
            displayStoresList();
            updateStoreCount();

            // 編集モードで開く
            editStore(newId);

            // モーダルを閉じる
            document.querySelector('.modal').remove();

            showToast('✅ Googleマップから店舗を追加しました。詳細情報を入力してください。', 'success');
        }

        // CSV機能は csv-upload.js モジュールに移動
        // window.showCsvUploadModal は CSVUploader.showModal() として実装
        window.showCsvUploadModal = function() {
            console.log('showCsvUploadModal called');
            try {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-file-csv"></i> CSV一括アップロード</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <!-- ステップ1: ファイル選択 -->
                        <div id="csvStep1">
                            <h4>ステップ1: CSVファイルを選択</h4>
                            <div class="form-group">
                                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCsvFile(this)">
                                <button class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()" style="width: 100%;">
                                    <i class="fas fa-upload"></i> CSVファイルを選択
                                </button>
                            </div>
                            
                            <div style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md); margin-top: var(--space-lg);">
                                <h5>📋 CSVフォーマット</h5>
                                <code style="display: block; font-size: 0.8rem; margin: var(--space-sm) 0;">
                                    GoogleマップURL,店舗名,カテゴリー,住所,電話番号,営業時間,定休日,ウェブサイト,画像URL,グルテンフリー対応度,対応メニュー,備考,緯度,経度
                                </code>
                                <div style="background: #e0f2fe; padding: var(--space-sm); border-radius: var(--radius-sm); margin: var(--space-md) 0;">
                                    <strong>💡 使い方：</strong><br>
                                    • GoogleマップURLがある場合：URLから店舗情報を自動取得<br>
                                    • URLがない場合：各項目を手動入力<br>
                                    • 必須：「GoogleマップURL」または「店舗名＋住所」
                                </div>
                                <div style="margin-top: var(--space-md);">
                                    <a href="#" onclick="downloadCsvTemplate(event)" style="color: var(--primary);">
                                        <i class="fas fa-download"></i> テンプレートをダウンロード
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ステップ2: プレビューと重複チェック -->
                        <div id="csvStep2" style="display: none;">
                            <h4>ステップ2: データ確認と重複チェック</h4>
                            
                            <div id="csvStats" style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                                <!-- 統計情報 -->
                            </div>
                            
                            <div id="csvDuplicates" style="display: none; background: #fef2f2; padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                                <h5 style="color: var(--warning);">⚠️ 重複の可能性がある店舗</h5>
                                <div id="duplicatesList"></div>
                                <div style="margin-top: var(--space-md);">
                                    <label>
                                        <input type="checkbox" id="skipDuplicates" checked>
                                        重複する店舗をスキップする
                                    </label>
                                </div>
                            </div>
                            
                            <div id="csvPreview" style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                                <!-- プレビューテーブル -->
                            </div>
                            
                            <div style="margin-top: var(--space-lg); display: flex; gap: var(--space-md);">
                                <button class="btn btn-secondary" onclick="resetCsvUpload()" style="flex: 1;">
                                    <i class="fas fa-redo"></i> やり直す
                                </button>
                                <button class="btn btn-success" onclick="processCsvUpload()" style="flex: 1;">
                                    <i class="fas fa-check"></i> インポート開始
                                </button>
                            </div>
                        </div>
                        
                        <!-- ステップ3: 処理中 -->
                        <div id="csvStep3" style="display: none;">
                            <h4>ステップ3: インポート処理中</h4>
                            <div class="progress-container" style="margin: var(--space-lg) 0;">
                                <div class="progress-bar" style="background: var(--border-light); height: 30px; border-radius: var(--radius-md); overflow: hidden;">
                                    <div id="csvProgressBar" style="background: var(--success); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                        0%
                                    </div>
                                </div>
                                <div id="csvProgressText" style="text-align: center; margin-top: var(--space-sm); color: var(--text-secondary);">
                                    準備中...
                                </div>
                            </div>
                            
                            <div id="csvImportLog" style="background: #f9fafb; padding: var(--space-md); border-radius: var(--radius-md); max-height: 200px; overflow-y: auto; font-size: 0.9rem;">
                                <!-- インポートログ -->
                            </div>
                        </div>
                        
                        <!-- ステップ4: 完了 -->
                        <div id="csvStep4" style="display: none;">
                            <h4>✅ インポート完了</h4>
                            <div id="csvResult" style="background: var(--bg-secondary); padding: var(--space-lg); border-radius: var(--radius-md);">
                                <!-- 結果サマリー -->
                            </div>
                            <div style="margin-top: var(--space-lg);">
                                <button class="btn btn-primary" onclick="this.closest('.modal').remove()" style="width: 100%;">
                                    <i class="fas fa-times"></i> 閉じる
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error in showCsvUploadModal:', error);
                showToast('❌ CSVアップロード画面の表示に失敗しました', 'error');
            }
        }

        // CSVテンプレートダウンロード
        window.downloadCsvTemplate = function(event) {
            event.preventDefault();
            const csvContent = `GoogleマップURL,店舗名,カテゴリー,住所,電話番号,営業時間,定休日,ウェブサイト,画像URL,グルテンフリー対応度,対応メニュー,備考,緯度,経度
https://maps.google.com/maps/place/...,,,,,,,,,完全対応,米粉パン・米粉ケーキ,専門店,,
,グルテンフリーカフェ,カフェ,東京都渋谷区1-1-1,03-1234-5678,10:00-20:00,月曜日,https://example.com,https://example.com/image.jpg,完全対応,米粉パン・米粉ケーキ,完全グルテンフリー専門店,35.6762,139.6503
,サンプルレストラン,洋食,東京都新宿区2-2-2,03-9876-5432,11:00-22:00,なし,,,一部対応,グルテンフリーパスタ,要事前予約,,`;
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'gluten_free_stores_template.csv';
            link.click();
            
            showToast('📥 テンプレートをダウンロードしました', 'success');
        }

        // CSV処理用変数
        let csvData = [];
        let csvHeaders = [];
        
        // CSVファイル処理
        window.handleCsvFile = function(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // エンコーディング自動検出とパース
                    const text = e.target.result;
                    const lines = text.split(/\r?\n/).filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        showToast('❌ CSVファイルにデータがありません', 'error');
                        return;
                    }
                    
                    // ヘッダー解析
                    csvHeaders = parseCsvLine(lines[0]);
                    
                    // 必須列チェック（GoogleマップURLか、店舗名+住所のいずれか）
                    const hasGoogleMapUrl = csvHeaders.includes('GoogleマップURL');
                    const hasStoreInfo = csvHeaders.includes('店舗名') && csvHeaders.includes('住所');
                    
                    if (!hasGoogleMapUrl && !hasStoreInfo) {
                        showToast('❌ 必須列が不足: 「GoogleマップURL」または「店舗名＋住所」が必要です', 'error');
                        return;
                    }
                    
                    // データ解析
                    csvData = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCsvLine(lines[i]);
                        if (values.length === csvHeaders.length) {
                            const row = {};
                            csvHeaders.forEach((header, index) => {
                                row[header] = values[index] || '';
                            });
                            csvData.push(row);
                        }
                    }
                    
                    if (csvData.length === 0) {
                        showToast('❌ 有効なデータが見つかりません', 'error');
                        return;
                    }
                    
                    // プレビュー表示
                    showCsvPreview();
                    
                } catch (error) {
                    console.error('CSV parse error:', error);
                    showToast('❌ CSVファイルの解析に失敗しました', 'error');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // CSV行パース（カンマ区切り、引用符対応）
        function parseCsvLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        // CSVプレビュー表示
        window.showCsvPreview = function() {
            // 重複チェック
            const duplicates = checkDuplicates();
            
            // 統計情報
            const stats = document.getElementById('csvStats');
            stats.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-md);">
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">${csvData.length}</div>
                        <div style="color: var(--text-secondary);">総店舗数</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${csvData.length - duplicates.length}</div>
                        <div style="color: var(--text-secondary);">新規店舗</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">${duplicates.length}</div>
                        <div style="color: var(--text-secondary);">重複の可能性</div>
                    </div>
                </div>
            `;
            
            // 重複表示
            if (duplicates.length > 0) {
                document.getElementById('csvDuplicates').style.display = 'block';
                const duplicatesList = document.getElementById('duplicatesList');
                duplicatesList.innerHTML = duplicates.map(dup => `
                    <div style="padding: var(--space-xs) 0; border-bottom: 1px solid #fecaca;">
                        <strong>${dup.csvStore.店舗名}</strong> 
                        <span style="color: var(--text-secondary);">（${dup.csvStore.住所}）</span>
                        <br>
                        <span style="font-size: 0.9rem; color: var(--error);">
                            既存: ${dup.existingStore.name} - ${dup.similarity}%一致
                        </span>
                    </div>
                `).join('');
            } else {
                document.getElementById('csvDuplicates').style.display = 'none';
            }
            
            // プレビューテーブル
            const preview = document.getElementById('csvPreview');
            const previewData = csvData.slice(0, 10); // 最初の10件表示
            
            preview.innerHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="background: var(--bg-secondary); position: sticky; top: 0;">
                            ${csvHeaders.map(h => `<th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--border-light);">${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${previewData.map(row => `
                            <tr>
                                ${csvHeaders.map(h => `<td style="padding: var(--space-sm); border: 1px solid var(--border-light);">${row[h] || '-'}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${csvData.length > 10 ? `<div style="text-align: center; padding: var(--space-md); color: var(--text-secondary);">... 他 ${csvData.length - 10} 件</div>` : ''}
            `;
            
            // ステップ2表示
            document.getElementById('csvStep1').style.display = 'none';
            document.getElementById('csvStep2').style.display = 'block';
        }
        
        // 重複チェック（類似度計算付き）
        function checkDuplicates() {
            const duplicates = [];
            
            // storesが空の場合は重複なし
            if (!stores || stores.length === 0) {
                console.log('No existing stores, no duplicates possible');
                return duplicates;
            }
            
            csvData.forEach(csvStore => {
                // CSVデータが有効かチェック
                if (!csvStore.店舗名 || csvStore.店舗名.trim() === '') {
                    return; // 店舗名がない場合はスキップ
                }
                
                let isDuplicate = false;
                stores.forEach(existingStore => {
                    // 既存データが有効かチェック
                    if (!existingStore.name || existingStore.name.trim() === '') {
                        return; // 既存店舗名がない場合はスキップ
                    }
                    
                    // 店舗名と住所の類似度をチェック
                    const nameSimilarity = calculateSimilarity(
                        csvStore.店舗名.trim(), 
                        existingStore.name.trim()
                    );
                    const addressSimilarity = calculateSimilarity(
                        csvStore.住所 || '', 
                        existingStore.address || ''
                    );
                    
                    // より厳しい条件で重複判定（90%以上の類似度、または80%以上で住所も類似）
                    if (nameSimilarity > 90 || (nameSimilarity > 80 && addressSimilarity > 80)) {
                        if (!isDuplicate) { // 同じCSV店舗が複数回追加されるのを防ぐ
                            duplicates.push({
                                csvStore: csvStore,
                                existingStore: existingStore,
                                similarity: Math.max(nameSimilarity, addressSimilarity)
                            });
                            isDuplicate = true;
                        }
                    }
                });
            });
            
            console.log(`Found ${duplicates.length} potential duplicates out of ${csvData.length} CSV records`);
            return duplicates;
        }
        
        // 文字列類似度計算（レーベンシュタイン距離）
        function calculateSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;
            
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 100;
            
            const distance = levenshteinDistance(longer, shorter);
            return Math.round(((longer.length - distance) / longer.length) * 100);
        }
        
        // レーベンシュタイン距離
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // CSVアップロード処理
        window.processCsvUpload = async function() {
            console.log('=== CSVアップロード処理開始 ===');
            console.log('csvData:', csvData);
            console.log('Current stores:', stores);
            console.log('Stores count:', stores ? stores.length : 0);
            
            const skipDuplicates = document.getElementById('skipDuplicates').checked;
            console.log('Skip duplicates:', skipDuplicates);
            
            const duplicates = skipDuplicates ? checkDuplicates() : [];
            console.log('Duplicates found:', duplicates);
            
            const duplicateNames = duplicates.map(d => d.csvStore.店舗名);
            console.log('Duplicate names:', duplicateNames);
            
            // 処理対象データ
            const dataToProcess = csvData.filter(row => !duplicateNames.includes(row.店舗名));
            console.log('Data to process:', dataToProcess.length, 'records out of', csvData.length, 'total');
            console.log('Processing data:', dataToProcess);
            
            if (dataToProcess.length === 0) {
                console.warn('No data to process after duplicate check');
                showToast('⚠️ インポートする新規店舗がありません。重複チェックを無効にしてみてください。', 'warning');
                return;
            }
            
            // ステップ3表示
            document.getElementById('csvStep2').style.display = 'none';
            document.getElementById('csvStep3').style.display = 'block';
            
            const progressBar = document.getElementById('csvProgressBar');
            const progressText = document.getElementById('csvProgressText');
            const importLog = document.getElementById('csvImportLog');
            
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            // バッチ処理（50件ずつ）
            const batchSize = 50;
            for (let i = 0; i < dataToProcess.length; i += batchSize) {
                const batch = dataToProcess.slice(i, Math.min(i + batchSize, dataToProcess.length));
                
                for (const row of batch) {
                    try {
                        console.log('Processing row:', row);
                        let storeData = {};
                        
                        console.log('Processing CSV row:', row);
                        
                        // 基本データ処理（Googleマップ有無に関わらず共通）
                        storeData = {
                            name: row.店舗名 || '未設定',
                            category: row.カテゴリー || 'その他',
                            address: row.住所 || '',
                            phone: row.電話番号 || '',
                            hours: row.営業時間 || '',
                            closed: row.定休日 || '',
                            website: row.ウェブサイト || '',
                            instagram: row['Instagram URL'] || '',
                            image_url: row.画像URL || '',
                            gluten_free_level: row.グルテンフリー対応度 || '要確認',
                            gluten_free_menu: row.対応メニュー || '',
                            notes: row.備考 || '',
                            latitude: parseFloat(row.緯度) || null,
                            longitude: parseFloat(row.経度) || null,
                            place_id: ''
                        };
                        
                        // GoogleマップURLがある場合は追加情報を取得
                        if (row.GoogleマップURL && row.GoogleマップURL.trim()) {
                            console.log('Processing Google Maps URL:', row.GoogleマップURL);
                            const googleData = await parseGoogleMapUrl(row.GoogleマップURL);
                            if (googleData) {
                                // GoogleマップデータでCSVデータを補完（CSVデータを優先）
                                storeData.name = storeData.name === '未設定' ? (googleData.name || '未設定') : storeData.name;
                                storeData.address = storeData.address || googleData.address || '';
                                storeData.latitude = storeData.latitude || googleData.latitude || null;
                                storeData.longitude = storeData.longitude || googleData.longitude || null;
                                storeData.place_id = googleData.place_id || '';
                                
                                importLog.innerHTML += `<div style="color: #3b82f6;">🔍 GoogleマップURLから情報取得: ${storeData.name}</div>`;
                            }
                        }
                        
                        // 店舗データ作成（IDを安全に生成）
                        const newId = stores.length > 0 ? Math.max(...stores.map(s => s.id || 0)) + 1 : 1;
                        const newStore = {
                            id: newId,
                            ...storeData
                        };
                        
                        console.log('Created new store data:', newStore);
                        
                        // 座標がない場合は住所から取得を試みる
                        if (!newStore.latitude || !newStore.longitude) {
                            if (newStore.address) {
                                // 住所から座標を推定（簡易版）
                                const coords = await geocodeAddress(newStore.address);
                                if (coords) {
                                    newStore.latitude = coords.lat;
                                    newStore.longitude = coords.lng;
                                    importLog.innerHTML += `<div style="color: #10b981;">📍 住所から座標取得: ${newStore.address}</div>`;
                                }
                            } else {
                                // デフォルト座標（東京）
                                newStore.latitude = 35.6762 + (Math.random() - 0.5) * 0.1;
                                newStore.longitude = 139.6503 + (Math.random() - 0.5) * 0.1;
                            }
                        }
                        
                        console.log('Adding store to stores array. Current length:', stores.length);
                        stores.push(newStore);
                        console.log('Store added. New length:', stores.length);
                        console.log('Added store:', newStore);
                        
                        successCount++;
                        
                        // ログ追加
                        importLog.innerHTML += `<div style="color: var(--success);">✅ ${newStore.name} を追加しました</div>`;
                        
                    } catch (error) {
                        errorCount++;
                        errors.push(`${row.店舗名}: ${error.message}`);
                        importLog.innerHTML += `<div style="color: var(--error);">❌ ${row.店舗名} の追加に失敗: ${error.message}</div>`;
                    }
                    
                    // プログレス更新
                    const progress = Math.round(((i + batch.indexOf(row) + 1) / dataToProcess.length) * 100);
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                    progressText.textContent = `${i + batch.indexOf(row) + 1} / ${dataToProcess.length} 件処理中...`;
                    
                    // スクロール
                    importLog.scrollTop = importLog.scrollHeight;
                    
                    // UIを更新
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
            
            console.log('=== CSVアップロード処理完了 ===');
            console.log('Success count:', successCount);
            console.log('Error count:', errorCount);
            console.log('Final stores count:', stores.length);
            
            // データ保存
            saveStoresData();
            displayStoresList();
            updateStoreCount();
            
            // 結果表示
            document.getElementById('csvStep3').style.display = 'none';
            document.getElementById('csvStep4').style.display = 'block';
            
            const result = document.getElementById('csvResult');
            result.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: var(--space-md);">
                        ${successCount > 0 ? '🎉' : '😔'}
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: var(--space-lg);">
                        ${successCount} 件の店舗を追加しました
                    </div>
                    <div style="margin-bottom: var(--space-md); padding: var(--space-sm); background: var(--bg-secondary); border-radius: var(--radius-md);">
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            処理結果: ${csvData.length}件中 ${dataToProcess.length}件を処理対象として選択し、${successCount}件を正常に追加
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-md); text-align: center;">
                        <div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--success);">${successCount}</div>
                            <div style="color: var(--text-secondary);">成功</div>
                        </div>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--warning);">${duplicates.length}</div>
                            <div style="color: var(--text-secondary);">スキップ</div>
                        </div>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--error);">${errorCount}</div>
                            <div style="color: var(--text-secondary);">エラー</div>
                        </div>
                    </div>
                    ${errors.length > 0 ? `
                        <div style="margin-top: var(--space-lg); text-align: left;">
                            <h5>エラー詳細:</h5>
                            <div style="background: #fef2f2; padding: var(--space-sm); border-radius: var(--radius-sm); font-size: 0.9rem; max-height: 100px; overflow-y: auto;">
                                ${errors.map(e => `<div>• ${e}</div>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // GitHub自動デプロイ
            if (successCount > 0 && githubSettings.token) {
                showToast('🚀 GitHub自動デプロイを開始します...', 'info');
                setTimeout(() => deployToGitHub(), 2000);
            }
        }
        
        // CSVアップロードリセット
        window.resetCsvUpload = function() {
            csvData = [];
            csvHeaders = [];
            document.getElementById('csvFileInput').value = '';
            document.getElementById('csvStep1').style.display = 'block';
            document.getElementById('csvStep2').style.display = 'none';
            document.getElementById('csvStep3').style.display = 'none';
            document.getElementById('csvStep4').style.display = 'none';
        }
        
        // 住所から座標を取得（簡易版）
        async function geocodeAddress(address) {
            if (!address) return null;
            
            try {
                // 日本の主要都市の座標マッピング（簡易版）
                const cityCoords = {
                    '東京': { lat: 35.6762, lng: 139.6503 },
                    '横浜': { lat: 35.4437, lng: 139.6380 },
                    '大阪': { lat: 34.6937, lng: 135.5023 },
                    '名古屋': { lat: 35.1815, lng: 136.9066 },
                    '札幌': { lat: 43.0642, lng: 141.3469 },
                    '福岡': { lat: 33.5904, lng: 130.4017 },
                    '神戸': { lat: 34.6901, lng: 135.1955 },
                    '京都': { lat: 35.0116, lng: 135.7681 },
                    '仙台': { lat: 38.2682, lng: 140.8694 },
                    '広島': { lat: 34.3853, lng: 132.4553 },
                    '千葉': { lat: 35.6074, lng: 140.1065 },
                    'さいたま': { lat: 35.8617, lng: 139.6455 },
                    '川崎': { lat: 35.5308, lng: 139.7029 },
                    '新宿': { lat: 35.6938, lng: 139.7036 },
                    '渋谷': { lat: 35.6580, lng: 139.7016 },
                    '品川': { lat: 35.6284, lng: 139.7387 },
                    '池袋': { lat: 35.7295, lng: 139.7109 },
                    '上野': { lat: 35.7141, lng: 139.7774 },
                    '浅草': { lat: 35.7118, lng: 139.7966 },
                    '銀座': { lat: 35.6717, lng: 139.7642 },
                    '六本木': { lat: 35.6628, lng: 139.7315 },
                    '原宿': { lat: 35.6702, lng: 139.7026 },
                    '秋葉原': { lat: 35.6984, lng: 139.7731 },
                    '吉祥寺': { lat: 35.7032, lng: 139.5798 },
                    '町田': { lat: 35.5438, lng: 139.4386 },
                    '立川': { lat: 35.6978, lng: 139.4140 },
                    '八王子': { lat: 35.6586, lng: 139.3161 }
                };
                
                // 住所から都市名を抽出
                for (const [city, coords] of Object.entries(cityCoords)) {
                    if (address.includes(city)) {
                        // 都市の座標に少しランダムな偏差を加える
                        return {
                            lat: coords.lat + (Math.random() - 0.5) * 0.05,
                            lng: coords.lng + (Math.random() - 0.5) * 0.05
                        };
                    }
                }
                
                // 都道府県レベルでの判定
                if (address.includes('東京都')) {
                    return {
                        lat: 35.6762 + (Math.random() - 0.5) * 0.2,
                        lng: 139.6503 + (Math.random() - 0.5) * 0.2
                    };
                } else if (address.includes('大阪府')) {
                    return {
                        lat: 34.6937 + (Math.random() - 0.5) * 0.2,
                        lng: 135.5023 + (Math.random() - 0.5) * 0.2
                    };
                } else if (address.includes('神奈川県')) {
                    return {
                        lat: 35.4437 + (Math.random() - 0.5) * 0.2,
                        lng: 139.6380 + (Math.random() - 0.5) * 0.2
                    };
                }
                
                // デフォルトは東京
                return {
                    lat: 35.6762 + (Math.random() - 0.5) * 0.3,
                    lng: 139.6503 + (Math.random() - 0.5) * 0.3
                };
                
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 自動保存機能の可用性をチェック
            setTimeout(checkAutoSaveAvailability, 1000); // 1秒後にチェック
            
            // CSV一括アップロードボタンのイベントリスナーは showAdminPanel 内で設定されます
        });
    </script>
</body>
</html>