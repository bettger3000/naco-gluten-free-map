<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç®¡ç†ç”»é¢ - ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #ff6b9d;
            --primary-dark: #e55a8a;
            --secondary: #40e0d0;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-primary: #fdf2f8;
            --bg-secondary: #f9fafb;
            --bg-glass: rgba(255, 255, 255, 0.95);
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-light: #e5e7eb;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --space-xs: 0.5rem;
            --space-sm: 0.75rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg);
        }
        
        .login-card {
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            box-shadow: var(--shadow-lg);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        .login-title {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: var(--space-md);
        }
        
        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: var(--space-xl);
        }
        
        .input-group {
            margin-bottom: var(--space-lg);
            text-align: left;
        }
        
        .input-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: var(--space-xs);
            font-weight: 500;
        }
        
        .input-group input {
            width: 100%;
            padding: var(--space-md);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }
        
        .login-btn {
            width: 100%;
            padding: var(--space-md);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .login-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .login-error {
            color: var(--error);
            font-size: 0.9rem;
            margin-bottom: var(--space-md);
            padding: var(--space-sm);
            background: rgba(239, 68, 68, 0.1);
            border-radius: var(--radius-sm);
            display: none;
        }
        
        /* ç®¡ç†ç”»é¢ */
        .admin-container {
            display: none;
            min-height: 100vh;
            background: var(--bg-secondary);
        }
        
        .admin-header {
            background: white;
            box-shadow: var(--shadow-md);
            padding: var(--space-md) var(--space-lg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .admin-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
        }

        .tab-btn {
            flex: 1;
            padding: var(--space-md) var(--space-lg);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .tab-btn:hover {
            background: rgba(255, 107, 157, 0.1);
            color: var(--primary);
        }

        .tab-btn.active {
            background: white;
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            font-weight: 600;
        }

        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãƒ‘ãƒãƒ« */
        .users-panel {
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-md);
            border-bottom: 1px solid var(--border-light);
            transition: background-color 0.2s ease;
        }

        .user-item:hover {
            background: var(--bg-secondary);
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-info {
            flex: 1;
        }

        .user-email {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .user-meta {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            font-size: 0.85rem;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-registered {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .user-date {
            color: var(--text-secondary);
        }

        .user-actions {
            display: flex;
            gap: var(--space-xs);
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        .btn-error {
            background: var(--error);
            color: white;
            border: 1px solid var(--error);
        }

        .btn-error:hover {
            background: #dc2626;
            border-color: #dc2626;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 700;
        }
        
        .header-actions {
            display: flex;
            gap: var(--space-md);
        }
        
        .btn {
            padding: var(--space-sm) var(--space-md);
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-light);
        }
        
        .btn-danger {
            background: var(--error);
            color: white;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .admin-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-lg);
        }
        
        /* åº—èˆ—ãƒªã‚¹ãƒˆ */
        .stores-panel {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }
        
        .panel-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .store-count {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .search-box {
            padding: 0 var(--space-lg) var(--space-md);
        }
        
        .search-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }
        
        .stores-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .store-item {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .store-item:hover {
            background: var(--bg-primary);
        }
        
        .store-item.selected {
            background: var(--bg-primary);
            border-left: 4px solid var(--primary);
        }
        
        .store-info {
            flex: 1;
        }
        
        .store-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .store-category {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .store-address {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .store-actions {
            display: flex;
            gap: var(--space-xs);
        }
        
        .icon-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .icon-btn:hover {
            background: var(--primary);
            color: white;
        }
        
        .icon-btn.delete:hover {
            background: var(--error);
        }
        
        /* ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  */
        .edit-panel {
            background: white;
            border: 2px solid var(--primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--space-lg);
            min-height: 500px;
            overflow-y: auto;
            display: block !important;
            visibility: visible !important;
        }
        
        .form-group {
            margin-bottom: var(--space-lg);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--space-xs);
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--space-sm);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
        }
        
        /* åœ°å›³ */
        .map-container {
            margin-bottom: var(--space-lg);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 2px solid var(--border-light);
        }
        
        #editMap {
            height: 300px;
            width: 100%;
        }
        
        .map-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: var(--space-xs);
        }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ ãƒœã‚¿ãƒ³ */
        .form-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-xl);
        }
        
        .form-actions .btn {
            flex: 1;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 1.3rem;
            margin-bottom: var(--space-md);
            color: var(--primary);
        }
        
        .modal-body {
            margin-bottom: var(--space-lg);
        }
        
        .modal-actions {
            display: flex;
            gap: var(--space-sm);
            justify-content: flex-end;
        }
        
        /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
        .toast {
            position: fixed;
            bottom: var(--space-lg);
            right: var(--space-lg);
            background: var(--success);
            color: white;
            padding: var(--space-md) var(--space-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: var(--space-sm);
            z-index: 2000;
        }
        
        .toast.show {
            display: flex;
            animation: slideIn 0.3s ease;
        }
        
        .toast.error {
            background: var(--error);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 1024px) {
            #storesTab > div {
                grid-template-columns: 1fr !important;
            }
            
            .edit-panel {
                position: static;
                max-height: none;
                margin-top: var(--space-lg);
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <h1 class="login-title">ğŸ” ç®¡ç†ç”»é¢</h1>
            <p class="login-subtitle">ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—åº—èˆ—ç®¡ç†</p>
            
            <div class="input-group">
                <label for="adminPin">ç®¡ç†è€…PINã‚³ãƒ¼ãƒ‰ï¼ˆ6æ¡ï¼‰</label>
                <input type="password" id="adminPin" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="6" pattern="[0-9]*" inputmode="numeric" onkeypress="if(event.key==='Enter'){
                    document.querySelector('.login-btn').click();
                }">
            </div>
            
            <div id="loginError" class="login-error">
                PINã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“
            </div>
            
            <button class="login-btn" onclick="(async function(){
                const pin = document.getElementById('adminPin').value;
                if (pin === '999999') {
                    localStorage.setItem('adminAuth', 'true');
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('adminContainer').style.display = 'block';
                    
                    // ç®¡ç†ç”»é¢ã®åˆæœŸåŒ–
                    if (typeof window.showAdminPanel === 'function') {
                        await window.showAdminPanel();
                    } else {
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šåŸºæœ¬çš„ãªåˆæœŸåŒ–
                        if (typeof loadStoresData === 'function') await loadStoresData();
                        if (typeof loadUsersData === 'function') await loadUsersData();
                        if (typeof initEditMap === 'function') initEditMap();
                        if (typeof initializeGitHubFeatures === 'function') initializeGitHubFeatures();
                        if (typeof displayStoresList === 'function') displayStoresList();
                    }
                } else {
                    document.getElementById('loginError').style.display = 'block';
                    document.getElementById('adminPin').value = '';
                    setTimeout(() => {
                        document.getElementById('loginError').style.display = 'none';
                    }, 3000);
                }
            })()">
                <i class="fas fa-sign-in-alt"></i>
                ãƒ­ã‚°ã‚¤ãƒ³
            </button>
        </div>
    </div>
    
    <!-- ç®¡ç†ç”»é¢ -->
    <div id="adminContainer" class="admin-container">
        <header class="admin-header">
            <div class="header-content">
                <h1 class="header-title">ğŸ—ºï¸ ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒãƒƒãƒ—ç®¡ç†ç”»é¢</h1>
                <div class="header-actions">
                    <button class="btn btn-success" onclick="exportJSON()">
                        <i class="fas fa-download"></i>
                        JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-primary" onclick="showGitHubSetup()" id="githubBtn">
                        <i class="fas fa-github"></i>
                        <span id="githubBtnText">GitHubé€£æº</span>
                    </button>
                    <button class="btn btn-warning" onclick="deployToGitHub()" id="deployBtn" style="display: none;">
                        <i class="fas fa-rocket"></i>
                        æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
                    </button>
                    <button class="btn btn-primary" onclick="generateEmbeddedCode()">
                        <i class="fas fa-code"></i>
                        åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                    </button>
                    <button class="btn btn-warning" onclick="autoSaveToGitHub()" id="autoSaveBtn">
                        <i class="fas fa-cloud-upload-alt"></i>
                        è‡ªå‹•ä¿å­˜
                    </button>
                    <button class="btn btn-secondary" onclick="importJSON()">
                        <i class="fas fa-upload"></i>
                        JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </div>
            </div>
        </header>
        
        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="admin-tabs">
            <button class="tab-btn active" data-tab="stores" onclick="switchTab('stores')">
                <i class="fas fa-store"></i>
                åº—èˆ—ç®¡ç†
            </button>
            <button class="tab-btn" data-tab="users" onclick="switchTab('users')">
                <i class="fas fa-users"></i>
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
            </button>
        </nav>
        
        <div class="admin-content">
            <!-- åº—èˆ—ç®¡ç†ã‚¿ãƒ– -->
            <div id="storesTab" class="tab-content active">
                <div style="display: grid; grid-template-columns: 1fr 400px; gap: 20px; align-items: start;">
                    <!-- åº—èˆ—ãƒªã‚¹ãƒˆ -->
                    <div class="stores-panel">
                <div class="panel-header">
                    <h2 class="panel-title">åº—èˆ—ä¸€è¦§</h2>
                    <span class="store-count">å…¨<span id="storeCount">0</span>ä»¶</span>
                </div>
                
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="åº—åãƒ»ä½æ‰€ã§æ¤œç´¢..." onkeyup="filterStores()">
                </div>
                
                <div class="stores-list" id="storesList">
                    <!-- åº—èˆ—ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
                
                <div style="padding: var(--space-md); border-top: 1px solid var(--border-light);">
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: var(--space-sm);" onclick="addNewStore()">
                        <i class="fas fa-plus"></i>
                        æ–°è¦åº—èˆ—ã‚’è¿½åŠ 
                    </button>
                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: var(--space-sm);" onclick="showGoogleMapModal()">
                        <i class="fab fa-google"></i>
                        Googleãƒãƒƒãƒ—ã‹ã‚‰è¿½åŠ 
                    </button>
                    <button class="btn btn-success" id="csvUploadBtn" style="width: 100%;">
                        <i class="fas fa-file-csv"></i>
                        CSVä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>
                    </div>
                    
                    <!-- ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <div class="edit-panel">
                <h3 style="margin-bottom: var(--space-lg);">åº—èˆ—æƒ…å ±ç·¨é›†</h3>
                
                <form id="editForm">
                    <input type="hidden" id="storeId">
                    
                    <div class="form-group">
                        <label class="form-label">åº—èˆ—å *</label>
                        <input type="text" class="form-input" id="storeName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼ *</label>
                        <select class="form-select" id="storeCategory" required>
                            <option value="ã‚«ãƒ•ã‚§">â˜• ã‚«ãƒ•ã‚§</option>
                            <option value="å’Œé£Ÿ">ğŸ± å’Œé£Ÿ</option>
                            <option value="æ´‹é£Ÿ">ğŸ½ï¸ æ´‹é£Ÿ</option>
                            <option value="ãƒ‘ãƒ³å±‹">ğŸ¥ ãƒ‘ãƒ³å±‹</option>
                            <option value="ã‚¹ã‚¤ãƒ¼ãƒ„">ğŸ§ ã‚¹ã‚¤ãƒ¼ãƒ„</option>
                            <option value="è²©å£²åº—">ğŸ›’ è²©å£²åº—</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ä½æ‰€ *</label>
                        <input type="text" class="form-input" id="storeAddress" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">åº§æ¨™ï¼ˆåœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¨­å®šï¼‰</label>
                        <div class="map-container">
                            <div id="editMap"></div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-sm);">
                            <div>
                                <label class="form-label">ç·¯åº¦</label>
                                <input type="number" class="form-input" id="storeLat" step="0.0001">
                            </div>
                            <div>
                                <label class="form-label">çµŒåº¦</label>
                                <input type="number" class="form-input" id="storeLng" step="0.0001">
                            </div>
                        </div>
                        <p class="map-hint">ğŸ’¡ åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½ç½®ã‚’è¨­å®šã™ã‚‹ã‹ã€åº§æ¨™ã‚’ç›´æ¥å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">é›»è©±ç•ªå·</label>
                        <input type="tel" class="form-input" id="storePhone">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</label>
                        <input type="url" class="form-input" id="storeWebsite">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Instagram URL</label>
                        <input type="url" class="form-input" id="storeInstagram" placeholder="https://instagram.com/...">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç”»åƒURL</label>
                        <input type="url" class="form-input" id="storeImageUrl" placeholder="åº—èˆ—ç”»åƒã®URL">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">å–¶æ¥­æ™‚é–“</label>
                        <input type="text" class="form-input" id="storeHours" placeholder="ä¾‹: 11:00-20:00">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼å¯¾å¿œ</label>
                        <textarea class="form-textarea" id="storeGfOptions" placeholder="ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è©³ç´°ãªã©"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">èª¬æ˜</label>
                        <textarea class="form-textarea" id="storeDescription" placeholder="ãŠåº—ã®ç‰¹å¾´ãªã©"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-success" onclick="saveStore()">
                            <i class="fas fa-save"></i>
                            ä¿å­˜
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-times"></i>
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </form>
                    </div>
                </div>
            </div> <!-- åº—èˆ—ç®¡ç†ã‚¿ãƒ–çµ‚äº† -->
            
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ– -->
            <div id="usersTab" class="tab-content">
                <div class="users-panel">
                    <div class="panel-header">
                        <h2 class="panel-title">æ‰¿èªæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
                        <span class="user-count">å…¨<span id="userCount">0</span>ä»¶</span>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" class="search-input" id="userSearchInput" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§æ¤œç´¢..." onkeyup="filterUsers()">
                    </div>
                    
                    <div class="users-list" id="usersList">
                        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                    
                    <div style="padding: var(--space-md); border-top: 1px solid var(--border-light);">
                        <button class="btn btn-primary" style="width: 100%;" onclick="addNewUser()">
                            <i class="fas fa-user-plus"></i>
                            æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ 
                        </button>
                    </div>
                </div>
            </div>
    </div>
    
    <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">å‰Šé™¤ç¢ºèª</h3>
            <div class="modal-body">
                <p>ã“ã®åº—èˆ—ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <p style="color: var(--error); margin-top: var(--space-sm);">â€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“</p>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-danger" onclick="confirmDelete()">å‰Šé™¤ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- GitHubè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="githubModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">ğŸš€ GitHubé€£æºè¨­å®š</h3>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">GitHub Personal Access Token</label>
                    <input type="password" class="form-input" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        <strong>å¿…è¦ãªæ¨©é™:</strong> repo (ãƒ•ãƒ«ã‚¢ã‚¯ã‚»ã‚¹)<br>
                        <a href="https://github.com/settings/tokens" target="_blank" style="color: var(--primary);">
                            <i class="fas fa-external-link-alt"></i> Personal Access Tokenã‚’ä½œæˆ
                        </a>
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±</label>
                    <input type="text" class="form-input" id="repoOwner" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" value="bettger3000">
                    <input type="text" class="form-input" id="repoName" placeholder="ãƒªãƒã‚¸ãƒˆãƒªå" style="margin-top: 0.5rem;" value="naco-gluten-free-map">
                    <input type="text" class="form-input" id="filePath" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹" style="margin-top: 0.5rem;" value="data/embeddedStores.json">
                </div>
                
                <div id="githubStatus" style="margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; display: none;">
                    <i class="fas fa-info-circle"></i>
                    <span id="githubStatusText"></span>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeGitHubModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-success" onclick="testGitHubConnection()">æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                <button class="btn btn-primary" onclick="saveGitHubSettings()">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="embeddedCodeModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
            <h3 class="modal-title">ğŸ“‹ åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ï¼ˆindex.htmlç”¨ï¼‰</h3>
            <div class="modal-body">
                <p style="margin-bottom: var(--space-md); color: var(--text-secondary);">
                    ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’index.htmlã®<code>const embeddedStores = [</code>ã‹ã‚‰<code>];</code>ã¾ã§ç½®ãæ›ãˆã¦ãã ã•ã„
                </p>
                
                <div style="margin-bottom: var(--space-md);">
                    <button class="btn btn-primary" onclick="copyEmbeddedCode()" style="width: 100%;">
                        <i class="fas fa-copy"></i>
                        ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                    </button>
                </div>
                
                <textarea id="embeddedCodeText" readonly style="
                    width: 100%; 
                    height: 400px; 
                    font-family: 'Courier New', monospace; 
                    font-size: 0.85rem; 
                    border: 1px solid var(--border-light); 
                    border-radius: var(--radius-sm); 
                    padding: var(--space-md);
                    background: #f8f9fa;
                    resize: vertical;
                "></textarea>
                
                <div style="margin-top: var(--space-md); padding: var(--space-md); background: #e3f2fd; border-radius: var(--radius-sm);">
                    <h4 style="margin-bottom: var(--space-sm); color: #1976d2;">ğŸ“ æ›´æ–°æ‰‹é †</h4>
                    <ol style="margin-left: var(--space-lg); color: var(--text-secondary);">
                        <li>ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</li>
                        <li>index.htmlã‚’é–‹ã</li>
                        <li><code>const embeddedStores = [</code>ã‚’æ¤œç´¢</li>
                        <li>é…åˆ—ã®ä¸­èº«ï¼ˆ<code>[</code>ã‹ã‚‰<code>];</code>ã¾ã§ï¼‰ã‚’ç½®ãæ›ãˆ</li>
                        <li>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦Gitã«ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥</li>
                    </ol>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeEmbeddedCodeModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
    
    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">ä¿å­˜ã—ã¾ã—ãŸ</span>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase JSï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†åŒæœŸç”¨ï¼‰ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- CSV Upload Module -->
    <script src="csv-upload.js"></script>
    
    <script>
        // Supabaseè¨­å®šï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ã§å®‰å…¨ï¼‰
        const SUPABASE_URL = 'https://hxrmsjfvgctoaxpbukvo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4cm1zamZ2Z2N0b2F4cGJ1a3ZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5MTI3NTAsImV4cCI6MjA3MDQ4ODc1MH0.tM1vDVVhYhh7OHlA1BTj071BfsIzeBG_HatijjtxwLw';
        
        // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–ï¼ˆå¿…è¦æœ€å°é™ã®æ¨©é™ï¼‰
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ç®¡ç†è€…PINã‚³ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®é‹ç”¨ã§ã¯ç’°å¢ƒå¤‰æ•°ç­‰ã§ç®¡ç†ï¼‰
        const ADMIN_PIN = '999999';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let stores = [];
        let editMap = null;
        let editMarker = null;
        let selectedStoreId = null;
        let deleteTargetId = null;
        let approvedUsers = []; // æ‰¿èªæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            const isAuthenticated = localStorage.getItem('adminAuth');
            if (isAuthenticated) {
                await showAdminPanel();
            }
            
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const loginBtn = document.getElementById('loginButton');
            if (loginBtn) {
                loginBtn.addEventListener('click', adminLogin);
            }
            
            // Enterã‚­ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³PIN
            const pinInput = document.getElementById('adminPin');
            if (pinInput) {
                pinInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') adminLogin();
                });
            }
        });
        
        // ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
        window.adminLogin = async function() {
            const pin = document.getElementById('adminPin').value;
            
            if (pin === ADMIN_PIN) {
                localStorage.setItem('adminAuth', 'true');
                await showAdminPanel();
            } else {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('adminPin').value = '';
                setTimeout(() => {
                    document.getElementById('loginError').style.display = 'none';
                }, 3000);
            }
        }
        
        // ç®¡ç†ç”»é¢è¡¨ç¤º
        window.showAdminPanel = async function() {
            console.log('showAdminPanel called');
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            console.log('About to load stores data');
            await loadStoresData();
            console.log('Stores data loaded');
            await loadUsersData();
            
            // åœ°å›³åˆæœŸåŒ–
            initEditMap();
            
            // GitHubæ©Ÿèƒ½åˆæœŸåŒ–
            initializeGitHubFeatures();
            console.log('Admin panel initialization complete');
        }
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        window.logout = function() {
            localStorage.removeItem('adminAuth');
            location.reload();
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        window.switchTab = function(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ãƒœã‚¿ãƒ³ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }
        
        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadStoresData() {
            console.log('loadStoresData called');
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ç·¨é›†ä¸­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°èª­ã¿è¾¼ã¿
            const savedData = localStorage.getItem('editingStores');
            if (savedData) {
                stores = JSON.parse(savedData);
                console.log('Loaded from localStorage:', stores.length, 'stores');
                showToast('ç·¨é›†ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ', false);
            } else {
                // index.htmlã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
                console.log('Loading initial stores...');
                stores = await getInitialStores();
                console.log('Loaded initial stores:', stores.length);
            }
            
            console.log('About to call displayStoresList');
            displayStoresList();
        }
        
        // åˆæœŸåº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å®‰å…¨ã«å–å¾—
        async function getInitialStores() {
            const fallbackChain = [
                './data/embeddedStores.json',
                './embeddedStores.json', // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å ´æ‰€
            ];
            
            for (const url of fallbackChain) {
                try {
                    console.log(`ğŸ“¡ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿è©¦è¡Œ: ${url}`);
                    const response = await fetch(url);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const storesData = await response.json();
                    
                    // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
                    if (!Array.isArray(storesData) || storesData.length === 0) {
                        throw new Error('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã¾ãŸã¯ç©ºã®ãƒ‡ãƒ¼ã‚¿');
                    }
                    
                    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
                    const validStores = storesData.filter(store => 
                        store.id && store.name && store.address
                    );
                    
                    if (validStores.length !== storesData.length) {
                        console.warn(`âš ï¸ ${storesData.length - validStores.length}ä»¶ã®ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ`);
                    }
                    
                    console.log(`âœ… ${validStores.length}åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (${url})`);
                    return validStores;
                    
                } catch (error) {
                    console.warn(`âš ï¸ ${url}ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—:`, error.message);
                }
            }
            
            // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æœ€å°é™ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
            console.error('âŒ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
            return getMinimalSampleData();
        }
        
        // æœ€å°é™ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
        function getMinimalSampleData() {
            return [
                {
                    id: 1,
                    name: "ã‚µãƒ³ãƒ—ãƒ«åº—èˆ—",
                    category: "ã‚«ãƒ•ã‚§",
                    address: "æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­åŒºæ „",
                    latitude: 35.1681,
                    longitude: 136.9069,
                    phone: "",
                    website: "",
                    image_url: "",
                    description: "ã“ã‚Œã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚",
                    gluten_free_options: "",
                    opening_hours: ""
                }
            ];
        }
        
        // åº—èˆ—ãƒªã‚¹ãƒˆè¡¨ç¤º
        function displayStoresList() {
            console.log('displayStoresList called, stores count:', stores.length);
            const list = document.getElementById('storesList');
            if (!list) {
                console.error('storesList element not found!');
                return;
            }
            
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            
            const filteredStores = stores.filter(store => 
                store.name.toLowerCase().includes(searchTerm) ||
                store.address.toLowerCase().includes(searchTerm)
            );
            console.log('Filtered stores count:', filteredStores.length);
            
            list.innerHTML = filteredStores.map(store => `
                <div class="store-item ${selectedStoreId === store.id ? 'selected' : ''}" onclick="selectStore(${store.id})">
                    <div class="store-info">
                        <div class="store-name">${store.name}</div>
                        <span class="store-category">${store.category}</span>
                        <div class="store-address">${store.address}</div>
                    </div>
                    <div class="store-actions">
                        <button class="icon-btn" onclick="editStore(${store.id}); event.stopPropagation();">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn delete" onclick="deleteStore(${store.id}); event.stopPropagation();">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('storeCount').textContent = filteredStores.length;
        }
        
        // åº—èˆ—æ¤œç´¢
        function filterStores() {
            displayStoresList();
        }
        
        // åº—èˆ—é¸æŠ
        function selectStore(id) {
            selectedStoreId = id;
            editStore(id);
        }
        
        // åº—èˆ—ç·¨é›†
        function editStore(id) {
            console.log('ç·¨é›†é–‹å§‹ - åº—èˆ—ID:', id);
            const store = stores.find(s => s.id === id);
            if (!store) {
                console.error('åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', id);
                return;
            }
            
            selectedStoreId = id;
            
            try {
                // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
                const formElements = {
                    storeId: document.getElementById('storeId'),
                    storeName: document.getElementById('storeName'),
                    storeCategory: document.getElementById('storeCategory'),
                    storeAddress: document.getElementById('storeAddress'),
                    storeLat: document.getElementById('storeLat'),
                    storeLng: document.getElementById('storeLng'),
                    storePhone: document.getElementById('storePhone'),
                    storeWebsite: document.getElementById('storeWebsite'),
                    storeInstagram: document.getElementById('storeInstagram'),
                    storeImageUrl: document.getElementById('storeImageUrl'),
                    storeHours: document.getElementById('storeHours'),
                    storeGfOptions: document.getElementById('storeGfOptions'),
                    storeDescription: document.getElementById('storeDescription')
                };
                
                // è¦ç´ ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
                for (const [key, element] of Object.entries(formElements)) {
                    if (!element) {
                        console.error(`ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${key}`);
                    }
                }
                
                // å€¤ã®è¨­å®š
                if (formElements.storeId) formElements.storeId.value = store.id;
                if (formElements.storeName) formElements.storeName.value = store.name;
                if (formElements.storeCategory) formElements.storeCategory.value = store.category;
                if (formElements.storeAddress) formElements.storeAddress.value = store.address;
                if (formElements.storeLat) formElements.storeLat.value = store.latitude || '';
                if (formElements.storeLng) formElements.storeLng.value = store.longitude || '';
                if (formElements.storePhone) formElements.storePhone.value = store.phone || '';
                if (formElements.storeWebsite) formElements.storeWebsite.value = store.website || '';
                if (formElements.storeInstagram) formElements.storeInstagram.value = store.instagram || '';
                if (formElements.storeImageUrl) formElements.storeImageUrl.value = store.image_url || '';
                if (formElements.storeHours) formElements.storeHours.value = store.opening_hours || '';
                if (formElements.storeGfOptions) formElements.storeGfOptions.value = store.gluten_free_options || '';
                if (formElements.storeDescription) formElements.storeDescription.value = store.description || '';
                
                // ç·¨é›†ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºï¼ˆvisibilityç¢ºèªï¼‰
                const editPanel = document.querySelector('.edit-panel');
                if (editPanel) {
                    console.log('ç·¨é›†ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºçŠ¶æ…‹:', {
                        display: window.getComputedStyle(editPanel).display,
                        visibility: window.getComputedStyle(editPanel).visibility,
                        opacity: window.getComputedStyle(editPanel).opacity
                    });
                    
                    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                    editPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                console.log('ãƒ•ã‚©ãƒ¼ãƒ å€¤è¨­å®šå®Œäº† - åº—èˆ—å:', formElements.storeName?.value);
                
                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒç·¨é›†å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
                if (formElements.storeName) {
                    console.log('åº—èˆ—åãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®çŠ¶æ…‹:', {
                        disabled: formElements.storeName.disabled,
                        readOnly: formElements.storeName.readOnly,
                        value: formElements.storeName.value,
                        type: formElements.storeName.type
                    });
                    
                    // å¼·åˆ¶çš„ã«ç·¨é›†å¯èƒ½ã«ã™ã‚‹
                    formElements.storeName.disabled = false;
                    formElements.storeName.readOnly = false;
                }
                
                // åœ°å›³æ›´æ–°ï¼ˆã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ãƒ•ã‚©ãƒ¼ãƒ ã¯å‹•ä½œã™ã‚‹ã‚ˆã†ã«ï¼‰
                if (store.latitude && store.longitude && typeof updateMapMarker === 'function') {
                    try {
                        updateMapMarker(store.latitude, store.longitude);
                    } catch (mapError) {
                        console.warn('åœ°å›³ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€ç·¨é›†ã¯ç¶šè¡Œã§ãã¾ã™:', mapError);
                    }
                }
                
                displayStoresList();
                showToast('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã™', false);
                
                // æœ€åˆã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                setTimeout(() => {
                    if (formElements.storeName && !formElements.storeName.disabled) {
                        formElements.storeName.focus();
                        formElements.storeName.select();
                        console.log('åº—èˆ—åãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®šã—ã¾ã—ãŸ');
                    }
                }, 100);
            } catch (error) {
                console.error('ç·¨é›†ã‚¨ãƒ©ãƒ¼:', error);
                alert('ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        // æ–°è¦åº—èˆ—è¿½åŠ 
        function addNewStore() {
            const newId = Math.max(...stores.map(s => s.id), 0) + 1;
            
            const newStore = {
                id: newId,
                name: 'æ–°è¦åº—èˆ—',
                category: 'ã‚«ãƒ•ã‚§',
                address: '',
                latitude: null,
                longitude: null,
                phone: '',
                website: '',
                image_url: '',
                description: '',
                gluten_free_options: '',
                opening_hours: ''
            };
            
            stores.push(newStore);
            displayStoresList();
            editStore(newId);
            
            // åº—åå…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            document.getElementById('storeName').focus();
            document.getElementById('storeName').select();
        }
        
        // åº—èˆ—ä¿å­˜ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
        function saveStore() {
            try {
                const id = parseInt(document.getElementById('storeId').value);
                if (!id || isNaN(id)) {
                    throw new Error('ç„¡åŠ¹ãªåº—èˆ—IDã§ã™');
                }
                
                const storeIndex = stores.findIndex(s => s.id === id);
                if (storeIndex === -1) {
                    throw new Error('åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
                const formData = getFormData();
                validateStoreData(formData);
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                stores[storeIndex] = formData;
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('editingStores', JSON.stringify(stores));
                localStorage.setItem('lastSaved', new Date().toISOString());
                
                displayStoresList();
                showToast(`åº—èˆ—ã€Œ${formData.name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`, false);
                
                console.log('âœ… åº—èˆ—ä¿å­˜å®Œäº†:', formData.name);
                
            } catch (error) {
                console.error('âŒ åº—èˆ—ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showToast(`ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, true);
            }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å®‰å…¨ã«å–å¾—
        function getFormData() {
            const getValue = (id) => {
                const element = document.getElementById(id);
                return element ? element.value.trim() : '';
            };
            
            const getNumberValue = (id) => {
                const value = getValue(id);
                return value ? parseFloat(value) : null;
            };
            
            return {
                id: parseInt(getValue('storeId')),
                name: getValue('storeName'),
                category: getValue('storeCategory'),
                address: getValue('storeAddress'),
                latitude: getNumberValue('storeLat'),
                longitude: getNumberValue('storeLng'),
                phone: getValue('storePhone'),
                website: getValue('storeWebsite'),
                instagram: getValue('storeInstagram'),
                image_url: getValue('storeImageUrl'),
                opening_hours: getValue('storeHours'),
                gluten_free_options: getValue('storeGfOptions'),
                description: getValue('storeDescription')
            };
        }
        
        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
        function validateStoreData(data) {
            if (!data.name) {
                throw new Error('åº—èˆ—åã¯å¿…é ˆã§ã™');
            }
            
            if (!data.category) {
                throw new Error('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¯å¿…é ˆã§ã™');
            }
            
            if (!data.address) {
                throw new Error('ä½æ‰€ã¯å¿…é ˆã§ã™');
            }
            
            if (data.latitude && (data.latitude < -90 || data.latitude > 90)) {
                throw new Error('ç·¯åº¦ã¯-90ã‹ã‚‰90ã®é–“ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
            }
            
            if (data.longitude && (data.longitude < -180 || data.longitude > 180)) {
                throw new Error('çµŒåº¦ã¯-180ã‹ã‚‰180ã®é–“ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
            }
            
            if (data.website && !isValidUrl(data.website)) {
                throw new Error('ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®URLãŒç„¡åŠ¹ã§ã™');
            }
            
            if (data.image_url && !isValidUrl(data.image_url)) {
                throw new Error('ç”»åƒURLãŒç„¡åŠ¹ã§ã™');
            }
        }
        
        // URLæ¤œè¨¼
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        
        // åº—èˆ—å‰Šé™¤
        function deleteStore(id) {
            deleteTargetId = id;
            document.getElementById('deleteModal').classList.add('active');
        }
        
        // å‰Šé™¤ç¢ºèª
        function confirmDelete() {
            if (deleteTargetId) {
                stores = stores.filter(s => s.id !== deleteTargetId);
                localStorage.setItem('editingStores', JSON.stringify(stores));
                
                if (selectedStoreId === deleteTargetId) {
                    resetForm();
                }
                
                displayStoresList();
                showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
                closeDeleteModal();
            }
        }
        
        // å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deleteTargetId = null;
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'deleteModal') {
                    closeDeleteModal();
                } else if (e.target.id === 'embeddedCodeModal') {
                    closeEmbeddedCodeModal();
                }
            }
        });
        
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetForm() {
            document.getElementById('editForm').reset();
            document.getElementById('storeId').value = '';
            selectedStoreId = null;
            
            if (editMarker) {
                editMap.removeLayer(editMarker);
                editMarker = null;
            }
            
            displayStoresList();
        }
        
        // åœ°å›³åˆæœŸåŒ–
        function initEditMap() {
            try {
                const mapElement = document.getElementById('editMap');
                if (!mapElement) {
                    console.warn('åœ°å›³è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                editMap = L.map('editMap').setView([35.6762, 139.6503], 10);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(editMap);
                
                // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                editMap.on('click', function(e) {
                    updateMapMarker(e.latlng.lat, e.latlng.lng);
                    document.getElementById('storeLat').value = e.latlng.lat.toFixed(4);
                    document.getElementById('storeLng').value = e.latlng.lng.toFixed(4);
                });
                
                console.log('åœ°å›³åˆæœŸåŒ–å®Œäº†');
            } catch (error) {
                console.error('åœ°å›³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                console.warn('åœ°å›³æ©Ÿèƒ½ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ãŒã€ãã®ä»–ã®ç·¨é›†ã¯å¯èƒ½ã§ã™');
            }
        }
        
        // åœ°å›³ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
        function updateMapMarker(lat, lng) {
            try {
                if (!editMap) {
                    console.warn('åœ°å›³ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                if (editMarker) {
                    editMap.removeLayer(editMarker);
                }
                
                editMarker = L.marker([lat, lng]).addTo(editMap);
                editMap.setView([lat, lng], 15);
            } catch (error) {
                console.error('ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        function generateEmbeddedCode() {
            // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’JavaScripté…åˆ—å½¢å¼ã§ç”Ÿæˆ
            const embeddedCode = generateEmbeddedStoresArray();
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤º
            document.getElementById('embeddedCodeText').value = embeddedCode;
            document.getElementById('embeddedCodeModal').classList.add('active');
        }
        
        // embeddedStoresé…åˆ—ã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        function generateEmbeddedStoresArray() {
            let code = 'const embeddedStores = [\n';
            
            stores.forEach((store, index) => {
                code += '          {\n';
                code += `                    "id": ${store.id},\n`;
                code += `                    "name": "${escapeString(store.name)}",\n`;
                code += `                    "category": "${escapeString(store.category)}",\n`;
                code += `                    "address": "${escapeString(store.address)}",\n`;
                
                if (store.latitude) {
                    code += `                    "latitude": ${store.latitude},\n`;
                }
                if (store.longitude) {
                    code += `                    "longitude": ${store.longitude},\n`;
                }
                if (store.phone) {
                    code += `                    "phone": "${escapeString(store.phone)}",\n`;
                }
                if (store.website) {
                    code += `                    "website": "${escapeString(store.website)}",\n`;
                    code += `                    "instagram": "${escapeString(store.instagram)}",\n`;
                }
                if (store.description) {
                    code += `                    "description": "${escapeString(store.description)}",\n`;
                }
                if (store.gluten_free_options) {
                    code += `                    "gluten_free_options": "${escapeString(store.gluten_free_options)}",\n`;
                }
                if (store.opening_hours) {
                    code += `                    "opening_hours": "${escapeString(store.opening_hours)}"\n`;
                } else {
                    // æœ€å¾Œã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
                    code = code.replace(/,\n$/, '\n');
                }
                
                code += '          }';
                
                // æœ€å¾Œã®è¦ç´ ä»¥å¤–ã¯ã‚«ãƒ³ãƒã‚’è¿½åŠ 
                if (index < stores.length - 1) {
                    code += ',';
                }
                code += '\n';
            });
            
            code += '];';
            
            return code;
        }
        
        // æ–‡å­—åˆ—ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeString(str) {
            if (!str) return '';
            return str
                .replace(/\\/g, '\\\\')
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/\t/g, '\\t');
        }
        
        // åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        async function copyEmbeddedCode() {
            const codeText = document.getElementById('embeddedCodeText').value;
            
            try {
                await navigator.clipboard.writeText(codeText);
                showToast('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            } catch (err) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’é¸æŠ
                document.getElementById('embeddedCodeText').select();
                document.execCommand('copy');
                showToast('ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã—ãŸã€‚Ctrl+Cã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„');
            }
        }
        
        // åŸ‹ã‚è¾¼ã¿ã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeEmbeddedCodeModal() {
            document.getElementById('embeddedCodeModal').classList.remove('active');
        }
        
        // JSONã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportJSON() {
            const dataStr = JSON.stringify(stores, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `stores_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        }

        // ===========================================
        // GitHub APIçµ±åˆæ©Ÿèƒ½
        // ===========================================
        
        // GitHubè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showGitHubSetup() {
            loadGitHubSettings();
            document.getElementById('githubModal').classList.add('active');
        }
        
        // GitHubè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeGitHubModal() {
            document.getElementById('githubModal').classList.remove('active');
        }
        
        // GitHubè¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadGitHubSettings() {
            const settings = getGitHubSettings();
            if (settings) {
                document.getElementById('githubToken').value = settings.token || '';
                document.getElementById('repoOwner').value = settings.owner || 'bettger3000';
                document.getElementById('repoName').value = settings.repo || 'naco-gluten-free-map';
                document.getElementById('filePath').value = settings.filePath || 'data/embeddedStores.json';
            }
            updateGitHubUI();
        }
        
        // GitHubè¨­å®šã‚’å–å¾—
        function getGitHubSettings() {
            const settings = localStorage.getItem('githubSettings');
            return settings ? JSON.parse(settings) : null;
        }
        
        // GitHubè¨­å®šã‚’ä¿å­˜
        function saveGitHubSettings() {
            const settings = {
                token: document.getElementById('githubToken').value.trim(),
                owner: document.getElementById('repoOwner').value.trim(),
                repo: document.getElementById('repoName').value.trim(),
                filePath: document.getElementById('filePath').value.trim()
            };
            
            if (!settings.token || !settings.owner || !settings.repo || !settings.filePath) {
                showGitHubStatus('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            localStorage.setItem('githubSettings', JSON.stringify(settings));
            updateGitHubUI();
            closeGitHubModal();
            showToast('GitHubè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', false);
        }
        
        // GitHubæ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testGitHubConnection() {
            const settings = {
                token: document.getElementById('githubToken').value.trim(),
                owner: document.getElementById('repoOwner').value.trim(),
                repo: document.getElementById('repoName').value.trim(),
                filePath: document.getElementById('filePath').value.trim()
            };
            
            if (!settings.token || !settings.owner || !settings.repo) {
                showGitHubStatus('å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            showGitHubStatus('æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...', 'info');
            
            try {
                // ãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ†ã‚¹ãƒˆ
                const response = await fetch(`https://api.github.com/repos/${settings.owner}/${settings.repo}`, {
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`${response.status}: ${error.message || response.statusText}`);
                }
                
                const repoData = await response.json();
                showGitHubStatus(`âœ… æ¥ç¶šæˆåŠŸ: ${repoData.full_name}`, 'success');
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
                await testFileAccess(settings);
                
            } catch (error) {
                console.error('GitHubæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                showGitHubStatus(`âŒ æ¥ç¶šå¤±æ•—: ${error.message}`, 'error');
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
        async function testFileAccess(settings) {
            try {
                const response = await fetch(`https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.filePath}`, {
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    showGitHubStatus('âœ… æ¥ç¶šæˆåŠŸ: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª', 'success');
                } else if (response.status === 404) {
                    showGitHubStatus('âš ï¸ æ¥ç¶šæˆåŠŸ: ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆæ–°è¦ä½œæˆã•ã‚Œã¾ã™ï¼‰', 'warning');
                } else {
                    throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: ${response.status}`);
                }
            } catch (error) {
                showGitHubStatus(`âš ï¸ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèªå¤±æ•—: ${error.message}`, 'warning');
            }
        }
        
        // GitHubã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showGitHubStatus(message, type) {
            const statusDiv = document.getElementById('githubStatus');
            const statusText = document.getElementById('githubStatusText');
            
            statusDiv.style.display = 'block';
            statusText.textContent = message;
            
            statusDiv.className = '';
            statusDiv.style.backgroundColor = {
                'success': '#d4edda',
                'error': '#f8d7da',
                'warning': '#fff3cd',
                'info': '#d1ecf1'
            }[type] || '#f8f9fa';
            
            statusDiv.style.color = {
                'success': '#155724',
                'error': '#721c24',
                'warning': '#856404',
                'info': '#0c5460'
            }[type] || '#333';
        }
        
        // GitHub UIæ›´æ–°
        function updateGitHubUI() {
            const settings = getGitHubSettings();
            const githubBtn = document.getElementById('githubBtn');
            const githubBtnText = document.getElementById('githubBtnText');
            const deployBtn = document.getElementById('deployBtn');
            
            if (settings && settings.token) {
                githubBtnText.textContent = 'âš¡ GitHubé€£æºæ¸ˆã¿';
                githubBtn.classList.remove('btn-primary');
                githubBtn.classList.add('btn-success');
                deployBtn.style.display = 'inline-block';
            } else {
                githubBtnText.textContent = 'GitHubé€£æº';
                githubBtn.classList.remove('btn-success');
                githubBtn.classList.add('btn-primary');
                deployBtn.style.display = 'none';
            }
        }

        // æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆGitHubçµŒç”±ï¼‰
        async function deployToGitHub() {
            const settings = getGitHubSettings();
            if (!settings || !settings.token) {
                showToast('GitHubè¨­å®šãŒå¿…è¦ã§ã™', true);
                showGitHubSetup();
                return;
            }
            
            if (!confirm(`ğŸš€ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\n${stores.length}åº—èˆ—ã®ãƒ‡ãƒ¼ã‚¿ãŒæœ¬ç•ªã‚µã‚¤ãƒˆã«åæ˜ ã•ã‚Œã¾ã™ã€‚\n\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
                return;
            }
            
            const deployBtn = document.getElementById('deployBtn');
            const originalText = deployBtn.innerHTML;
            
            try {
                deployBtn.disabled = true;
                deployBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­...';
                
                console.log('ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹:', stores.length, 'åº—èˆ—');
                
                // 1. ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—
                const currentFile = await getCurrentFileInfo(settings);
                
                // 2. ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
                const jsonData = JSON.stringify(stores, null, 2);
                const base64Content = btoa(unescape(encodeURIComponent(jsonData)));
                
                // 3. GitHubã«ãƒ—ãƒƒã‚·ãƒ¥
                const commitMessage = `åº—èˆ—ãƒ‡ãƒ¼ã‚¿æ›´æ–° (${stores.length}åº—èˆ—) - ${new Date().toLocaleString('ja-JP')}`;
                await updateGitHubFile(settings, base64Content, commitMessage, currentFile?.sha);
                
                console.log('âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†');
                showToast('ğŸš€ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼', false);
                
                // 4. GitHub Pages ã®æ›´æ–°ã‚’å¾…ã¤
                setTimeout(() => {
                    showToast('GitHub Pagesã®æ›´æ–°ã«ã¯1-2åˆ†ã‹ã‹ã‚Šã¾ã™', false);
                }, 2000);
                
            } catch (error) {
                console.error('âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼:', error);
                showToast(`ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, true);
            } finally {
                deployBtn.disabled = false;
                deployBtn.innerHTML = originalText;
            }
        }
        
        // ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—
        async function getCurrentFileInfo(settings) {
            try {
                const response = await fetch(`https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.filePath}`, {
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const fileData = await response.json();
                    console.log('ğŸ“„ ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±å–å¾—:', fileData.name);
                    return fileData;
                } else if (response.status === 404) {
                    console.log('ğŸ“„ æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä½œæˆã—ã¾ã™');
                    return null;
                } else {
                    throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±å–å¾—å¤±æ•—: ${response.status}`);
                }
            } catch (error) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }
        
        // GitHubãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
        async function updateGitHubFile(settings, content, message, sha) {
            const requestBody = {
                message: message,
                content: content,
                branch: 'main'
            };
            
            // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯SHAã‚’è¿½åŠ 
            if (sha) {
                requestBody.sha = sha;
            }
            
            const response = await fetch(`https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.filePath}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${settings.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(`GitHub API ã‚¨ãƒ©ãƒ¼: ${error.message || response.statusText}`);
            }
            
            const result = await response.json();
            console.log('âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°å®Œäº†:', result.commit.sha);
            return result;
        }
        
        // ç®¡ç†ç”»é¢èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        function initializeGitHubFeatures() {
            updateGitHubUI();
            
            // GitHubè¨­å®šãŒã‚ã‚‹å ´åˆã€æ¥ç¶šçŠ¶æ…‹ã‚’è¡¨ç¤º
            const settings = getGitHubSettings();
            if (settings && settings.token) {
                console.log('âš¡ GitHubé€£æºãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™');
            }
        }
        
        // JSONã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        stores = importedData;
                        localStorage.setItem('editingStores', JSON.stringify(stores));
                        displayStoresList();
                        showToast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
                    } catch (error) {
                        showToast('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // è‡ªå‹•ä¿å­˜è¨­å®š
        const CLOUDFLARE_WORKER_URL = 'https://gluten-free-store-updater.bettger1000.workers.dev';
        
        // GitHubè‡ªå‹•ä¿å­˜æ©Ÿèƒ½
        async function autoSaveToGitHub() {
            const btn = document.getElementById('autoSaveBtn');
            const originalText = btn.innerHTML;
            
            // ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';
            
            try {
                // 1. ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
                if (!stores || stores.length === 0) {
                    throw new Error('ä¿å­˜ã™ã‚‹åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                }
                
                // 2. Cloudflare WorkerçµŒç”±ã§GitHubã«ä¿å­˜
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stores: stores,
                        commitMessage: `ç®¡ç†ç”»é¢ã‹ã‚‰åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–° (${stores.length}ä»¶)`
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                // 3. æˆåŠŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                showToast(`âœ… è‡ªå‹•ä¿å­˜å®Œäº†ï¼${result.stores_count}ä»¶ã®åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ`, false);
                console.log('âœ… GitHubæ›´æ–°æˆåŠŸ:', result);
                
                // 4. ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«æˆåŠŸçŠ¶æ…‹ã«
                btn.innerHTML = '<i class="fas fa-check"></i> ä¿å­˜å®Œäº†';
                btn.classList.add('btn-success');
                btn.classList.remove('btn-warning');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-warning');
                    btn.disabled = false;
                }, 3000);
                
            } catch (error) {
                console.error('âŒ è‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                showToast(`âŒ è‡ªå‹•ä¿å­˜å¤±æ•—: ${error.message}`, true);
                
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
                console.error('è©³ç´°ã‚¨ãƒ©ãƒ¼æƒ…å ±:', {
                    message: error.message,
                    workerUrl: CLOUDFLARE_WORKER_URL,
                    storesCount: stores ? stores.length : 'undefined'
                });
            }
        }
        
        // è‡ªå‹•ä¿å­˜ã®å¯ç”¨æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        async function checkAutoSaveAvailability() {
            try {
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'OPTIONS'
                });
                
                if (response.ok) {
                    console.log('âœ… è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™');
                } else {
                    console.warn('âš ï¸ è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆWorkeræœªãƒ‡ãƒ—ãƒ­ã‚¤ã®å¯èƒ½æ€§ï¼‰');
                    document.getElementById('autoSaveBtn').style.opacity = '0.6';
                }
            } catch (error) {
                console.warn('âš ï¸ è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ã®ç¢ºèªã«å¤±æ•—:', error.message);
                document.getElementById('autoSaveBtn').style.opacity = '0.6';
            }
        }
        
        // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.toggle('error', isError);
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ ==========
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadUsersData() {
            try {
                // LocalStorageã‹ã‚‰æ‰¿èªæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
                const savedUsers = localStorage.getItem('approvedUsers');
                if (savedUsers) {
                    approvedUsers = JSON.parse(savedUsers);
                } else {
                    // åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
                    approvedUsers = [
                        {
                            id: 1,
                            email: 'demo@example.com',
                            registeredAt: new Date().toISOString(),
                            hasPin: false
                        }
                    ];
                    saveUsersData();
                }
                
                displayUsersList();
                updateUserCount();
                
            } catch (error) {
                console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                approvedUsers = [];
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆSupabaseã¨ã‚‚åŒæœŸï¼‰
        async function saveUsersData() {
            // LocalStorageã«ä¿å­˜
            localStorage.setItem('approvedUsers', JSON.stringify(approvedUsers));
            
            // Supabaseã«ã‚‚åŒæœŸï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿è­·ã—ãªãŒã‚‰ï¼‰
            try {
                for (const user of approvedUsers) {
                    // æ—¢å­˜ã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’ä¿è­·
                    const { data: existingProfile } = await supabaseClient
                        .from('user_profiles')
                        .select('nickname')
                        .eq('email', user.email)
                        .single();
                    
                    const safeNickname = existingProfile?.nickname || (user.email.split('@')[0] || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼');
                    
                    await supabaseClient
                        .from('user_profiles')
                        .upsert({
                            email: user.email,
                            nickname: safeNickname,
                            is_active: true
                        });
                }
                console.log('âœ… Supabaseã¨åŒæœŸå®Œäº†');
            } catch (error) {
                console.warn('âš ï¸ SupabaseåŒæœŸã‚¨ãƒ©ãƒ¼ï¼ˆLocalStorageã«ã¯ä¿å­˜æ¸ˆã¿ï¼‰:', error);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§è¡¨ç¤º
        function displayUsersList() {
            const usersList = document.getElementById('usersList');
            
            if (approvedUsers.length === 0) {
                usersList.innerHTML = `
                    <div style="padding: var(--space-xl); text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-users" style="font-size: 3rem; margin-bottom: var(--space-md); opacity: 0.3;"></i>
                        <p>æ‰¿èªæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }

            usersList.innerHTML = approvedUsers.map(user => `
                <div class="user-item" data-user-id="${user.id}">
                    <div class="user-info">
                        <div class="user-email">
                            <i class="fas fa-envelope"></i>
                            ${user.email}
                        </div>
                        <div class="user-meta">
                            <span class="user-status ${user.hasPin ? 'status-registered' : 'status-pending'}">
                                <i class="fas ${user.hasPin ? 'fa-check-circle' : 'fa-clock'}"></i>
                                ${user.hasPin ? 'PINè¨­å®šæ¸ˆã¿' : 'PINæœªè¨­å®š'}
                            </span>
                            <span class="user-date">
                                ç™»éŒ²: ${new Date(user.registeredAt).toLocaleDateString('ja-JP')}
                            </span>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-sm btn-secondary" onclick="resetUserPin(${user.id})" title="PIN ãƒªã‚»ãƒƒãƒˆ">
                            <i class="fas fa-key"></i>
                        </button>
                        <button class="btn btn-sm btn-error" onclick="deleteUser(${user.id})" title="å‰Šé™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°æ›´æ–°
        function updateUserCount() {
            document.getElementById('userCount').textContent = approvedUsers.length;
        }

        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
        function addNewUser() {
            const email = prompt('æ‰¿èªã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (!email) return;

            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãƒã‚§ãƒƒã‚¯
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (approvedUsers.some(user => user.email === email)) {
                alert('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                return;
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
            const newUser = {
                id: Date.now(),
                email: email,
                registeredAt: new Date().toISOString(),
                hasPin: false
            };

            approvedUsers.push(newUser);
            saveUsersData();
            displayUsersList();
            updateUserCount();

            showToast(`âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${email}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
        function deleteUser(userId) {
            const user = approvedUsers.find(u => u.id === userId);
            if (!user) return;

            if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.email}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                approvedUsers = approvedUsers.filter(u => u.id !== userId);
                saveUsersData();
                displayUsersList();
                updateUserCount();

                showToast(`ğŸ—‘ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.email}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼PINãƒªã‚»ãƒƒãƒˆ
        function resetUserPin(userId) {
            const user = approvedUsers.find(u => u.id === userId);
            if (!user) return;

            if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.email}ã€ã®PINã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ`)) {
                user.hasPin = false;
                saveUsersData();
                displayUsersList();

                showToast(`ğŸ”‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${user.email}ã€ã®PINã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ`);
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
        function filterUsers() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            const userItems = document.querySelectorAll('.user-item');

            userItems.forEach(item => {
                const email = item.querySelector('.user-email').textContent.toLowerCase();
                if (email.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Googleãƒãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showGoogleMapModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3><i class="fab fa-google"></i> Googleãƒãƒƒãƒ—ã‹ã‚‰åº—èˆ—æƒ…å ±å–å¾—</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Googleãƒãƒƒãƒ—URL</label>
                            <input type="url" class="form-input" id="googleMapUrl" 
                                   placeholder="https://maps.google.com/..." 
                                   style="margin-bottom: var(--space-sm);">
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                ğŸ’¡ Googleãƒãƒƒãƒ—ã§åº—èˆ—ã‚’æ¤œç´¢ã—ã€URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
                            </div>
                        </div>
                        
                        <div style="margin: var(--space-lg) 0;">
                            <button class="btn btn-primary" onclick="fetchGoogleMapData()" style="width: 100%;">
                                <i class="fas fa-download"></i>
                                åº—èˆ—æƒ…å ±ã‚’å–å¾—
                            </button>
                        </div>
                        
                        <div id="googleMapResult" style="display: none;">
                            <h4 style="margin-bottom: var(--space-md);">å–å¾—ã—ãŸåº—èˆ—æƒ…å ±</h4>
                            <div id="googleMapPreview" class="form-preview"></div>
                            <div style="margin-top: var(--space-lg);">
                                <button class="btn btn-success" onclick="useGoogleMapData()" style="width: 100%;">
                                    <i class="fas fa-check"></i>
                                    ã“ã®æƒ…å ±ã§åº—èˆ—ã‚’è¿½åŠ 
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Googleãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿å–å¾—
        let googleMapStoreData = null;
        
        async function fetchGoogleMapData() {
            const url = document.getElementById('googleMapUrl').value.trim();
            if (!url) {
                showToast('âŒ Googleãƒãƒƒãƒ—URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!url.includes('maps.google') && !url.includes('goo.gl/maps')) {
                showToast('âŒ æœ‰åŠ¹ãªGoogleãƒãƒƒãƒ—URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                showToast('ğŸ” åº—èˆ—æƒ…å ±ã‚’å–å¾—ä¸­...', 'info');
                
                // Googleãƒãƒƒãƒ—URLã‹ã‚‰åº—èˆ—æƒ…å ±ã‚’è§£æ
                const storeInfo = await parseGoogleMapUrl(url);
                
                if (storeInfo) {
                    googleMapStoreData = storeInfo;
                    displayGoogleMapPreview(storeInfo);
                    document.getElementById('googleMapResult').style.display = 'block';
                    showToast('âœ… åº—èˆ—æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ', 'success');
                } else {
                    showToast('âŒ åº—èˆ—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('Google Map data fetch error:', error);
                showToast('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // Googleãƒãƒƒãƒ—URLè§£æ
        async function parseGoogleMapUrl(url) {
            try {
                // URLã‹ã‚‰åº§æ¨™ã¨place_idã‚’æŠ½å‡º
                let lat, lng, placeName, placeId;
                
                // åº§æ¨™ã®æŠ½å‡ºï¼ˆ@ç·¯åº¦,çµŒåº¦ã®å½¢å¼ï¼‰
                const coordMatch = url.match(/@([+-]?\d+\.\d+),([+-]?\d+\.\d+)/);
                if (coordMatch) {
                    lat = parseFloat(coordMatch[1]);
                    lng = parseFloat(coordMatch[2]);
                }
                
                // place_idã®æŠ½å‡º
                const placeIdMatch = url.match(/place_id:([A-Za-z0-9_-]+)/);
                if (placeIdMatch) {
                    placeId = placeIdMatch[1];
                }
                
                // URLã‹ã‚‰åº—èˆ—åã‚’æ¨æ¸¬ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                const nameMatch = url.match(/place\/([^\/]+)/);
                if (nameMatch) {
                    placeName = decodeURIComponent(nameMatch[1]).replace(/\+/g, ' ');
                }

                // åŸºæœ¬çš„ãªåº—èˆ—æƒ…å ±ã‚’ä½œæˆ
                const storeData = {
                    name: placeName || 'å–å¾—ã—ãŸåº—èˆ—',
                    latitude: lat || 35.6762,
                    longitude: lng || 139.6503,
                    address: 'ä½æ‰€ã‚’ç¢ºèªã—ã¦ãã ã•ã„',
                    phone: '',
                    hours: '',
                    website: '',
                    image_url: '',
                    category: 'ãã®ä»–',
                    gluten_free_level: 'è¦ç¢ºèª',
                    gluten_free_menu: '',
                    notes: '',
                    place_id: placeId || ''
                };

                return storeData;
            } catch (error) {
                console.error('URL parsing error:', error);
                throw new Error('URLã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // Googleãƒãƒƒãƒ—å–å¾—çµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        function displayGoogleMapPreview(storeInfo) {
            const preview = document.getElementById('googleMapPreview');
            preview.innerHTML = `
                <div style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md);">
                    <div style="margin-bottom: var(--space-sm);"><strong>åº—èˆ—å:</strong> ${storeInfo.name}</div>
                    <div style="margin-bottom: var(--space-sm);"><strong>ç·¯åº¦:</strong> ${storeInfo.latitude}</div>
                    <div style="margin-bottom: var(--space-sm);"><strong>çµŒåº¦:</strong> ${storeInfo.longitude}</div>
                    <div style="margin-bottom: var(--space-sm);"><strong>ä½æ‰€:</strong> ${storeInfo.address}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: var(--space-md);">
                        âš ï¸ å–å¾—å¾Œã«è©³ç´°æƒ…å ±ï¼ˆå–¶æ¥­æ™‚é–“ã€é›»è©±ç•ªå·ã€ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼å¯¾å¿œç­‰ï¼‰ã‚’æ‰‹å‹•ã§è¿½åŠ ã—ã¦ãã ã•ã„
                    </div>
                </div>
            `;
        }

        // Googleãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦åº—èˆ—è¿½åŠ 
        function useGoogleMapData() {
            if (!googleMapStoreData) {
                showToast('âŒ åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            // æ–°è¦åº—èˆ—ã¨ã—ã¦è¿½åŠ 
            const newId = Math.max(...stores.map(s => s.id), 0) + 1;
            const newStore = {
                id: newId,
                ...googleMapStoreData
            };

            stores.push(newStore);
            saveStoresData();
            displayStoresList();
            updateStoreCount();

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã
            editStore(newId);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.querySelector('.modal').remove();

            showToast('âœ… Googleãƒãƒƒãƒ—ã‹ã‚‰åº—èˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚è©³ç´°æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'success');
        }

        // CSVæ©Ÿèƒ½ã¯ csv-upload.js ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ç§»å‹•
        // window.showCsvUploadModal ã¯ CSVUploader.showModal() ã¨ã—ã¦å®Ÿè£…
        window.showCsvUploadModal = function() {
            console.log('showCsvUploadModal called');
            try {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-file-csv"></i> CSVä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <!-- ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ -->
                        <div id="csvStep1">
                            <h4>ã‚¹ãƒ†ãƒƒãƒ—1: CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h4>
                            <div class="form-group">
                                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCsvFile(this)">
                                <button class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()" style="width: 100%;">
                                    <i class="fas fa-upload"></i> CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                                </button>
                            </div>
                            
                            <div style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md); margin-top: var(--space-lg);">
                                <h5>ğŸ“‹ CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</h5>
                                <code style="display: block; font-size: 0.8rem; margin: var(--space-sm) 0;">
                                    Googleãƒãƒƒãƒ—URL,åº—èˆ—å,ã‚«ãƒ†ã‚´ãƒªãƒ¼,ä½æ‰€,é›»è©±ç•ªå·,å–¶æ¥­æ™‚é–“,å®šä¼‘æ—¥,ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ,ç”»åƒURL,ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼å¯¾å¿œåº¦,å¯¾å¿œãƒ¡ãƒ‹ãƒ¥ãƒ¼,å‚™è€ƒ,ç·¯åº¦,çµŒåº¦
                                </code>
                                <div style="background: #e0f2fe; padding: var(--space-sm); border-radius: var(--radius-sm); margin: var(--space-md) 0;">
                                    <strong>ğŸ’¡ ä½¿ã„æ–¹ï¼š</strong><br>
                                    â€¢ Googleãƒãƒƒãƒ—URLãŒã‚ã‚‹å ´åˆï¼šURLã‹ã‚‰åº—èˆ—æƒ…å ±ã‚’è‡ªå‹•å–å¾—<br>
                                    â€¢ URLãŒãªã„å ´åˆï¼šå„é …ç›®ã‚’æ‰‹å‹•å…¥åŠ›<br>
                                    â€¢ å¿…é ˆï¼šã€ŒGoogleãƒãƒƒãƒ—URLã€ã¾ãŸã¯ã€Œåº—èˆ—åï¼‹ä½æ‰€ã€
                                </div>
                                <div style="margin-top: var(--space-md);">
                                    <a href="#" onclick="downloadCsvTemplate(event)" style="color: var(--primary);">
                                        <i class="fas fa-download"></i> ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨é‡è¤‡ãƒã‚§ãƒƒã‚¯ -->
                        <div id="csvStep2" style="display: none;">
                            <h4>ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒ¼ã‚¿ç¢ºèªã¨é‡è¤‡ãƒã‚§ãƒƒã‚¯</h4>
                            
                            <div id="csvStats" style="background: var(--bg-secondary); padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                                <!-- çµ±è¨ˆæƒ…å ± -->
                            </div>
                            
                            <div id="csvDuplicates" style="display: none; background: #fef2f2; padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-lg);">
                                <h5 style="color: var(--warning);">âš ï¸ é‡è¤‡ã®å¯èƒ½æ€§ãŒã‚ã‚‹åº—èˆ—</h5>
                                <div id="duplicatesList"></div>
                                <div style="margin-top: var(--space-md);">
                                    <label>
                                        <input type="checkbox" id="skipDuplicates" checked>
                                        é‡è¤‡ã™ã‚‹åº—èˆ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
                                    </label>
                                </div>
                            </div>
                            
                            <div id="csvPreview" style="overflow-x: auto; max-height: 300px; overflow-y: auto;">
                                <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ« -->
                            </div>
                            
                            <div style="margin-top: var(--space-lg); display: flex; gap: var(--space-md);">
                                <button class="btn btn-secondary" onclick="resetCsvUpload()" style="flex: 1;">
                                    <i class="fas fa-redo"></i> ã‚„ã‚Šç›´ã™
                                </button>
                                <button class="btn btn-success" onclick="processCsvUpload()" style="flex: 1;">
                                    <i class="fas fa-check"></i> ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹
                                </button>
                            </div>
                        </div>
                        
                        <!-- ã‚¹ãƒ†ãƒƒãƒ—3: å‡¦ç†ä¸­ -->
                        <div id="csvStep3" style="display: none;">
                            <h4>ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ä¸­</h4>
                            <div class="progress-container" style="margin: var(--space-lg) 0;">
                                <div class="progress-bar" style="background: var(--border-light); height: 30px; border-radius: var(--radius-md); overflow: hidden;">
                                    <div id="csvProgressBar" style="background: var(--success); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                        0%
                                    </div>
                                </div>
                                <div id="csvProgressText" style="text-align: center; margin-top: var(--space-sm); color: var(--text-secondary);">
                                    æº–å‚™ä¸­...
                                </div>
                            </div>
                            
                            <div id="csvImportLog" style="background: #f9fafb; padding: var(--space-md); border-radius: var(--radius-md); max-height: 200px; overflow-y: auto; font-size: 0.9rem;">
                                <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ­ã‚° -->
                            </div>
                        </div>
                        
                        <!-- ã‚¹ãƒ†ãƒƒãƒ—4: å®Œäº† -->
                        <div id="csvStep4" style="display: none;">
                            <h4>âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†</h4>
                            <div id="csvResult" style="background: var(--bg-secondary); padding: var(--space-lg); border-radius: var(--radius-md);">
                                <!-- çµæœã‚µãƒãƒªãƒ¼ -->
                            </div>
                            <div style="margin-top: var(--space-lg);">
                                <button class="btn btn-primary" onclick="this.closest('.modal').remove()" style="width: 100%;">
                                    <i class="fas fa-times"></i> é–‰ã˜ã‚‹
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error in showCsvUploadModal:', error);
                showToast('âŒ CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»é¢ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        // CSVãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        window.downloadCsvTemplate = function(event) {
            event.preventDefault();
            const csvContent = `Googleãƒãƒƒãƒ—URL,åº—èˆ—å,ã‚«ãƒ†ã‚´ãƒªãƒ¼,ä½æ‰€,é›»è©±ç•ªå·,å–¶æ¥­æ™‚é–“,å®šä¼‘æ—¥,ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ,ç”»åƒURL,ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼å¯¾å¿œåº¦,å¯¾å¿œãƒ¡ãƒ‹ãƒ¥ãƒ¼,å‚™è€ƒ,ç·¯åº¦,çµŒåº¦
https://maps.google.com/maps/place/...,,,,,,,,,å®Œå…¨å¯¾å¿œ,ç±³ç²‰ãƒ‘ãƒ³ãƒ»ç±³ç²‰ã‚±ãƒ¼ã‚­,å°‚é–€åº—,,
,ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ã‚«ãƒ•ã‚§,ã‚«ãƒ•ã‚§,æ±äº¬éƒ½æ¸‹è°·åŒº1-1-1,03-1234-5678,10:00-20:00,æœˆæ›œæ—¥,https://example.com,https://example.com/image.jpg,å®Œå…¨å¯¾å¿œ,ç±³ç²‰ãƒ‘ãƒ³ãƒ»ç±³ç²‰ã‚±ãƒ¼ã‚­,å®Œå…¨ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼å°‚é–€åº—,35.6762,139.6503
,ã‚µãƒ³ãƒ—ãƒ«ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³,æ´‹é£Ÿ,æ±äº¬éƒ½æ–°å®¿åŒº2-2-2,03-9876-5432,11:00-22:00,ãªã—,,,ä¸€éƒ¨å¯¾å¿œ,ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼ãƒ‘ã‚¹ã‚¿,è¦äº‹å‰äºˆç´„,,`;
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'gluten_free_stores_template.csv';
            link.click();
            
            showToast('ğŸ“¥ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
        }

        // CSVå‡¦ç†ç”¨å¤‰æ•°
        let csvData = [];
        let csvHeaders = [];
        
        // CSVãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        window.handleCsvFile = function(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è‡ªå‹•æ¤œå‡ºã¨ãƒ‘ãƒ¼ã‚¹
                    const text = e.target.result;
                    const lines = text.split(/\r?\n/).filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        showToast('âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                        return;
                    }
                    
                    // ãƒ˜ãƒƒãƒ€ãƒ¼è§£æ
                    csvHeaders = parseCsvLine(lines[0]);
                    
                    // å¿…é ˆåˆ—ãƒã‚§ãƒƒã‚¯ï¼ˆGoogleãƒãƒƒãƒ—URLã‹ã€åº—èˆ—å+ä½æ‰€ã®ã„ãšã‚Œã‹ï¼‰
                    const hasGoogleMapUrl = csvHeaders.includes('Googleãƒãƒƒãƒ—URL');
                    const hasStoreInfo = csvHeaders.includes('åº—èˆ—å') && csvHeaders.includes('ä½æ‰€');
                    
                    if (!hasGoogleMapUrl && !hasStoreInfo) {
                        showToast('âŒ å¿…é ˆåˆ—ãŒä¸è¶³: ã€ŒGoogleãƒãƒƒãƒ—URLã€ã¾ãŸã¯ã€Œåº—èˆ—åï¼‹ä½æ‰€ã€ãŒå¿…è¦ã§ã™', 'error');
                        return;
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿è§£æ
                    csvData = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCsvLine(lines[i]);
                        if (values.length === csvHeaders.length) {
                            const row = {};
                            csvHeaders.forEach((header, index) => {
                                row[header] = values[index] || '';
                            });
                            csvData.push(row);
                        }
                    }
                    
                    if (csvData.length === 0) {
                        showToast('âŒ æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                        return;
                    }
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                    showCsvPreview();
                    
                } catch (error) {
                    console.error('CSV parse error:', error);
                    showToast('âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }
        
        // CSVè¡Œãƒ‘ãƒ¼ã‚¹ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€å¼•ç”¨ç¬¦å¯¾å¿œï¼‰
        function parseCsvLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        // CSVãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        window.showCsvPreview = function() {
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const duplicates = checkDuplicates();
            
            // çµ±è¨ˆæƒ…å ±
            const stats = document.getElementById('csvStats');
            stats.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-md);">
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">${csvData.length}</div>
                        <div style="color: var(--text-secondary);">ç·åº—èˆ—æ•°</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">${csvData.length - duplicates.length}</div>
                        <div style="color: var(--text-secondary);">æ–°è¦åº—èˆ—</div>
                    </div>
                    <div>
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">${duplicates.length}</div>
                        <div style="color: var(--text-secondary);">é‡è¤‡ã®å¯èƒ½æ€§</div>
                    </div>
                </div>
            `;
            
            // é‡è¤‡è¡¨ç¤º
            if (duplicates.length > 0) {
                document.getElementById('csvDuplicates').style.display = 'block';
                const duplicatesList = document.getElementById('duplicatesList');
                duplicatesList.innerHTML = duplicates.map(dup => `
                    <div style="padding: var(--space-xs) 0; border-bottom: 1px solid #fecaca;">
                        <strong>${dup.csvStore.åº—èˆ—å}</strong> 
                        <span style="color: var(--text-secondary);">ï¼ˆ${dup.csvStore.ä½æ‰€}ï¼‰</span>
                        <br>
                        <span style="font-size: 0.9rem; color: var(--error);">
                            æ—¢å­˜: ${dup.existingStore.name} - ${dup.similarity}%ä¸€è‡´
                        </span>
                    </div>
                `).join('');
            } else {
                document.getElementById('csvDuplicates').style.display = 'none';
            }
            
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
            const preview = document.getElementById('csvPreview');
            const previewData = csvData.slice(0, 10); // æœ€åˆã®10ä»¶è¡¨ç¤º
            
            preview.innerHTML = `
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="background: var(--bg-secondary); position: sticky; top: 0;">
                            ${csvHeaders.map(h => `<th style="padding: var(--space-sm); text-align: left; border: 1px solid var(--border-light);">${h}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${previewData.map(row => `
                            <tr>
                                ${csvHeaders.map(h => `<td style="padding: var(--space-sm); border: 1px solid var(--border-light);">${row[h] || '-'}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${csvData.length > 10 ? `<div style="text-align: center; padding: var(--space-md); color: var(--text-secondary);">... ä»– ${csvData.length - 10} ä»¶</div>` : ''}
            `;
            
            // ã‚¹ãƒ†ãƒƒãƒ—2è¡¨ç¤º
            document.getElementById('csvStep1').style.display = 'none';
            document.getElementById('csvStep2').style.display = 'block';
        }
        
        // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆé¡ä¼¼åº¦è¨ˆç®—ä»˜ãï¼‰
        function checkDuplicates() {
            const duplicates = [];
            
            csvData.forEach(csvStore => {
                stores.forEach(existingStore => {
                    // åº—èˆ—åã¨ä½æ‰€ã®é¡ä¼¼åº¦ã‚’ãƒã‚§ãƒƒã‚¯
                    const nameSimilarity = calculateSimilarity(
                        csvStore.åº—èˆ—å || '', 
                        existingStore.name || ''
                    );
                    const addressSimilarity = calculateSimilarity(
                        csvStore.ä½æ‰€ || '', 
                        existingStore.address || ''
                    );
                    
                    // 70%ä»¥ä¸Šã®é¡ä¼¼åº¦ã§é‡è¤‡ã¨ã¿ãªã™
                    if (nameSimilarity > 70 || (nameSimilarity > 50 && addressSimilarity > 70)) {
                        duplicates.push({
                            csvStore: csvStore,
                            existingStore: existingStore,
                            similarity: Math.max(nameSimilarity, addressSimilarity)
                        });
                    }
                });
            });
            
            return duplicates;
        }
        
        // æ–‡å­—åˆ—é¡ä¼¼åº¦è¨ˆç®—ï¼ˆãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ï¼‰
        function calculateSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;
            
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 100;
            
            const distance = levenshteinDistance(longer, shorter);
            return Math.round(((longer.length - distance) / longer.length) * 100);
        }
        
        // ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }
        
        // CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        window.processCsvUpload = async function() {
            console.log('processCsvUpload started with csvData:', csvData);
            const skipDuplicates = document.getElementById('skipDuplicates').checked;
            const duplicates = skipDuplicates ? checkDuplicates() : [];
            const duplicateNames = duplicates.map(d => d.csvStore.åº—èˆ—å);
            
            // å‡¦ç†å¯¾è±¡ãƒ‡ãƒ¼ã‚¿
            const dataToProcess = csvData.filter(row => !duplicateNames.includes(row.åº—èˆ—å));
            console.log('Data to process:', dataToProcess.length, 'records');
            
            if (dataToProcess.length === 0) {
                showToast('âš ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹æ–°è¦åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
                return;
            }
            
            // ã‚¹ãƒ†ãƒƒãƒ—3è¡¨ç¤º
            document.getElementById('csvStep2').style.display = 'none';
            document.getElementById('csvStep3').style.display = 'block';
            
            const progressBar = document.getElementById('csvProgressBar');
            const progressText = document.getElementById('csvProgressText');
            const importLog = document.getElementById('csvImportLog');
            
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            // ãƒãƒƒãƒå‡¦ç†ï¼ˆ50ä»¶ãšã¤ï¼‰
            const batchSize = 50;
            for (let i = 0; i < dataToProcess.length; i += batchSize) {
                const batch = dataToProcess.slice(i, Math.min(i + batchSize, dataToProcess.length));
                
                for (const row of batch) {
                    try {
                        console.log('Processing row:', row);
                        let storeData = {};
                        
                        // Googleãƒãƒƒãƒ—URLãŒã‚ã‚‹å ´åˆã¯è§£æ
                        if (row.Googleãƒãƒƒãƒ—URL && row.Googleãƒãƒƒãƒ—URL.trim()) {
                            console.log('Processing Google Maps URL:', row.Googleãƒãƒƒãƒ—URL);
                            const googleData = await parseGoogleMapUrl(row.Googleãƒãƒƒãƒ—URL);
                            storeData = {
                                name: row.åº—èˆ—å || googleData.name || 'æœªè¨­å®š',
                                category: row.ã‚«ãƒ†ã‚´ãƒªãƒ¼ || 'ãã®ä»–',
                                address: row.ä½æ‰€ || googleData.address || '',
                                phone: row.é›»è©±ç•ªå· || '',
                                hours: row.å–¶æ¥­æ™‚é–“ || '',
                                closed: row.å®šä¼‘æ—¥ || '',
                                website: row.ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ || '',
                                instagram: row['Instagram URL'] || '',
                                image_url: row.ç”»åƒURL || '',
                                latitude: parseFloat(row.ç·¯åº¦) || googleData.latitude || null,
                                longitude: parseFloat(row.çµŒåº¦) || googleData.longitude || null,
                                place_id: googleData.place_id || ''
                            };
                            
                            importLog.innerHTML += `<div style="color: #3b82f6;">ğŸ” Googleãƒãƒƒãƒ—URLã‹ã‚‰æƒ…å ±å–å¾—: ${storeData.name}</div>`;
                        } else {
                            // é€šå¸¸ã®CSVãƒ‡ãƒ¼ã‚¿å‡¦ç†
                            storeData = {
                                name: row.åº—èˆ—å || 'æœªè¨­å®š',
                                category: row.ã‚«ãƒ†ã‚´ãƒªãƒ¼ || 'ãã®ä»–',
                                address: row.ä½æ‰€ || '',
                                phone: row.é›»è©±ç•ªå· || '',
                                hours: row.å–¶æ¥­æ™‚é–“ || '',
                                closed: row.å®šä¼‘æ—¥ || '',
                                website: row.ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ || '',
                                instagram: row['Instagram URL'] || '',
                                image_url: row.ç”»åƒURL || '',
                                latitude: parseFloat(row.ç·¯åº¦) || null,
                                longitude: parseFloat(row.çµŒåº¦) || null
                            };
                        }
                        
                        // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ä½œæˆ
                        const newStore = {
                            id: Math.max(...stores.map(s => s.id), 0) + 1,
                            ...storeData,
                            instagram: row['Instagram URL'] || '',
                            gluten_free_level: row.ã‚°ãƒ«ãƒ†ãƒ³ãƒ•ãƒªãƒ¼å¯¾å¿œåº¦ || 'è¦ç¢ºèª',
                            gluten_free_menu: row.å¯¾å¿œãƒ¡ãƒ‹ãƒ¥ãƒ¼ || '',
                            notes: row.å‚™è€ƒ || ''
                        };
                        
                        // åº§æ¨™ãŒãªã„å ´åˆã¯ä½æ‰€ã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
                        if (!newStore.latitude || !newStore.longitude) {
                            if (newStore.address) {
                                // ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’æ¨å®šï¼ˆç°¡æ˜“ç‰ˆï¼‰
                                const coords = await geocodeAddress(newStore.address);
                                if (coords) {
                                    newStore.latitude = coords.lat;
                                    newStore.longitude = coords.lng;
                                    importLog.innerHTML += `<div style="color: #10b981;">ğŸ“ ä½æ‰€ã‹ã‚‰åº§æ¨™å–å¾—: ${newStore.address}</div>`;
                                }
                            } else {
                                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº§æ¨™ï¼ˆæ±äº¬ï¼‰
                                newStore.latitude = 35.6762 + (Math.random() - 0.5) * 0.1;
                                newStore.longitude = 139.6503 + (Math.random() - 0.5) * 0.1;
                            }
                        }
                        
                        stores.push(newStore);
                        successCount++;
                        
                        // ãƒ­ã‚°è¿½åŠ 
                        importLog.innerHTML += `<div style="color: var(--success);">âœ… ${newStore.name} ã‚’è¿½åŠ ã—ã¾ã—ãŸ</div>`;
                        
                    } catch (error) {
                        errorCount++;
                        errors.push(`${row.åº—èˆ—å}: ${error.message}`);
                        importLog.innerHTML += `<div style="color: var(--error);">âŒ ${row.åº—èˆ—å} ã®è¿½åŠ ã«å¤±æ•—: ${error.message}</div>`;
                    }
                    
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
                    const progress = Math.round(((i + batch.indexOf(row) + 1) / dataToProcess.length) * 100);
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';
                    progressText.textContent = `${i + batch.indexOf(row) + 1} / ${dataToProcess.length} ä»¶å‡¦ç†ä¸­...`;
                    
                    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    importLog.scrollTop = importLog.scrollHeight;
                    
                    // UIã‚’æ›´æ–°
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
            }
            
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            saveStoresData();
            displayStoresList();
            updateStoreCount();
            
            // çµæœè¡¨ç¤º
            document.getElementById('csvStep3').style.display = 'none';
            document.getElementById('csvStep4').style.display = 'block';
            
            const result = document.getElementById('csvResult');
            result.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: var(--space-md);">
                        ${successCount > 0 ? 'ğŸ‰' : 'ğŸ˜”'}
                    </div>
                    <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: var(--space-lg);">
                        ${successCount} ä»¶ã®åº—èˆ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-md); text-align: center;">
                        <div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--success);">${successCount}</div>
                            <div style="color: var(--text-secondary);">æˆåŠŸ</div>
                        </div>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--warning);">${duplicates.length}</div>
                            <div style="color: var(--text-secondary);">ã‚¹ã‚­ãƒƒãƒ—</div>
                        </div>
                        <div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--error);">${errorCount}</div>
                            <div style="color: var(--text-secondary);">ã‚¨ãƒ©ãƒ¼</div>
                        </div>
                    </div>
                    ${errors.length > 0 ? `
                        <div style="margin-top: var(--space-lg); text-align: left;">
                            <h5>ã‚¨ãƒ©ãƒ¼è©³ç´°:</h5>
                            <div style="background: #fef2f2; padding: var(--space-sm); border-radius: var(--radius-sm); font-size: 0.9rem; max-height: 100px; overflow-y: auto;">
                                ${errors.map(e => `<div>â€¢ ${e}</div>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // GitHubè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
            if (successCount > 0 && githubSettings.token) {
                showToast('ğŸš€ GitHubè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™...', 'info');
                setTimeout(() => deployToGitHub(), 2000);
            }
        }
        
        // CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
        window.resetCsvUpload = function() {
            csvData = [];
            csvHeaders = [];
            document.getElementById('csvFileInput').value = '';
            document.getElementById('csvStep1').style.display = 'block';
            document.getElementById('csvStep2').style.display = 'none';
            document.getElementById('csvStep3').style.display = 'none';
            document.getElementById('csvStep4').style.display = 'none';
        }
        
        // ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        async function geocodeAddress(address) {
            if (!address) return null;
            
            try {
                // æ—¥æœ¬ã®ä¸»è¦éƒ½å¸‚ã®åº§æ¨™ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                const cityCoords = {
                    'æ±äº¬': { lat: 35.6762, lng: 139.6503 },
                    'æ¨ªæµœ': { lat: 35.4437, lng: 139.6380 },
                    'å¤§é˜ª': { lat: 34.6937, lng: 135.5023 },
                    'åå¤å±‹': { lat: 35.1815, lng: 136.9066 },
                    'æœ­å¹Œ': { lat: 43.0642, lng: 141.3469 },
                    'ç¦å²¡': { lat: 33.5904, lng: 130.4017 },
                    'ç¥æˆ¸': { lat: 34.6901, lng: 135.1955 },
                    'äº¬éƒ½': { lat: 35.0116, lng: 135.7681 },
                    'ä»™å°': { lat: 38.2682, lng: 140.8694 },
                    'åºƒå³¶': { lat: 34.3853, lng: 132.4553 },
                    'åƒè‘‰': { lat: 35.6074, lng: 140.1065 },
                    'ã•ã„ãŸã¾': { lat: 35.8617, lng: 139.6455 },
                    'å·å´': { lat: 35.5308, lng: 139.7029 },
                    'æ–°å®¿': { lat: 35.6938, lng: 139.7036 },
                    'æ¸‹è°·': { lat: 35.6580, lng: 139.7016 },
                    'å“å·': { lat: 35.6284, lng: 139.7387 },
                    'æ± è¢‹': { lat: 35.7295, lng: 139.7109 },
                    'ä¸Šé‡': { lat: 35.7141, lng: 139.7774 },
                    'æµ…è‰': { lat: 35.7118, lng: 139.7966 },
                    'éŠ€åº§': { lat: 35.6717, lng: 139.7642 },
                    'å…­æœ¬æœ¨': { lat: 35.6628, lng: 139.7315 },
                    'åŸå®¿': { lat: 35.6702, lng: 139.7026 },
                    'ç§‹è‘‰åŸ': { lat: 35.6984, lng: 139.7731 },
                    'å‰ç¥¥å¯º': { lat: 35.7032, lng: 139.5798 },
                    'ç”ºç”°': { lat: 35.5438, lng: 139.4386 },
                    'ç«‹å·': { lat: 35.6978, lng: 139.4140 },
                    'å…«ç‹å­': { lat: 35.6586, lng: 139.3161 }
                };
                
                // ä½æ‰€ã‹ã‚‰éƒ½å¸‚åã‚’æŠ½å‡º
                for (const [city, coords] of Object.entries(cityCoords)) {
                    if (address.includes(city)) {
                        // éƒ½å¸‚ã®åº§æ¨™ã«å°‘ã—ãƒ©ãƒ³ãƒ€ãƒ ãªåå·®ã‚’åŠ ãˆã‚‹
                        return {
                            lat: coords.lat + (Math.random() - 0.5) * 0.05,
                            lng: coords.lng + (Math.random() - 0.5) * 0.05
                        };
                    }
                }
                
                // éƒ½é“åºœçœŒãƒ¬ãƒ™ãƒ«ã§ã®åˆ¤å®š
                if (address.includes('æ±äº¬éƒ½')) {
                    return {
                        lat: 35.6762 + (Math.random() - 0.5) * 0.2,
                        lng: 139.6503 + (Math.random() - 0.5) * 0.2
                    };
                } else if (address.includes('å¤§é˜ªåºœ')) {
                    return {
                        lat: 34.6937 + (Math.random() - 0.5) * 0.2,
                        lng: 135.5023 + (Math.random() - 0.5) * 0.2
                    };
                } else if (address.includes('ç¥å¥ˆå·çœŒ')) {
                    return {
                        lat: 35.4437 + (Math.random() - 0.5) * 0.2,
                        lng: 139.6380 + (Math.random() - 0.5) * 0.2
                    };
                }
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ±äº¬
                return {
                    lat: 35.6762 + (Math.random() - 0.5) * 0.3,
                    lng: 139.6503 + (Math.random() - 0.5) * 0.3
                };
                
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ã®å¯ç”¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯
            setTimeout(checkAutoSaveAvailability, 1000); // 1ç§’å¾Œã«ãƒã‚§ãƒƒã‚¯
            
            // CSVä¸€æ‹¬ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const csvBtn = document.getElementById('csvUploadBtn');
            if (csvBtn) {
                csvBtn.addEventListener('click', function() {
                    console.log('CSV button clicked via event listener');
                    if (typeof showCsvUploadModal === 'function') {
                        showCsvUploadModal();
                    } else {
                        console.error('showCsvUploadModal is not defined');
                        // ç›´æ¥å®Ÿè¡Œã‚’è©¦ã¿ã‚‹
                        try {
                            window.showCsvUploadModal();
                        } catch (e) {
                            console.error('Failed to call showCsvUploadModal:', e);
                        }
                    }
                });
                console.log('CSV button event listener attached');
            } else {
                console.log('CSV button not found in DOM');
            }
        });
    </script>
</body>
</html>